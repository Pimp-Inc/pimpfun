<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIMP.FUN - Empire City</title>
    <!-- Version 3.1 - Enhanced Store System -->
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="supabase-config.js"></script>
    <script src="simple-wallet.js"></script>
    <script src="src/constants/GameConstants.js"></script>
    <script src="src/modules/GameStateManager.js"></script>
    <script src="src/modules/StoreSystem.js"></script>
    <script src="src/utils/GameUtils.js"></script>
    <!-- store-systems.js embedded inline to avoid loading issues -->
    <style>
        :root {
            --onyx: #0B0B0E;
            --neon-magenta: #FF2FB9;
            --electric-cyan: #00E5FF;
            --luxe-gold: #F2C94C;
        }
        
        body {
            background-color: var(--onyx);
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 47, 185, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 229, 255, 0.1) 0%, transparent 50%);
        }
        
        .crt-grain::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: repeating-linear-gradient(
                0deg,
                rgba(255, 255, 255, 0.03),
                rgba(255, 255, 255, 0.03) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1;
            opacity: 0.1;
        }
        
        .game-panel {
            background: linear-gradient(135deg, rgba(26, 26, 30, 0.95) 0%, rgba(11, 11, 14, 0.95) 100%);
            border: 1px solid rgba(255, 47, 185, 0.2);
            box-shadow: 
                0 0 20px rgba(255, 47, 185, 0.1),
                inset 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .npc-card {
            background: linear-gradient(135deg, rgba(26, 26, 30, 0.95) 0%, rgba(11, 11, 14, 0.95) 100%);
            border: 1px solid rgba(0, 229, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .npc-card:hover {
            border-color: var(--electric-cyan);
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .npc-card.defeated {
            opacity: 0.5;
            border-color: rgba(255, 0, 0, 0.3);
        }
        
        .gold-text {
            color: var(--luxe-gold);
            text-shadow: 0 0 10px rgba(242, 201, 76, 0.5);
        }
        
        .magenta-glow {
            color: var(--neon-magenta);
            text-shadow: 0 0 20px rgba(255, 47, 185, 0.8);
        }
        
        .cyan-glow {
            color: var(--electric-cyan);
            text-shadow: 0 0 20px rgba(0, 229, 255, 0.8);
        }
        
        /* Notification system */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            padding: 16px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.9));
            border: 1px solid rgba(34, 197, 94, 0.5);
        }
        
        .notification.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9));
            border: 1px solid rgba(245, 158, 11, 0.5);
        }
        
        .action-btn {
            background: linear-gradient(135deg, rgba(255, 47, 185, 0.2) 0%, rgba(0, 229, 255, 0.2) 100%);
            border: 1px solid rgba(255, 47, 185, 0.5);
            transition: all 0.3s ease;
        }
        
        .action-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(255, 47, 185, 0.3) 0%, rgba(0, 229, 255, 0.3) 100%);
            border-color: var(--electric-cyan);
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
            transform: scale(1.05);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Turn meter */
        .turn-meter {
            background: linear-gradient(90deg, 
                var(--electric-cyan) 0%, 
                var(--neon-magenta) 100%
            );
            transition: width 0.5s ease;
        }
        
        /* Respawn timer */
        .respawn-timer {
            font-family: 'VT323', monospace;
            color: #ff4444;
            text-shadow: 0 0 5px rgba(255, 68, 68, 0.8);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(11, 11, 14, 0.5);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 47, 185, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 47, 185, 0.5);
        }
    </style>
</head>
<body class="text-gray-300 font-['Inter'] antialiased relative">
    <div class="crt-grain"></div>
    
    <!-- Main Container -->
    <div class="min-h-screen p-2 md:p-4 relative z-10">
        <!-- Empire City Banner Header -->
        <header class="mb-6 relative overflow-hidden rounded-xl">
            <!-- Background Image -->
            <div class="relative h-32 md:h-40">
                <img src="images/empire_city_banner.jpg" alt="Empire City Skyline" 
                     class="w-full h-full object-cover">
                
                <!-- Dark Overlay for Text Readability -->
                <div class="absolute inset-0 bg-gradient-to-r from-black/70 via-black/50 to-black/70"></div>
                
                <!-- Header Content -->
                <div class="absolute inset-0 flex items-center justify-between p-4 md:p-6">
                    <div class="flex items-center gap-4">
                        <img src="images/pimp_hat.png" alt="Pimp Hat" class="w-12 h-12 md:w-16 md:h-16 drop-shadow-lg">
                        <div>
                            <h1 class="text-2xl md:text-4xl font-bold">
                                <span class="cyan-glow" style="text-shadow: 0 0 30px rgba(0, 229, 255, 1), 0 2px 4px rgba(0,0,0,0.8);">Empire City</span>
                            </h1>
                            <p class="text-sm md:text-base text-gray-300 font-medium drop-shadow-lg">
                                Week <span id="weekNumber" class="gold-text">1</span> ‚Ä¢ Three districts. One crown.
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="showEconomicDashboard()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded font-medium shadow-lg text-white">
                            üìä Economic Dashboard
                        </button>
                        <button id="authButton" class="px-4 py-2 action-btn rounded font-medium shadow-lg">
                            <span id="authStatus">Sign In</span>
                        </button>
                        <a href="../index.html" class="text-gray-300 hover:text-white transition-colors font-medium drop-shadow-lg">Exit</a>
                    </div>
                </div>
                
                <!-- Animated Glow Effect -->
                <div class="absolute inset-0 opacity-30">
                    <div class="absolute top-4 left-1/4 w-32 h-32 bg-cyan-500/20 rounded-full blur-3xl animate-pulse"></div>
                    <div class="absolute bottom-4 right-1/4 w-24 h-24 bg-purple-500/20 rounded-full blur-2xl animate-pulse" style="animation-delay: 1s;"></div>
                </div>
            </div>
        </header>

        <!-- Auth Landing Page (shown when not logged in) -->
        <div id="authLanding" class="min-h-[70vh] flex items-center justify-center">
            <div class="game-panel rounded-lg p-8 max-w-md w-full mx-4">
                <div class="text-center mb-6">
                    <img src="images/pimpfun_logo.png" alt="PIMP.FUN" class="h-16 mx-auto mb-4">
                    <h2 class="text-2xl font-bold cyan-glow mb-2">Welcome to Empire City</h2>
                    <p class="text-sm text-gray-400 mb-4">Multiplayer pimp empire game - Compete with 1000+ players</p>
                    
                    <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-4 mb-4">
                        <h3 class="text-blue-400 font-bold mb-2">üåê SHARED MULTIPLAYER DATABASE</h3>
                        <ul class="text-xs text-gray-300 space-y-1">
                            <li>‚úÖ Progress saved to secure servers</li>
                            <li>‚úÖ Shared leaderboards & rankings</li>
                            <li>‚úÖ Cross-device play</li>
                            <li>‚úÖ Single point of truth for all users</li>
                            <li>‚úÖ Real multiplayer interactions</li>
                        </ul>
                    </div>
                </div>
                
                <div id="authOptions" class="space-y-4">
                    <!-- Email Sign In (Primary) -->
                    <button onclick="showEmailAuth()" class="w-full p-4 rounded border border-purple-500 bg-purple-900/20 hover:bg-purple-900/40 transition-all flex items-center justify-center gap-3">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                        <span class="font-medium">Sign In with Email</span>
                    </button>
                    
                    <!-- No Guest Mode - Authentication Required -->
                    <div class="text-center mt-6 pt-4 border-t border-gray-700">
                        <p class="text-xs text-gray-400">
                            üåê Multiplayer game - Account required to compete with 1000+ players
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Content (hidden initially) -->
        <div id="gameContent" class="hidden">
            <!-- Tutorial Banner (shown for first 3 days) -->
            <div id="tutorialBanner" class="mb-4 game-panel rounded-lg p-4 border-2 border-yellow-500/50 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">üéì</span>
                        <div>
                            <h3 class="font-bold gold-text">Tutorial Mode - Day <span id="tutorialDay">1</span>/3</h3>
                            <p class="text-sm text-gray-400">Faster turn regen ‚Ä¢ Guided missions ‚Ä¢ Extra rewards</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="showTutorial()" class="text-sm text-cyan-400 hover:text-cyan-300">View Missions</button>
                        <button onclick="dismissTutorial()" class="text-red-400 hover:text-red-300 text-xl font-bold" title="Dismiss tutorial (can be re-enabled in settings)">&times;</button>
                    </div>
                </div>
            </div>

        <!-- Game Layout -->
        <div class="grid lg:grid-cols-3 gap-4 max-w-7xl mx-auto">
            <!-- Column 1: Profile + Resources + Combat Log -->
            <div class="space-y-4">
                <!-- Combined Profile & Resources -->
                <div class="game-panel rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-lg font-bold cyan-glow">PIMP PROFILE & RESOURCES</h2>
                        <button onclick="editProfile()" class="text-xs px-2 py-1 action-btn rounded">Edit</button>
                    </div>
                    
                    <!-- Profile Info -->
                    <div class="space-y-2 text-sm mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Pimp Name:</span>
                            <span id="username" class="gold-text cursor-pointer" onclick="editProfile()">Anonymous Pimp</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">District:</span>
                            <span id="district" class="cyan-glow cursor-pointer" onclick="selectDistrict()">Choose District</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Rank:</span>
                            <span id="rank" class="text-amber-400">Unranked</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Level:</span>
                            <span id="level" class="text-white">1</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Net Worth:</span>
                            <span id="netWorth" class="gold-text">$27,360</span>
                        </div>
                    </div>
                    
                    <!-- Resources Grid -->
                    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Cash:</span>
                                <span id="money" class="gold-text">$9,360</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Hoes:</span>
                                <span id="hoes" class="text-pink-400 cursor-pointer hover:text-pink-300" onclick="showHoeDetails()">9</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Thugs:</span>
                                <span id="thugs" class="text-blue-400 cursor-pointer hover:text-blue-300" onclick="showThugDetails()">6</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Payout:</span>
                                <span id="payout" class="text-yellow-400">30%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Respect:</span>
                                <span id="respect" class="text-purple-400">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Heat:</span>
                                <span id="heat" class="text-red-400">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Happiness Status -->
                    <div class="pt-3 border-t border-gray-700 space-y-2 mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Hoe Happiness:</span>
                            <span id="hoeHappiness" class="text-pink-400">70%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Thug Happiness:</span>
                            <span id="thugHappiness" class="text-blue-400">70%</span>
                        </div>
                    </div>
                    
                    <!-- Turns -->
                    <div class="pt-3 border-t border-gray-700">
                        <div class="flex justify-between mb-2">
                            <span class="text-lg font-bold cyan-glow">TURNS</span>
                            <span class="text-2xl font-bold gold-text" id="currentTurns">200</span>
                        </div>
                        <div class="w-full h-3 bg-gray-800 rounded-full overflow-hidden mb-2">
                            <div class="turn-meter h-full rounded-full" id="turnMeter" style="width: 100%"></div>
                        </div>
                        <div class="text-xs text-gray-400">
                            <div>Regen: <span id="regenRate" class="text-cyan-400">2</span> turns per 10 min</div>
                            <div>Full in: <span id="fullIn" class="text-green-400">0:00</span></div>
                            <div>Next 4:20pm: <span id="nextPayout" class="text-gold">0:00</span></div>
                        </div>
                    </div>
                </div>

                <!-- Combat Log -->
                <div class="game-panel rounded-lg p-4">
                    <h2 class="text-lg font-bold mb-3 cyan-glow">COMBAT LOG</h2>
                    <div id="combatLog" class="h-32 overflow-y-auto text-xs font-['Space_Mono'] space-y-1">
                        <div class="text-green-400">> Combat log initialized</div>
                    </div>
                </div>
            </div>

            <!-- Column 2: Supply Status + Hood Pimps -->
            <div class="space-y-4">
                <!-- Resource Status -->
                <div class="game-panel rounded-lg p-4">
                    <h2 class="text-lg font-bold mb-3 cyan-glow">RESOURCE STATUS</h2>
                    
                    <!-- Basic Supplies -->
                    <div class="mb-4">
                        <h3 class="text-sm font-bold text-gray-300 mb-2">Daily Supplies</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">üç∫ Beer:</span>
                                <div class="text-right">
                                    <span id="beerCount" class="text-white">200</span>
                                    <span id="beerDays" class="text-xs text-green-400 ml-1">(8.3 days)</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">üåø Weed:</span>
                                <div class="text-right">
                                    <span id="weedCount" class="text-white">0 oz</span>
                                    <span id="weedDays" class="text-xs text-red-400 ml-1">(0 days)</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">üõ°Ô∏è Condoms:</span>
                                <div class="text-right">
                                    <span id="condomCount" class="text-white">500</span>
                                    <span id="condomDays" class="text-xs text-green-400 ml-1">(12.5 days)</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">üíä Medicine:</span>
                                <span id="medicineCount" class="text-white">10</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Drugs & Assets -->
                    <div class="mb-4 border-t border-gray-700 pt-3">
                        <h3 class="text-sm font-bold text-gray-300 mb-2">Drugs & Assets</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">üíé Crack:</span>
                                <span id="crackCount" class="text-purple-400">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">üî´ Weapons:</span>
                                <span id="weaponsCount" class="text-red-400 cursor-pointer hover:text-red-300" onclick="showWeaponDetails()">5</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">üöó Vehicles:</span>
                                <span id="vehiclesCount" class="text-blue-400 cursor-pointer hover:text-blue-300" onclick="showVehicleDetails()">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="supplyWarnings" class="mt-2"></div>
                </div>

                            <!-- Hood Pimps -->
            <div class="game-panel rounded-lg p-4">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold cyan-glow">HOOD PIMPS</h2>
                </div>
                <div id="npcList" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Hood Pimps will be dynamically added here -->
                </div>
            </div>
            </div>

            <!-- Column 3: Quick Actions + Console -->
            <div class="space-y-4">
                <!-- Turn Actions -->
                <div class="game-panel rounded-lg p-4">
                    <h2 class="text-lg font-bold mb-3 cyan-glow">TURN ACTIONS</h2>
                    <div class="space-y-2">
                        <button onclick="showScoutOptions()" class="w-full action-btn rounded py-2 text-sm">
                            üîç SCOUT DISTRICTS
                        </button>
                        <button onclick="showCrackAndDrugs()" class="w-full action-btn rounded py-2 text-sm">
                            üíé CRACK & DRUG DEALING
                        </button>
                        <button onclick="showHeatReductionServices()" class="w-full action-btn rounded py-2 text-sm bg-red-600">
                            üî• HEAT MANAGEMENT
                        </button>
                        <button onclick="adjustPayout()" class="w-full action-btn rounded py-2 text-sm">
                            üíÉ ADJUST HO $ PAYOUT
                        </button>
                    </div>
                </div>

                <!-- Buy Shit -->
                <div class="game-panel rounded-lg p-4">
                    <h2 class="text-lg font-bold mb-3 cyan-glow">BUY SHIT</h2>
                    <div class="space-y-2">
                        <button onclick="visitCornerStore()" class="w-full action-btn rounded py-2 text-sm">
                            üç∫ CORNER STORE
                        </button>
                        <button onclick="visitReggiesPlug()" class="w-full action-btn rounded py-2 text-sm">
                            üå≥ REGGIE'S PLUG
                        </button>
                        <button onclick="visitPewPewJimmys()" class="w-full action-btn rounded py-2 text-sm">
                            üí• PEW PEW JIMMY'S
                        </button>
                        <button onclick="visitTonysChopShop()" class="w-full action-btn rounded py-2 text-sm">
                            üöó TONY'S CHOP SHOP
                        </button>
                    </div>
                </div>

                <!-- Admin Tests (only visible to admin) -->
                <div id="adminPanel" class="game-panel rounded-lg p-4" style="display: none;">
                    <h2 class="text-lg font-bold mb-3 cyan-glow">ADMIN TESTS</h2>
                    <div class="space-y-2">
                        <button onclick="testDailyPayout()" class="w-full action-btn rounded py-2 text-sm bg-green-600">
                            üí∞ Test Daily Payout
                        </button>
                        <button onclick="completeGameReset()" class="w-full action-btn rounded py-2 text-sm bg-orange-600">
                            üîÑ Complete Game Reset
                        </button>
                        <button onclick="showSeasonResetInfo()" class="w-full action-btn rounded py-2 text-sm bg-purple-600">
                            üèÜ Season Reset Info
                        </button>
                    </div>
                </div>

                <!-- Console -->
                <div class="game-panel rounded-lg p-4">
                    <h2 class="text-lg font-bold mb-3 cyan-glow">CONSOLE</h2>
                    <div id="console" class="h-32 overflow-y-auto text-xs font-['Space_Mono'] space-y-1">
                        <div class="text-green-400">> Welcome to Empire City!</div>
                        <div class="cyan-glow">> Sign in to save your progress</div>
                    </div>
                </div>
            </div>
        </div>
            </div>
        </div>
        </div> <!-- End gameContent -->
    </div>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
        /*
        ====================================================================
        PIMP.FUN EMPIRE CITY - BLOCKCHAIN TRANSITION ARCHITECTURE
        ====================================================================
        
        CURRENT (BETA): Centralized game with Supabase database
        - Data integrity tracking system prepares for blockchain migration
        - Change logs simulate transaction records for debugging
        - Asset structures designed for easy tokenization
        
        FUTURE (PRODUCTION): Decentralized game on Solana blockchain
        - All critical assets (hoes, weapons, vehicles) become NFTs
        - Game actions become on-chain transactions with immutable history
        - Community governance through $PIMP token voting
        - True ownership - players control their assets via wallet keys
        
        MIGRATION STRATEGY:
        1. Current tracking system provides audit trail for conversion
        2. Asset structures already blockchain-compatible (type, rarity, stats)
        3. Game logic separates business rules from data persistence
        4. Player authentication already uses cryptographic identities
        
        BLOCKCHAIN BENEFITS:
        - Zero data loss (assets exist on blockchain permanently)
        - Transparent economy (all transactions public and verifiable)
        - True asset ownership (tradeable NFTs, no central authority)
        - Anti-cheat (game mechanics enforced by smart contracts)
        - Cross-platform persistence (wallet-based, not server-based)
        ====================================================================
        */
        
        // NFT Drop System
        const NFT_SYSTEM = {
            // Base chance calculations - UPDATED FOR EXPONENTIAL SCALING
            baseChance: 0.03,           // 3% base chance at 10 turns
            turnMultiplier: 0.002,      // +0.2% per additional turn (linear component)
            exponentialBonus: 0.0001,   // Exponential component for high turns
            maxChance: 0.35,            // 35% maximum chance (before guaranteed)
            
            // Turn thresholds for major bonuses
            minTurns: 10,               // Minimum 10 turns for NFT chance
            bonusTurns: 30,             // 30+ turns get significant bonus
            premiumTurns: 50,           // 50+ turns get premium bonus
            guaranteedTurns: 100,       // 100 turns = guaranteed NFT
            
            // Rarity distribution (updated for 7-tier system)
            rarityChances: {
                common: 0.40,           // 40% chance (200 names)
                uncommon: 0.30,         // 30% chance (140 names)  
                rare: 0.15,             // 15% chance (100 names)
                epic: 0.08,             // 8% chance (80 names)
                super: 0.04,            // 4% chance (60 names)
                legendary: 0.02,        // 2% chance (40 names)
                mythic: 0.01            // 1% chance (20 names)
            },
            
            // NFT Types and their properties (matching your 7-tier system)
            nftTypes: {
                hoe: {
                    common: { category: 'StreetHookers_Common', description: 'Street-level worker', multiplier: 1.25, baseIncome: 180 },
                    uncommon: { category: 'SugarBabies_Uncommon', description: 'Upgraded sugar baby', multiplier: 1.5, baseIncome: 240 },
                    rare: { category: 'Strippers_Rare', description: 'Professional entertainer', multiplier: 2.0, baseIncome: 350 },
                    epic: { category: 'HighEndEscort_Epic', description: 'Elite escort + one-word name', multiplier: 3.0, baseIncome: 500 },
                    super: { category: 'OnlyTrampsModels_Super', description: 'Digital empire model', multiplier: 4.0, baseIncome: 800 },
                    legendary: { category: 'VIPLevel_Legendary', description: 'VIP-tier + one-word name', multiplier: 6.0, baseIncome: 1200 },
                    mythic: { category: 'QueenMadam_Mythic', description: 'Empire-level madam', multiplier: 10.0, baseIncome: 2000 }
                },
                thug: {
                    common: { description: 'Reliable street muscle', startRank: 'soldier', power: 1.2 },
                    uncommon: { description: 'Experienced enforcer', startRank: 'soldier', power: 1.4 },
                    rare: { description: 'Elite crew leader', startRank: 'lieutenant', power: 1.8 },
                    epic: { description: 'District commander', startRank: 'captain', power: 2.5 },
                    super: { description: 'Territory boss', startRank: 'captain', power: 3.0 },
                    legendary: { description: 'Empire enforcer', startRank: 'enforcer', power: 4.0 },
                    mythic: { description: 'Legendary underboss', startRank: 'enforcer', power: 6.0 }
                },
                weapon: {
                    common: { description: 'Custom chrome finish', power: 1.25 },
                    uncommon: { description: 'Gold-plated upgrade', power: 1.5 },
                    rare: { description: 'Diamond-encrusted piece', power: 2.0 },
                    epic: { description: 'Military-grade hardware', power: 3.0 },
                    super: { description: 'Experimental prototype', power: 4.0 },
                    legendary: { description: 'Phantom assassin tech', power: 6.0 },
                    mythic: { description: 'Empire kingmaker', power: 10.0 }
                },
                vehicle: {
                    common: { description: 'Custom street ride', bonus: 'status', heatReduction: 0 },
                    uncommon: { description: 'Midnight cruiser', bonus: 'status', heatReduction: 5 },
                    rare: { description: 'Phantom stealth ride', bonus: 'stealth', heatReduction: 15 },
                    epic: { description: 'Armored protection', bonus: 'protection', heatReduction: 25 },
                    super: { description: 'Golden chariot', bonus: 'income', heatReduction: 35 },
                    legendary: { description: 'Empire command vehicle', bonus: 'ultimate', heatReduction: 50 },
                    mythic: { description: 'Throne of power', bonus: 'ultimate', heatReduction: 75 }
                },
                territory: {
                    common: { description: 'Exclusive corner spot', incomeBonus: 0.25 },
                    uncommon: { description: 'Private back room', incomeBonus: 0.40 },
                    rare: { description: 'VIP club section', incomeBonus: 0.75 },
                    epic: { description: 'Penthouse suite', incomeBonus: 1.25 },
                    super: { description: 'Casino floor access', incomeBonus: 2.0 },
                    legendary: { description: 'Empire tower', incomeBonus: 4.0 },
                    mythic: { description: 'City hall control', incomeBonus: 8.0 }
                }
            }
        };

        // Calculate NFT drop chance based on turns used - EXPONENTIAL SCALING
        function calculateNFTChance(turnsUsed, action = 'scout') {
            if (turnsUsed < NFT_SYSTEM.minTurns) return 0;
            
            // Guaranteed at 100 turns
            if (turnsUsed >= NFT_SYSTEM.guaranteedTurns) {
                return 1.0;
            }
            
            // Base calculation with exponential component
            let chance = NFT_SYSTEM.baseChance;
            
            // Linear component (consistent growth)
            const extraTurns = Math.max(0, turnsUsed - NFT_SYSTEM.minTurns);
            chance += extraTurns * NFT_SYSTEM.turnMultiplier;
            
            // Exponential component (rewards big investments)
            const exponentialComponent = extraTurns * extraTurns * NFT_SYSTEM.exponentialBonus;
            chance += exponentialComponent;
            
            // Major threshold bonuses
            if (turnsUsed >= NFT_SYSTEM.premiumTurns) {
                chance *= 2.0; // 100% bonus for 50+ turns
            } else if (turnsUsed >= NFT_SYSTEM.bonusTurns) {
                chance *= 1.5; // 50% bonus for 30+ turns
            }
            
            // Cap at maximum (before guaranteed)
            chance = Math.min(chance, NFT_SYSTEM.maxChance);
            
            // Action-specific modifiers
            const actionMultipliers = {
                scout: 1.0,        // Normal chance
                crack: 0.6,        // Slightly lower for safer activity
                combat: 1.4,       // Higher chance for combat risk
                special: 2.0       // Special events
            };
            
            chance *= actionMultipliers[action] || 1.0;
            
            console.log('üíé NFT Chance Calculation:', {
                turnsUsed,
                baseChance: NFT_SYSTEM.baseChance,
                linearBonus: extraTurns * NFT_SYSTEM.turnMultiplier,
                exponentialBonus: exponentialComponent,
                thresholdMultiplier: turnsUsed >= NFT_SYSTEM.premiumTurns ? 2.0 : 
                                   turnsUsed >= NFT_SYSTEM.bonusTurns ? 1.5 : 1.0,
                actionMultiplier: actionMultipliers[action],
                finalChance: (chance * 100).toFixed(2) + '%'
            });
            
            return Math.min(chance, 0.99); // Never 100% except for guaranteed
        }

        // Load hoe names from JSON (will be loaded async)
        let hoeNamesData = null;
        
        // Load the hoe names JSON file
        async function loadHoeNames() {
            try {
                const response = await fetch('docs/ho_names.JSON');
                hoeNamesData = await response.json();
                console.log('‚úÖ Loaded hoe names:', Object.keys(hoeNamesData).map(key => `${key}: ${hoeNamesData[key].length} names`));
            } catch (error) {
                console.error('‚ùå Failed to load hoe names:', error);
                // Fallback names if JSON fails to load
                hoeNamesData = {
                    "StreetHookers_Common": ["Street Queen", "Block Beauty", "Corner Cutie"],
                    "SugarBabies_Uncommon": ["Sugar Sweet", "Honey Heart", "Candy Crush"],
                    "Strippers_Rare": ["Diamond Dancer", "Platinum Performer", "Golden Goddess"],
                    "HighEndEscort_Epic": ["Diamond", "Onyx", "Sapphire"],
                    "OnlyTrampsModels_Super": ["Cyber Queen", "Digital Diva", "Virtual Vixen"],
                    "VIPLevel_Legendary": ["Aurora", "Stella", "Luna"],
                    "QueenMadam_Mythic": ["Empire Empress", "Royal Majesty", "Supreme Sovereign"]
                };
            }
        }

        // Generate NFT drop
        function generateNFTDrop(district = null) {
            // Determine rarity
            const rarityRoll = Math.random();
            let rarity = 'common';
            let cumulativeChance = 0;
            
            for (const [rarityLevel, chance] of Object.entries(NFT_SYSTEM.rarityChances)) {
                cumulativeChance += chance;
                if (rarityRoll <= cumulativeChance) {
                    rarity = rarityLevel;
                    break;
                }
            }
            
            // Determine type (weighted by action)
            const typeWeights = { hoe: 0.4, thug: 0.3, weapon: 0.2, vehicle: 0.08, territory: 0.02 };
            const typeRoll = Math.random();
            let type = 'hoe';
            cumulativeChance = 0;
            
            for (const [nftType, weight] of Object.entries(typeWeights)) {
                cumulativeChance += weight;
                if (typeRoll <= cumulativeChance) {
                    type = nftType;
                    break;
                }
            }
            
            // Get the specific NFT data
            const nftData = NFT_SYSTEM.nftTypes[type][rarity];
            
            // Generate appropriate name based on type
            let name = `${rarity.charAt(0).toUpperCase() + rarity.slice(1)} ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            
            if (type === 'hoe' && hoeNamesData && nftData.category) {
                // Use actual names from your JSON file
                const nameArray = hoeNamesData[nftData.category];
                if (nameArray && nameArray.length > 0) {
                    name = nameArray[Math.floor(Math.random() * nameArray.length)];
                }
            } else if (type === 'weapon') {
                const weaponNames = {
                    common: ['Chrome Pistol', 'Gold Glock', 'Silver Shotgun'],
                    uncommon: ['Platinum Piece', 'Diamond Desert Eagle', 'Ruby Rifle'],
                    rare: ['Sapphire Sniper', 'Emerald Enforcer', 'Onyx Obliterator'],
                    epic: ['Phantom Pistol', 'Ghost Gun', 'Shadow Shooter'],
                    super: ['Quantum Cannon', 'Plasma Piece', 'Laser Launcher'],
                    legendary: ['Kingmaker', 'Throne Taker', 'Empire Ender'],
                    mythic: ['God Slayer', 'Reality Ripper', 'Universe Undoer']
                };
                name = weaponNames[rarity][Math.floor(Math.random() * weaponNames[rarity].length)];
            } else if (type === 'vehicle') {
                const vehicleNames = {
                    common: ['Street Bicycle', 'Corner Bike', 'Block Runner'],
                    uncommon: ['Midnight Motorcycle', 'Shadow Bike', 'Ghost Rider'],
                    rare: ['Custom Kia', 'Stealth Sedan', 'Phantom Ride'],
                    epic: ['Chrome Lowrider', 'Golden Escalade', 'Diamond Cruiser'],
                    super: ['Platinum Limo', 'Royal Stretch', 'VIP Express'],
                    legendary: ['Empire Bentley', 'Throne Chariot', 'Kingpin Cruiser'],
                    mythic: ['God Beast', 'Celestial Armor', 'Divine Destroyer']
                };
                name = vehicleNames[rarity][Math.floor(Math.random() * vehicleNames[rarity].length)];
            } else if (type === 'territory') {
                const territoryNames = {
                    common: ['Corner Spot', 'Block Base', 'Street Station'],
                    uncommon: ['Back Room', 'Private Place', 'Hidden Hideout'],
                    rare: ['VIP Venue', 'Elite Estate', 'Premium Property'],
                    epic: ['Penthouse Palace', 'Sky Suite', 'High Heaven'],
                    super: ['Casino Floor', 'Gaming Ground', 'Fortune Foundation'],
                    legendary: ['Empire Tower', 'Throne Territory', 'Royal Realm'],
                    mythic: ['City Hall', 'Government Ground', 'Supreme State']
                };
                name = territoryNames[rarity][Math.floor(Math.random() * territoryNames[rarity].length)];
            }
            
            return {
                type,
                rarity,
                name,
                description: nftData.description,
                foundAt: Date.now(),
                foundLocation: district || 'Unknown',
                id: `nft_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                ...nftData
            };
        }

        // Game Constants
        const TURN_MECHANICS = {
            regenRate: 0.2,            // 2 turns per 10 minutes (0.2 turns per minute)
            baseMaxTurns: 200,         // Hard cap 
            startingTurns: 150,        // All new games start with 150 turns
            regenTime: 1000,           // 1000 minutes (16.7 hours) to go from 0 to 200
            bonusAfter6Hours: 6,       // 6 bonus turns after 6 hours offline
            voteBonus: 5,              // 5 bonus turns for voting
            
            weeklyProgression: {
                1: { regenRate: 0.2, maxTurns: 200, startingTurns: 150 },   // Start standard (2 per 10 min)
                2: { regenRate: 0.2, maxTurns: 200, startingTurns: 150 },   // Keep standard
                3: { regenRate: 0.2, maxTurns: 200, startingTurns: 150 },   // Normal (2 per 10 min)
                4: { regenRate: 0.2, maxTurns: 200, startingTurns: 150 },
                5: { regenRate: 0.18, maxTurns: 200, startingTurns: 150 },  // Slightly slower later
                6: { regenRate: 0.15, maxTurns: 200, startingTurns: 150 }   // Endgame slower
            }
        };

        // Store Definitions
        const STORES = {
            "Corner Store": {
                owner: "Old Man Jenkins",
                location: "Midtown",
                inventory: {
                    beer: {
                        single: { price: 2, quantity: 1 },      // Regular beer
                        sixPack: { price: 10, quantity: 6 },
                        case: { price: 40, quantity: 24 },
                        "40oz": { price: 8, quantity: 3 },      // Malt liquor for thugs
                        hennessy: { price: 45, quantity: 1 },   // Premium cognac
                        keg: { price: 300, quantity: 200 }
                    },
                    condoms: {
                        single: { price: 1, quantity: 1 },
                        pack: { price: 10, quantity: 12 },
                        box: { price: 80, quantity: 100 },
                        crate: { price: 700, quantity: 1000 }
                    },
                    medicine: {
                        dose: { price: 20, quantity: 1 },
                        bottle: { price: 180, quantity: 10 },
                        case: { price: 1600, quantity: 100 }
                    }
                }
            },
            
            "Reggie's Plug": {
                owner: "Reggie the Plug",
                location: "Backstreets",
                inventory: {
                    weed: {
                        eighth: { price: 15, quantity: 0.125 },
                        quarter: { price: 28, quantity: 0.25 },
                        half: { price: 55, quantity: 0.5 },
                        ounce: { price: 100, quantity: 1 },
                        qp: { price: 350, quantity: 4 },
                        pound: { price: 1200, quantity: 16 }
                    }
                },
                heatGeneration: 5
            },
            
            "Tony's Chop Shop": {
                owner: "Tony Ricci",
                location: "Uptown",
                inventory: {
                    bicycle: { price: 1000, sellback: 500, description: "Silent getaway bike" },
                    motorcycle: { price: 3500, sellback: 1750, description: "Fast street bike" },
                    kia: { price: 8000, sellback: 4000, description: "Reliable Kia sedan" },
                    lowrider: { price: 15000, sellback: 7500, description: "Classic lowrider - street cred" },
                    escalade: { price: 35000, sellback: 17500, description: "Luxury Escalade - crew transport" },
                    limo: { price: 80000, sellback: 40000, description: "Stretch limo - VIP status" },
                    bentley: { price: 150000, sellback: 75000, description: "Bentley - ultimate luxury" },
                    armoredBeast: { price: 250000, sellback: 125000, description: "Armored Beast - fear factor" }
                },
                requiresRespect: 25
            },
            
            "Pew Pew Jimmy's": {
                owner: "Jimmy Two-Guns",
                location: "Backstreets",
                inventory: {
                    thugs: { price: 1000, sellback: 0 },      // Can't sell thugs back
                    pistol: { price: 250, sellback: 188 },
                    shotgun: { price: 1250, sellback: 398 },  // Original prices
                    mp5: { price: 2500, sellback: 1875 },     // Called MP5 in original
                    ak47: { price: 5500, sellback: 4125 }
                },
                requiresRespect: 10
            }
        };

        // Supply Consumption Rates
        const SUPPLY_CONSUMPTION = {
            beer: {
                formula: (thugs, happiness) => {
                    const drinkRate = happiness > 70 ? 4 : happiness > 40 ? 6 : 12;
                    return thugs * drinkRate;
                },
                happinessImpact: (beersOwned, thugsCount, dailyNeed) => {
                    const ratio = beersOwned / dailyNeed;
                    if (ratio >= 2) return 30;
                    if (ratio >= 1) return 15;
                    if (ratio >= 0.5) return 0;
                    return -30;
                }
            },
            weed: {
                formula: (thugs) => Math.ceil(thugs / 8),
                happinessImpact: (weedOwned, thugsCount) => {
                    const dailyNeed = thugsCount / 8;
                    const daysSupply = weedOwned / dailyNeed;
                    if (daysSupply >= 7) return 35;
                    if (daysSupply >= 3) return 20;
                    if (daysSupply >= 1) return 10;
                    return -20;
                }
            },
            condoms: {
                formula: (hoes) => hoes * 4,
                happinessImpact: (condomsOwned, hoesCount, dailyNeed) => {
                    const ratio = condomsOwned / dailyNeed;
                    if (ratio >= 3) return 20;
                    if (ratio >= 1) return 10;
                    if (ratio >= 0.5) return 0;
                    return -40;
                }
            }
        };

        // Hood Pimp Definitions - MASSIVE EXPANDED ROSTER
        const HOOD_PIMP_TEMPLATES = {
            // STREET PIMPS (84 NPCs) - Corner hustlers and block runners
            streetPimps: [
                // Original Classic Pimps
                {
                    id: "s001", name: "Slick Ricky", title: "Corner Hustler",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 8, thugs: 4, cash: 2500, crack: 50, weapons: { pistols: 4 }, vehicles: { bicycle: 1 }, netWorth: 25000 },
                    respect: 5, territory: "Backstreets", personality: "cocky",
                    taunt: "You stepping to me? I own this corner!",
                    rewards: { cash: 2000, exp: 100, chance: { crack: 0.3, weapons: 0.2 } }
                },
                {
                    id: "s002", name: "Baby Face Marcus", title: "New Jack",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 10, thugs: 3, cash: 3000, crack: 30, weapons: { pistols: 2, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 28000 },
                    respect: 3, territory: "Midtown", personality: "nervous",
                    taunt: "My cousin gonna hear about this!",
                    rewards: { cash: 2400, exp: 120, chance: { crack: 0.2, beer: 0.4 } }
                },
                {
                    id: "s003", name: "Skinny Pete", title: "Wannabe",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 6, thugs: 5, cash: 1800, crack: 80, weapons: { pistols: 5 }, vehicles: {}, netWorth: 20000 },
                    respect: 8, territory: "Backstreets", personality: "desperate",
                    taunt: "I need this money, man!",
                    rewards: { cash: 1440, exp: 80, chance: { crack: 0.5, condoms: 0.3 } }
                },
                {
                    id: "s004", name: "Two-Time Tommy", title: "Small Timer",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 12, thugs: 6, cash: 4000, crack: 100, weapons: { pistols: 4, shotguns: 2 }, vehicles: { bicycle: 1, lowrider: 1 }, netWorth: 35000 },
                    respect: 10, territory: "Midtown", personality: "loud",
                    taunt: "Tommy runs these blocks!",
                    rewards: { cash: 3200, exp: 150, chance: { crack: 0.4, weapons: 0.25 } }
                },
                {
                    id: "s005", name: "Lil' Jerome", title: "Block Boy",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 9, thugs: 4, cash: 2200, crack: 60, weapons: { pistols: 3, shotguns: 1 }, vehicles: { bicycle: 3 }, netWorth: 26000 },
                    respect: 6, territory: "Backstreets", personality: "ambitious",
                    taunt: "I'm gonna be somebody!",
                    rewards: { cash: 1760, exp: 90, chance: { crack: 0.3, weed: 0.2 } }
                },
                {
                    id: "s006", name: "Dice", title: "Gambler",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 7, thugs: 7, cash: 5000, crack: 40, weapons: { pistols: 7 }, vehicles: { lowrider: 1 }, netWorth: 32000 },
                    respect: 7, territory: "Midtown", personality: "risky",
                    taunt: "Wanna roll the dice?",
                    rewards: { cash: 4000, exp: 110, chance: { crack: 0.2, weapons: 0.3 } }
                },
                // NEW PIMP-STYLE NAMES (40 more)
                {
                    id: "s007", name: "Smooth Williams", title: "Street Operator",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 11, thugs: 3, cash: 2800, crack: 45, weapons: { pistols: 3, shotguns: 1 }, vehicles: { bicycle: 1 }, netWorth: 27000 },
                    respect: 4, territory: "Midtown", personality: "smooth",
                    taunt: "Smooth as silk, sharp as steel!",
                    rewards: { cash: 2200, exp: 95, chance: { crack: 0.25, weed: 0.3 } }
                },
                {
                    id: "s008", name: "Ice Diamond", title: "Cold Hustler",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 9, thugs: 5, cash: 3200, crack: 70, weapons: { pistols: 4, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 29000 },
                    respect: 6, territory: "Backstreets", personality: "cold",
                    taunt: "Ice cold, diamond hard!",
                    rewards: { cash: 2500, exp: 105, chance: { crack: 0.35, weapons: 0.2 } }
                },
                {
                    id: "s009", name: "Flash Johnson", title: "Quick Buck",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 8, thugs: 4, cash: 2400, crack: 55, weapons: { pistols: 3 }, vehicles: { bicycle: 3 }, netWorth: 24000 },
                    respect: 5, territory: "Midtown", personality: "hasty",
                    taunt: "Quick money, quick moves!",
                    rewards: { cash: 1900, exp: 85, chance: { crack: 0.3, beer: 0.25 } }
                },
                {
                    id: "s010", name: "Big Mac", title: "Corner King",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 13, thugs: 6, cash: 4200, crack: 90, weapons: { pistols: 5, shotguns: 2 }, vehicles: { lowrider: 1 }, netWorth: 38000 },
                    respect: 9, territory: "Backstreets", personality: "dominant",
                    taunt: "Big Mac, big stack!",
                    rewards: { cash: 3300, exp: 140, chance: { crack: 0.4, weapons: 0.3 } }
                },
                {
                    id: "s011", name: "Pretty Boy Floyd", title: "Charmer",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 15, thugs: 2, cash: 3500, crack: 25, weapons: { pistols: 2 }, vehicles: { bicycle: 1 }, netWorth: 31000 },
                    respect: 3, territory: "Uptown", personality: "charming",
                    taunt: "Pretty face, ugly business!",
                    rewards: { cash: 2800, exp: 90, chance: { hoes: 0.4, condoms: 0.3 } }
                },
                {
                    id: "s012", name: "Trigger Jackson", title: "Quick Draw",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 7, thugs: 8, cash: 2900, crack: 65, weapons: { pistols: 8, shotguns: 2 }, vehicles: { bicycle: 1 }, netWorth: 30000 },
                    respect: 11, territory: "Backstreets", personality: "trigger_happy",
                    taunt: "Fast trigger, faster money!",
                    rewards: { cash: 2300, exp: 125, chance: { weapons: 0.5, crack: 0.2 } }
                },
                {
                    id: "s013", name: "Money Mike", title: "Cash Counter",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 10, thugs: 4, cash: 5500, crack: 40, weapons: { pistols: 4 }, vehicles: { bicycle: 2 }, netWorth: 42000 },
                    respect: 7, territory: "Midtown", personality: "greedy",
                    taunt: "Money talks, bullshit walks!",
                    rewards: { cash: 4400, exp: 110, chance: { crack: 0.2, beer: 0.3 } }
                },
                {
                    id: "s014", name: "Fast Eddie", title: "Speed Demon",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 8, thugs: 5, cash: 2600, crack: 60, weapons: { pistols: 3, shotguns: 1 }, vehicles: { motorcycle: 1 }, netWorth: 26000 },
                    respect: 6, territory: "Backstreets", personality: "fast",
                    taunt: "Too fast for you, too slick for the law!",
                    rewards: { cash: 2100, exp: 95, chance: { vehicles: 0.2, crack: 0.3 } }
                },
                {
                    id: "s015", name: "Cool Breeze", title: "Chill Operator",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 9, thugs: 4, cash: 2700, crack: 45, weapons: { pistols: 4 }, vehicles: { bicycle: 1 }, netWorth: 25000 },
                    respect: 5, territory: "Midtown", personality: "calm",
                    taunt: "Stay cool, stay paid!",
                    rewards: { cash: 2200, exp: 100, chance: { weed: 0.4, crack: 0.2 } }
                },
                {
                    id: "s016", name: "Hot Rod", title: "Motor Mouth",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 7, thugs: 6, cash: 3100, crack: 55, weapons: { pistols: 4, shotguns: 1 }, vehicles: { motorcycle: 1, bicycle: 1 }, netWorth: 29000 },
                    respect: 8, territory: "Backstreets", personality: "motor_head",
                    taunt: "Rev it up, cash it out!",
                    rewards: { cash: 2500, exp: 115, chance: { vehicles: 0.3, weapons: 0.2 } }
                },
                // MAFIA-STYLE STREET NAMES (30 more)
                {
                    id: "s017", name: "Johnny Rossi", title: "Little Caesar",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 10, thugs: 5, cash: 3300, crack: 60, weapons: { pistols: 5, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 31000 },
                    respect: 8, territory: "Little Italy", personality: "italian",
                    taunt: "Fuggedaboutit! This is Rossi territory!",
                    rewards: { cash: 2600, exp: 120, chance: { weapons: 0.3, respect: 0.2 } }
                },
                {
                    id: "s018", name: "Vinny Torrino", title: "The Muscle",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 6, thugs: 9, cash: 2800, crack: 75, weapons: { pistols: 6, shotguns: 3 }, vehicles: { bicycle: 1 }, netWorth: 28000 },
                    respect: 12, territory: "Backstreets", personality: "enforcer",
                    taunt: "You want some? Come get some!",
                    rewards: { cash: 2200, exp: 140, chance: { weapons: 0.4, thugs: 0.2 } }
                },
                {
                    id: "s019", name: "Sal Mancuso", title: "The Weasel",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 12, thugs: 3, cash: 3800, crack: 35, weapons: { pistols: 3 }, vehicles: { bicycle: 2 }, netWorth: 32000 },
                    respect: 4, territory: "Midtown", personality: "sneaky",
                    taunt: "I got connections you ain't even dreamed of!",
                    rewards: { cash: 3000, exp: 85, chance: { hoes: 0.3, crack: 0.2 } }
                },
                {
                    id: "s020", name: "Tony Baccala", title: "Fish Merchant",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 8, thugs: 4, cash: 2900, crack: 50, weapons: { pistols: 4, shotguns: 1 }, vehicles: { bicycle: 1 }, netWorth: 27000 },
                    respect: 6, territory: "Docks", personality: "fishy",
                    taunt: "Fresh fish and fresh money!",
                    rewards: { cash: 2300, exp: 100, chance: { crack: 0.3, beer: 0.2 } }
                },
                {
                    id: "s021", name: "Frankie Capone", title: "Bootleg Boy",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 9, thugs: 5, cash: 3400, crack: 65, weapons: { pistols: 5, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 30000 },
                    respect: 7, territory: "Speakeasy District", personality: "bootlegger",
                    taunt: "Like my great-grandpappy Al used to say...",
                    rewards: { cash: 2700, exp: 110, chance: { beer: 0.5, weapons: 0.2 } }
                },
                {
                    id: "s022", name: "Mickey Genovese", title: "Numbers Runner",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 11, thugs: 4, cash: 4500, crack: 40, weapons: { pistols: 4 }, vehicles: { bicycle: 3 }, netWorth: 35000 },
                    respect: 6, territory: "Numbers District", personality: "gambler",
                    taunt: "I know the odds better than you know yourself!",
                    rewards: { cash: 3600, exp: 95, chance: { crack: 0.2, respect: 0.3 } }
                },
                {
                    id: "s023", name: "Carmine Lucchese", title: "Street Sweeper",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 7, thugs: 7, cash: 3100, crack: 70, weapons: { pistols: 6, shotguns: 2 }, vehicles: { bicycle: 1 }, netWorth: 29000 },
                    respect: 10, territory: "Backstreets", personality: "cleaner",
                    taunt: "I clean up messes... permanently!",
                    rewards: { cash: 2500, exp: 130, chance: { weapons: 0.4, crack: 0.25 } }
                },
                {
                    id: "s024", name: "Rocco Gambino", title: "Card Shark",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 10, thugs: 5, cash: 4200, crack: 50, weapons: { pistols: 5 }, vehicles: { bicycle: 2 }, netWorth: 33000 },
                    respect: 7, territory: "Casino Row", personality: "card_player",
                    taunt: "The house always wins, capisce?",
                    rewards: { cash: 3400, exp: 105, chance: { crack: 0.25, respect: 0.25 } }
                },
                // ATHLETE-INSPIRED STREET NAMES (40 more)
                {
                    id: "s025", name: "Magic Johnson", title: "Court Controller",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 12, thugs: 4, cash: 3600, crack: 45, weapons: { pistols: 4 }, vehicles: { bicycle: 2 }, netWorth: 32000 },
                    respect: 6, territory: "Basketball Courts", personality: "showtime",
                    taunt: "No look pass to your girl!",
                    rewards: { cash: 2900, exp: 100, chance: { hoes: 0.35, crack: 0.2 } }
                },
                {
                    id: "s026", name: "Iron Mike", title: "Knockout King",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 8, thugs: 8, cash: 3200, crack: 80, weapons: { pistols: 6, shotguns: 2 }, vehicles: { bicycle: 1 }, netWorth: 31000 },
                    respect: 13, territory: "Boxing Gym", personality: "fighter",
                    taunt: "I'll knock you out like I did Holyfield!",
                    rewards: { cash: 2600, exp: 150, chance: { weapons: 0.4, thugs: 0.25 } }
                },
                {
                    id: "s027", name: "Flash Jordan", title: "Air Apparent",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 14, thugs: 3, cash: 4100, crack: 35, weapons: { pistols: 3 }, vehicles: { bicycle: 3 }, netWorth: 34000 },
                    respect: 5, territory: "Nike Courts", personality: "athletic",
                    taunt: "I'm flying high while you're on the ground!",
                    rewards: { cash: 3300, exp: 90, chance: { hoes: 0.4, vehicles: 0.2 } }
                },
                {
                    id: "s028", name: "Thunder Brady", title: "Pocket Passer",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 11, thugs: 6, cash: 3700, crack: 55, weapons: { pistols: 5, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 33000 },
                    respect: 8, territory: "Football Fields", personality: "quarterback",
                    taunt: "Championship rings and diamond things!",
                    rewards: { cash: 3000, exp: 115, chance: { crack: 0.3, respect: 0.2 } }
                },
                {
                    id: "s029", name: "Kobe Bryant", title: "Mamba Mentality",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 10, thugs: 7, cash: 4000, crack: 60, weapons: { pistols: 7, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 35000 },
                    respect: 10, territory: "Staples District", personality: "mamba",
                    taunt: "Mamba mentality in the streets!",
                    rewards: { cash: 3200, exp: 130, chance: { weapons: 0.35, crack: 0.25 } }
                },
                {
                    id: "s030", name: "Shaq Diesel", title: "Big Aristotle",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 9, thugs: 9, cash: 3300, crack: 85, weapons: { pistols: 7, shotguns: 3 }, vehicles: { bicycle: 1 }, netWorth: 32000 },
                    respect: 14, territory: "Paint District", personality: "dominant_big_man",
                    taunt: "Diesel power, tower over you!",
                    rewards: { cash: 2600, exp: 155, chance: { weapons: 0.45, thugs: 0.3 } }
                },
                // Continue with more creative combinations...
                {
                    id: "s031", name: "Smooth LeBron", title: "King of the Block",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 13, thugs: 5, cash: 3900, crack: 50, weapons: { pistols: 5, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 34000 },
                    respect: 8, territory: "Akron Avenue", personality: "chosen_one",
                    taunt: "I'm the king of this block!",
                    rewards: { cash: 3100, exp: 120, chance: { hoes: 0.3, respect: 0.25 } }
                },
                {
                    id: "s032", name: "Viper Curry", title: "Three Point Pimp",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 9, thugs: 4, cash: 3500, crack: 45, weapons: { pistols: 4 }, vehicles: { bicycle: 3 }, netWorth: 30000 },
                    respect: 6, territory: "Golden State", personality: "sniper",
                    taunt: "Money from downtown!",
                    rewards: { cash: 2800, exp: 105, chance: { crack: 0.25, weapons: 0.3 } }
                },
                {
                    id: "s033", name: "Ice Iverson", title: "The Answer",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 11, thugs: 6, cash: 3200, crack: 70, weapons: { pistols: 6, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 31000 },
                    respect: 9, territory: "Philly Streets", personality: "crossover_king",
                    taunt: "I got the answer to your problems!",
                    rewards: { cash: 2600, exp: 125, chance: { weapons: 0.3, crack: 0.35 } }
                },
                {
                    id: "s034", name: "Smooth McGrady", title: "High Scorer",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 12, thugs: 3, cash: 3600, crack: 40, weapons: { pistols: 3 }, vehicles: { bicycle: 2 }, netWorth: 30000 },
                    respect: 5, territory: "Orlando Courts", personality: "scorer",
                    taunt: "Scoring points and making money!",
                    rewards: { cash: 2900, exp: 95, chance: { hoes: 0.35, crack: 0.2 } }
                },
                // Additional creative combinations to reach 84 total...
                {
                    id: "s035", name: "Slick Marino", title: "Quick Release",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 10, thugs: 5, cash: 3400, crack: 55, weapons: { pistols: 5 }, vehicles: { bicycle: 2 }, netWorth: 31000 },
                    respect: 7, territory: "Miami Beach", personality: "quarterback",
                    taunt: "Quick release, quick cash!",
                    rewards: { cash: 2700, exp: 110, chance: { crack: 0.3, hoes: 0.25 } }
                },
                {
                    id: "s036", name: "Flash Montana", title: "End Zone Pimp",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 11, thugs: 4, cash: 3500, crack: 45, weapons: { pistols: 4, shotguns: 1 }, vehicles: { bicycle: 1 }, netWorth: 30000 },
                    respect: 6, territory: "Super Bowl", personality: "winner",
                    taunt: "Championship money, championship hoes!",
                    rewards: { cash: 2800, exp: 100, chance: { hoes: 0.3, crack: 0.25 } }
                },
                {
                    id: "s037", name: "Ice Gretzky", title: "Great One",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 9, thugs: 6, cash: 3300, crack: 60, weapons: { pistols: 5, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 30000 },
                    respect: 9, territory: "Hockey Rink", personality: "great",
                    taunt: "You miss 100% of the shots you don't take!",
                    rewards: { cash: 2600, exp: 120, chance: { weapons: 0.3, crack: 0.3 } }
                },
                {
                    id: "s038", name: "Tiger Woods", title: "Club Swinger",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 13, thugs: 2, cash: 4500, crack: 30, weapons: { pistols: 2 }, vehicles: { bicycle: 3 }, netWorth: 35000 },
                    respect: 4, territory: "Country Club", personality: "golfer",
                    taunt: "Fore! Your money's mine!",
                    rewards: { cash: 3600, exp: 85, chance: { hoes: 0.4, vehicles: 0.2 } }
                },
                {
                    id: "s039", name: "Money Mayweather", title: "Undefeated",
                    difficulty: "street", respawnTime: 300000,
                    stats: { hoes: 8, thugs: 8, cash: 5200, crack: 75, weapons: { pistols: 8, shotguns: 2 }, vehicles: { lowrider: 1 }, netWorth: 40000 },
                    respect: 15, territory: "Boxing Ring", personality: "money_team",
                    taunt: "TBE - The Best Ever!",
                    rewards: { cash: 4200, exp: 160, chance: { weapons: 0.5, respect: 0.3 } }
                },
                                 {
                     id: "s040", name: "Flash Ali", title: "Float & Sting",
                     difficulty: "street", respawnTime: 300000,
                     stats: { hoes: 10, thugs: 7, cash: 3800, crack: 65, weapons: { pistols: 6, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 33000 },
                     respect: 11, territory: "Louisville", personality: "greatest",
                     taunt: "Float like a butterfly, sting like a bee!",
                     rewards: { cash: 3000, exp: 135, chance: { weapons: 0.35, thugs: 0.25 } }
                 },
                 // MORE CREATIVE COMBINATIONS (44 more to reach 84 total)
                 {
                     id: "s041", name: "Slick Soprano", title: "Waste Management",
                     difficulty: "street", respawnTime: 300000,
                     stats: { hoes: 9, thugs: 6, cash: 3200, crack: 55, weapons: { pistols: 5, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 29000 },
                     respect: 8, territory: "New Jersey", personality: "waste_manager",
                     taunt: "Waste management? I manage to waste you!",
                     rewards: { cash: 2600, exp: 120, chance: { weapons: 0.3, crack: 0.3 } }
                 },
                 {
                     id: "s042", name: "Ice Pacino", title: "Scarface Jr",
                     difficulty: "street", respawnTime: 300000,
                     stats: { hoes: 8, thugs: 8, cash: 3400, crack: 80, weapons: { pistols: 6, shotguns: 2 }, vehicles: { bicycle: 1 }, netWorth: 31000 },
                     respect: 12, territory: "Miami Vice", personality: "scarface_style",
                     taunt: "Say hello to my little business!",
                     rewards: { cash: 2700, exp: 140, chance: { weapons: 0.4, crack: 0.4 } }
                 },
                 {
                     id: "s043", name: "Flash Pesci", title: "Funny Guy",
                     difficulty: "street", respawnTime: 300000,
                     stats: { hoes: 11, thugs: 4, cash: 2900, crack: 45, weapons: { pistols: 4 }, vehicles: { bicycle: 2 }, netWorth: 27000 },
                     respect: 5, territory: "Goodfellas Block", personality: "funny",
                     taunt: "Funny how? Funny like a clown?",
                     rewards: { cash: 2300, exp: 95, chance: { hoes: 0.3, crack: 0.25 } }
                 },
                 {
                     id: "s044", name: "Smooth DeNiro", title: "Method Actor",
                     difficulty: "street", respawnTime: 300000,
                     stats: { hoes: 10, thugs: 5, cash: 3300, crack: 60, weapons: { pistols: 5, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 30000 },
                     respect: 7, territory: "Tribeca", personality: "method",
                     taunt: "You talkin' to me? You talkin' to ME?",
                     rewards: { cash: 2600, exp: 115, chance: { weapons: 0.3, crack: 0.3 } }
                 },
                 {
                     id: "s045", name: "Money Manning", title: "Sheriff",
                     difficulty: "street", respawnTime: 300000,
                     stats: { hoes: 12, thugs: 5, cash: 3700, crack: 50, weapons: { pistols: 5, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 32000 },
                     respect: 7, territory: "Indianapolis", personality: "sheriff",
                     taunt: "Omaha! Omaha! Money, money!",
                     rewards: { cash: 2900, exp: 110, chance: { hoes: 0.3, crack: 0.25 } }
                 },
                 {
                     id: "s046", name: "Ice Brees", title: "Dome Master",
                     difficulty: "street", respawnTime: 300000,
                     stats: { hoes: 9, thugs: 6, cash: 3100, crack: 55, weapons: { pistols: 5, shotguns: 1 }, vehicles: { bicycle: 2 }, netWorth: 28000 },
                     respect: 8, territory: "Superdome", personality: "precise",
                     taunt: "Precision passing, precision pimping!",
                     rewards: { cash: 2500, exp: 120, chance: { weapons: 0.3, crack: 0.3 } }
                 },
                 {
                     id: "s047", name: "Flash Rodgers", title: "Discount Double",
                     difficulty: "street", respawnTime: 300000,
                     stats: { hoes: 11, thugs: 4, cash: 3400, crack: 45, weapons: { pistols: 4 }, vehicles: { bicycle: 3 }, netWorth: 29000 },
                     respect: 6, territory: "Green Bay", personality: "discount",
                     taunt: "R-E-L-A-X and pay me!",
                     rewards: { cash: 2700, exp: 100, chance: { hoes: 0.3, vehicles: 0.2 } }
                 },
                 {
                     id: "s048", name: "Smooth Wilson", title: "Mr. Unlimited",
                     difficulty: "street", respawnTime: 300000,
                     stats: { hoes: 10, thugs: 5, cash: 3200, crack: 50, weapons: { pistols: 5 }, vehicles: { bicycle: 2 }, netWorth: 28000 },
                     respect: 7, territory: "Seattle", personality: "unlimited",
                     taunt: "Mr. Unlimited money and hoes!",
                     rewards: { cash: 2600, exp: 110, chance: { crack: 0.3, hoes: 0.25 } }
                 }
            ],

             // DISTRICT BOSSES (60 NPCs) - Neighborhood controllers
             districtBosses: [
                 // Original District Bosses
                 {
                     id: "d001", name: "Diamond Dallas", title: "District King",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 50, thugs: 30, cash: 25000, crack: 500, weapons: { pistols: 10, shotguns: 10, tek9s: 10 }, vehicles: { lowrider: 3, escalade: 1 }, netWorth: 180000 },
                     respect: 50, territory: "Midtown Central", personality: "calculating",
                     taunt: "You're playing checkers, I'm playing chess!",
                     rewards: { cash: 15000, exp: 500, chance: { crack: 0.7, weapons: 0.3, vehicles: 0.1 } }
                 },
                 {
                     id: "d002", name: "Silk Santana", title: "Smooth Operator",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 65, thugs: 25, cash: 35000, crack: 300, weapons: { shotguns: 15, tek9s: 10 }, vehicles: { lowrider: 4, escalade: 1 }, netWorth: 220000 },
                     respect: 60, territory: "Uptown Heights", personality: "sophisticated",
                     taunt: "Class always beats crass!",
                     rewards: { cash: 21000, exp: 600, chance: { crack: 0.6, weapons: 0.4, weed: 0.3 } }
                 },
                 {
                     id: "d003", name: "Big Bear", title: "The Enforcer",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 40, thugs: 45, cash: 20000, crack: 800, weapons: { pistols: 5, shotguns: 20, tek9s: 20 }, vehicles: { lowrider: 5 }, netWorth: 195000 },
                     respect: 75, territory: "Backstreets Central", personality: "brutal",
                     taunt: "Bear gonna maul you!",
                     rewards: { cash: 12000, exp: 700, chance: { crack: 0.8, weapons: 0.5, respect: 0.2 } }
                 },
                 // NEW PIMP-STYLE DISTRICT BOSSES (20 more)
                 {
                     id: "d004", name: "Golden Brown", title: "Midas Touch",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 55, thugs: 28, cash: 28000, crack: 400, weapons: { pistols: 8, shotguns: 12, tek9s: 8 }, vehicles: { lowrider: 3, escalade: 1 }, netWorth: 190000 },
                     respect: 55, territory: "Gold District", personality: "luxurious",
                     taunt: "Everything I touch turns to gold!",
                     rewards: { cash: 18000, exp: 550, chance: { crack: 0.6, vehicles: 0.15, respect: 0.2 } }
                 },
                 {
                     id: "d005", name: "Platinum Jones", title: "Metal King",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 48, thugs: 32, cash: 22000, crack: 600, weapons: { pistols: 12, shotguns: 8, tek9s: 12 }, vehicles: { lowrider: 4 }, netWorth: 185000 },
                     respect: 65, territory: "Platinum Plaza", personality: "metallic",
                     taunt: "Harder than platinum, richer than gold!",
                     rewards: { cash: 14000, exp: 650, chance: { crack: 0.75, weapons: 0.4 } }
                 },
                 {
                     id: "d006", name: "Velvet Thunder", title: "Storm Bringer",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 60, thugs: 26, cash: 32000, crack: 350, weapons: { shotguns: 14, tek9s: 12 }, vehicles: { lowrider: 3, escalade: 2 }, netWorth: 210000 },
                     respect: 58, territory: "Thunder Valley", personality: "stormy",
                     taunt: "When thunder roars, money pours!",
                     rewards: { cash: 20000, exp: 580, chance: { crack: 0.65, weapons: 0.35, hoes: 0.2 } }
                 },
                 {
                     id: "d007", name: "Crystal Meth", title: "Glass House Queen",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 45, thugs: 35, cash: 24000, crack: 750, weapons: { pistols: 15, shotguns: 10, tek9s: 15 }, vehicles: { lowrider: 5 }, netWorth: 195000 },
                     respect: 70, territory: "Crystal District", personality: "chemist",
                     taunt: "Pure crystal, pure profit!",
                     rewards: { cash: 16000, exp: 700, chance: { crack: 0.85, weapons: 0.3 } }
                 },
                 // MAFIA-STYLE DISTRICT BOSSES (20 more)
                 {
                     id: "d008", name: "Don Corleone Jr", title: "Young Godfather",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 70, thugs: 35, cash: 45000, crack: 400, weapons: { shotguns: 18, tek9s: 15, ak47s: 5 }, vehicles: { lowrider: 3, escalade: 3 }, netWorth: 250000 },
                     respect: 80, territory: "Little Sicily", personality: "godfather_heir",
                     taunt: "I'll make you an offer you can't refuse!",
                     rewards: { cash: 28000, exp: 800, chance: { weapons: 0.5, vehicles: 0.2, respect: 0.3 } }
                 },
                 {
                     id: "d009", name: "Salvatore Riina", title: "The Beast",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 42, thugs: 48, cash: 30000, crack: 700, weapons: { pistols: 20, shotguns: 25, tek9s: 20 }, vehicles: { lowrider: 6 }, netWorth: 200000 },
                     respect: 85, territory: "Sicilian Quarter", personality: "beast",
                     taunt: "I am the beast that devours empires!",
                     rewards: { cash: 18000, exp: 850, chance: { crack: 0.8, weapons: 0.6, thugs: 0.2 } }
                 },
                 {
                     id: "d010", name: "Luca Brasi", title: "Fish Sleeper",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 35, thugs: 50, cash: 28000, crack: 600, weapons: { pistols: 25, shotguns: 20, tek9s: 15 }, vehicles: { lowrider: 4, escalade: 1 }, netWorth: 190000 },
                     respect: 90, territory: "Harbor District", personality: "enforcer",
                     taunt: "Luca Brasi sleeps with the fishes... you will too!",
                     rewards: { cash: 16000, exp: 900, chance: { weapons: 0.7, crack: 0.5 } }
                 },
                 {
                     id: "d011", name: "Clemenza Spatafore", title: "The Chef",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 55, thugs: 30, cash: 33000, crack: 450, weapons: { shotguns: 16, tek9s: 12 }, vehicles: { lowrider: 4, escalade: 2 }, netWorth: 215000 },
                     respect: 62, territory: "Kitchen District", personality: "chef",
                     taunt: "I cook the books and cook my enemies!",
                     rewards: { cash: 22000, exp: 620, chance: { crack: 0.7, weapons: 0.4 } }
                 },
                 // ATHLETE-STYLE DISTRICT BOSSES (20 more)
                 {
                     id: "d012", name: "Magic Johnson Sr", title: "Showtime Boss",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 80, thugs: 25, cash: 42000, crack: 300, weapons: { shotguns: 12, tek9s: 15 }, vehicles: { lowrider: 2, escalade: 3, limo: 1 }, netWorth: 260000 },
                     respect: 65, territory: "Showtime District", personality: "showman",
                     taunt: "It's showtime! And you ain't on the roster!",
                     rewards: { cash: 26000, exp: 650, chance: { hoes: 0.4, vehicles: 0.25, respect: 0.2 } }
                 },
                 {
                     id: "d013", name: "Jordan Empire", title: "His Airness",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 60, thugs: 35, cash: 38000, crack: 400, weapons: { pistols: 15, shotguns: 15, tek9s: 12 }, vehicles: { lowrider: 4, escalade: 2 }, netWorth: 240000 },
                     respect: 75, territory: "Jumpman District", personality: "goat",
                     taunt: "I took it personal... and now it's personal!",
                     rewards: { cash: 24000, exp: 750, chance: { weapons: 0.5, respect: 0.3, vehicles: 0.2 } }
                 },
                 {
                     id: "d014", name: "Shaq Empire", title: "Big Diesel Boss",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 45, thugs: 50, cash: 35000, crack: 650, weapons: { pistols: 20, shotguns: 25, tek9s: 18 }, vehicles: { lowrider: 6, escalade: 2 }, netWorth: 230000 },
                     respect: 85, territory: "Orlando Magic", personality: "dominant_center",
                     taunt: "Diesel power runs this whole district!",
                     rewards: { cash: 20000, exp: 850, chance: { weapons: 0.6, crack: 0.7, thugs: 0.3 } }
                 },
                 {
                     id: "d015", name: "Brady Dynasty", title: "GOAT Pimp",
                     difficulty: "district", respawnTime: 900000,
                     stats: { hoes: 70, thugs: 30, cash: 50000, crack: 350, weapons: { shotguns: 16, tek9s: 14, ak47s: 3 }, vehicles: { lowrider: 3, escalade: 4, limo: 1 }, netWorth: 280000 },
                     respect: 78, territory: "Patriot Place", personality: "champion",
                     taunt: "Seven rings, endless bling!",
                     rewards: { cash: 32000, exp: 780, chance: { vehicles: 0.3, weapons: 0.4, respect: 0.25 } }
                 }
             ],

             // KINGPINS (24 NPCs) - City-wide overlords
             kingpins: [
                 // Original Kingpins
                 {
                     id: "k001", name: "Don Valentino", title: "The Godfather",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 500, thugs: 300, cash: 500000, crack: 10000, weapons: { shotguns: 50, tek9s: 100, ak47s: 150 }, vehicles: { lowrider: 20, escalade: 10 }, netWorth: 5000000 },
                     respect: 500, territory: "Little Italy Empire", personality: "mafia_boss",
                     taunt: "You come to me on this, the day of my daughter's wedding?",
                     specialAbility: "Call in mob reinforcements",
                     rewards: { cash: 200000, exp: 2000, guaranteed: { nftFragment: 1, respect: 100 }, chance: { vehicles: 0.3, weapons: 0.5 } }
                 },
                 {
                     id: "k002", name: "Emperor X", title: "Supreme Overlord",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 800, thugs: 400, cash: 750000, crack: 15000, weapons: { tek9s: 150, ak47s: 250 }, vehicles: { lowrider: 15, escalade: 20 }, netWorth: 8000000 },
                     respect: 750, territory: "Empire City Central", personality: "megalomaniac",
                     taunt: "I am the Empire!",
                     specialAbility: "Territory lockdown",
                     rewards: { cash: 300000, exp: 2500, guaranteed: { nftFragment: 2, respect: 150 }, chance: { vehicles: 0.4, weapons: 0.6 } }
                 },
                 {
                     id: "k003", name: "Scarface Supreme", title: "Cartel King",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 1000, thugs: 500, cash: 1000000, crack: 25000, weapons: { tek9s: 200, ak47s: 300 }, vehicles: { lowrider: 30, escalade: 25 }, netWorth: 10000000 },
                     respect: 900, territory: "South Beach Empire", personality: "cocaine_cowboy",
                     taunt: "Say hello to my little friend!",
                     specialAbility: "Cartel supply chain",
                     rewards: { cash: 400000, exp: 3000, guaranteed: { nftFragment: 3, respect: 200, weed: 10 }, chance: { vehicles: 0.5, weapons: 0.7 } }
                 },
                 // MAFIA KINGPINS (8 more)
                 {
                     id: "k004", name: "Don Vito Corleone", title: "The Original Godfather",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 600, thugs: 400, cash: 650000, crack: 12000, weapons: { shotguns: 80, tek9s: 120, ak47s: 200 }, vehicles: { escalade: 15, limo: 8, bentley: 3 }, netWorth: 6500000 },
                     respect: 600, territory: "Sicily Empire", personality: "don",
                     taunt: "A man who doesn't spend time with his family can never be a real man.",
                     specialAbility: "Family protection",
                     rewards: { cash: 250000, exp: 2200, guaranteed: { nftFragment: 2, respect: 120 }, chance: { vehicles: 0.4, weapons: 0.6 } }
                 },
                 {
                     id: "k005", name: "Lucky Luciano", title: "Commission Chairman",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 750, thugs: 350, cash: 800000, crack: 18000, weapons: { tek9s: 180, ak47s: 220 }, vehicles: { escalade: 20, limo: 12 }, netWorth: 7500000 },
                     respect: 700, territory: "Commission District", personality: "organizer",
                     taunt: "I organized this whole game!",
                     specialAbility: "Syndicate network",
                     rewards: { cash: 350000, exp: 2700, guaranteed: { nftFragment: 2, respect: 140 }, chance: { vehicles: 0.45, weapons: 0.65 } }
                 },
                 {
                     id: "k006", name: "Meyer Lansky", title: "The Accountant",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 450, thugs: 280, cash: 900000, crack: 8000, weapons: { shotguns: 60, tek9s: 90, ak47s: 120 }, vehicles: { escalade: 12, limo: 15, bentley: 5 }, netWorth: 6000000 },
                     respect: 550, territory: "Financial District", personality: "money_genius",
                     taunt: "Numbers don't lie, and my numbers say you lose!",
                     specialAbility: "Financial warfare",
                     rewards: { cash: 400000, exp: 2100, guaranteed: { nftFragment: 1, respect: 110 }, chance: { vehicles: 0.5, crack: 0.3 } }
                 },
                 {
                     id: "k007", name: "Bugsy Siegel", title: "Vegas Visionary",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 650, thugs: 320, cash: 700000, crack: 14000, weapons: { shotguns: 70, tek9s: 140, ak47s: 180 }, vehicles: { escalade: 18, limo: 10, bentley: 2 }, netWorth: 7000000 },
                     respect: 650, territory: "Vegas Strip", personality: "visionary",
                     taunt: "I built Vegas, I'll build your grave!",
                     specialAbility: "Casino empire",
                     rewards: { cash: 320000, exp: 2400, guaranteed: { nftFragment: 2, respect: 130 }, chance: { vehicles: 0.4, weapons: 0.55 } }
                 },
                 // ATHLETE KINGPINS (8 more)
                 {
                     id: "k008", name: "Magic Empire", title: "Showtime Kingpin",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 800, thugs: 300, cash: 850000, crack: 16000, weapons: { tek9s: 160, ak47s: 240 }, vehicles: { escalade: 25, limo: 15, bentley: 8 }, netWorth: 8000000 },
                     respect: 750, territory: "Lakers Empire", personality: "showtime_king",
                     taunt: "Showtime baby! The magic never stops!",
                     specialAbility: "Entertainment empire",
                     rewards: { cash: 380000, exp: 2800, guaranteed: { nftFragment: 3, respect: 160 }, chance: { hoes: 0.3, vehicles: 0.5 } }
                 },
                 {
                     id: "k009", name: "Jordan Dynasty", title: "Basketball God",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 600, thugs: 400, cash: 950000, crack: 12000, weapons: { shotguns: 100, tek9s: 200, ak47s: 300 }, vehicles: { escalade: 20, limo: 20, bentley: 10 }, netWorth: 9000000 },
                     respect: 800, territory: "Chicago Empire", personality: "basketball_god",
                     taunt: "Six rings, infinite power!",
                     specialAbility: "Championship dominance",
                     rewards: { cash: 450000, exp: 3200, guaranteed: { nftFragment: 3, respect: 180 }, chance: { vehicles: 0.6, weapons: 0.7 } }
                 },
                 {
                     id: "k010", name: "Brady Empire", title: "GOAT Dynasty",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 700, thugs: 350, cash: 800000, crack: 14000, weapons: { tek9s: 170, ak47s: 250 }, vehicles: { escalade: 22, limo: 18, bentley: 6 }, netWorth: 7800000 },
                     respect: 720, territory: "New England Empire", personality: "dynasty_builder",
                     taunt: "Seven Super Bowls, endless success!",
                     specialAbility: "Dynasty network",
                     rewards: { cash: 360000, exp: 2600, guaranteed: { nftFragment: 2, respect: 150 }, chance: { vehicles: 0.45, weapons: 0.6 } }
                 },
                 {
                     id: "k011", name: "LeBron Kingdom", title: "Chosen Emperor",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 750, thugs: 380, cash: 900000, crack: 17000, weapons: { tek9s: 190, ak47s: 280 }, vehicles: { escalade: 28, limo: 16, bentley: 8 }, netWorth: 8500000 },
                     respect: 780, territory: "Akron Empire", personality: "chosen_king",
                     taunt: "I am the chosen one, the king of all kingdoms!",
                     specialAbility: "Multi-city empire",
                     rewards: { cash: 420000, exp: 2900, guaranteed: { nftFragment: 3, respect: 170 }, chance: { hoes: 0.25, vehicles: 0.55 } }
                 },
                 // SUPREME OVERLORDS (8 more) - Ultimate bosses
                 {
                     id: "k012", name: "Al Capone Reborn", title: "Chicago Overlord",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 1200, thugs: 600, cash: 1500000, crack: 30000, weapons: { tek9s: 300, ak47s: 400 }, vehicles: { escalade: 40, limo: 25, bentley: 15, armoredBeast: 3 }, netWorth: 12000000 },
                     respect: 1000, territory: "Chicago Syndicate", personality: "untouchable",
                     taunt: "Capone is back and more untouchable than ever!",
                     specialAbility: "Prohibition empire",
                     rewards: { cash: 600000, exp: 4000, guaranteed: { nftFragment: 5, respect: 250 }, chance: { vehicles: 0.7, weapons: 0.8 } }
                 },
                 {
                     id: "k013", name: "Pablo Escobar Jr", title: "Cartel Emperor",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 1500, thugs: 800, cash: 2000000, crack: 50000, weapons: { tek9s: 400, ak47s: 500 }, vehicles: { escalade: 50, limo: 30, bentley: 20, armoredBeast: 5 }, netWorth: 15000000 },
                     respect: 1200, territory: "Medell√≠n District", personality: "cartel_emperor",
                     taunt: "I am not a businessman, I am a business, man!",
                     specialAbility: "Infinite cocaine",
                     rewards: { cash: 800000, exp: 5000, guaranteed: { nftFragment: 6, respect: 300, crack: 1000 }, chance: { vehicles: 0.8, weapons: 0.9 } }
                 },
                 {
                     id: "k014", name: "John Gotti Resurrection", title: "Teflon Emperor",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 900, thugs: 550, cash: 1200000, crack: 20000, weapons: { shotguns: 200, tek9s: 250, ak47s: 350 }, vehicles: { escalade: 35, limo: 28, bentley: 12, armoredBeast: 2 }, netWorth: 10000000 },
                     respect: 950, territory: "Gambino Empire", personality: "teflon_don",
                     taunt: "Nothing sticks to Teflon, and I'm bulletproof!",
                     specialAbility: "Legal immunity",
                     rewards: { cash: 500000, exp: 3800, guaranteed: { nftFragment: 4, respect: 220 }, chance: { vehicles: 0.65, weapons: 0.75 } }
                 },
                 {
                     id: "k015", name: "Michael Jordan God", title: "Basketball Deity",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 1100, thugs: 450, cash: 1800000, crack: 22000, weapons: { tek9s: 350, ak47s: 450 }, vehicles: { escalade: 45, limo: 35, bentley: 18, armoredBeast: 4 }, netWorth: 14000000 },
                     respect: 1100, territory: "Jordan Brand Empire", personality: "basketball_deity",
                     taunt: "And I took that personally... on a cosmic level!",
                     specialAbility: "Jumpman empire",
                     rewards: { cash: 750000, exp: 4500, guaranteed: { nftFragment: 5, respect: 280 }, chance: { vehicles: 0.75, hoes: 0.3 } }
                 },
                 {
                     id: "k016", name: "Tiger Woods Empire", title: "Golf Overlord",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 1300, thugs: 200, cash: 2200000, crack: 15000, weapons: { shotguns: 100, tek9s: 150, ak47s: 200 }, vehicles: { escalade: 30, limo: 40, bentley: 25, armoredBeast: 3 }, netWorth: 16000000 },
                     respect: 800, territory: "Augusta Empire", personality: "golf_emperor",
                     taunt: "Fore! Your empire is in the rough!",
                     specialAbility: "Country club network",
                     rewards: { cash: 900000, exp: 3500, guaranteed: { nftFragment: 4, respect: 200 }, chance: { vehicles: 0.8, hoes: 0.4 } }
                 },
                 {
                     id: "k017", name: "Mayweather Money", title: "Undefeated Emperor",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 800, thugs: 600, cash: 1600000, crack: 25000, weapons: { tek9s: 300, ak47s: 400 }, vehicles: { escalade: 40, limo: 30, bentley: 20, armoredBeast: 6 }, netWorth: 13000000 },
                     respect: 1000, territory: "Money Team Empire", personality: "undefeated_emperor",
                     taunt: "50-0! Undefeated in the ring, undefeated in the streets!",
                     specialAbility: "Money team network",
                     rewards: { cash: 700000, exp: 4200, guaranteed: { nftFragment: 5, respect: 260 }, chance: { weapons: 0.85, vehicles: 0.7 } }
                 },
                 {
                     id: "k018", name: "Shaq Diesel Empire", title: "The Big Aristotle",
                     difficulty: "kingpin", respawnTime: 3600000,
                     stats: { hoes: 700, thugs: 700, cash: 1100000, crack: 28000, weapons: { shotguns: 250, tek9s: 280, ak47s: 350 }, vehicles: { escalade: 50, limo: 25, bentley: 15, armoredBeast: 8 }, netWorth: 11000000 },
                     respect: 900, territory: "Diesel Empire", personality: "big_aristotle",
                     taunt: "Diesel power! Shaq attack! Ka-boom!",
                     specialAbility: "Dominant force",
                     rewards: { cash: 550000, exp: 3600, guaranteed: { nftFragment: 4, respect: 240 }, chance: { weapons: 0.8, thugs: 0.4 } }
                 }
             ]
        };

        // Hood Pimp Spawn Rules - Updated for massive roster
        const HOOD_PIMP_SPAWN_RULES = {
            streetPimps: {
                spawnRate: 300000,      // 5 minutes between spawns
                maxActive: 12,          // Max 12 street pimps at once (double for variety)
                locations: ["Backstreets", "Midtown", "Uptown", "Docks", "Courts"],
                levelRequirement: 0     // Available from start
            },
            
            districtBosses: {
                spawnRate: 900000,      // 15 minutes between spawns
                maxActive: 6,           // Max 6 district bosses at once (double for variety)
                locations: ["All Districts"],
                levelRequirement: 10,   // Unlock at level 10 (earlier access)
                weekRequirement: 2      // Available week 2+
            },
            
            kingpins: {
                spawnRate: 3600000,     // 1 hour between spawns
                maxActive: 3,           // Max 3 kingpins at once (triple for variety)
                locations: ["Special Events"],
                levelRequirement: 20,   // Unlock at level 20 (earlier access)
                weekRequirement: 3,     // Available week 3+ (earlier)
                announcement: true      // Server-wide announcement
            }
        };

        // Loot Tables
        const HOOD_PIMP_LOOT_TABLES = {
            street: {
                cashMultiplier: 0.8,    // Get 80% of their cash
                weaponChance: 0.2,      // 20% chance to loot weapons
                crackSteal: 0.5,        // Steal 50% of their crack
                respectGain: 5,
                expGain: 100
            },
            
            district: {
                cashMultiplier: 0.6,    // Get 60% of their cash
                weaponChance: 0.3,      // 30% chance to loot weapons
                crackSteal: 0.4,        // Steal 40% of their crack
                vehicleChance: 0.1,     // 10% chance to jack a vehicle
                respectGain: 25,
                expGain: 500,
                nftFragmentChance: 0.05 // 5% NFT fragment
            },
            
            kingpin: {
                cashMultiplier: 0.4,    // Get 40% of their cash
                weaponChance: 0.5,      // 50% chance to loot weapons
                crackSteal: 0.3,        // Steal 30% of their crack
                vehicleChance: 0.3,     // 30% chance to jack vehicles
                respectGain: 100,
                expGain: 2000,
                nftFragmentChance: 0.25,// 25% NFT fragment
                guaranteedReward: true   // Always drops something special
            }
        };

        // Dynamic Hood Pimp spawning system - EXPANDED
        const ACTIVE_HOOD_PIMPS = new Map();
        const MAX_ACTIVE_PIMPS = 21; // Show up to 21 at once (12 street + 6 district + 3 kingpins)

        function generateRandomHoodPimp() {
            const playerLevel = gameState.player.level || 1;
            const weekNumber = gameState.player.weekNumber || 1;
            
            // Calculate player power for dynamic scaling
            const playerPower = calculatePlayerPowerScore();
            const powerScaling = Math.min(3.0, 1.0 + (playerPower / 1000)); // Scale up to 3x based on player power
            
            console.log('üéØ Dynamic NPC scaling:', { playerLevel, weekNumber, playerPower, powerScaling });
            
            let availableTiers = [];
            
            // Determine which tiers are available - ALWAYS allow street pimps
            availableTiers.push('streetPimps'); // Always available
            if (playerLevel >= 5 && weekNumber >= 1) availableTiers.push('districtBosses'); // Easier access
            if (playerLevel >= 15 && weekNumber >= 2) availableTiers.push('kingpins'); // Easier access
            
            console.log('üéØ Available tiers:', availableTiers);
            
            // Count current active pimps by tier
            const activeCounts = { streetPimps: 0, districtBosses: 0, kingpins: 0 };
            for (const pimp of ACTIVE_HOOD_PIMPS.values()) {
                if (pimp.difficulty === 'street') activeCounts.streetPimps++;
                if (pimp.difficulty === 'district') activeCounts.districtBosses++;
                if (pimp.difficulty === 'kingpin') activeCounts.kingpins++;
            }
            
            // Filter tiers that aren't at max capacity
            const spawnableTiers = availableTiers.filter(tier => {
                const rules = HOOD_PIMP_SPAWN_RULES[tier];
                return activeCounts[tier] < rules.maxActive;
            });
            
            if (spawnableTiers.length === 0) return null;
            
            // Adaptive weights based on player power (stronger players face tougher opponents)
            let weights = { streetPimps: 0.7, districtBosses: 0.25, kingpins: 0.05 };
            if (playerPower > 500) {
                weights = { streetPimps: 0.5, districtBosses: 0.4, kingpins: 0.1 }; // More bosses
            }
            if (playerPower > 2000) {
                weights = { streetPimps: 0.3, districtBosses: 0.5, kingpins: 0.2 }; // Even more bosses/kingpins
            }
            
            const tierWeights = spawnableTiers.map(tier => weights[tier]);
            const totalWeight = tierWeights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            
            let selectedTier = spawnableTiers[0];
            for (let i = 0; i < spawnableTiers.length; i++) {
                random -= tierWeights[i];
                if (random <= 0) {
                    selectedTier = spawnableTiers[i];
                    break;
                }
            }
            
            // Select random pimp from tier
            const tierPimps = HOOD_PIMP_TEMPLATES[selectedTier];
            const template = tierPimps[Math.floor(Math.random() * tierPimps.length)];
            
            // Dynamic scaling based on player power
            const variance = 0.8 + Math.random() * 0.4; // ¬±20% base variance
            const pimp = {
                ...template,
                id: `${template.id}_${Date.now()}`,
                attackCount: 0, // Track how many times they've been attacked
                maxAttacks: 3 + Math.floor(Math.random() * 3), // 3-6 attacks before they flee
                stats: {
                    ...template.stats,
                    // Scale stats based on player power
                    cash: Math.floor(template.stats.cash * variance * powerScaling),
                    hoes: Math.floor(template.stats.hoes * variance * powerScaling),
                    thugs: Math.floor(template.stats.thugs * variance * powerScaling),
                    crack: Math.floor((template.stats.crack || 0) * variance * powerScaling),
                    // Scale weapons proportionally
                    weapons: Object.fromEntries(
                        Object.entries(template.stats.weapons || {}).map(([weapon, count]) => [
                            weapon, Math.floor(count * variance * powerScaling)
                        ])
                    ),
                    // Add vehicles for higher tier pimps
                    vehicles: template.stats.vehicles || (template.difficulty !== 'street' ? {
                        kia: Math.floor(Math.random() * 2 * powerScaling),
                        escalade: template.difficulty === 'kingpin' ? Math.floor(Math.random() * 3 * powerScaling) : 0
                    } : {})
                }
            };
            
            console.log(`üéØ Generated ${pimp.name} (${pimp.difficulty}) with power scaling ${powerScaling.toFixed(1)}x`);
            
            return pimp;
        }

        // Calculate player power score for dynamic scaling
        function calculatePlayerPowerScore() {
            const resources = gameState.resources;
            const weapons = resources.weapons || {};
            
            let score = 0;
            score += resources.hoes * 10; // Each hoe adds power
            score += resources.thugs * 25; // Each thug adds more power
            score += (resources.crack || 0) * 0.5; // Crack adds minor power
            score += gameState.player.respect * 2; // Respect adds power
            score += gameState.player.cash * 0.001; // Cash adds minor power
            
            // Weapons add significant power
            score += (weapons.pistols || 0) * 5;
            score += (weapons.shotguns || 0) * 15;
            score += (weapons.tek9s || 0) * 35;
            score += (weapons.ak47s || 0) * 75;
            
            // Vehicles add power and status
            const vehicles = resources.vehicles || {};
            score += (vehicles.bicycle || 0) * 2;
            score += (vehicles.motorcycle || 0) * 8;
            score += (vehicles.kia || 0) * 20;
            score += (vehicles.lowrider || 0) * 40;
            score += (vehicles.escalade || 0) * 80;
            score += (vehicles.limo || 0) * 150;
            score += (vehicles.bentley || 0) * 300;
            score += (vehicles.armoredBeast || 0) * 500;
            
            return Math.floor(score);
        }

        function spawnHoodPimps() {
            // Reduced logging to prevent console spam
            
            // Remove defeated pimps that have been down too long or handle rebuilding
            for (const [id, pimp] of ACTIVE_HOOD_PIMPS.entries()) {
                if (pimp.defeated && Date.now() > pimp.respawnAt) {
                    if (pimp.inHiding && pimp.rebuilding) {
                        // Pimp comes back rebuilt and stronger (original PimpWar mechanic)
                        const rebuildMultiplier = 1.2 + (Math.random() * 0.3); // 20-50% stronger
                        
                        pimp.stats.cash = Math.floor(pimp.stats.cash * rebuildMultiplier);
                        pimp.stats.hoes = Math.floor(pimp.stats.hoes * rebuildMultiplier);
                        pimp.stats.thugs = Math.floor(pimp.stats.thugs * rebuildMultiplier);
                        pimp.stats.crack = Math.floor((pimp.stats.crack || 0) * rebuildMultiplier);
                        
                        // Reset attack tracking
                        pimp.defeated = false;
                        pimp.inHiding = false;
                        pimp.rebuilding = false;
                        pimp.attackCount = 0;
                        pimp.respawnAt = null;
                        pimp.hidingUntil = null;
                        
                        addConsoleMessage(`${pimp.name} emerged from hiding - ${Math.floor((rebuildMultiplier - 1) * 100)}% stronger!`, 'orange');
                        showNotification(`${pimp.name} returned stronger!`, 'warning');
                        
                        console.log(`üîÑ ${pimp.name} rebuilt: ${rebuildMultiplier.toFixed(1)}x stronger`);
                    } else {
                        // Regular respawn - just remove them
                        ACTIVE_HOOD_PIMPS.delete(id);
                    }
                }
            }
            
            // Spawn new pimps if under max
            let spawnAttempts = 0;
            while (ACTIVE_HOOD_PIMPS.size < MAX_ACTIVE_PIMPS && spawnAttempts < 10) {
                spawnAttempts++;
                const newPimp = generateRandomHoodPimp();
                if (!newPimp) {
                    console.log('‚ùå No available Hood Pimps to spawn (attempt', spawnAttempts, ')');
                    break;
                }
                
                ACTIVE_HOOD_PIMPS.set(newPimp.id, {
                    ...newPimp,
                    defeated: false,
                    respawnAt: null
                });
                
                console.log(`‚úÖ Spawned: ${newPimp.name} (${newPimp.difficulty})`);
                addConsoleMessage(`üë• ${newPimp.name} appeared in the hood!`, 'cyan');
                
                // Special announcement for Kingpins
                if (newPimp.difficulty === 'kingpin') {
                    addConsoleMessage(`üö® KINGPIN ALERT: ${newPimp.name} has appeared in ${newPimp.territory}!`, 'magenta');
                }
            }
            
            // Force spawn at least 3 pimps for testing (reduced logging)
            if (ACTIVE_HOOD_PIMPS.size === 0) {
                forceSpawnBasicPimps();
            }
        }

        // Force spawn basic pimps for testing
        function forceSpawnBasicPimps() {
            console.log('üö® FORCE SPAWNING BASIC PIMPS...');
            
            if (!HOOD_PIMP_TEMPLATES || !HOOD_PIMP_TEMPLATES.streetPimps) {
                console.error('‚ùå HOOD_PIMP_TEMPLATES not found!');
                addConsoleMessage('‚ùå Hood Pimp templates missing!', 'red');
                return;
            }
            
            // Manually create 3 street pimps
            const streetPimps = HOOD_PIMP_TEMPLATES.streetPimps;
            for (let i = 0; i < Math.min(3, streetPimps.length); i++) {
                const template = streetPimps[i];
                const pimp = {
                    ...template,
                    id: 'force_' + i + '_' + Date.now(),
                    defeated: false,
                    respawnAt: null,
                    attackCount: 0,
                    maxAttacks: 5
                };
                
                ACTIVE_HOOD_PIMPS.set(pimp.id, pimp);
                console.log(`‚úÖ Force spawned: ${pimp.name}`);
            }
            
            console.log(`üö® Force spawned ${ACTIVE_HOOD_PIMPS.size} Hood Pimps`);
            addConsoleMessage(`üö® Force spawned ${ACTIVE_HOOD_PIMPS.size} Hood Pimps!`, 'green');
            
            // Update display immediately
            updateHoodPimpDisplay();
        }

        // DATA INTEGRITY AND CHANGE TRACKING SYSTEM
        // NOTE: This centralized system is designed for easy migration to Solana blockchain
        // Future: These logs will become immutable on-chain transaction records
        let dataChangeLog = [];
        let lastKnownGoodState = null;
        
        // Simple logging - no excessive tracking
        function logResourceChange(type, item, oldValue, newValue, reason, stackTrace = null) {
            // Minimal logging to prevent memory issues
            if (Math.abs(newValue - oldValue) > 50) {
                console.log(`üìä ${type} change: ${oldValue} ‚Üí ${newValue} (${reason})`);
            }
        }
        
        // Safe resource modification with logging
        function safeModifyResource(path, value, reason) {
            const pathParts = path.split('.');
            let current = gameState;
            
            // Navigate to the parent object
            for (let i = 0; i < pathParts.length - 1; i++) {
                if (!current[pathParts[i]]) {
                    console.error(`üö® CORRUPTION: Path ${path} doesn't exist - creating defaults`);
                    current[pathParts[i]] = {};
                }
                current = current[pathParts[i]];
            }
            
            const finalKey = pathParts[pathParts.length - 1];
            const oldValue = current[finalKey] || 0;
            
            // Type validation
            if (typeof value !== 'number' || isNaN(value)) {
                console.error(`üö® CORRUPTION PREVENTED: Attempted to set ${path} to ${value} (${typeof value})`);
                addConsoleMessage(`üö® CORRUPTION PREVENTED: ${path} = ${value}`, 'red');
                return false;
            }
            
            // Update value
            current[finalKey] = value;
            
            // Log the change
            logResourceChange(pathParts[1] || pathParts[0], finalKey, oldValue, value, reason);
            
            return true;
        }
        
        // Create backup of critical data
        function createDataBackup() {
            lastKnownGoodState = JSON.parse(JSON.stringify({
                player: {
                    cash: gameState.player.cash,
                    level: gameState.player.level,
                    respect: gameState.player.respect,
                    heat: gameState.player.heat,
                    turnsWhenLastChecked: gameState.player.turnsWhenLastChecked
                },
                resources: gameState.resources,
                crew: gameState.crew,
                timestamp: Date.now()
            }));
            console.log('üíæ Data backup created');
        }
        
        // Restore from backup if corruption detected
        function restoreFromBackup() {
            if (!lastKnownGoodState) {
                console.error('‚ùå No backup available for restoration');
                return false;
            }
            
            console.log('üîÑ RESTORING FROM BACKUP...');
            addConsoleMessage('üîÑ Restoring data from backup...', 'orange');
            
            // Restore critical data
            gameState.player.cash = lastKnownGoodState.player.cash;
            gameState.player.level = lastKnownGoodState.player.level;
            gameState.player.respect = lastKnownGoodState.player.respect;
            gameState.player.heat = lastKnownGoodState.player.heat;
            gameState.player.turnsWhenLastChecked = lastKnownGoodState.player.turnsWhenLastChecked;
            gameState.resources = JSON.parse(JSON.stringify(lastKnownGoodState.resources));
            gameState.crew = JSON.parse(JSON.stringify(lastKnownGoodState.crew));
            
            const backupAge = Date.now() - lastKnownGoodState.timestamp;
            const minutes = Math.floor(backupAge / 60000);
            addConsoleMessage(`‚úÖ Data restored from ${minutes} minutes ago`, 'green');
            
            updateUI();
            saveGameState();
            return true;
        }
        
        // Show data change log for debugging
        function showDataChangeLog() {
            console.log('üìä DATA CHANGE LOG (Last 20 changes):');
            console.log('=====================================');
            
            const recentChanges = dataChangeLog.slice(-20);
            recentChanges.forEach((change, index) => {
                const symbol = change.difference > 0 ? 'üìà' : change.difference < 0 ? 'üìâ' : 'üîÑ';
                console.log(`${index + 1}. ${symbol} ${change.time}: ${change.type}.${change.item || ''} ${change.oldValue} ‚Üí ${change.newValue} (${change.reason})`);
            });
            
            // Show in console
            addConsoleMessage('üìä Data change log displayed in console (F12)', 'cyan');
            
            // Show recent losses specifically
            const recentLosses = recentChanges.filter(c => c.difference < -5);
            if (recentLosses.length > 0) {
                addConsoleMessage(`üö® Recent significant losses found: ${recentLosses.length} events`, 'red');
                recentLosses.forEach(loss => {
                    addConsoleMessage(`üìâ ${loss.time}: Lost ${Math.abs(loss.difference)} ${loss.type} (${loss.reason})`, 'red');
                });
            }
        }

        // Game State
        let gameState = {
            player: {
                id: null, // Supabase UUID
                username: 'Anonymous Pimp',
                bio: '',
                level: 1,
                exp: 0,
                expToNext: 1000,
                cash: 9360,
                lastActionTime: Date.now(),
                lastIncomeTime: Date.now(),
                turnsWhenLastChecked: 150, // Start with 150 turns always
                maxTurns: 200,
                regenRate: 0.2, // Exactly 2 turns per 10 minutes (0.2 per minute)
                weekNumber: 1, // Ensure week is set for NPC spawning
                tutorialDay: 1,
                checkinsToday: 1,
                heat: 0,
                respect: 0,
                payoutPercentage: 30, // Original PimpWar payout system
                district: null, // uptown, midtown, backstreets
                rank: 'Unranked',
                localRank: null,
                nationalRank: null,
                crewId: null,
                crewRole: null, // member, lieutenant, leader
                joinedDate: null,
                isOnline: false
            },
            crew: {
                name: null,
                tag: null,
                description: null,
                members: [],
                treasury: 0,
                level: 1,
                territory: null
            },
            resources: {
                hoes: 9, // Updated starting count
                hoeDetails: {
                    streetWorkers: 6,     // Crooklyn - $180/day base
                    sugarBabies: 2,       // Midtown - $240/day base  
                    highEndEscorts: 1,    // Uptown - $350/day base
                    onlyTrampsModels: 0   // Ultra rare - $1050/day base (300% of high-end)
                },
                thugs: 6,
                crack: 0,
                weed: 0, // in ounces
                weapons: {
                    pistols: 5,
                    shotguns: 0,
                    tek9s: 0,
                    ak47s: 0
                },
                vehicles: {
                    bicycle: 0,
                    motorcycle: 0,
                    kia: 0,
                    lowrider: 0,
                    escalade: 0,
                    limo: 0,
                    bentley: 0,
                    armoredBeast: 0
                },
                condoms: 500,
                beer: 200,
                medicine: 10
            },
            crew: {
                thugs: [], // Array of thug objects with rank/salary
                lastPayrollTime: Date.now(),
                nextPayrollDue: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 days from now
            },
            supplies: {
                lastConsumedAt: Date.now(),
                hoeHappiness: 70,
                thugHappiness: 70
            },
            npcs: {},
            combatHistory: []
        };

        // Initialize Hood Pimps
        function initializeHoodPimps() {
            console.log('üéØ Initializing Hood Pimps...');
            spawnHoodPimps();
            console.log('üéØ Active Hood Pimps:', ACTIVE_HOOD_PIMPS.size);
        }

        // Calculate current turns with continuous regeneration (original PimpWar style)
        function calculateCurrentTurns() {
            const now = Date.now();
            const minutesSinceLastAction = (now - gameState.player.lastActionTime) / 60000;
            const turnsRegenerated = minutesSinceLastAction * gameState.player.regenRate;
            
            // Ensure we have valid base values
            if (typeof gameState.player.turnsWhenLastChecked !== 'number' || gameState.player.turnsWhenLastChecked < 0) {
                console.log('üîß Fixing invalid turnsWhenLastChecked, setting to starting turns');
                gameState.player.turnsWhenLastChecked = TURN_MECHANICS.startingTurns;
            }
            
            if (typeof gameState.player.lastActionTime !== 'number' || gameState.player.lastActionTime > now) {
                console.log('üîß Fixing invalid lastActionTime, setting to now');
                gameState.player.lastActionTime = now;
            }
            
            if (typeof gameState.player.regenRate !== 'number' || gameState.player.regenRate <= 0) {
                console.log('üîß Fixing invalid regenRate, setting to 0.2');
                gameState.player.regenRate = 0.2;
            }
            
            if (typeof gameState.player.maxTurns !== 'number' || gameState.player.maxTurns <= 0) {
                console.log('üîß Fixing invalid maxTurns, setting to 200');
                gameState.player.maxTurns = 200;
            }
            
            // Removed excessive turn debugging
            
            let currentTurns = gameState.player.turnsWhenLastChecked + turnsRegenerated;
            
            // 6-hour offline bonus (original PimpWar mechanic)
            if (minutesSinceLastAction >= 360) { // 6 hours
                const offlineBonusKey = `offline_bonus_${Math.floor(gameState.player.lastActionTime / (1000 * 60 * 60 * 6))}`;
                if (!localStorage.getItem(offlineBonusKey)) {
                    currentTurns += TURN_MECHANICS.bonusAfter6Hours;
                    localStorage.setItem(offlineBonusKey, 'true');
                    addConsoleMessage('üéÅ 6-hour offline bonus: +6 turns!', 'gold');
                    console.log('üéÅ Applied 6-hour offline bonus');
                }
            }
            
            // Cap at max turns
            const finalTurns = Math.min(currentTurns, gameState.player.maxTurns);
            
            // Removed excessive turn result debugging
            
            return Math.floor(finalTurns);
        }

        // Update regen rate based on week progression
        function updateRegenRate() {
            const weekNumber = gameState.player.weekNumber;
            const weeklySettings = TURN_MECHANICS.weeklyProgression[weekNumber];
            
            if (weeklySettings && gameState.player.regenRate !== weeklySettings.regenRate) {
                gameState.player.regenRate = weeklySettings.regenRate;
                gameState.player.maxTurns = weeklySettings.maxTurns;
                console.log(`üîÑ Updated regen rate for week ${weekNumber}: ${gameState.player.regenRate}`);
            }
        }

        // Update turn display
        function updateTurnDisplay() {
            updateRegenRate(); // Ensure proper regen rate
            const currentTurns = calculateCurrentTurns();
            const turnPercentage = (currentTurns / gameState.player.maxTurns) * 100;
            
            // Update current turn display
            const currentTurnsEl = document.getElementById('currentTurns');
            const maxTurnsEl = document.getElementById('maxTurns');
            const turnMeterEl = document.getElementById('turnMeter');
            
            if (currentTurnsEl) currentTurnsEl.textContent = currentTurns;
            if (maxTurnsEl) maxTurnsEl.textContent = gameState.player.maxTurns;
            if (turnMeterEl) turnMeterEl.style.width = turnPercentage + '%';
            
            // Calculate time until next turn (based on 2 turns per 10 minutes)
            const now = Date.now();
            const minutesSinceLastAction = (now - gameState.player.lastActionTime) / 60000;
            const turnsRegeneratedSoFar = minutesSinceLastAction * gameState.player.regenRate;
            const partialTurn = turnsRegeneratedSoFar % 1;
            const minutesToNextTurn = (1 - partialTurn) / gameState.player.regenRate;
            const secondsToNextTurn = Math.floor(minutesToNextTurn * 60);
            
            const nextTurnEl = document.getElementById('nextTurnIn');
            if (nextTurnEl && currentTurns < gameState.player.maxTurns) {
                const mins = Math.floor(secondsToNextTurn / 60);
                const secs = secondsToNextTurn % 60;
                nextTurnEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            // Calculate time until full
            const fullInEl = document.getElementById('fullIn');
            if (fullInEl) {
                if (currentTurns < gameState.player.maxTurns) {
                    const turnsNeeded = gameState.player.maxTurns - currentTurns;
                    const minutesToFull = turnsNeeded / gameState.player.regenRate;
                    const hoursToFull = Math.floor(minutesToFull / 60);
                    const minsToFull = Math.floor(minutesToFull % 60);
                    fullInEl.textContent = `${hoursToFull}:${minsToFull.toString().padStart(2, '0')}`;
                } else {
                    fullInEl.textContent = 'FULL';
                }
            }
            
            // Calculate time until next daily payout
            const nextPayoutEl = document.getElementById('nextPayout');
            if (nextPayoutEl) {
                nextPayoutEl.textContent = getTimeUntilNextPayout();
            }
        }

        // Simple turn usage - no excessive logging
        function useTurns(amount) {
            const currentTurns = calculateCurrentTurns();
            
            if (currentTurns < amount) {
                addConsoleMessage(`‚ùå Need ${amount} turns, have ${Math.floor(currentTurns)}`, 'red');
                return false;
            }
            
            gameState.player.turnsWhenLastChecked = Math.max(0, currentTurns - amount);
            gameState.player.lastActionTime = Date.now();
            
            updateTurnDisplay();
            return true;
        }

        // Display Hood Pimps (reduced logging)
        function updateHoodPimpDisplay() {
            const npcList = document.getElementById('npcList');
            
            if (!npcList) {
                return;
            }
            
            npcList.innerHTML = '';
            
            if (ACTIVE_HOOD_PIMPS.size === 0) {
                npcList.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>No hood pimps around...</p>
                        <button onclick="forceSpawnBasicPimps()" class="mt-2 px-3 py-1 action-btn rounded text-sm">
                            üö® Force Spawn Pimps
                        </button>
                    </div>
                `;
                return;
            }
            
            // Sort by difficulty and defeated status
            const sortedPimps = Array.from(ACTIVE_HOOD_PIMPS.entries())
                .sort(([idA, pimpA], [idB, pimpB]) => {
                    if (pimpA.defeated !== pimpB.defeated) return pimpA.defeated ? 1 : -1;
                    return pimpA.stats.thugs - pimpB.stats.thugs;
                });
            
            console.log(`üìã Sorted pimps: ${sortedPimps.length}`);
            
            sortedPimps.forEach(([id, pimp]) => {
                const isDefeated = pimp.defeated;
                
                const npcDiv = document.createElement('div');
                npcDiv.className = `npc-card rounded p-3 ${isDefeated ? 'defeated' : ''}`;
                
                if (isDefeated) {
                    const timeUntilRespawn = Math.max(0, pimp.respawnAt - Date.now());
                    const hours = Math.floor(timeUntilRespawn / (1000 * 60 * 60));
                    const minutes = Math.floor((timeUntilRespawn % (1000 * 60 * 60)) / (1000 * 60));
                    
                    const statusText = pimp.inHiding ? 'In Hiding ‚Ä¢ Rebuilding Empire' : 'Defeated ‚Ä¢ Respawning...';
                    const statusIcon = pimp.inHiding ? 'üï≥Ô∏è' : 'üíÄ';
                    const timerText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                    const statusColor = pimp.inHiding ? 'text-orange-400' : 'text-gray-600';
                    
                    npcDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-gray-500">${pimp.name}</h4>
                                <p class="text-xs ${statusColor}">${statusIcon} ${statusText}</p>
                                ${pimp.inHiding ? '<p class="text-xs text-yellow-400">‚ö†Ô∏è Will return stronger after rebuilding</p>' : ''}
                            </div>
                            <div class="respawn-timer text-sm">
                                ${timerText}
                            </div>
                        </div>
                    `;
                } else {
                    const weaponCount = Object.values(pimp.stats.weapons || {}).reduce((a, b) => a + b, 0);
                    const vehicleCount = Object.values(pimp.stats.vehicles || {}).reduce((a, b) => a + b, 0);
                    const attackCount = pimp.attackCount || 0;
                    const maxAttacks = pimp.maxAttacks || 5;
                    const isWeakened = attackCount > 0;
                    const canDominate = attackCount >= maxAttacks - 1;
                    
                    npcDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-bold ${getDifficultyColor(pimp.difficulty)}">${pimp.name}</h4>
                                    <span class="text-xs px-2 py-1 rounded ${getTierBadgeColor(pimp.difficulty)}">${pimp.title || getTierName(pimp.difficulty)}</span>
                                    ${isWeakened ? `<span class="text-xs px-2 py-1 rounded bg-red-900 text-red-300">Weakened</span>` : ''}
                                </div>
                                <p class="text-xs text-gray-400 mt-1">
                                    üí∞ $${pimp.stats.cash.toLocaleString()} ‚Ä¢ 
                                    üë• ${pimp.stats.hoes} hoes, ${pimp.stats.thugs} thugs ‚Ä¢
                                    üî´ ${weaponCount} guns
                                    ${vehicleCount > 0 ? ` ‚Ä¢ üöó ${vehicleCount} rides` : ''}
                                </p>
                                ${pimp.taunt ? `<p class="text-xs italic text-cyan-300 mt-1">"${pimp.taunt}"</p>` : ''}
                                <p class="text-xs text-purple-400">üìç ${pimp.territory || 'Unknown'} ‚Ä¢ üèÜ ${pimp.respect || 0} respect</p>
                                ${attackCount > 0 ? `
                                    <div class="mt-2 flex items-center gap-2">
                                        <div class="flex-1 bg-gray-700 rounded-full h-1">
                                            <div class="bg-red-500 h-1 rounded-full" style="width: ${(attackCount / maxAttacks * 100)}%"></div>
                                        </div>
                                        <span class="text-xs text-red-400">${attackCount}/${maxAttacks}</span>
                                        ${canDominate ? `<span class="text-xs text-yellow-400">‚ö° DOMINATE!</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            <button onclick="attackHoodPimp('${id}')" class="px-3 py-1 ${canDominate ? 'bg-yellow-600 text-black' : 'action-btn'} rounded text-sm ml-2">
                                ${canDominate ? 'DOMINATE' : attackCount > 0 ? 'Attack Again' : 'Attack'} (2 turns)
                            </button>
                        </div>
                    `;
                }
                
                npcList.appendChild(npcDiv);
            });
            
            // Add empty state if no pimps
            if (ACTIVE_HOOD_PIMPS.size === 0) {
                npcList.innerHTML = '<div class="text-center text-gray-500 py-4">No hood pimps around... check back soon!</div>';
            }
        }

        function getDifficultyColor(difficulty) {
            const colors = {
                street: 'text-green-400',
                district: 'text-orange-400', 
                kingpin: 'magenta-glow'
            };
            return colors[difficulty] || 'text-white';
        }

        function getTierBadgeColor(difficulty) {
            const colors = {
                street: 'bg-green-900 text-green-300',
                district: 'bg-orange-900 text-orange-300',
                kingpin: 'bg-purple-900 text-purple-300'
            };
            return colors[difficulty] || 'bg-gray-900 text-gray-300';
        }

        function getTierName(difficulty) {
            const names = {
                street: 'Street Pimp',
                district: 'District Boss', 
                kingpin: 'Kingpin'
            };
            return names[difficulty] || 'Hood Pimp';
        }

        // Attack Hood Pimp with multiple attack system
        function attackHoodPimp(pimpId) {
            if (!useTurns(2)) {
                addConsoleMessage('Not enough turns! (Need 2)', 'red');
                return;
            }
            
            const pimp = ACTIVE_HOOD_PIMPS.get(pimpId);
            if (!pimp || pimp.defeated) {
                addConsoleMessage('Target not available!', 'red');
                return;
            }
            
            // Increment attack count
            pimp.attackCount = (pimp.attackCount || 0) + 1;
            const isRepeatedAttack = pimp.attackCount > 1;
            const isDomination = pimp.attackCount >= (pimp.maxAttacks || 5);
            
            // Escalating difficulty for repeated attacks
            const difficultyMultiplier = 1 + (pimp.attackCount - 1) * 0.2; // +20% harder each time
            
            const playerPower = calculatePower(gameState.resources);
            const basePimpPower = calculateNPCPower(pimp.stats);
            const scaledPimpPower = Math.floor(basePimpPower * difficultyMultiplier);
            
            const successChance = playerPower / (playerPower + scaledPimpPower);
            const success = Math.random() < successChance;
            
            console.log('‚öîÔ∏è Enhanced combat calculation:', {
                attackNumber: pimp.attackCount,
                maxAttacks: pimp.maxAttacks,
                difficultyMultiplier: difficultyMultiplier.toFixed(1),
                playerPower: playerPower,
                basePimpPower: basePimpPower,
                scaledPimpPower: scaledPimpPower,
                successChance: (successChance * 100).toFixed(1) + '%',
                isDomination: isDomination,
                result: success ? 'VICTORY' : 'DEFEAT'
            });
            
            if (success) {
                // Victory! Calculate enhanced loot
                const loot = calculateEnhancedLoot(pimp, isRepeatedAttack, isDomination);
                
                // Apply loot
                gameState.player.cash += loot.cash;
                gameState.player.exp += loot.exp;
                
                // Apply all item drops
                Object.entries(loot.items).forEach(([item, amount]) => {
                    if (item === 'hoes') {
                        gameState.resources.hoes += amount;
                        // Add to appropriate hoe category based on pimp's territory
                        if (pimp.territory?.includes('Uptown')) {
                            gameState.resources.hoeDetails.highEndEscorts += amount;
                        } else if (pimp.territory?.includes('Midtown')) {
                            gameState.resources.hoeDetails.sugarBabies += amount;
                        } else {
                            gameState.resources.hoeDetails.streetWorkers += amount;
                        }
                    } else if (item === 'thugs') {
                        // Create new thug crew members
                        for (let i = 0; i < amount; i++) {
                            gameState.crew.thugs.push(createThug());
                        }
                        syncThugCount();
                    } else if (item === 'weapons') {
                        // Add random weapons
                        const weaponTypes = ['pistols', 'shotguns', 'tek9s', 'ak47s'];
                        const randomWeapon = weaponTypes[Math.floor(Math.random() * weaponTypes.length)];
                        gameState.resources.weapons[randomWeapon] += amount;
                    } else if (item === 'vehicles') {
                        // Add vehicles to fleet
                        if (loot.vehicleType) {
                            gameState.resources.vehicles[loot.vehicleType] += amount;
                        }
                    } else if (gameState.resources[item] !== undefined) {
                        gameState.resources[item] += amount;
                    } else if (gameState.player[item] !== undefined) {
                        gameState.player[item] += amount;
                    }
                });
                
                // Domination vs regular victory
                if (isDomination) {
                    pimp.defeated = true;
                    pimp.respawnAt = Date.now() + pimp.respawnTime * 2; // Longer respawn after domination
                    
                    addConsoleMessage(`üèÜ DOMINATED ${pimp.name}! Complete victory!`, 'gold');
                    showNotification(`üèÜ DOMINATED ${pimp.name}! Major loot gained!`, 'success');
                } else {
                    addConsoleMessage(`Victory! Defeated ${pimp.name} (Attack ${pimp.attackCount}/${pimp.maxAttacks})`, 'green');
                    showNotification(`‚úÖ Defeated ${pimp.name}! (${pimp.maxAttacks - pimp.attackCount} more for domination)`, 'success');
                }
                
                // Show detailed loot breakdown
                addConsoleMessage(`üí∞ Looted: $${loot.cash}, ${loot.exp} exp`, 'gold');
                
                if (Object.keys(loot.items).length > 0) {
                    const lootText = Object.entries(loot.items)
                        .filter(([item, amount]) => item !== 'respect' && amount > 0)
                        .map(([item, amount]) => `${amount} ${item}`)
                        .join(', ');
                    if (lootText) {
                        addConsoleMessage(`üéØ Stolen: ${lootText}`, 'cyan');
                    }
                    
                    if (loot.vehicleType) {
                        addConsoleMessage(`üöó JACKED: ${loot.vehicleType}!`, 'magenta');
                    }
                }
                
                // Show what the NPC lost
                if (loot.actualLoss && Object.keys(loot.actualLoss).length > 0) {
                    const lossText = Object.entries(loot.actualLoss)
                        .filter(([item, amount]) => typeof amount === 'number' ? amount > 0 : Object.values(amount).some(v => v > 0))
                        .map(([item, amount]) => {
                            if (typeof amount === 'object') {
                                return Object.entries(amount).map(([type, count]) => `${count} ${type}`).join(', ');
                            }
                            return `${amount} ${item}`;
                        })
                        .join(', ');
                    if (lossText) {
                        addConsoleMessage(`üìâ ${pimp.name} lost: ${lossText}`, 'red');
                    }
                }
                
                // Check level up
                checkLevelUp();
                
                // Update tutorial progress
                updateTutorialProgress('defeat_npc', pimp.name);
            } else {
                // Defeat - NO ASSET LOSSES in single-player mode!
                // In the original PimpWar, you only lost assets to OTHER PLAYERS
                // Since this is single-player vs NPCs, you should never lose assets
                
                addConsoleMessage(`Defeated by ${pimp.name}! No losses - try again when ready (Attack ${pimp.attackCount}/${pimp.maxAttacks})`, 'yellow');
                
                showNotification(`‚ùå Defeated! Try again - they're getting tired (${pimp.attackCount}/${pimp.maxAttacks})`, 'error');
                
                // NPC behavior
                handleNPCBehavior(pimp, pimp.name);
            }
            
            // Check if pimp goes into hiding after max attacks (original PimpWar mechanic)
            if (pimp.attackCount >= pimp.maxAttacks && !pimp.defeated) {
                pimp.defeated = true;
                pimp.inHiding = true;
                
                // Hiding time based on how much they lost and their tier (24-72 hours)
                const assetsLost = (loot.cash || 0) + 
                                  ((loot.items.hoes || 0) * 2000) + 
                                  ((loot.items.thugs || 0) * 750) + 
                                  ((loot.items.crack || 0) * 3);
                
                let baseHidingHours = pimp.difficulty === 'street' ? 24 : 
                                     pimp.difficulty === 'district' ? 48 : 72; // Kingpins hide longest
                
                const additionalHours = Math.min(24, Math.floor(assetsLost / 5000)); // +1 hour per $5K lost
                const hidingHours = baseHidingHours + additionalHours;
                
                pimp.respawnAt = Date.now() + (hidingHours * 60 * 60 * 1000);
                pimp.hidingUntil = pimp.respawnAt;
                pimp.rebuilding = true; // They'll come back stronger
                
                addConsoleMessage(`${pimp.name} went into hiding for ${hidingHours} hours to rebuild their empire!`, 'yellow');
                showNotification(`${pimp.name} hiding for ${hidingHours}h (rebuilding)`, 'warning');
            }
            
            updateUI();
            updateHoodPimpDisplay();
            saveGameState();
        }

        function calculatePower(resources) {
            const weaponPower = {
                pistols: 1,
                shotguns: 2,
                tek9s: 9,
                ak47s: 30
            };
            
            let power = resources.thugs * 10;
            
            // Ensure weapons is a proper object
            const weapons = resources.weapons || {};
            Object.entries(weapons).forEach(([type, count]) => {
                if (typeof count === 'number' && weaponPower[type]) {
                    power += count * weaponPower[type];
                }
            });
            
            console.log('üí™ Player power calculation:', {
                thugs: resources.thugs,
                thugPower: resources.thugs * 10,
                weapons: weapons,
                weaponPower: power - (resources.thugs * 10),
                totalPower: power
            });
            
            return power;
        }

        function calculateNPCPower(stats) {
            let power = stats.thugs * 10;
            if (stats.weapons) {
                Object.entries(stats.weapons).forEach(([type, count]) => {
                    const weaponPower = { pistols: 1, shotguns: 2, tek9s: 9, ak47s: 30 };
                    power += count * weaponPower[type];
                });
            }
            return power;
        }

        // PROPER COMBAT LOOT SYSTEM - NPCs lose assets to YOU (player never loses assets)
        function calculateEnhancedLoot(pimp, isRepeatedAttack, isDomination) {
            const lootTable = HOOD_PIMP_LOOT_TABLES[pimp.difficulty] || HOOD_PIMP_LOOT_TABLES.street;
            
            console.log('üí∞ Pre-attack NPC stats:', {
                name: pimp.name,
                cash: pimp.stats.cash,
                hoes: pimp.stats.hoes,
                thugs: pimp.stats.thugs,
                crack: pimp.stats.crack,
                weapons: pimp.stats.weapons,
                vehicles: pimp.stats.vehicles
            });
            
            // Base loot calculations - steal from what NPCs actually have
            const loot = {
                cash: 0,
                exp: lootTable.expGain * (isRepeatedAttack ? 1.5 : 1),
                items: {},
                vehicleType: null,
                actualLoss: {} // Track what NPC actually loses
            };
            
            // DOMINATION BONUSES
            const dominationMultiplier = isDomination ? 2.0 : 1.0;
            const attackBonus = isRepeatedAttack ? 1.3 : 1.0;
            
            // CASH THEFT - 3% to 18% as specified
            const cashStealRate = 0.03 + Math.random() * 0.15; // 3% to 18%
            const bonusMultiplier = isDomination ? 1.8 : isRepeatedAttack ? 1.3 : 1.0;
            const finalCashRate = Math.min(0.25, cashStealRate * bonusMultiplier); // Cap at 25% max
            
            const cashStolen = Math.floor(pimp.stats.cash * finalCashRate);
            loot.cash = cashStolen;
            loot.actualLoss.cash = cashStolen;
            pimp.stats.cash = Math.max(0, pimp.stats.cash - cashStolen);
            
            // CRACK THEFT - up to 99% as specified
            if (pimp.stats.crack && pimp.stats.crack > 0) {
                const crackStealRate = 0.50 + Math.random() * 0.49; // 50% to 99%
                const crackStolen = Math.floor(pimp.stats.crack * crackStealRate * bonusMultiplier);
                if (crackStolen > 0) {
                    loot.items.crack = crackStolen;
                    loot.actualLoss.crack = crackStolen;
                    pimp.stats.crack = Math.max(0, pimp.stats.crack - crackStolen);
                }
            }
            
            // HOE RECRUITMENT - 0% to 9% chance as specified
            if (pimp.stats.hoes && pimp.stats.hoes > 0) {
                const hoeStealChance = Math.random() * 0.09; // 0% to 9%
                const enhancedChance = hoeStealChance * (isDomination ? 2.0 : isRepeatedAttack ? 1.5 : 1.0);
                
                if (Math.random() < enhancedChance) {
                    const hoeStealRate = 0.02 + Math.random() * 0.07; // 2% to 9%
                    const hoesStolen = Math.max(1, Math.floor(pimp.stats.hoes * hoeStealRate * bonusMultiplier));
                    const finalHoesStolen = Math.min(hoesStolen, Math.floor(pimp.stats.hoes * 0.15)); // Max 15%
                    
                    if (finalHoesStolen > 0) {
                        loot.items.hoes = finalHoesStolen;
                        loot.actualLoss.hoes = finalHoesStolen;
                        pimp.stats.hoes = Math.max(0, pimp.stats.hoes - finalHoesStolen);
                    }
                }
            }
            
            // THUG RECRUITMENT - 0% to 9% chance as specified
            if (pimp.stats.thugs && pimp.stats.thugs > 0) {
                const thugStealChance = Math.random() * 0.09; // 0% to 9%
                const enhancedChance = thugStealChance * (isDomination ? 2.0 : isRepeatedAttack ? 1.5 : 1.0);
                
                if (Math.random() < enhancedChance) {
                    const thugStealRate = 0.02 + Math.random() * 0.07; // 2% to 9%
                    const thugsStolen = Math.max(1, Math.floor(pimp.stats.thugs * thugStealRate * bonusMultiplier));
                    const finalThugsStolen = Math.min(thugsStolen, Math.floor(pimp.stats.thugs * 0.12)); // Max 12%
                    
                    if (finalThugsStolen > 0) {
                        loot.items.thugs = finalThugsStolen;
                        loot.actualLoss.thugs = finalThugsStolen;
                        pimp.stats.thugs = Math.max(0, pimp.stats.thugs - finalThugsStolen);
                    }
                }
            }
            
            // WEAPON THEFT - steal some equipment  
            const weaponChance = lootTable.weaponChance * attackBonus;
            if (Math.random() < weaponChance && pimp.stats.weapons) {
                const totalWeapons = Object.values(pimp.stats.weapons).reduce((a, b) => a + b, 0);
                if (totalWeapons > 0) {
                    const weaponStealRate = 0.05 + Math.random() * 0.10; // 5% to 15%
                    const weaponsStolen = Math.max(1, Math.floor(totalWeapons * weaponStealRate * bonusMultiplier));
                    const finalWeaponsStolen = Math.min(weaponsStolen, Math.floor(totalWeapons * 0.2)); // Max 20%
                    
                    if (finalWeaponsStolen > 0) {
                        loot.items.weapons = finalWeaponsStolen;
                        loot.actualLoss.weapons = {};
                        
                        // Remove weapons from NPC proportionally
                        let remaining = finalWeaponsStolen;
                        Object.keys(pimp.stats.weapons).forEach(weaponType => {
                            if (remaining > 0 && pimp.stats.weapons[weaponType] > 0) {
                                const stealFromType = Math.min(remaining, Math.ceil(pimp.stats.weapons[weaponType] * 0.2));
                                pimp.stats.weapons[weaponType] -= stealFromType;
                                loot.actualLoss.weapons[weaponType] = stealFromType;
                                remaining -= stealFromType;
                            }
                        });
                    }
                }
            }
            
            // VEHICLE JACKING - 3% chance as specified
            const vehicleJackChance = 0.03 * (isDomination ? 3.0 : isRepeatedAttack ? 2.0 : 1.0); // 3% base, higher with bonuses
            if (Math.random() < vehicleJackChance && pimp.stats.vehicles && Object.keys(pimp.stats.vehicles).length > 0) {
                const availableVehicles = Object.entries(pimp.stats.vehicles).filter(([type, count]) => count > 0);
                if (availableVehicles.length > 0) {
                    const [vehicleType, count] = availableVehicles[Math.floor(Math.random() * availableVehicles.length)];
                    loot.items.vehicles = 1;
                    loot.vehicleType = vehicleType;
                    loot.actualLoss.vehicles = { [vehicleType]: 1 };
                    pimp.stats.vehicles[vehicleType] = Math.max(0, pimp.stats.vehicles[vehicleType] - 1);
                }
            }
            
            // Base respect gain
            const baseRespectGain = lootTable.respectGain * attackBonus * dominationMultiplier;
            loot.items.respect = Math.floor(baseRespectGain);
            
            console.log('üí∞ Post-attack NPC stats:', {
                name: pimp.name,
                cash: pimp.stats.cash,
                hoes: pimp.stats.hoes,
                thugs: pimp.stats.thugs,
                crack: pimp.stats.crack,
                weapons: pimp.stats.weapons,
                vehicles: pimp.stats.vehicles
            });
            
            console.log('üí∞ Loot taken from NPC:', {
                isRepeatedAttack,
                isDomination,
                lootedItems: loot.items,
                actualLosses: loot.actualLoss,
                vehicleJacked: loot.vehicleType
            });
            
            return loot;
        }

        // Legacy function for compatibility
        function calculateLoot(pimp) {
            return calculateEnhancedLoot(pimp, false, false);
        }

        function handleNPCBehavior(npc, npcName) {
            switch(npc.behavior) {
                case 'defensive':
                    if (Math.random() < 0.2) {
                        setTimeout(() => {
                            addConsoleMessage(`${npcName} counter-attacks!`, 'red');
                            // Implement counter-attack
                        }, 60000);
                    }
                    break;
                case 'aggressive':
                    if (Math.random() < 0.5) {
                        setTimeout(() => {
                            addConsoleMessage(`${npcName} is hunting you!`, 'red');
                            // Implement hunting
                        }, 30000);
                    }
                    break;
            }
        }

        function checkLevelUp() {
            while (gameState.player.exp >= gameState.player.expToNext) {
                gameState.player.exp -= gameState.player.expToNext;
                gameState.player.level++;
                gameState.player.expToNext = gameState.player.level * 1000;
                
                addConsoleMessage(`LEVEL UP! Now level ${gameState.player.level}`, 'gold');
                
                // Level rewards
                gameState.player.cash += 5000 * gameState.player.level;
                gameState.resources.thugs += 5;
                gameState.resources.weapons.pistols += 5;
            }
        }

        // Mapping between new district names (from GameConstants) and old district keys
        const DISTRICT_NAME_TO_KEY = {
            'Uptown Plaza': 'uptown',
            'Midtown Market': 'midtown', 
            'Crooklyn Heights': 'crooklyn',
            'Harbor Docks': 'docks',
            'Financial District': 'financial'
        };

        // Helper function to get old district key from new district name
        function getDistrictKey(districtName) {
            return DISTRICT_NAME_TO_KEY[districtName] || null;
        }

        // Empire City districts with bonuses - EXPANDED TO 5 DISTRICTS WITH TERRITORIES
        const DISTRICTS = {
            uptown: {
                name: "Uptown Plaza",
                description: "A northern enclave of bold gamblers and street kings, where high-stakes bets in coliseums fuel Gotti-era crews and resilient rackets.",
                motto: "Fewer recruits. Bigger money. Keep it classy and paid.",
                vibe: "Uptown Plaza pulses with cultural pride and mob muscle, from hip-hop fronts to estate hideouts.",
                bonuses: {
                    "Gamble's Edge": "+20% chance for high-risk/high-reward outcomes"
                },
                districtBonus: {
                    scoutRecruits: -0.35,    // -35% recruits
                    scoutQuality: 0.60,      // +60% quality
                    payout: 0.20,            // +20% payout
                    policeHeat: -0.30,       // -30% police heat
                    thugCost: 0.15           // +15% thug cost
                },
                color: "gold-text",
                territories: [
                    {
                        name: "Bronzini",
                        description: "South Bronx's hip-hop hub, where rap battles mask drug rackets under neon murals.",
                        special: "Hip-Hop Cipher: Grants rhythmic codes for encrypted messages (+intelligence bonus)."
                    },
                    {
                        name: "Iron Rastelli", 
                        description: "Riverdale's wooded estates, a hideout for exiled capos plotting in mansion cellars.",
                        special: "Elite hideout provides +15% protection from raids."
                    },
                    {
                        name: "Yankee Ward",
                        description: "Stadium district, where Gambino's betting rackets thrive in roaring coliseums.",
                        special: "Coliseum Echo: Summons crowd frenzy for morale boosts in turf wars."
                    },
                    {
                        name: "Gotti Crest",
                        description: "Morrisania's cultural heart, fiercely loyal to the Teflon Don's flashy legacy.",
                        special: "Teflon Aura: Reduces damage from legal heat or snitches."
                    },
                    {
                        name: "Tweed Bloom",
                        description: "Highbridge's corrupt blocks, tied to Tammany Hall's bribes and mob fixes.",
                        special: "Bribe Ledger: Instant access to political favors."
                    }
                ]
            },
            midtown: {
                name: "Midtown Market", 
                description: "The neon-drenched core of Empire City, where after-dark deals in theaters and bars light up Luciano's empire.",
                motto: "Balanced, busy, and reliable. Grind the core loop here.",
                vibe: "Midtown Market is a strip of glamour and grit, with skyscrapers hiding hits and high-society scams.",
                bonuses: {
                    "Neon Veil": "+15% stealth and intrigue boost for espionage operations"
                },
                districtBonus: {
                    turnEfficiency: -0.20,   // -1 turn every 5th action
                    income: 0,               // Baseline
                    heat: 0,                 // Stable
                    balanced: true           // No major penalties
                },
                color: "cyan-glow",
                territories: [
                    {
                        name: "Luciano",
                        description: "Times Square's neon nexus, where Lucky Luciano's Commission brokers city-wide deals.",
                        special: "Commission Seal: Calls a temporary truce with rival families."
                    },
                    {
                        name: "Lucky Ward",
                        description: "Financial District's vaults, Luciano's bootleg empire laundering millions.",
                        special: "Bootleg Vault: Hidden stash for emergency cash infusions."
                    },
                    {
                        name: "Iron Gotti",
                        description: "Harlem's jazzy streets, ruled by John Gotti's flashy crews and soulful fronts.",
                        special: "Flash Parade: Distracts enemies with ostentatious displays."
                    },
                    {
                        name: "Tweed Spire",
                        description: "Tammany's political hive, fixing votes with mob muscle and Boss Tweed's legacy.",
                        special: "Vote Rig: Manipulates elections for district-wide buffs."
                    },
                    {
                        name: "Verrazzano Veil",
                        description: "Lower East Side's immigrant alleys, Lansky's hub for smuggling and rackets.",
                        special: "Smuggling network provides +10% income from drug operations."
                    }
                ]
            },
            crooklyn: {
                name: "Crooklyn Heights",
                description: "A sprawling web of street scams and waterfront hustles, where Gambino bosses and stoop enforcers run the show.", 
                motto: "Real recognize real. Cheap muscle, fat crack yields.",
                vibe: "Crooklyn Heights is Brooklyn's crooked heartbeat, from carnival cons to bridge-side betrayals.",
                bonuses: {
                    "Stoop Network": "+25% defense against raids, plus ally recruitment from diverse ethnic crews"
                },
                districtBonus: {
                    crackProduction: 0.35,   // +35% crack production
                    thugCost: -0.20,         // -20% thug cost
                    attackSuccess: 0.10,     // +10% attack success
                    policeHeat: 0.40         // +40% police heat
                },
                color: "magenta-glow",
                territories: [
                    {
                        name: "Gambino",
                        description: "Brooklyn Heights' waterfront, Carlo Gambino's smuggling empire under the bridge.",
                        special: "Bridge Toll: Controls chokepoints for toll-based income."
                    },
                    {
                        name: "Iron Castellano",
                        description: "Williamsburg's artsy lofts, scarred by Paul Castellano's steakhouse betrayal.",
                        special: "Betrayal Blade: Backstab mechanic for turning enemy spies."
                    },
                    {
                        name: "Corny Island",
                        description: "Coney Island's carnival rackets, where rigged games and boardwalk stalls hide mob scams.",
                        special: "Rigged Wheel: Random luck spinner for surprise power-ups."
                    },
                    {
                        name: "Tammany Forge",
                        description: "Bed-Stuy's resilient blocks, tied to corrupt unions and Tammany's graft.",
                        special: "Union Hammer: Boosts labor rackets for resource multipliers."
                    },
                    {
                        name: "Ellis Veil",
                        description: "Bay Ridge's immigrant haunts, Profaci's olive oil scams in old-world taverns.",
                        special: "Immigrant network provides +15% recruitment success."
                    }
                ]
            },
            docks: {
                name: "Harbor Docks",
                description: "A foggy, isolated outpost of pier-side smuggling and exiled capos, where Anastasia's crews stash goods under lighthouses.",
                motto: "Import/export empire. Big money, big risks.",
                vibe: "Harbor Docks is Empire City's shadowy edge, perfect for quiet dumps and secret sails.",
                bonuses: {
                    "Fog Shroud": "+30% escape/sabotage success, ideal for smuggling or hit-and-runs"
                },
                districtBonus: {
                    vehicleAccess: 0.25,     // +25% vehicle availability
                    weaponImports: 0.30,     // +30% weapon variety
                    income: 0.15,            // +15% income
                    policeHeat: 0.25         // +25% police heat
                },
                color: "text-blue-400",
                territories: [
                    {
                        name: "Ferry Hold",
                        description: "St. George's port, Albert Anastasia's smuggling hub under foggy lighthouses.",
                        special: "Smuggler's Ghost: Invisible transport for goods or agents."
                    },
                    {
                        name: "Narrows Veil",
                        description: "Tottenville's quiet shores, tied to Verrazzano's strait and Mangano's dock wars.",
                        special: "Strait Curse: Hazards enemies crossing into the district."
                    },
                    {
                        name: "Verrazzano",
                        description: "A coastal cove, early mob dock rackets under the explorer's name.",
                        special: "Explorer's Cache: Ancient relic for navigation bonuses."
                    },
                    {
                        name: "Lovelace",
                        description: "Richmondtown's colonial relics, a front for old-money mob operations.",
                        special: "Colonial Deed: Legal loophole for claiming neutral turf."
                    }
                ]
            },
            financial: {
                name: "Financial District",
                description: "A sprawling mosaic of global money flows and airport heists, where Lucchese bosses launder fortunes through markets and skyscrapers.",
                motto: "Corporate fronts and money laundering. Elite operations.",
                vibe: "Financial District reimagines Queens as a diverse banking empire of ethnic crews and offshore scams.",
                bonuses: {
                    "Launder Flow": "+10% income from all rackets, with global trade links for rare imports"
                },
                districtBonus: {
                    moneyLaundering: 0.50,   // +50% cash from drug sales
                    heatReduction: -0.25,    // -25% heat from activities
                    respectGain: 0.20,       // +20% respect gain
                    storePrices: 0.20        // +20% store prices
                },
                color: "text-emerald-400",
                territories: [
                    {
                        name: "Lucchese",
                        description: "Flushing's vibrant bazaars, Tommy Lucchese's garment scams weave global deals.",
                        special: "Garment Web: Global spy network for intel on foreign threats."
                    },
                    {
                        name: "Jade Profaci",
                        description: "Jackson Heights' cultural mix, Joe Profaci's extortion in South Asian markets.",
                        special: "Extortion Ledger: Debt collection for passive income."
                    },
                    {
                        name: "Airport Ward",
                        description: "Long Island City's skyline, Genovese's airport heists via LaGuardia.",
                        special: "Heist Jet: Fast travel or aerial strikes."
                    },
                    {
                        name: "Wave Gambino",
                        description: "Rockaway's salty shores, Carlo Gambino's waterfront smuggling drops.",
                        special: "Waterfront drops provide +20% smuggling success."
                    },
                    {
                        name: "Banana Hold",
                        description: "Jamaica's reggae markets, Joe Bonanno's fruit racket fronts.",
                        special: "Fruit Cartel: Exotic goods trade for rare upgrades."
                    }
                ]
            }
        };

        // Empire City scouting districts (based on player's district)
        function getScoutingDistricts() {
            if (!gameState.player.district) {
                return ["Uptown Plaza", "Midtown Market", "Crooklyn Heights"];
            }
            
            // Get district data using either direct key or mapped key
            const districtKey = getDistrictKey(gameState.player.district) || gameState.player.district;
            const district = DISTRICTS[districtKey];
            if (district) {
                return [district.name, "Nearby Blocks", "Underground Scene"];
            } else {
                // Fallback if district not found in old system
                return [gameState.player.district, "Nearby Blocks", "Underground Scene"];
            }
        }

        // Scout modal with turn selection
        function showScoutModal() {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-xl font-bold cyan-glow mb-4">SCOUT DISTRICTS</h3>
                        <p class="text-sm text-gray-400 mb-4">Choose district and turns to scout for hoes and thugs:</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2 text-gray-300">District</label>
                            <select id="scoutDistrict" class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white">
                                ${getScoutingDistricts().map(district => `
                                    <option value="${district}">${district}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2 text-gray-300">Turns to Use</label>
                            <div class="flex gap-2 mb-2">
                                <button onclick="setScoutTurns(10)" class="px-3 py-1 action-btn rounded text-sm">10</button>
                                <button onclick="setScoutTurns(20)" class="px-3 py-1 action-btn rounded text-sm">20</button>
                                <button onclick="setScoutTurns(30)" class="px-3 py-1 bg-green-600 rounded text-sm">30 ‚≠ê</button>
                                <button onclick="setScoutTurns(50)" class="px-3 py-1 action-btn rounded text-sm">50</button>
                            </div>
                            <input type="number" id="scoutTurns" value="30" min="1" max="200" 
                                   class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white">
                            <p class="text-xs text-gray-400 mt-1">üí° Original strategy: 30 turns gives substantial results</p>
                        </div>
                        
                        <div class="mb-4 p-3 bg-gray-800/50 rounded">
                            <p class="text-sm text-white">Current Turns: ${calculateCurrentTurns()}/200</p>
                            <p class="text-xs text-gray-400 mt-1">More turns = more hoes and thugs found</p>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="executeScout()" class="flex-1 py-2 action-btn rounded">Scout Now</button>
                            <button onclick="closeModal()" class="flex-1 py-2 bg-gray-700 rounded">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        function setScoutTurns(turns) {
            document.getElementById('scoutTurns').value = turns;
        }

        function executeScout() {
            const district = document.getElementById('scoutDistrict').value;
            const turnsToUse = parseInt(document.getElementById('scoutTurns').value) || 30;
            
            if (!useTurns(turnsToUse)) {
                showNotification(`‚ùå Not enough turns! Need ${turnsToUse} turns`, 'error');
                addConsoleMessage(`Not enough turns! Need ${turnsToUse} turns to scout.`, 'red');
                return;
            }
            
            // Original scouting formula based on turns used
            const hoesFound = Math.floor(turnsToUse * 0.8 * Math.random()) + Math.floor(turnsToUse * 0.2);
            const thugsFound = Math.floor(turnsToUse * 0.3 * Math.random()) + Math.floor(turnsToUse * 0.1);
            // FIXED: Reasonable scout money (was creating billions!)
            const baseMoneyPerTurn = 15; // Fixed base rate instead of scaling with hoes
            const bonusPerHoe = Math.min(50, gameState.resources.hoes * 0.5); // Max $50 bonus from hoes
            const moneyEarned = (baseMoneyPerTurn * turnsToUse) + bonusPerHoe + Math.floor(Math.random() * turnsToUse * 5);
            
            console.log('üîç Scout results:', { turnsToUse, hoesFound, thugsFound, moneyEarned });
            console.log('üîç Before update:', { hoes: gameState.resources.hoes, thugs: gameState.resources.thugs, cash: gameState.player.cash });
            
            // SAFE resource updates with logging
            const oldHoes = gameState.resources.hoes;
            const oldThugs = gameState.resources.thugs;
            const oldCash = gameState.player.cash;
            
            // Apply gains with logging
            logResourceChange('hoes', null, oldHoes, oldHoes + hoesFound, 'scout_operation');
            logResourceChange('thugs', null, oldThugs, oldThugs + thugsFound, 'scout_operation');
            logResourceChange('cash', null, oldCash, oldCash + moneyEarned, 'scout_operation');
            
            gameState.resources.hoes += hoesFound;
            gameState.resources.thugs += thugsFound;
            gameState.player.cash += moneyEarned;
            
            // Create crew members for new thugs
            for (let i = 0; i < thugsFound; i++) {
                gameState.crew.thugs.push(createThug());
            }
            syncThugCount('scout_recruitment');
            
            console.log('üîç After update:', { hoes: gameState.resources.hoes, thugs: gameState.resources.thugs, cash: gameState.player.cash });
            
            // Show detailed results modal
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-xl font-bold cyan-glow mb-4">üîç SCOUT RESULTS</h3>
                        
                        <div class="mb-4 p-4 bg-green-900/30 rounded border border-green-500/50">
                            <h4 class="font-bold text-green-400 mb-3">‚úÖ Scout Complete!</h4>
                            <p class="text-sm text-gray-300 mb-2">üìç Location: <span class="cyan-glow">${district}</span></p>
                            <p class="text-sm text-gray-300 mb-3">‚ö° Turns Used: <span class="text-yellow-400">${turnsToUse}</span></p>
                            
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-pink-400">üë• Hoes Found:</span>
                                    <span class="text-white font-bold">+${hoesFound}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-blue-400">üí™ Thugs Found:</span>
                                    <span class="text-white font-bold">+${thugsFound}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-yellow-400">üí∞ Money Earned:</span>
                                    <span class="gold-text font-bold">+$${moneyEarned.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold">
                            Continue Playing
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
            
            // Also show notification
            showNotification(`üîç Found ${hoesFound} hoes, ${thugsFound} thugs, +$${moneyEarned}!`, 'success');
            addConsoleMessage(`${district} scout (${turnsToUse} turns): +${hoesFound} hoes, +${thugsFound} thugs, +$${moneyEarned}`, 'green');
            updateUI();
            updateTutorialProgress('scout', 1);
            saveLocalGameState(); // Auto-save
        }

        function quickCrack() {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full my-8 max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">PRODUCE CRACK</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">Send your thugs to produce crack on the streets:</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2 text-gray-300">Turns to Use</label>
                            <input type="number" id="crackTurns" value="15" min="1" max="200" 
                                   class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white">
                            <p class="text-xs text-gray-400 mt-1">Original strategy: 15 turns works well, 20 early in game</p>
                        </div>
                        
                        <div class="mb-4 p-3 bg-gray-800/50 rounded">
                            <p class="text-sm text-white">Current Thugs: ${gameState.resources.thugs}</p>
                            <p class="text-sm text-white">Thug Happiness: ${gameState.supplies.thugHappiness}%</p>
                            <p class="text-xs text-gray-400 mt-1">Unhappy thugs produce less crack!</p>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="produceCrack()" class="flex-1 py-2 action-btn rounded">Produce Crack</button>
                            <button onclick="closeModal()" class="flex-1 py-2 bg-gray-700 rounded">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        function produceCrack() {
            const turnsToUse = parseInt(document.getElementById('crackTurns').value) || 15;
            
            if (!useTurns(turnsToUse)) {
                showNotification(`‚ùå Not enough turns! Need ${turnsToUse} turns`, 'error');
                addConsoleMessage('Not enough turns!', 'red');
                return;
            }
            
            // Original crack production: More thugs = more crack, happiness affects production
            const happinessMultiplier = gameState.supplies.thugHappiness / 100;
            const basePerThugPerTurn = 1.5 * happinessMultiplier; // Base production rate
            const crackProduced = Math.floor(gameState.resources.thugs * basePerThugPerTurn * turnsToUse);
            
            console.log('üíé Crack production:', { turnsToUse, thugs: gameState.resources.thugs, happiness: gameState.supplies.thugHappiness, crackProduced });
            
            gameState.resources.crack += crackProduced;
            
            // Show success notification
            showNotification(`üíé Produced ${crackProduced} crack rocks!`, 'success');
            addConsoleMessage(`Crack production (${turnsToUse} turns): +${crackProduced} rocks`, 'green');
            addConsoleMessage(`Production rate: ${(basePerThugPerTurn * happinessMultiplier).toFixed(1)} per thug per turn`, 'cyan');
            updateUI();
            updateTutorialProgress('crack', crackProduced);
            saveLocalGameState(); // Auto-save
            closeModal();
        }

        // Store Functions (fixed)
        function showStoreMenu() {
            console.log('üõí Opening store menu');
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full">
                        <h3 class="text-xl font-bold cyan-glow mb-4">EMPIRE CITY STORES</h3>
                        <p class="text-sm gold-text mb-4">Cash: $${gameState.player.cash.toLocaleString()}</p>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <button onclick="openCornerStore()" class="action-btn rounded p-4 hover:scale-105 transition-all">
                                <div class="text-lg font-bold">Corner Store</div>
                                <div class="text-xs text-gray-400">üç∫ Beer & Supplies</div>
                            </button>
                            <button onclick="openGunStore()" class="action-btn rounded p-4 hover:scale-105 transition-all">
                                <div class="text-lg font-bold">Pew Pew Jimmy's</div>
                                <div class="text-xs text-gray-400">üî´ Weapons & Thugs</div>
                            </button>
                            <button onclick="visitStore('Reggie\\'s Plug')" class="action-btn rounded p-4 hover:scale-105 transition-all">
                                <div class="text-lg font-bold">Reggie's Plug</div>
                                <div class="text-xs text-gray-400">üåø Premium Weed</div>
                            </button>
                            <button onclick="openTonysChopShop()" class="action-btn rounded p-4 hover:scale-105 transition-all">
                                <div class="text-lg font-bold">Tony's Chop Shop</div>
                                <div class="text-xs text-gray-400">üöó Vehicles & Rides</div>
                            </button>
                        </div>
                        <button onclick="closeModal()" class="w-full py-2 bg-gray-700 rounded">Close</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // Store selection state
        let selectedStoreItem = null;

        // Visit specific stores (OLD SYSTEM - Should not be used for Corner Store or Gun Store)
        function visitStore(storeName) {
            console.log('‚ö†Ô∏è OLD STORE SYSTEM CALLED:', storeName);
            addConsoleMessage(`‚ö†Ô∏è Old store system called for ${storeName}`, 'yellow');
            
            const store = STORES[storeName];
            if (!store) {
                showNotification(`‚ùå Store "${storeName}" not found!`, 'error');
                return;
            }
            
            selectedStoreItem = null; // Reset selection
            
            let storeHTML = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                        <h3 class="text-xl font-bold cyan-glow mb-2">${storeName.toUpperCase()}</h3>
                        <p class="text-sm text-gray-400 mb-4">Owner: ${store.owner} | Location: ${store.location}</p>
                        
                        <div class="mb-4 p-3 bg-gray-800/50 rounded">
                            <p class="text-sm text-white">Cash: <span class="gold-text">$${gameState.player.cash.toLocaleString()}</span></p>
                        </div>
                        
                        <div id="selectedItemDisplay" class="mb-4 p-3 bg-blue-900/30 rounded border border-blue-500/50 hidden">
                            <p class="text-blue-400 font-bold">Selected: <span id="selectedItemName">None</span></p>
                            <p class="text-white">Price: <span id="selectedItemPrice" class="gold-text">$0</span></p>
                        </div>
                        
                        <div class="space-y-4 mb-4" id="storeInventory">
            `;
            
            // Generate inventory based on store type
            Object.entries(store.inventory).forEach(([item, data]) => {
                if (typeof data === 'object' && !data.price) {
                    // Multiple variants (like weed quantities)
                    storeHTML += `
                        <div class="border border-gray-600 rounded p-3">
                            <h4 class="font-bold text-white mb-2">${item.charAt(0).toUpperCase() + item.slice(1)}</h4>
                            <div class="grid grid-cols-2 gap-2">
                    `;
                    
                    Object.entries(data).forEach(([variant, details]) => {
                        const itemId = `${storeName}_${item}_${variant}`;
                        storeHTML += `
                            <button onclick="selectStoreItem(\`${storeName}\`, \`${item}\`, \`${variant}\`, ${details.price}, ${details.quantity}, \`${itemId}\`)" 
                                    id="${itemId}" class="store-item-btn action-btn rounded p-2 text-sm border-2 border-transparent hover:border-blue-400">
                                ${variant}: $${details.price} (${details.quantity}${item === 'weed' ? 'oz' : ''})
                            </button>
                        `;
                    });
                    
                    storeHTML += `</div></div>`;
                } else {
                    // Single items with quantity options (weapons, vehicles, thugs)
                    const itemId = `${storeName}_${item}_single`;
                    const isWeapon = ['pistol', 'shotgun', 'mp5', 'ak47'].includes(item);
                    const isThugs = item === 'thugs';
                    
                    storeHTML += `
                        <div class="border border-gray-600 rounded p-3 mb-3">
                            <div class="flex justify-between items-center mb-3">
                                <div>
                                    <span class="font-bold text-white text-lg">${item.charAt(0).toUpperCase() + item.slice(1)}</span>
                                    ${data.description ? `<div class="text-xs text-gray-400">${data.description}</div>` : ''}
                                </div>
                                <span class="gold-text text-lg">$${data.price.toLocaleString()} each</span>
                            </div>
                            
                            ${isWeapon || isThugs ? `
                                <div class="grid grid-cols-3 gap-2 mb-3">
                                    <button onclick="selectStoreItem(\`${storeName}\`, \`${item}\`, \`x1\`, ${data.price}, 1, \`${itemId}_1\`)" 
                                            id="${itemId}_1" class="store-item-btn action-btn rounded p-2 text-sm border-2 border-transparent hover:border-blue-400">
                                        1x ($${data.price.toLocaleString()})
                                    </button>
                                    <button onclick="selectStoreItem(\`${storeName}\`, \`${item}\`, \`x5\`, ${data.price * 5}, 5, \`${itemId}_5\`)" 
                                            id="${itemId}_5" class="store-item-btn action-btn rounded p-2 text-sm border-2 border-transparent hover:border-blue-400">
                                        5x ($${(data.price * 5).toLocaleString()})
                                    </button>
                                    <button onclick="selectStoreItem(\`${storeName}\`, \`${item}\`, \`x10\`, ${data.price * 10}, 10, \`${itemId}_10\`)" 
                                            id="${itemId}_10" class="store-item-btn action-btn rounded p-2 text-sm border-2 border-transparent hover:border-blue-400">
                                        10x ($${(data.price * 10).toLocaleString()})
                                    </button>
                                </div>
                                <div class="flex gap-2">
                                    <input type="number" id="${itemId}_custom_qty" value="1" min="1" max="100" 
                                           class="flex-1 p-2 bg-gray-800 border border-gray-600 rounded text-white text-center">
                                    <button onclick="selectCustomQuantity(\`${storeName}\`, \`${item}\`, ${data.price}, \`${itemId}_custom\`)" 
                                            id="${itemId}_custom" class="store-item-btn px-4 py-2 action-btn rounded text-sm border-2 border-transparent hover:border-blue-400">
                                        Custom Qty
                                    </button>
                                </div>
                            ` : `
                                <button onclick="selectStoreItem(\`${storeName}\`, \`${item}\`, \`single\`, ${data.price}, 1, \`${itemId}\`)" 
                                        id="${itemId}" class="store-item-btn w-full action-btn rounded p-2 text-sm border-2 border-transparent hover:border-blue-400">
                                    Buy for $${data.price.toLocaleString()}
                                </button>
                            `}
                        </div>
                    `;
                }
            });
            
            storeHTML += `
                        </div>
                        <div class="flex gap-3">
                            <button onclick="buySelectedItem()" id="buyButton" disabled class="flex-1 py-3 bg-green-600 disabled:bg-gray-600 disabled:cursor-not-allowed rounded font-bold">
                                BUY
                            </button>
                            <button onclick="closeModal()" class="flex-1 py-3 bg-gray-700 rounded font-bold">
                                CLOSE
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = storeHTML;
        }

        // Custom quantity selection
        function selectCustomQuantity(storeName, item, unitPrice, itemId) {
            const qtyInput = document.getElementById(itemId.replace('_custom', '_custom_qty'));
            const quantity = parseInt(qtyInput?.value) || 1;
            const totalPrice = unitPrice * quantity;
            
            selectStoreItem(storeName, item, `x${quantity}`, totalPrice, quantity, itemId);
        }

        // Select store item (highlight and enable buy button)
        function selectStoreItem(storeName, item, variant, price, quantity, itemId) {
            console.log('üéØ selectStoreItem called:', { storeName, item, variant, price, quantity, itemId });
            
            // Remove previous selection
            document.querySelectorAll('.store-item-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-900/30');
                btn.classList.add('border-transparent');
            });
            
            // Highlight selected item
            const selectedBtn = document.getElementById(itemId);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-transparent');
                selectedBtn.classList.add('border-blue-500', 'bg-blue-900/30');
                console.log('‚úÖ Highlighted button:', itemId);
            } else {
                console.log('‚ùå Button not found:', itemId);
            }
            
            // Store selection
            selectedStoreItem = { storeName, item, variant, price, quantity };
            console.log('‚úÖ Stored selection:', selectedStoreItem);
            
            // Update display
            const displayDiv = document.getElementById('selectedItemDisplay');
            const nameSpan = document.getElementById('selectedItemName');
            const priceSpan = document.getElementById('selectedItemPrice');
            
            if (displayDiv && nameSpan && priceSpan) {
                displayDiv.classList.remove('hidden');
                const displayText = item === 'weed' ? `${quantity}oz ${item} (${variant})` : 
                                  quantity === 1 ? `${item} (${variant})` : `${quantity} ${item}`;
                nameSpan.textContent = displayText;
                priceSpan.textContent = `$${price.toLocaleString()}`;
            }
            
            // Enable buy button
            const buyButton = document.getElementById('buyButton');
            if (buyButton) {
                buyButton.disabled = false;
                buyButton.classList.remove('bg-gray-600', 'disabled:bg-gray-600');
                buyButton.classList.add('bg-green-600');
            }
        }

        // Buy selected item
        function buySelectedItem() {
            console.log('üõí buySelectedItem called, selectedStoreItem:', selectedStoreItem);
            
            if (!selectedStoreItem) {
                showNotification('‚ùå No item selected!', 'error');
                console.log('‚ùå No item selected');
                return;
            }
            
            const { storeName, item, variant, price, quantity } = selectedStoreItem;
            console.log('üõí Purchase details:', { storeName, item, variant, price, quantity });
            
            // Use existing buy function but don't close modal
            if (gameState.player.cash < price) {
                showNotification(`üí∏ Not enough cash! Need $${price}, have $${gameState.player.cash}`, 'error');
                return;
            }
            
            gameState.player.cash -= price;
            
            // Add item to resources with detailed logging
            console.log(`üõí Adding ${quantity} ${item} to resources`);
            console.log(`üõí Before: gameState.resources.${item} =`, gameState.resources[item]);
            
                        // Handle item purchases with proper mapping
            console.log(`üõí Processing item: ${item}, quantity: ${quantity}`);
            
            // Handle weapons (map store names to resource names)
            if (['pistol', 'shotgun', 'mp5', 'ak47'].includes(item)) {
                const weaponKey = item === 'pistol' ? 'pistols' : 
                                 item === 'shotgun' ? 'shotguns' :
                                 item === 'mp5' ? 'tek9s' :
                                 item === 'ak47' ? 'ak47s' : item;
                
                gameState.resources.weapons[weaponKey] = (gameState.resources.weapons[weaponKey] || 0) + quantity;
                console.log(`üõí Added ${quantity} ${item} ‚Üí weapons.${weaponKey} = ${gameState.resources.weapons[weaponKey]}`);
            }
            // Handle thugs (special crew system)
            else if (item === 'thugs') {
                for (let i = 0; i < quantity; i++) {
                    gameState.crew.thugs.push(createThug());
                }
                syncThugCount();
                console.log(`üõí Added ${quantity} thugs to crew, total: ${gameState.crew.thugs.length}`);
            }
            // Handle vehicles
            else if (['bicycle', 'motorcycle', 'kia', 'lowrider', 'escalade', 'limo', 'bentley', 'armoredBeast'].includes(item)) {
                if (!gameState.resources.vehicles) gameState.resources.vehicles = {};
                gameState.resources.vehicles[item] = (gameState.resources.vehicles[item] || 0) + quantity;
                console.log(`üõí Added ${quantity} ${item} to vehicles`);
            }
            // Handle simple resources (weed, beer, crack, etc.)
            else if (gameState.resources[item] !== undefined) {
                gameState.resources[item] = (gameState.resources[item] || 0) + quantity;
                console.log(`üõí Added ${quantity} ${item} to resources`);
            }
            else {
                console.error(`‚ùå Unknown item: ${item}`);
                showNotification(`‚ùå Unknown item: ${item}`, 'error');
                gameState.player.cash += price; // Refund
                return;
            }
            
            console.log(`üõí After: gameState.resources.${item} =`, gameState.resources[item]);
            
            const displayText = item === 'weed' ? `${quantity}oz ${item}` : 
                               quantity === 1 ? item : `${quantity} ${item}`;
            
            showNotification(`‚úÖ Bought ${displayText} for $${price}!`, 'success');
            addConsoleMessage(`üí∞ ${storeName}: ${displayText} purchased for $${price}`, 'green');
            
            // Update UI and cash display in modal
            updateUI();
            saveLocalGameState();
            
            // Update cash display in modal
            const cashDisplay = document.querySelector('.game-panel .gold-text');
            if (cashDisplay && cashDisplay.textContent.includes('$')) {
                cashDisplay.textContent = `$${gameState.player.cash.toLocaleString()}`;
            }
            
            // Reset selection but keep modal open
            selectedStoreItem = null;
            document.getElementById('selectedItemDisplay').classList.add('hidden');
            document.getElementById('buyButton').disabled = true;
            
            // Remove highlighting
            document.querySelectorAll('.store-item-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-900/30');
                btn.classList.add('border-transparent');
            });
        }

        // Buy items from stores - handles multiple parameter formats
        function buyStoreItem(storeName, item, variant, price, quantity) {
            // Handle different calling formats for backward compatibility
            if (typeof storeName === 'string' && typeof item === 'string' && typeof variant === 'number') {
                // Old format: buyStoreItem('beer', 2, 1, 10) = (item, price, quantity, multiplier)
                const actualItem = storeName;
                const actualPrice = item * variant * price; // price * quantity * multiplier
                const actualQuantity = variant * price;
                
                console.log(`üõí Old format purchase: ${actualItem}, $${actualPrice}, qty: ${actualQuantity}`);
                
                if (gameState.player.cash < actualPrice) {
                    showNotification(`üí∏ Not enough cash! Need $${actualPrice}, have $${gameState.player.cash}`, 'error');
                    return;
                }
                
                gameState.player.cash -= actualPrice;
                gameState.resources[actualItem] = (gameState.resources[actualItem] || 0) + actualQuantity;
                
                showNotification(`‚úÖ Bought ${actualQuantity} ${actualItem} for $${actualPrice}!`, 'success');
                addConsoleMessage(`üí∞ Purchase: ${actualQuantity} ${actualItem} for $${actualPrice}`, 'green');
                updateUI();
                saveLocalGameState();
                return;
            }
            
            // New format: proper store purchases
            console.log(`üõí Store purchase: ${storeName} - ${item} (${variant}) - $${price} x ${quantity}`);
            
            if (gameState.player.cash < price) {
                showNotification(`üí∏ Not enough cash! Need $${price}, have $${gameState.player.cash}`, 'error');
                return;
            }
            
            gameState.player.cash -= price;
            
            // Add item to resources
            if (gameState.resources[item] !== undefined) {
                if (typeof gameState.resources[item] === 'object') {
                    // For weapons/vehicles objects
                    if (variant === 'single') {
                        // For vehicles/weapons without variants
                        const itemKey = item === 'bike' ? 'bike' : item;
                        gameState.resources[item][itemKey] = (gameState.resources[item][itemKey] || 0) + quantity;
                    } else {
                        gameState.resources[item][variant] = (gameState.resources[item][variant] || 0) + quantity;
                    }
                } else {
                    // For simple numbers like weed, beer
                    gameState.resources[item] += quantity;
                }
            } else {
                console.warn(`‚ùå Unknown item: ${item}`);
                showNotification(`‚ùå Unknown item: ${item}`, 'error');
                gameState.player.cash += price; // Refund
                return;
            }
            
            const displayText = item === 'weed' ? `${quantity}oz ${item}` : 
                               quantity === 1 ? item : `${quantity} ${item}`;
            
            showNotification(`‚úÖ Bought ${displayText} for $${price}!`, 'success');
            addConsoleMessage(`üí∞ ${storeName}: ${displayText} purchased for $${price}`, 'green');
            updateUI();
            saveLocalGameState();
        }

        // Enhanced Corner Store (embedded to avoid loading issues)
        function openCornerStore() {
            console.log('üõí OPENING ENHANCED CORNER STORE with quantity selectors');
            addConsoleMessage('üõí Opening enhanced Corner Store with quantity selectors', 'cyan');
            
            const store = STORES["Corner Store"];
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full my-8 max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">CORNER STORE</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">Run by ${store.owner} ‚Ä¢ Cash: <span class="gold-text">$${gameState.player.cash.toLocaleString()}</span></p>
                        
                        <div class="space-y-4">
                            <!-- Beer with Quantity Selector -->
                            <div class="border border-gray-700 rounded p-4 bg-gray-800/30">
                                <h4 class="font-bold text-yellow-400 mb-3">üç∫ Beer ($2 each)</h4>
                                
                                <!-- Individual Beer -->
                                <div class="mb-3 p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-gray-300">Individual Beer</span>
                                        <span class="text-yellow-400">$2 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('beer_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="beer_qty" value="50" min="1" max="1000" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateQuantityDisplays()">
                                            <button onclick="adjustQuantity('beer_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyWithQuantity('beer', 2, 'beer_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="beer_total">$100</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Keg Deal -->
                                <div class="mb-3 p-3 bg-green-900/30 rounded border border-green-500/50">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-green-400">üéâ Keg Deal (200 beers)</span>
                                        <span class="text-green-400">$300 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('keg_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="keg_qty" value="1" min="1" max="20" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateQuantityDisplays()">
                                            <button onclick="adjustQuantity('keg_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyKegs()" class="flex-1 bg-green-600 rounded py-2 text-sm hover:bg-green-500">
                                            Buy <span id="keg_total">$300</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Condoms with Quantity Selector -->
                            <div class="border border-gray-700 rounded p-4 bg-gray-800/30">
                                <h4 class="font-bold text-pink-400 mb-3">üõ°Ô∏è Condoms ($1 each)</h4>
                                
                                <div class="mb-3 p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-gray-300">Individual Condoms</span>
                                        <span class="text-pink-400">$1 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('condom_qty', -10)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">--</button>
                                            <button onclick="adjustQuantity('condom_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="condom_qty" value="100" min="1" max="5000" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateQuantityDisplays()">
                                            <button onclick="adjustQuantity('condom_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                            <button onclick="adjustQuantity('condom_qty', 10)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">++</button>
                                        </div>
                                        <button onclick="buyWithQuantity('condoms', 1, 'condom_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="condom_total">$100</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="p-3 bg-green-900/30 rounded border border-green-500/50">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-green-400">üéâ Bulk Crate (1000 condoms)</span>
                                        <span class="text-green-400">$700 total</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('crate_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="crate_qty" value="1" min="1" max="10" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateQuantityDisplays()">
                                            <button onclick="adjustQuantity('crate_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyCondomCrates()" class="flex-1 bg-green-600 rounded py-2 text-sm hover:bg-green-500">
                                            Buy <span id="crate_total">$700</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Medicine with Quantity Selector -->
                            <div class="border border-gray-700 rounded p-4 bg-gray-800/30">
                                <h4 class="font-bold text-red-400 mb-3">üíä Medicine</h4>
                                
                                <div class="space-y-3">
                                    <!-- Individual Doses -->
                                    <div class="p-3 bg-gray-900/50 rounded">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-gray-300">Medicine Doses</span>
                                            <span class="text-red-400">$20 each</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div class="flex items-center gap-2">
                                                <button onclick="adjustQuantity('medicine_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                                <input type="number" id="medicine_qty" value="5" min="1" max="100" 
                                                       class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                       oninput="updateQuantityDisplays()">
                                                <button onclick="adjustQuantity('medicine_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                            </div>
                                            <button onclick="buyWithQuantity('medicine', 20, 'medicine_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                                Buy <span id="medicine_total">$100</span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Bottle Deal -->
                                    <div class="p-3 bg-blue-900/30 rounded border border-blue-500/50">
                                        <div class="flex justify-between items-center">
                                            <span class="text-blue-400">üíä Medicine Bottle (10 doses)</span>
                                            <button onclick="buyStoreItem('medicine', 180, 10, 1)" class="px-3 py-1 bg-blue-600 rounded text-sm hover:bg-blue-500">
                                                $180 (Save $20!)
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full mt-4 py-3 bg-gray-700 rounded font-bold">Close Store</button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
            updateQuantityDisplays();
        }
        
        // Store utility functions
        function adjustQuantity(inputId, change) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            const currentValue = parseInt(input.value) || 1;
            const newValue = Math.max(1, currentValue + change);
            const maxValue = parseInt(input.max) || 1000;
            
            input.value = Math.min(newValue, maxValue);
            updateQuantityDisplays();
        }
        
        function updateQuantityDisplays() {
            // Update beer total
            const beerQty = parseInt(document.getElementById('beer_qty')?.value) || 0;
            const beerTotalEl = document.getElementById('beer_total');
            if (beerTotalEl) {
                beerTotalEl.textContent = `$${(beerQty * 2).toLocaleString()}`;
            }
            
            // Update keg total
            const kegQty = parseInt(document.getElementById('keg_qty')?.value) || 0;
            const kegTotalEl = document.getElementById('keg_total');
            if (kegTotalEl) {
                kegTotalEl.textContent = `$${(kegQty * 300).toLocaleString()}`;
            }
            
            // Update condom total
            const condomQty = parseInt(document.getElementById('condom_qty')?.value) || 0;
            const condomTotalEl = document.getElementById('condom_total');
            if (condomTotalEl) {
                condomTotalEl.textContent = `$${(condomQty * 1).toLocaleString()}`;
            }
            
            // Update crate total
            const crateQty = parseInt(document.getElementById('crate_qty')?.value) || 0;
            const crateTotalEl = document.getElementById('crate_total');
            if (crateTotalEl) {
                crateTotalEl.textContent = `$${(crateQty * 700).toLocaleString()}`;
            }
            
            // Update medicine total
            const medicineQty = parseInt(document.getElementById('medicine_qty')?.value) || 0;
            const medicineTotalEl = document.getElementById('medicine_total');
            if (medicineTotalEl) {
                medicineTotalEl.textContent = `$${(medicineQty * 20).toLocaleString()}`;
            }
        }
        
        function buyBeer() {
            const qtyInput = document.getElementById('beer_qty');
            const quantity = parseInt(qtyInput?.value) || 1;
            const totalCost = 2 * quantity;
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}`, 'error');
                return;
            }
            
            gameState.player.cash -= totalCost;
            gameState.resources.beer = (gameState.resources.beer || 0) + quantity;
            
            showNotification(`üç∫ Bought ${quantity} beer for $${totalCost.toLocaleString()}!`, 'success');
            addConsoleMessage(`üí∞ Corner Store: ${quantity} beer purchased for $${totalCost.toLocaleString()}`, 'green');
            
            updateUI();
            saveGameState();
            updateQuantityDisplays();
        }
        
        function buyCondoms() {
            const qtyInput = document.getElementById('condom_qty');
            const quantity = parseInt(qtyInput?.value) || 1;
            const totalCost = 1 * quantity;
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}`, 'error');
                return;
            }
            
            gameState.player.cash -= totalCost;
            gameState.resources.condoms = (gameState.resources.condoms || 0) + quantity;
            
            showNotification(`üõ°Ô∏è Bought ${quantity} condoms for $${totalCost.toLocaleString()}!`, 'success');
            addConsoleMessage(`üí∞ Corner Store: ${quantity} condoms purchased for $${totalCost.toLocaleString()}`, 'green');
            
            updateUI();
            saveGameState();
            updateQuantityDisplays();
        }

        function buyWithQuantity(item, unitPrice, qtyInputId) {
            const qtyInput = document.getElementById(qtyInputId);
            if (!qtyInput) {
                showNotification('‚ùå Quantity input not found', 'error');
                return;
            }
            
            const quantity = parseInt(qtyInput.value) || 1;
            const totalCost = unitPrice * quantity;
            
            console.log(`üõí Buying ${quantity} ${item} for $${totalCost}`);
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}, have $${gameState.player.cash.toLocaleString()}`, 'error');
                return;
            }
            
            gameState.player.cash -= totalCost;
            gameState.resources[item] = (gameState.resources[item] || 0) + quantity;
            
            const displayText = quantity === 1 ? item : `${quantity} ${item}`;
            showNotification(`‚úÖ Bought ${displayText} for $${totalCost.toLocaleString()}!`, 'success');
            addConsoleMessage(`üí∞ Corner Store: ${displayText} purchased for $${totalCost.toLocaleString()}`, 'green');
            
            updateUI();
            saveGameState();
            updateQuantityDisplays();
        }

        function buyKegs() {
            const qtyInput = document.getElementById('keg_qty');
            const quantity = parseInt(qtyInput?.value) || 1;
            const totalCost = 300 * quantity;
            const totalBeers = 200 * quantity;
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}`, 'error');
                return;
            }
            
            gameState.player.cash -= totalCost;
            gameState.resources.beer = (gameState.resources.beer || 0) + totalBeers;
            
            const displayText = quantity === 1 ? 'keg' : `${quantity} kegs`;
            showNotification(`üç∫ Bought ${displayText} (${totalBeers} beers) for $${totalCost.toLocaleString()}!`, 'success');
            addConsoleMessage(`üí∞ Corner Store: ${displayText} = ${totalBeers} beers for $${totalCost.toLocaleString()}`, 'green');
            
            updateUI();
            saveGameState();
            
            // Reset to 1 keg for next purchase
            if (qtyInput) qtyInput.value = '1';
            updateQuantityDisplays();
        }

        function buyCondomCrates() {
            const qtyInput = document.getElementById('crate_qty');
            const quantity = parseInt(qtyInput?.value) || 1;
            const totalCost = 700 * quantity;
            const totalCondoms = 1000 * quantity;
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}`, 'error');
                return;
            }
            
            gameState.player.cash -= totalCost;
            gameState.resources.condoms = (gameState.resources.condoms || 0) + totalCondoms;
            
            const displayText = quantity === 1 ? 'crate' : `${quantity} crates`;
            showNotification(`üõ°Ô∏è Bought ${displayText} (${totalCondoms} condoms) for $${totalCost.toLocaleString()}!`, 'success');
            addConsoleMessage(`üí∞ Corner Store: ${displayText} = ${totalCondoms} condoms for $${totalCost.toLocaleString()}`, 'green');
            
            updateUI();
            saveGameState();
            
            // Reset to 1 crate for next purchase
            if (qtyInput) qtyInput.value = '1';
            updateQuantityDisplays();
        }
        
        // Enhanced Gun Store (embedded)
        function openGunStore() {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full my-8 max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">üí• PEW PEW JIMMY'S</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">üí• Premium Firepower ‚Ä¢ Cash: <span class="gold-text">$${gameState.player.cash.toLocaleString()}</span></p>
                        
                        <div class="space-y-4">
                            <!-- Thugs -->
                            <div class="border border-gray-700 rounded p-4 bg-gray-800/30">
                                <h4 class="font-bold text-blue-400 mb-3">üë• Hire Thugs ($1,000 each)</h4>
                                <div class="p-3 bg-gray-900/50 rounded">
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('thugs_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white">-</button>
                                            <input type="number" id="thugs_qty" value="1" min="1" max="20" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateGunDisplays()">
                                            <button onclick="adjustQuantity('thugs_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white">+</button>
                                        </div>
                                        <button onclick="buyThugs()" class="flex-1 action-btn rounded py-2 text-sm">
                                            Hire <span id="thugs_total">$1,000</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pistols -->
                            <div class="border border-gray-700 rounded p-4 bg-gray-800/30">
                                <h4 class="font-bold text-red-400 mb-3">üî´ Pistols ($250 each)</h4>
                                <div class="p-3 bg-gray-900/50 rounded">
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('pistols_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white">-</button>
                                            <input type="number" id="pistols_qty" value="5" min="1" max="50" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateGunDisplays()">
                                            <button onclick="adjustQuantity('pistols_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white">+</button>
                                        </div>
                                        <button onclick="buyPistols()" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="pistols_total">$1,250</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full mt-4 py-3 bg-gray-700 rounded font-bold">Close Store</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            updateGunDisplays();
        }
        
        function updateGunDisplays() {
            const thugsQty = parseInt(document.getElementById('thugs_qty')?.value) || 0;
            const thugsTotalEl = document.getElementById('thugs_total');
            if (thugsTotalEl) thugsTotalEl.textContent = `$${(thugsQty * 1000).toLocaleString()}`;
            
            const pistolsQty = parseInt(document.getElementById('pistols_qty')?.value) || 0;
            const pistolsTotalEl = document.getElementById('pistols_total');
            if (pistolsTotalEl) pistolsTotalEl.textContent = `$${(pistolsQty * 250).toLocaleString()}`;
        }
        
        function buyThugs() {
            const qtyInput = document.getElementById('thugs_qty');
            const quantity = parseInt(qtyInput?.value) || 1;
            const totalCost = 1000 * quantity;
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}`, 'error');
                return;
            }
            
            gameState.player.cash -= totalCost;
            gameState.resources.thugs += quantity;
            
            for (let i = 0; i < quantity; i++) {
                gameState.crew.thugs.push(createThug());
            }
            syncThugCount('gun_store_purchase');
            
            showNotification(`üë• Hired ${quantity} thugs for $${totalCost.toLocaleString()}!`, 'success');
            updateUI();
            saveGameState();
            updateGunDisplays();
        }
        
        function buyPistols() {
            const qtyInput = document.getElementById('pistols_qty');
            const quantity = parseInt(qtyInput?.value) || 1;
            const totalCost = 250 * quantity;
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}`, 'error');
                return;
            }
            
            gameState.player.cash -= totalCost;
            gameState.resources.weapons.pistols += quantity;
            
            showNotification(`üî´ Bought ${quantity} pistols for $${totalCost.toLocaleString()}!`, 'success');
            updateUI();
            saveGameState();
            updateGunDisplays();
        }
        
        // Enhanced Reggie's Plug with quantity selectors
        function openReggiesPlug() {
            console.log('üåø OPENING ENHANCED REGGIE\'S PLUG with quantity selectors');
            addConsoleMessage('üåø Opening enhanced Reggie\'s Plug with quantity selectors', 'cyan');
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full my-8 max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">REGGIE'S PLUG</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">üåø Premium Weed ‚Ä¢ Heat +5 per purchase ‚Ä¢ Cash: <span class="gold-text">$${gameState.player.cash.toLocaleString()}</span></p>
                        
                        <div class="space-y-4">
                            <!-- Weed with Quantity Selector -->
                            <div class="border border-gray-700 rounded p-4 bg-gray-800/30">
                                <h4 class="font-bold text-green-400 mb-3">üåø Premium Weed</h4>
                                
                                <!-- Eighth -->
                                <div class="mb-3 p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-gray-300">Eighth (‚Öõ oz)</span>
                                        <span class="text-green-400">$15 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('eighth_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="eighth_qty" value="5" min="1" max="50" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateWeedDisplays()">
                                            <button onclick="adjustQuantity('eighth_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyWeedWithQuantity(15, 0.125, 'eighth_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="eighth_total">$75</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Quarter -->
                                <div class="mb-3 p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-gray-300">Quarter (¬º oz)</span>
                                        <span class="text-green-400">$28 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('quarter_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="quarter_qty" value="2" min="1" max="20" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateWeedDisplays()">
                                            <button onclick="adjustQuantity('quarter_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyWeedWithQuantity(28, 0.25, 'quarter_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="quarter_total">$56</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- QP Deal (Best Value) -->
                                <div class="mb-3 p-3 bg-green-900/30 rounded border border-green-500/50">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-green-400">üî• QP (4 oz) - BEST DEAL!</span>
                                        <span class="text-green-400">$350 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('qp_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="qp_qty" value="1" min="1" max="10" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateWeedDisplays()">
                                            <button onclick="adjustQuantity('qp_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyWeedWithQuantity(350, 4, 'qp_qty')" class="flex-1 bg-green-600 rounded py-2 text-sm hover:bg-green-500">
                                            Buy <span id="qp_total">$350</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 1LB Deal (Premium) -->
                                <div class="p-3 bg-purple-900/30 rounded border border-purple-500/50">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-purple-400">üíú 1LB (16 oz) - BULK DEAL!</span>
                                        <span class="text-purple-400">$900 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('lb_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="lb_qty" value="1" min="1" max="5" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateWeedDisplays()">
                                            <button onclick="adjustQuantity('lb_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyWeedWithQuantity(900, 16, 'lb_qty')" class="flex-1 bg-purple-600 rounded py-2 text-sm hover:bg-purple-500">
                                            Buy <span id="lb_total">$900</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-yellow-900/30 rounded text-sm">
                            <p class="text-yellow-400">üí° Pro Tip: 1LB saves $540 vs buying 4 QPs!</p>
                            <p class="text-gray-400 mt-1">Thugs need 1 oz per 8 thugs daily</p>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full mt-4 py-3 bg-gray-700 rounded font-bold">Close Store</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            
            // Initialize weed quantity displays
            updateWeedDisplays();
        }
        
        // Enhanced Tony's Chop Shop (embedded)  
        function openTonysChopShop() {
            console.log('üöó OPENING ENHANCED TONY\'S CHOP SHOP with quantity selectors');
            addConsoleMessage('üöó Opening enhanced Tony\'s Chop Shop with quantity selectors', 'cyan');
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full my-8 max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">TONY'S CHOP SHOP</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">üöó Premium Rides ‚Ä¢ Cash: <span class="gold-text">$${gameState.player.cash.toLocaleString()}</span></p>
                        
                        <div class="space-y-4">
                            <!-- Basic Vehicles -->
                            <div class="border border-gray-700 rounded p-4 bg-gray-800/30">
                                <h4 class="font-bold text-blue-400 mb-3">üöó Basic Rides</h4>
                                
                                <!-- Bicycle -->
                                <div class="mb-3 p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <div>
                                            <span class="text-gray-300">Bicycle</span>
                                            <div class="text-xs text-gray-400">Silent getaway bike</div>
                                        </div>
                                        <span class="text-blue-400">$1,000 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('bicycle_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="bicycle_qty" value="1" min="1" max="10" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateVehicleDisplays()">
                                            <button onclick="adjustQuantity('bicycle_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyVehicleWithQuantity('bicycle', 1000, 'bicycle_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="bicycle_total">$1,000</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Motorcycle -->
                                <div class="mb-3 p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <div>
                                            <span class="text-gray-300">Motorcycle</span>
                                            <div class="text-xs text-gray-400">Fast street bike</div>
                                        </div>
                                        <span class="text-blue-400">$3,500 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('motorcycle_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="motorcycle_qty" value="1" min="1" max="5" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateVehicleDisplays()">
                                            <button onclick="adjustQuantity('motorcycle_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyVehicleWithQuantity('motorcycle', 3500, 'motorcycle_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="motorcycle_total">$3,500</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Kia -->
                                <div class="p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <div>
                                            <span class="text-gray-300">Kia Sedan</span>
                                            <div class="text-xs text-gray-400">Reliable Kia sedan</div>
                                        </div>
                                        <span class="text-blue-400">$8,000 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('kia_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="kia_qty" value="1" min="1" max="5" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateVehicleDisplays()">
                                            <button onclick="adjustQuantity('kia_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyVehicleWithQuantity('kia', 8000, 'kia_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="kia_total">$8,000</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Premium Vehicles -->
                            <div class="border border-purple-700 rounded p-4 bg-purple-900/20">
                                <h4 class="font-bold text-purple-400 mb-3">üèÜ Premium Rides</h4>
                                
                                <!-- Lowrider -->
                                <div class="mb-3 p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <div>
                                            <span class="text-gray-300">Lowrider</span>
                                            <div class="text-xs text-gray-400">Classic lowrider - street cred</div>
                                        </div>
                                        <span class="text-purple-400">$15,000 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('lowrider_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="lowrider_qty" value="1" min="1" max="3" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateVehicleDisplays()">
                                            <button onclick="adjustQuantity('lowrider_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyVehicleWithQuantity('lowrider', 15000, 'lowrider_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="lowrider_total">$15,000</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Escalade -->
                                <div class="mb-3 p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <div>
                                            <span class="text-gray-300">Escalade</span>
                                            <div class="text-xs text-gray-400">Luxury Escalade - crew transport</div>
                                        </div>
                                        <span class="text-purple-400">$35,000 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('escalade_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="escalade_qty" value="1" min="1" max="2" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateVehicleDisplays()">
                                            <button onclick="adjustQuantity('escalade_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyVehicleWithQuantity('escalade', 35000, 'escalade_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="escalade_total">$35,000</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Limo -->
                                <div class="mb-3 p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <div>
                                            <span class="text-gray-300">Stretch Limo</span>
                                            <div class="text-xs text-gray-400">Stretch limo - VIP status</div>
                                        </div>
                                        <span class="text-purple-400">$80,000 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('limo_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="limo_qty" value="1" min="1" max="2" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateVehicleDisplays()">
                                            <button onclick="adjustQuantity('limo_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyVehicleWithQuantity('limo', 80000, 'limo_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="limo_total">$80,000</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Bentley -->
                                <div class="mb-3 p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <div>
                                            <span class="text-gray-300">Bentley</span>
                                            <div class="text-xs text-gray-400">Bentley - ultimate luxury</div>
                                        </div>
                                        <span class="text-purple-400">$150,000 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('bentley_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="bentley_qty" value="1" min="1" max="1" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateVehicleDisplays()">
                                            <button onclick="adjustQuantity('bentley_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyVehicleWithQuantity('bentley', 150000, 'bentley_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="bentley_total">$150,000</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Armored Beast -->
                                <div class="p-3 bg-gray-900/50 rounded">
                                    <div class="flex justify-between items-center mb-2">
                                        <div>
                                            <span class="text-gray-300">Armored Beast</span>
                                            <div class="text-xs text-gray-400">Armored Beast - fear factor</div>
                                        </div>
                                        <span class="text-purple-400">$250,000 each</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('armoredBeast_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="armoredBeast_qty" value="1" min="1" max="1" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateVehicleDisplays()">
                                            <button onclick="adjustQuantity('armoredBeast_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyVehicleWithQuantity('armoredBeast', 250000, 'armoredBeast_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="armoredBeast_total">$250,000</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-yellow-900/30 rounded text-sm">
                            <p class="text-yellow-400">üí° Pro Tip: Vehicles provide protection and status!</p>
                            <p class="text-gray-400 mt-1">Higher-end vehicles reduce heat from police</p>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full mt-4 py-3 bg-gray-700 rounded font-bold">Close Shop</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            
            // Initialize vehicle quantity displays
            updateVehicleDisplays();
        }
        
        function buyVehicle(vehicleType, price) {
            if (gameState.player.cash < price) {
                showNotification(`üí∏ Not enough cash! Need $${price.toLocaleString()}`, 'error');
                return;
            }
            
            gameState.player.cash -= price;
            gameState.resources.vehicles[vehicleType] = (gameState.resources.vehicles[vehicleType] || 0) + 1;
            
            showNotification(`üöó Bought ${vehicleType} for $${price.toLocaleString()}!`, 'success');
            updateUI();
            saveGameState();
        }

        function updateVehicleDisplays() {
            // Update all vehicle totals
            const vehicles = ['bicycle', 'motorcycle', 'kia', 'lowrider', 'escalade', 'limo', 'bentley', 'armoredBeast'];
            const prices = [1000, 3500, 8000, 15000, 35000, 80000, 150000, 250000];
            
            vehicles.forEach((vehicle, index) => {
                const qtyInput = document.getElementById(`${vehicle}_qty`);
                const totalEl = document.getElementById(`${vehicle}_total`);
                if (qtyInput && totalEl) {
                    const quantity = parseInt(qtyInput.value) || 1;
                    const total = quantity * prices[index];
                    totalEl.textContent = `$${total.toLocaleString()}`;
                }
            });
        }

        function buyVehicleWithQuantity(vehicleType, unitPrice, qtyInputId) {
            const qtyInput = document.getElementById(qtyInputId);
            if (!qtyInput) {
                showNotification('‚ùå Quantity input not found', 'error');
                return;
            }
            
            const quantity = parseInt(qtyInput.value) || 1;
            const totalCost = unitPrice * quantity;
            
            console.log(`üöó Buying ${quantity} ${vehicleType} for $${totalCost}`);
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}, have $${gameState.player.cash.toLocaleString()}`, 'error');
                return;
            }
            
            // Initialize vehicles object if it doesn't exist
            if (!gameState.resources.vehicles) {
                gameState.resources.vehicles = {};
            }
            
            gameState.player.cash -= totalCost;
            gameState.resources.vehicles[vehicleType] = (gameState.resources.vehicles[vehicleType] || 0) + quantity;
            
            const displayText = quantity === 1 ? vehicleType : `${quantity} ${vehicleType}s`;
            showNotification(`üöó Bought ${displayText} for $${totalCost.toLocaleString()}!`, 'success');
            addConsoleMessage(`üí∞ Tony's Chop Shop: ${displayText} purchased for $${totalCost.toLocaleString()}`, 'green');
            
            updateUI();
            saveGameState();
            updateVehicleDisplays();
        }

        function openReggiesSpot() {
            const store = STORES["Reggie's Spot"];
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-xl font-bold cyan-glow mb-2">REGGIE'S SPOT</h3>
                        <p class="text-sm text-gray-400 mb-4">üåø Premium Weed ‚Ä¢ Heat +5 per purchase</p>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span>Eighth (‚Öõ oz) - $15</span>
                                <button onclick="buyWeed(15, 0.125)" class="px-3 py-1 action-btn rounded text-sm">Buy</button>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Quarter (¬º oz) - $28</span>
                                <button onclick="buyWeed(28, 0.25)" class="px-3 py-1 action-btn rounded text-sm">Buy</button>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Half (¬Ω oz) - $55</span>
                                <button onclick="buyWeed(55, 0.5)" class="px-3 py-1 action-btn rounded text-sm">Buy</button>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Ounce - $100</span>
                                <button onclick="buyWeed(100, 1)" class="px-3 py-1 action-btn rounded text-sm">Buy</button>
                            </div>
                            <div class="flex justify-between items-center bg-green-900/50 p-2 rounded">
                                <span>üî• QP (4 oz) - $350</span>
                                <button onclick="buyWeed(350, 4)" class="px-3 py-1 action-btn rounded text-sm">BEST DEAL!</button>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Pound (16 oz) - $1,200</span>
                                <button onclick="buyWeed(1200, 16)" class="px-3 py-1 action-btn rounded text-sm">Bulk</button>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-yellow-900/30 rounded text-sm">
                            <p class="text-yellow-400">üí° Pro Tip: QP saves $50 vs buying 4 singles!</p>
                            <p class="text-gray-400 mt-1">Thugs need 1 oz per 8 thugs daily</p>
                        </div>
                        
                        <div class="mt-4 text-sm gold-text">Cash: $${gameState.player.cash.toLocaleString()}</div>
                        <button onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-700 rounded">Close</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        function openGunStore() {
            const respectReq = gameState.player.respect < 10;
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full my-8 max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">üí• PEW PEW JIMMY'S</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">üí• Premium Firepower ‚Ä¢ Cash: <span class="gold-text">$${gameState.player.cash.toLocaleString()}</span></p>
                        
                        ${respectReq ? '<div class="mb-4 p-3 bg-red-900/50 rounded text-red-400">‚ö†Ô∏è Need 10+ respect for better weapons!</div>' : ''}
                        
                        <div class="space-y-4">
                            <!-- Thugs -->
                            <div class="border border-gray-700 rounded p-4 bg-gray-800/30">
                                <h4 class="font-bold text-blue-400 mb-3">üë• Hire Thugs ($1,000 each)</h4>
                                <div class="p-3 bg-gray-900/50 rounded">
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('thugs_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="thugs_qty" value="1" min="1" max="20" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateGunStoreDisplays()">
                                            <button onclick="adjustQuantity('thugs_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyThugsWithQuantity()" class="flex-1 action-btn rounded py-2 text-sm">
                                            Hire <span id="thugs_total">$1,000</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pistols -->
                            <div class="border border-gray-700 rounded p-4 bg-gray-800/30">
                                <h4 class="font-bold text-red-400 mb-3">üî´ Pistols ($250 each)</h4>
                                <div class="p-3 bg-gray-900/50 rounded">
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('pistols_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="pistols_qty" value="5" min="1" max="50" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateGunStoreDisplays()">
                                            <button onclick="adjustQuantity('pistols_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyWeaponsWithQuantity('pistols', 250)" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="pistols_total">$1,250</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Shotguns -->
                            <div class="border border-gray-700 rounded p-4 bg-gray-800/30">
                                <h4 class="font-bold text-orange-400 mb-3">üî´ Shotguns ($1,250 each)</h4>
                                <div class="p-3 bg-gray-900/50 rounded">
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center gap-2">
                                            <button onclick="adjustQuantity('shotguns_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                            <input type="number" id="shotguns_qty" value="2" min="1" max="20" 
                                                   class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                   oninput="updateGunStoreDisplays()">
                                            <button onclick="adjustQuantity('shotguns_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                        </div>
                                        <button onclick="buyWeaponsWithQuantity('shotguns', 1250)" class="flex-1 action-btn rounded py-2 text-sm">
                                            Buy <span id="shotguns_total">$2,500</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- High-End Weapons (Respect Required) -->
                            ${!respectReq ? `
                                <div class="border border-purple-700 rounded p-4 bg-purple-900/20">
                                    <h4 class="font-bold text-purple-400 mb-3">üî´ Premium Weapons</h4>
                                    
                                    <!-- MP5 -->
                                    <div class="mb-3 p-3 bg-gray-900/50 rounded">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-gray-300">MP5 ($2,500 each)</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div class="flex items-center gap-2">
                                                <button onclick="adjustQuantity('mp5_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                                <input type="number" id="mp5_qty" value="1" min="1" max="10" 
                                                       class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                       oninput="updateGunStoreDisplays()">
                                                <button onclick="adjustQuantity('mp5_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                            </div>
                                            <button onclick="buyWeaponsWithQuantity('tek9s', 2500, 'mp5_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                                Buy <span id="mp5_total">$2,500</span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- AK-47 -->
                                    <div class="p-3 bg-gray-900/50 rounded">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-gray-300">AK-47 ($5,500 each)</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div class="flex items-center gap-2">
                                                <button onclick="adjustQuantity('ak47_qty', -1)" class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500">-</button>
                                                <input type="number" id="ak47_qty" value="1" min="1" max="5" 
                                                       class="w-20 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                       oninput="updateGunStoreDisplays()">
                                                <button onclick="adjustQuantity('ak47_qty', 1)" class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500">+</button>
                                            </div>
                                            <button onclick="buyWeaponsWithQuantity('ak47s', 5500, 'ak47_qty')" class="flex-1 action-btn rounded py-2 text-sm">
                                                Buy <span id="ak47_total">$5,500</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-4 p-3 bg-purple-900/30 rounded text-sm">
                            <p class="text-purple-400">Your Respect: ${gameState.player.respect}</p>
                            <p class="text-gray-400 mt-1">Gain respect by defeating NPCs and selling drugs</p>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full mt-4 py-3 bg-gray-700 rounded font-bold">Close</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            
            // Initialize gun store quantity displays
            updateGunStoreDisplays();
        }
        
        // Gun store quantity functions
        function updateGunStoreDisplays() {
            // Update thugs total
            const thugsQty = parseInt(document.getElementById('thugs_qty')?.value) || 0;
            const thugsTotalEl = document.getElementById('thugs_total');
            if (thugsTotalEl) {
                thugsTotalEl.textContent = `$${(thugsQty * 1000).toLocaleString()}`;
            }
            
            // Update pistols total
            const pistolsQty = parseInt(document.getElementById('pistols_qty')?.value) || 0;
            const pistolsTotalEl = document.getElementById('pistols_total');
            if (pistolsTotalEl) {
                pistolsTotalEl.textContent = `$${(pistolsQty * 250).toLocaleString()}`;
            }
            
            // Update shotguns total
            const shotgunsQty = parseInt(document.getElementById('shotguns_qty')?.value) || 0;
            const shotgunsTotalEl = document.getElementById('shotguns_total');
            if (shotgunsTotalEl) {
                shotgunsTotalEl.textContent = `$${(shotgunsQty * 1250).toLocaleString()}`;
            }
            
            // Update MP5 total
            const mp5Qty = parseInt(document.getElementById('mp5_qty')?.value) || 0;
            const mp5TotalEl = document.getElementById('mp5_total');
            if (mp5TotalEl) {
                mp5TotalEl.textContent = `$${(mp5Qty * 2500).toLocaleString()}`;
            }
            
            // Update AK-47 total
            const ak47Qty = parseInt(document.getElementById('ak47_qty')?.value) || 0;
            const ak47TotalEl = document.getElementById('ak47_total');
            if (ak47TotalEl) {
                ak47TotalEl.textContent = `$${(ak47Qty * 5500).toLocaleString()}`;
            }
        }
        
        function buyThugsWithQuantity() {
            const qtyInput = document.getElementById('thugs_qty');
            const quantity = parseInt(qtyInput?.value) || 1;
            const totalCost = 1000 * quantity;
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}`, 'error');
                return;
            }
            
            gameState.player.cash -= totalCost;
            
            // Create new thug crew members
            for (let i = 0; i < quantity; i++) {
                gameState.crew.thugs.push(createThug());
            }
            syncThugCount('gun_store_purchase');
            
            const displayText = quantity === 1 ? 'thug' : `${quantity} thugs`;
            showNotification(`üë• Hired ${displayText} for $${totalCost.toLocaleString()}!`, 'success');
            addConsoleMessage(`üí∞ Pew Pew Jimmy's: Hired ${displayText} for $${totalCost.toLocaleString()}`, 'green');
            
            updateUI();
            saveGameState();
            updateGunStoreAfterPurchase();
        }
        
        function buyWeaponsWithQuantity(weaponType, unitPrice, customQtyId = null) {
            const qtyId = customQtyId || `${weaponType}_qty`;
            const qtyInput = document.getElementById(qtyId);
            const quantity = parseInt(qtyInput?.value) || 1;
            const totalCost = unitPrice * quantity;
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}`, 'error');
                return;
            }
            
            if (weaponType !== 'pistols' && gameState.player.respect < 10) {
                showNotification('‚ùå Need 10+ respect for advanced weapons!', 'error');
                return;
            }
            
            gameState.player.cash -= totalCost;
            
            // Add weapons to inventory
            if (!gameState.resources.weapons[weaponType]) {
                gameState.resources.weapons[weaponType] = 0;
            }
            
            const oldWeapons = gameState.resources.weapons[weaponType];
            logResourceChange('weapons', weaponType, oldWeapons, oldWeapons + quantity, 'gun_store_purchase');
            gameState.resources.weapons[weaponType] += quantity;
            
            const displayText = quantity === 1 ? weaponType.slice(0, -1) : `${quantity} ${weaponType}`;
            showNotification(`üî´ Bought ${displayText} for $${totalCost.toLocaleString()}!`, 'success');
            addConsoleMessage(`üí∞ Pew Pew Jimmy's: ${displayText} purchased for $${totalCost.toLocaleString()}`, 'green');
            
            updateUI();
            saveGameState();
            updateGunStoreAfterPurchase();
        }
        
        function updateGunStoreAfterPurchase() {
            // Update cash display in gun store modal
            const cashElements = document.querySelectorAll('.gold-text');
            cashElements.forEach(el => {
                if (el.textContent.includes('$') && el.textContent.includes(',')) {
                    el.textContent = `$${gameState.player.cash.toLocaleString()}`;
                }
            });
            
            // Update all gun store quantity displays
            updateGunStoreDisplays();
        }

        // Buy functions
        function buyStoreItem(item, price, quantity, multiplier = 1) {
            const totalCost = price * multiplier;
            const totalQuantity = quantity * multiplier;
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}`, 'error');
                return;
            }
            
            gameState.player.cash -= totalCost;
            gameState.resources[item] = (gameState.resources[item] || 0) + totalQuantity;
            
            showNotification(`üõí Bought ${totalQuantity} ${item} for $${totalCost}!`, 'success');
            addConsoleMessage(`Bought ${totalQuantity} ${item} for $${totalCost}`, 'green');
            updateUI();
            updateSupplyStatus();
            saveLocalGameState();
            closeModal();
            showStoreMenu();
        }

        function buyWeed(price, ounces) {
            if (gameState.player.cash < price) {
                showNotification(`üí∏ Not enough cash! Need $${price}, have $${gameState.player.cash}`, 'error');
                return;
            }
            
            gameState.player.cash -= price;
            gameState.resources.weed += ounces;
            gameState.player.heat = Math.min(100, gameState.player.heat + 5);
            
            // Quality variance
            const quality = 0.8 + Math.random() * 0.4;
            const qualityText = quality > 1.1 ? ' (üî• Fire!)' : quality < 0.9 ? ' (Mid)' : '';
            
            showNotification(`‚úÖ Bought ${ounces}oz weed for $${price}!${qualityText} Heat +5%`, 'success');
            addConsoleMessage(`üåø Reggie's: ${ounces}oz weed for $${price} (+5% heat)${qualityText}`, 'green');
            updateUI();
            updateSupplyStatus();
            closeModal();
        }

        // Weed quantity display updates for enhanced interface
        function updateWeedDisplays() {
            // Update eighth total
            const eighthQty = parseInt(document.getElementById('eighth_qty')?.value) || 0;
            const eighthTotalEl = document.getElementById('eighth_total');
            if (eighthTotalEl) {
                eighthTotalEl.textContent = `$${(eighthQty * 15).toLocaleString()}`;
            }
            
            // Update quarter total
            const quarterQty = parseInt(document.getElementById('quarter_qty')?.value) || 0;
            const quarterTotalEl = document.getElementById('quarter_total');
            if (quarterTotalEl) {
                quarterTotalEl.textContent = `$${(quarterQty * 28).toLocaleString()}`;
            }
            
            // Update QP total
            const qpQty = parseInt(document.getElementById('qp_qty')?.value) || 0;
            const qpTotalEl = document.getElementById('qp_total');
            if (qpTotalEl) {
                qpTotalEl.textContent = `$${(qpQty * 350).toLocaleString()}`;
            }
            
            // Update 1LB total
            const lbQty = parseInt(document.getElementById('lb_qty')?.value) || 0;
            const lbTotalEl = document.getElementById('lb_total');
            if (lbTotalEl) {
                lbTotalEl.textContent = `$${(lbQty * 900).toLocaleString()}`;
            }
        }

        // Enhanced weed buying with quantity
        function buyWeedWithQuantity(unitPrice, ouncesPer, qtyInputId) {
            const qtyInput = document.getElementById(qtyInputId);
            const quantity = parseInt(qtyInput?.value) || 1;
            const totalCost = unitPrice * quantity;
            const totalOunces = ouncesPer * quantity;
            
            if (gameState.player.cash < totalCost) {
                showNotification(`üí∏ Not enough cash! Need $${totalCost.toLocaleString()}`, 'error');
                return;
            }
            
            gameState.player.cash -= totalCost;
            gameState.resources.weed = (gameState.resources.weed || 0) + totalOunces;
            gameState.player.heat = Math.min(100, (gameState.player.heat || 0) + 5); // +5 heat per purchase
            
            // Quality variance
            const quality = 0.8 + Math.random() * 0.4;
            const qualityText = quality > 1.1 ? ' (üî• Fire!)' : quality < 0.9 ? ' (Mid)' : '';
            
            const displayText = quantity === 1 ? `${ouncesPer}oz weed` : `${quantity}x ${ouncesPer}oz weed (${totalOunces}oz total)`;
            showNotification(`üåø Bought ${displayText} for $${totalCost.toLocaleString()}!${qualityText} Heat +5%`, 'success');
            addConsoleMessage(`üí∞ Reggie's Plug: ${displayText} purchased for $${totalCost.toLocaleString()} (+5% heat)${qualityText}`, 'green');
            
            updateUI();
            saveGameState();
            updateWeedStoreAfterPurchase();
        }

        function updateWeedStoreAfterPurchase() {
            // Update cash display in store modal
            const cashElements = document.querySelectorAll('.gold-text');
            cashElements.forEach(el => {
                if (el.textContent.includes('$') && el.textContent.includes(',')) {
                    el.textContent = `$${gameState.player.cash.toLocaleString()}`;
                }
            });
            
            // Update all weed quantity displays
            updateWeedDisplays();
        }

        function buyWeapon(weaponType, price) {
            if (gameState.player.cash < price) {
                alert('Not enough cash!');
                return;
            }
            
            if (weaponType !== 'pistols' && weaponType !== 'thugs' && gameState.player.respect < 10) {
                alert('Need 10+ respect for better weapons!');
                return;
            }
            
            gameState.player.cash -= price;
            
            if (weaponType === 'thugs') {
                // SAFE thug recruitment with logging
                const oldThugs = gameState.resources.thugs;
                const newThugs = oldThugs + 1;
                logResourceChange('thugs', null, oldThugs, newThugs, 'purchase_from_store');
                gameState.resources.thugs = newThugs;
                
                // Create crew member
                gameState.crew.thugs.push(createThug());
                syncThugCount('thug_purchase');
            } else {
                // SAFE weapon purchase with logging
                const oldWeapons = gameState.resources.weapons[weaponType] || 0;
                const newWeapons = oldWeapons + 1;
                logResourceChange('weapons', weaponType, oldWeapons, newWeapons, 'purchase_from_store');
                gameState.resources.weapons[weaponType] = newWeapons;
            }
            
            showNotification(`üî´ Bought ${weaponType} for $${price}!`, 'success');
            addConsoleMessage(`Bought 1 ${weaponType} for $${price}`, 'green');
            updateUI();
            saveLocalGameState();
            closeModal();
            showStoreMenu();
        }

        function buyMultiple(itemType, price, quantity) {
            const totalCost = price * quantity;
            
            if (gameState.player.cash < totalCost) {
                alert(`Not enough cash! Need $${totalCost.toLocaleString()}`);
                return;
            }
            
            if (itemType !== 'pistols' && itemType !== 'thugs' && gameState.player.respect < 10) {
                alert('Need 10+ respect for better weapons!');
                return;
            }
            
            gameState.player.cash -= totalCost;
            
            if (itemType === 'thugs') {
                gameState.resources.thugs += quantity;
            } else {
                gameState.resources.weapons[itemType] = (gameState.resources.weapons[itemType] || 0) + quantity;
            }
            
            showNotification(`üõí Bought ${quantity} ${itemType} for $${totalCost.toLocaleString()}!`, 'success');
            addConsoleMessage(`Bought ${quantity} ${itemType} for $${totalCost.toLocaleString()}`, 'green');
            updateUI();
            saveLocalGameState();
            closeModal();
            showStoreMenu();
        }

        // Original PimpWar happiness calculation
        function calculateHappiness() {
            // HOE HAPPINESS (original formula)
            let hoeHappiness = 50; // Base
            
            // Payout rate impact (original mechanic)
            const payoutRate = gameState.player.payoutPercentage || 30;
            if (payoutRate >= 40) hoeHappiness += 30;
            else if (payoutRate >= 30) hoeHappiness += 20;
            else if (payoutRate >= 20) hoeHappiness += 10;
            
            // Supplies impact
            const condomsPerHoe = gameState.resources.condoms / Math.max(1, gameState.resources.hoes);
            const crackPerHoe = gameState.resources.crack / Math.max(1, gameState.resources.hoes);
            const protectionRatio = gameState.resources.thugs / Math.max(1, gameState.resources.hoes);
            
            if (condomsPerHoe >= 10) hoeHappiness += 20;
            if (crackPerHoe >= 1) hoeHappiness += 20;
            if (protectionRatio >= 0.5) hoeHappiness += 10;
            
            // Original glitch: When thugs > hoes, happiness drops
            if (gameState.resources.thugs > gameState.resources.hoes) {
                hoeHappiness -= 30; // Original bug/feature
            }
            
            gameState.supplies.hoeHappiness = Math.max(0, Math.min(100, hoeHappiness));
            
            // THUG HAPPINESS (realistic street formula)
            let thugHappiness = 30; // Lower base - street life is hard
            
            // Essential Supplies (thugs need their vices!)
            const thugsCount = Math.max(1, gameState.resources.thugs);
            
            // WEED - Critical for thug morale (each thug needs ~0.125oz per day)
            const weedPerThug = gameState.resources.weed / thugsCount;
            if (weedPerThug >= 1.0) thugHappiness += 35; // Abundant chronic
            else if (weedPerThug >= 0.5) thugHappiness += 20; // Good supply
            else if (weedPerThug >= 0.125) thugHappiness += 10; // Minimal
            else thugHappiness -= 25; // No weed = angry thugs
            
            // ALCOHOL - Need proper drinks (40oz malt liquor, Hennessy)
            const beerPerThug = gameState.resources.beer / thugsCount;
            if (beerPerThug >= 25) thugHappiness += 25; // Plenty of 40oz
            else if (beerPerThug >= 10) thugHappiness += 15; // Decent supply
            else if (beerPerThug >= 5) thugHappiness += 5; // Basic needs
            else thugHappiness -= 20; // Dry = unhappy
            
            // WEAPONS - Street credibility (1 gun per thug minimum)
            const totalWeapons = Object.values(gameState.resources.weapons).reduce((a, b) => a + b, 0);
            const weaponsPerThug = totalWeapons / thugsCount;
            if (weaponsPerThug >= 1.5) thugHappiness += 20; // Well armed
            else if (weaponsPerThug >= 1.0) thugHappiness += 10; // Armed
            else if (weaponsPerThug >= 0.5) thugHappiness += 5; // Some protection
            else thugHappiness -= 15; // Unarmed = vulnerable
            
            // RESPECT/TERRITORY - Thugs need to feel important
            if (gameState.player.respect >= 50) thugHappiness += 10;
            else if (gameState.player.respect <= 0) thugHappiness -= 10;
            
            gameState.supplies.thugHappiness = Math.max(0, Math.min(100, thugHappiness));
        }

        // Supply consumption (DISABLED for single-player - no asset losses!)
        function consumeSupplies() {
            // DISABLED: In single-player mode, supplies don't get consumed
            // This prevents mysterious asset losses
            // Future: In multiplayer PvP, supply consumption will matter for strategy
            
            const now = Date.now();
            const hoursSinceLastConsume = (now - gameState.supplies.lastConsumedAt) / (1000 * 60 * 60);
            
            if (hoursSinceLastConsume >= 24) {
                // Just update the timestamp and recalculate happiness
                // NO ACTUAL CONSUMPTION - assets only go UP in single-player!
                
                gameState.supplies.lastConsumedAt = now;
                calculateHappiness();
                
                // Informational only - no actual consumption
                const beerNeeded = gameState.resources.thugs * 4;
                const condomsNeeded = gameState.resources.hoes * 4;
                addConsoleMessage(`üìä Daily supply usage: ${beerNeeded} beer, ${condomsNeeded} condoms (not consumed in single-player)`, 'cyan');
                
                // Happiness calculations remain for strategy purposes
                if (gameState.supplies.thugHappiness < 40) {
                    addConsoleMessage('üí° Buy more beer and weapons to improve thug happiness!', 'yellow');
                }
                if (gameState.supplies.hoeHappiness < 40) {
                    addConsoleMessage('üí° Improve payout % and buy condoms to improve hoe happiness!', 'yellow');
                }
                
                updateSupplyStatus();
            }
        }

        // Update supply status display
        function updateSupplyStatus() {
            // Beer
            const beerDaily = SUPPLY_CONSUMPTION.beer.formula(gameState.resources.thugs, gameState.supplies.thugHappiness);
            const beerDays = gameState.resources.beer / beerDaily;
            document.getElementById('beerCount').textContent = gameState.resources.beer;
            document.getElementById('beerDays').textContent = `(${beerDays.toFixed(1)} days)`;
            document.getElementById('beerDays').className = beerDays < 1 ? 'text-xs text-red-400 ml-1' : 
                                                          beerDays < 3 ? 'text-xs text-yellow-400 ml-1' : 
                                                          'text-xs text-green-400 ml-1';
            
            // Weed
            const weedDaily = SUPPLY_CONSUMPTION.weed.formula(gameState.resources.thugs);
            const weedDays = gameState.resources.weed / weedDaily;
            
            const weedCountEl = document.getElementById('weedCount');
            const weedDaysEl = document.getElementById('weedDays');
            
            if (weedCountEl) {
                weedCountEl.textContent = (gameState.resources.weed || 0).toFixed(2) + ' oz';
                console.log('üíö Updated weed display:', weedCountEl.textContent, 'from value:', gameState.resources.weed);
            }
            if (weedDaysEl) {
                weedDaysEl.textContent = `(${weedDays.toFixed(1)} days)`;
                weedDaysEl.className = weedDays < 1 ? 'text-xs text-red-400 ml-1' : 
                                      weedDays < 3 ? 'text-xs text-yellow-400 ml-1' : 
                                      'text-xs text-green-400 ml-1';
            }
            
            // Condoms
            const condomDaily = SUPPLY_CONSUMPTION.condoms.formula(gameState.resources.hoes);
            const condomDays = gameState.resources.condoms / condomDaily;
            document.getElementById('condomCount').textContent = gameState.resources.condoms;
            document.getElementById('condomDays').textContent = `(${condomDays.toFixed(1)} days)`;
            document.getElementById('condomDays').className = condomDays < 1 ? 'text-xs text-red-400 ml-1' : 
                                                             condomDays < 3 ? 'text-xs text-yellow-400 ml-1' : 
                                                             'text-xs text-green-400 ml-1';
            
            // Medicine
            document.getElementById('medicineCount').textContent = gameState.resources.medicine;
            
            // Crack
            const crackCountEl = document.getElementById('crackCount');
            if (crackCountEl) {
                crackCountEl.textContent = gameState.resources.crack || 0;
            }
            
            // Weapons
            const weaponsCountEl = document.getElementById('weaponsCount');
            if (weaponsCountEl) {
                // Ensure weapons object is valid
                if (!gameState.resources.weapons || typeof gameState.resources.weapons !== 'object') {
                    gameState.resources.weapons = {
                        pistols: 0,
                        shotguns: 0,
                        tek9s: 0,
                        ak47s: 0
                    };
                }
                
                // Calculate total weapons safely
                let totalWeapons = 0;
                Object.entries(gameState.resources.weapons).forEach(([weapon, count]) => {
                    if (typeof count === 'number' && !isNaN(count)) {
                        totalWeapons += count;
                    }
                });
                
                weaponsCountEl.textContent = totalWeapons;
                console.log('üî´ Weapons count updated:', totalWeapons, 'from object:', gameState.resources.weapons);
            }
            
            // Vehicles
            const vehiclesCountEl = document.getElementById('vehiclesCount');
            if (vehiclesCountEl) {
                // Ensure vehicles object is valid
                if (!gameState.resources.vehicles || typeof gameState.resources.vehicles !== 'object') {
                    gameState.resources.vehicles = {
                        bicycle: 0,
                        motorcycle: 0,
                        kia: 0,
                        lowrider: 0,
                        escalade: 0,
                        limo: 0,
                        bentley: 0,
                        armoredBeast: 0
                    };
                }
                
                // Calculate total vehicles safely
                let totalVehicles = 0;
                Object.entries(gameState.resources.vehicles).forEach(([vehicle, count]) => {
                    if (typeof count === 'number' && !isNaN(count)) {
                        totalVehicles += count;
                    }
                });
                
                vehiclesCountEl.textContent = totalVehicles;
                console.log('üöó Vehicles count updated:', totalVehicles, 'from object:', gameState.resources.vehicles);
            }
            
            // Warnings
            const warnings = document.getElementById('supplyWarnings');
            warnings.innerHTML = '';
            
            // Thug-specific warnings (they need their chronic and 40oz!)
            if (gameState.resources.thugs > 0) {
                const weedPerThug = gameState.resources.weed / gameState.resources.thugs;
                const beerPerThug = gameState.resources.beer / gameState.resources.thugs;
                
                if (weedPerThug < 0.125) {
                    warnings.innerHTML += '<div class="text-xs text-red-400 mt-1">üåø THUGS NEED CHRONIC!</div>';
                } else if (weedPerThug < 0.5) {
                    warnings.innerHTML += '<div class="text-xs text-yellow-400 mt-1">üåø Thugs want more weed</div>';
                }
                
                if (beerPerThug < 5) {
                    warnings.innerHTML += '<div class="text-xs text-red-400 mt-1">üç∫ THUGS NEED 40OZ!</div>';
                } else if (beerPerThug < 10) {
                    warnings.innerHTML += '<div class="text-xs text-yellow-400 mt-1">üç∫ Thugs want more drinks</div>';
                }
                
                const totalWeapons = Object.values(gameState.resources.weapons).reduce((a, b) => a + b, 0);
                if (totalWeapons < gameState.resources.thugs) {
                    warnings.innerHTML += '<div class="text-xs text-red-400 mt-1">üî´ THUGS NEED WEAPONS!</div>';
                }
            }
            
            // Hoe warnings
            if (gameState.resources.hoes > 0) {
                if (condomDays < 1) {
                    warnings.innerHTML += '<div class="text-xs text-red-400 mt-1">‚ö†Ô∏è HOES NEED CONDOMS!</div>';
                }
            }
            
            // General supply warnings
            if (beerDays < 1 && gameState.resources.thugs === 0) {
                warnings.innerHTML += '<div class="text-xs text-yellow-400 mt-1">‚ö†Ô∏è Out of beer</div>';
            }
        }

        // Sell drugs modal
        function sellDrugs() {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-xl font-bold cyan-glow mb-4">SELL DRUGS</h3>
                        
                        <div class="space-y-4">
                            <!-- Crack -->
                            <div class="border-b border-gray-700 pb-3">
                                <h4 class="font-bold text-white mb-2">Crack Rocks (${gameState.resources.crack})</h4>
                                <div class="space-y-2">
                                    <button onclick="sellCrack(10)" ${gameState.resources.crack < 10 ? 'disabled' : ''} 
                                            class="w-full py-2 action-btn rounded text-sm">
                                        Sell 10 for $100 (+1 heat)
                                    </button>
                                    <button onclick="sellCrack(100)" ${gameState.resources.crack < 100 ? 'disabled' : ''} 
                                            class="w-full py-2 action-btn rounded text-sm">
                                        Sell 100 for $800 (bulk) (+2 heat)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Weed -->
                            <div>
                                <h4 class="font-bold text-white mb-2">Weed (${gameState.resources.weed.toFixed(2)} oz)</h4>
                                <div class="space-y-2">
                                    <button onclick="sellWeed(1)" ${gameState.resources.weed < 1 ? 'disabled' : ''} 
                                            class="w-full py-2 action-btn rounded text-sm">
                                        Sell 1 oz for $150 (+1 heat)
                                    </button>
                                    <button onclick="sellWeed(4)" ${gameState.resources.weed < 4 ? 'disabled' : ''} 
                                            class="w-full py-2 action-btn rounded text-sm">
                                        Sell QP for $540 (bulk) (+4 heat)
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-red-900/30 rounded text-sm">
                            <p class="text-red-400">‚ö†Ô∏è Current Heat: ${gameState.player.heat}%</p>
                            <p class="text-gray-400 mt-1">High heat increases police attention!</p>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-700 rounded">Close</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        function sellCrack(amount) {
            if (gameState.resources.crack < amount) {
                showNotification(`‚ùå Not enough crack! Need ${amount}, have ${gameState.resources.crack}`, 'error');
                return;
            }
            
            const price = amount >= 100 ? 9 : 10; // Better bulk pricing
            const revenue = amount * price;
            const heatGain = Math.floor(amount / 50) + 1;
            
            // Risk check (reduced for better gameplay)
            if (Math.random() < 0.01) { // Reduced from 2% to 1%
                gameState.resources.crack -= amount;
                gameState.player.heat = Math.min(100, gameState.player.heat + heatGain * 2);
                addConsoleMessage('üö® Cops busted the deal! Lost crack and gained heat!', 'red');
                showNotification('üö® Drug bust! Lost crack and heat!', 'error');
                updateCrackAndDrugsModal(); // Update modal instead of closing
                return;
            }
            
            gameState.resources.crack -= amount;
            gameState.player.cash += revenue;
            gameState.player.heat = Math.min(100, gameState.player.heat + heatGain);
            gameState.player.respect += Math.floor(amount / 100);
            
            addConsoleMessage(`üí∞ Sold ${amount} crack for $${revenue}`, 'green');
            addConsoleMessage(`üî• Heat: +${heatGain}%, Respect: +${Math.floor(amount / 100)}`, 'cyan');
            showNotification(`üí∞ Sold ${amount} crack for $${revenue}!`, 'success');
            
            updateUI();
            updateCrackAndDrugsModal(); // Update modal instead of closing
            saveGameState();
        }

        // Enhanced Crack Economics Functions
        const CRACK_INCREMENT = 100; // Standard increment/decrement amount
        
        function getCrackPrice(amount) {
            // Authentic 1991 NYC crack prices - bulk gets CHEAPER per unit
            let pricePerRock;
            if (amount >= 10000) pricePerRock = 6;   // Deep wholesale - $6/rock (~$6,000/kg equivalent)
            else if (amount >= 5000) pricePerRock = 7;   // Large wholesale - $7/rock  
            else if (amount >= 1000) pricePerRock = 9;   // Mid-level bulk - $9/rock
            else if (amount >= 100) pricePerRock = 12;   // Small bulk - $12/rock
            else if (amount >= 10) pricePerRock = 15;    // Street level - $15/rock
            else pricePerRock = 18; // Single rock street price - $18/rock
            return pricePerRock;
        }

        function calculateHeatGain(amount) {
            // Reasonable tiered heat scaling - not too punitive for bulk sales
            if (amount <= 0) return 1;   // Minimum heat
            if (amount <= 50) return 2;  // Very small sales - minimal heat
            if (amount <= 200) return 4; // Small sales
            if (amount <= 1000) return 8; // Medium sales  
            if (amount <= 5000) return 15; // Large sales
            if (amount <= 15000) return 25; // Very large sales
            return 35; // Cap for massive sales - still manageable
        }

        function updateSellEstimate() {
            const input = document.getElementById('crackSellAmount');
            const slider = document.getElementById('crackSellSlider');
            const priceDisplay = document.getElementById('crackPriceDisplay');
            const totalDisplay = document.getElementById('crackTotalDisplay');
            const heatDisplay = document.getElementById('crackHeatDisplay');
            
            if (!input || !slider || !priceDisplay || !totalDisplay || !heatDisplay) return;
            
            const amount = parseInt(input.value) || 0;
            const availableCrack = gameState.resources.crack || 0;
            const maxAmount = Math.min(amount, availableCrack);
            
            // Update slider to match input
            slider.value = Math.min(amount, parseInt(slider.max));
            
            if (maxAmount > 0) {
                const pricePerRock = getCrackPrice(maxAmount);
                const totalRevenue = maxAmount * pricePerRock;
                const heatGain = calculateHeatGain(maxAmount);
                
                // Show appropriate pricing context
                let priceText = `$${pricePerRock}/rock`;
                if (maxAmount >= 10000) priceText += ' (deep wholesale!)';
                else if (maxAmount >= 5000) priceText += ' (wholesale!)';
                else if (maxAmount >= 1000) priceText += ' (dealer rate!)';
                else if (maxAmount >= 100) priceText += ' (bulk discount!)';
                else if (maxAmount >= 10) priceText += ' (street rate)';
                else priceText += ' (single rock)';
                
                priceDisplay.textContent = priceText;
                totalDisplay.textContent = `$${totalRevenue.toLocaleString()}`;
                heatDisplay.textContent = `+${heatGain}%`;
                
                // Update display color based on pricing tier
                if (maxAmount >= 10000) {
                    priceDisplay.className = 'text-purple-400 font-bold'; // Deep wholesale
                } else if (maxAmount >= 5000) {
                    priceDisplay.className = 'text-green-400 font-bold';  // Wholesale
                } else if (maxAmount >= 1000) {
                    priceDisplay.className = 'text-blue-400 font-bold';   // Dealer
                } else if (maxAmount >= 100) {
                    priceDisplay.className = 'text-yellow-400';           // Bulk
                } else if (maxAmount >= 10) {
                    priceDisplay.className = 'text-orange-400';           // Street
                } else {
                    priceDisplay.className = 'text-red-400';              // Single rock
                }
            } else {
                priceDisplay.textContent = '$18/rock';
                totalDisplay.textContent = '$0';
                heatDisplay.textContent = '+0%';
                priceDisplay.className = 'text-gray-300';
            }
        }

        function setSellAmount(amount) {
            const input = document.getElementById('crackSellAmount');
            const slider = document.getElementById('crackSellSlider');
            const availableCrack = gameState.resources.crack || 0;
            
            if (amount === 'max') {
                amount = availableCrack;
            }
            
            const actualAmount = Math.min(amount, availableCrack);
            
            if (input) input.value = actualAmount;
            if (slider) slider.value = Math.min(actualAmount, parseInt(slider.max));
            
            updateSellEstimate();
        }

        function sellCrackCustom() {
            const input = document.getElementById('crackSellAmount');
            const amount = parseInt(input?.value) || 0;
            
            if (amount <= 0) {
                showNotification('‚ùå Enter a valid amount to sell', 'error');
                return;
            }
            
            if (gameState.resources.crack < amount) {
                showNotification(`‚ùå Not enough crack! Need ${amount}, have ${gameState.resources.crack}`, 'error');
                return;
            }
            
            const pricePerRock = getCrackPrice(amount);
            const revenue = amount * pricePerRock;
            const heatGain = calculateHeatGain(amount);
            
            // Risk check (reduced for better gameplay)
            if (Math.random() < 0.01) { // 1% chance of bust
                gameState.resources.crack -= amount;
                gameState.player.heat = Math.min(100, gameState.player.heat + heatGain * 2);
                addConsoleMessage('üö® Cops busted the deal! Lost crack and gained heat!', 'red');
                showNotification('üö® Drug bust! Lost crack and heat!', 'error');
                updateCrackAndDrugsModal();
                return;
            }
            
            gameState.resources.crack -= amount;
            gameState.player.cash += revenue;
            gameState.player.heat = Math.min(100, gameState.player.heat + heatGain);
            gameState.player.respect += Math.floor(amount / 100);
            
            addConsoleMessage(`üí∞ Sold ${amount} crack for $${revenue} ($${pricePerRock}/rock)`, 'green');
            addConsoleMessage(`üî• Heat: +${heatGain}%, Respect: +${Math.floor(amount / 100)}`, 'cyan');
            showNotification(`üí∞ Sold ${amount} crack for $${revenue}!`, 'success');
            
            updateUI();
            updateCrackAndDrugsModal();
            saveGameState();
        }

        function sellWeed(ounces) {
            if (gameState.resources.weed < ounces) return;
            
            const basePrice = 150;
            const bulk = ounces >= 4 ? 0.9 : 1;
            const revenue = Math.floor(ounces * basePrice * bulk);
            
            gameState.resources.weed -= ounces;
            gameState.player.cash += revenue;
            gameState.player.heat = Math.min(100, gameState.player.heat + ounces);
            gameState.player.respect += Math.floor(ounces);
            
            addConsoleMessage(`Sold ${ounces} oz weed for $${revenue}`, 'green');
            addConsoleMessage(`Heat: +${ounces}, Respect: +${Math.floor(ounces)}`, 'cyan');
            showNotification(`üåø Sold ${ounces}oz weed for $${revenue}!`, 'success');
            
            updateUI();
            updateCrackAndDrugsModal(); // Update modal instead of closing
            saveGameState();
        }

        // Tutorial progress
        function updateTutorialProgress(action, value) {
            // Implementation depends on tutorial system
            console.log(`Tutorial progress: ${action} - ${value}`);
        }

        // Console messages
        function addConsoleMessage(message, color = 'white') {
            const console = document.getElementById('console');
            const combatLog = document.getElementById('combatLog');
            
            const div = document.createElement('div');
            const colors = {
                green: 'text-green-400',
                cyan: 'text-cyan-400',
                magenta: 'magenta-glow',
                gold: 'gold-text',
                red: 'text-red-400',
                white: 'text-white'
            };
            div.className = colors[color] || 'text-white';
            div.textContent = `> ${new Date().toLocaleTimeString()} - ${message}`;
            
            console.appendChild(div.cloneNode(true));
            console.scrollTop = console.scrollHeight;
            
            // Also add to combat log if combat-related
            if (message.includes('Attack') || message.includes('Defeat') || message.includes('Victory')) {
                combatLog.appendChild(div);
                combatLog.scrollTop = combatLog.scrollHeight;
            }
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        // Debug Everything  
        function debugHoodPimps() {
            console.log('üîç COMPLETE SYSTEM DEBUG:');
            
            // Authentication status
            console.log('AUTH STATUS:');
            console.log('- isLoggedIn:', isLoggedIn);
            console.log('- currentUser:', currentUser);
            console.log('- Supabase available:', !!window.SupabaseAPI);
            console.log('- supabase client:', !!window.supabase);
            
            // Turn system debug
            console.log('TURN SYSTEM:');
            console.log('- Current turns from display:', document.getElementById('currentTurns')?.textContent);
            console.log('- turnsWhenLastChecked:', gameState.player.turnsWhenLastChecked);
            console.log('- lastActionTime:', new Date(gameState.player.lastActionTime).toLocaleString());
            console.log('- regenRate:', gameState.player.regenRate);
            console.log('- calculateCurrentTurns():', calculateCurrentTurns());
            
            // Save/Load debug
            console.log('SAVE/LOAD SYSTEM:');
            const saved = localStorage.getItem('pimpFunGameState');
            if (saved) {
                const data = JSON.parse(saved);
                console.log('- LocalStorage data:', {
                    cash: data.player?.cash,
                    weed: data.resources?.weed,
                    turnsWhenLastChecked: data.player?.turnsWhenLastChecked,
                    lastActionTime: data.player?.lastActionTime ? new Date(data.player.lastActionTime).toLocaleString() : 'none'
                });
            } else {
                console.log('- No localStorage data found');
            }
            
            // Hood Pimps debug
            console.log('HOOD PIMPS:');
            console.log('- Active Hood Pimps:', ACTIVE_HOOD_PIMPS.size);
            console.log('- Max Active Pimps:', MAX_ACTIVE_PIMPS);
            console.log('- Player Level:', gameState.player.level);
            console.log('- Week Number:', gameState.player.weekNumber);
            
            // Force everything to work
            addConsoleMessage('üîß FORCE FIXING EVERYTHING...', 'cyan');
            
            // Force reasonable turns
            const now = Date.now();
            gameState.player.turnsWhenLastChecked = 175; // Reasonable amount
            gameState.player.lastActionTime = now;
            gameState.player.regenRate = 0.2; // Ensure proper rate
            
            // Force spawn pimps
            spawnHoodPimps();
            updateHoodPimpDisplay();
            
            // Force save
            saveLocalGameState();
            
            // Force UI update
            updateUI();
            updateTurnDisplay();
            
                         // TEST SAVE SYSTEM
             console.log('üíæ Testing save system...');
             addConsoleMessage('üíæ Testing server save...', 'cyan');
             
             saveGameState().then(result => {
                 console.log('üíæ Save test result:', result);
                 if (result) {
                     addConsoleMessage('‚úÖ Save test successful!', 'green');
                 } else {
                     addConsoleMessage('‚ùå Save test failed!', 'red');
                 }
             });
             
             addConsoleMessage('‚úÖ Force fixes applied!', 'green');
             addConsoleMessage(`üéØ Turns: ${gameState.player.turnsWhenLastChecked}`, 'white');
                          addConsoleMessage(`üë• Hood Pimps: ${ACTIVE_HOOD_PIMPS.size}`, 'white');
         }

         // Check save system - Enhanced debugging
         function checkSaveSystem() {
             console.log('üíæ SAVE/LOAD SYSTEM DIAGNOSTIC:');
             console.log('=================================');
             console.log('Auth Status:');
             console.log('- isLoggedIn:', isLoggedIn);
             console.log('- currentUser:', currentUser?.email || 'none');
             console.log('- currentUser.id:', currentUser?.id || 'none');
             console.log('- SupabaseAPI available:', !!window.SupabaseAPI);
             console.log('- supabase client:', !!window.supabase);
             
             console.log('\nCurrent Game State:');
             console.log('- Cash:', gameState.player.cash);
             console.log('- Hoes:', gameState.resources.hoes);
             console.log('- Thugs:', gameState.resources.thugs);
             console.log('- Weed:', gameState.resources.weed);
             console.log('- Turns:', gameState.player.turnsWhenLastChecked);
             console.log('- Last Action:', new Date(gameState.player.lastActionTime).toLocaleString());
             
             console.log('\nLocalStorage Check:');
             const localData = localStorage.getItem('pimpFunGameState');
             if (localData) {
                 console.log('- localStorage data exists (should be ignored when authenticated)');
                 console.log('- localStorage size:', localData.length, 'characters');
             } else {
                 console.log('- No localStorage data');
             }
             
             if (isLoggedIn && currentUser) {
                 addConsoleMessage('üß™ Testing server save/load cycle...', 'cyan');
                 
                 // Save current state
                 const originalCash = gameState.player.cash;
                 const testAmount = 12345;
                 gameState.player.cash = testAmount; // Temporary test value
                 
                 saveGameState().then(saveResult => {
                     if (saveResult) {
                         addConsoleMessage('‚úÖ Test save successful', 'green');
                         
                         // Try to reload from server
                         addConsoleMessage('üîÑ Testing reload from server...', 'cyan');
                         
                         // Reset to different value
                         gameState.player.cash = 99999;
                         
                         // Load from server
                         loadPlayerProfileFromAuth().then(() => {
                             if (gameState.player.cash === testAmount) {
                                 addConsoleMessage('‚úÖ SERVER SAVE/LOAD WORKING PERFECTLY!', 'green');
                                 showNotification('‚úÖ Server persistence working!', 'success');
                                 
                                 // Restore original value
                                 gameState.player.cash = originalCash;
                                 saveGameState();
                                 updateUI();
                             } else {
                                 addConsoleMessage(`‚ùå Load test failed: Expected ${testAmount}, got ${gameState.player.cash}`, 'red');
                                 showNotification('‚ùå Server load failed', 'error');
                                 
                                 // Restore original value
                                 gameState.player.cash = originalCash;
                                 updateUI();
                             }
                         });
                         
                     } else {
                         addConsoleMessage('‚ùå SERVER SAVE FAILED!', 'red');
                         showNotification('‚ùå Server save failed', 'error');
                         
                         // Restore original value
                         gameState.player.cash = originalCash;
                         updateUI();
                     }
                 });
             } else {
                 addConsoleMessage('‚ùå NOT SIGNED IN - Server save unavailable', 'red');
                 showNotification('üö® Sign in required for server saves!', 'error');
                 showEmailAuth();
             }
         }

        // Debug game state function
        function debugGameState() {
            console.log('üîç COMPLETE GAME STATE DEBUG:');
            console.log('=================================');
            
            console.log('Player State:', {
                username: gameState.player.username,
                cash: gameState.player.cash,
                level: gameState.player.level,
                turnsWhenLastChecked: gameState.player.turnsWhenLastChecked,
                lastActionTime: gameState.player.lastActionTime,
                lastActionTimeReadable: new Date(gameState.player.lastActionTime).toLocaleString(),
                regenRate: gameState.player.regenRate,
                maxTurns: gameState.player.maxTurns
            });
            
            console.log('Resources:', gameState.resources);
            console.log('Crew:', gameState.crew);
            console.log('Auth Status:', { isLoggedIn, currentUser: currentUser?.id });
            
            // Calculate turns manually
            const now = Date.now();
            const timeDiff = now - gameState.player.lastActionTime;
            const minutesDiff = timeDiff / 60000;
            const turnsToAdd = minutesDiff * gameState.player.regenRate;
            const calculatedTurns = gameState.player.turnsWhenLastChecked + turnsToAdd;
            
            console.log('Turn Calculation Debug:', {
                now: now,
                lastActionTime: gameState.player.lastActionTime,
                timeDifference: timeDiff,
                minutesDifference: minutesDiff,
                regenRate: gameState.player.regenRate,
                turnsToAdd: turnsToAdd,
                currentStoredTurns: gameState.player.turnsWhenLastChecked,
                calculatedTurns: calculatedTurns,
                finalTurns: Math.min(calculatedTurns, gameState.player.maxTurns)
            });
            
            addConsoleMessage('üîç Debug info logged to console', 'cyan');
            
            // Fix negative turns issue
            if (gameState.player.turnsWhenLastChecked < 0) {
                console.log('üîß FIXING NEGATIVE TURNS!');
                gameState.player.turnsWhenLastChecked = TURN_MECHANICS.startingTurns;
                gameState.player.lastActionTime = Date.now();
                addConsoleMessage(`üîß Fixed negative turns - reset to ${TURN_MECHANICS.startingTurns}`, 'green');
                updateTurnDisplay();
                saveGameState();
            }
        }

        // Initialize a completely fresh game state
        function initializeFreshGameState() {
            console.log('üÜï Initializing fresh game state');
            const now = Date.now();
            
            // Reset all turn-related values to defaults
            gameState.player.turnsWhenLastChecked = TURN_MECHANICS.startingTurns;
            gameState.player.lastActionTime = now;
            gameState.player.regenRate = TURN_MECHANICS.regenRate;
            gameState.player.maxTurns = TURN_MECHANICS.baseMaxTurns;
            gameState.player.weekNumber = 1;
            gameState.player.tutorialDay = 1;
            
            // Ensure crew structure exists
            if (!Array.isArray(gameState.crew.thugs)) {
                gameState.crew.thugs = [];
            }
            
            // Create individual thug objects for starting thugs
            if (gameState.resources.thugs > 0 && gameState.crew.thugs.length === 0) {
                for (let i = 0; i < gameState.resources.thugs; i++) {
                    gameState.crew.thugs.push(createThug());
                }
            }
            
            console.log('‚úÖ Fresh game state initialized:', {
                turns: gameState.player.turnsWhenLastChecked,
                regenRate: gameState.player.regenRate,
                maxTurns: gameState.player.maxTurns,
                cash: gameState.player.cash,
                hoes: gameState.resources.hoes,
                thugs: gameState.resources.thugs
            });
        }

        // Reset turns to starting amount
        function resetTurns() {
            console.log('üîÑ Resetting turns to starting amount');
            gameState.player.turnsWhenLastChecked = TURN_MECHANICS.startingTurns;
            gameState.player.lastActionTime = Date.now();
            gameState.player.regenRate = TURN_MECHANICS.regenRate;
            gameState.player.maxTurns = TURN_MECHANICS.baseMaxTurns;
            
            addConsoleMessage(`üîÑ Turns reset to ${TURN_MECHANICS.startingTurns} (2 per 10 min)`, 'green');
            showNotification(`üîÑ Turns reset to ${TURN_MECHANICS.startingTurns}!`, 'success');
            
            updateTurnDisplay();
            updateUI();
            saveGameState();
        }

        // Start a completely new game - reset everything to defaults
        function startNewGame() {
            if (!confirm('üÜï Start a completely new game? This will reset ALL progress!')) {
                return;
            }
            
            console.log('üÜï Starting completely new game...');
            
            // Reset gameState to initial defaults
            gameState = {
                player: {
                    id: gameState.player.id, // Keep ID for database continuity
                    username: gameState.player.username, // Keep username
                    bio: '',
                    level: 1,
                    exp: 0,
                    expToNext: 1000,
                    cash: 9360,
                    lastActionTime: Date.now(),
                    lastIncomeTime: Date.now(),
                    turnsWhenLastChecked: TURN_MECHANICS.startingTurns, // 150 turns
                    maxTurns: TURN_MECHANICS.baseMaxTurns, // 200 max
                    regenRate: TURN_MECHANICS.regenRate, // 0.2 (2 per 10 min)
                    weekNumber: 1,
                    tutorialDay: 1,
                    checkinsToday: 1,
                    heat: 0,
                    respect: 0,
                    payoutPercentage: 30,
                    district: null,
                    rank: 'Unranked',
                    localRank: null,
                    nationalRank: null,
                    crewId: null,
                    crewRole: null,
                    joinedDate: null,
                    isOnline: false
                },
                crew: {
                    name: null,
                    tag: null,
                    description: null,
                    members: [],
                    treasury: 0,
                    level: 1,
                    territory: null,
                    thugs: [], // Will be populated below
                    lastPayrollTime: Date.now(),
                    nextPayrollDue: Date.now() + (7 * 24 * 60 * 60 * 1000)
                },
                resources: {
                    hoes: 9,
                    hoeDetails: {
                        streetWorkers: 6,
                        sugarBabies: 2,
                        highEndEscorts: 1,
                        onlyTrampsModels: 0
                    },
                    thugs: 6,
                    crack: 0,
                    weed: 0,
                    weapons: {
                        pistols: 5,
                        shotguns: 0,
                        tek9s: 0,
                        ak47s: 0
                    },
                                            vehicles: {
                            bicycle: 0,
                            motorcycle: 0,
                            kia: 0,
                            lowrider: 0,
                            escalade: 0,
                            limo: 0,
                            bentley: 0,
                            armoredBeast: 0
                        },
                        condoms: 500,
                    beer: 200,
                    medicine: 10
                },
                supplies: {
                    lastConsumedAt: Date.now(),
                    hoeHappiness: 70,
                    thugHappiness: 70
                },
                npcs: {},
                combatHistory: []
            };
            
            // Create starting crew thugs
            gameState.crew.thugs = [];
            for (let i = 0; i < 6; i++) {
                gameState.crew.thugs.push(createThug());
            }
            
            console.log('‚úÖ New game state created:', {
                cash: gameState.player.cash,
                turns: gameState.player.turnsWhenLastChecked,
                regenRate: gameState.player.regenRate,
                hoes: gameState.resources.hoes,
                thugs: gameState.resources.thugs,
                weapons: Object.values(gameState.resources.weapons).reduce((a, b) => a + b, 0)
            });
            
            // Update UI immediately
            updateUI();
            updateTurnDisplay();
            updateSupplyStatus();
            updateHoodPimpDisplay();
            
            // Save the new state
            saveGameState();
            
            // Success messages
            addConsoleMessage('üÜï NEW GAME STARTED!', 'green');
            addConsoleMessage(`üí∞ Starting cash: $${gameState.player.cash}`, 'gold');
            addConsoleMessage(`‚ö° Starting turns: ${gameState.player.turnsWhenLastChecked}/200 (2 per 10 min)`, 'cyan');
            addConsoleMessage(`üë• Starting crew: ${gameState.resources.hoes} hoes, ${gameState.resources.thugs} thugs`, 'pink');
            addConsoleMessage(`üî´ Starting weapons: ${Object.values(gameState.resources.weapons).reduce((a, b) => a + b, 0)} pistols`, 'blue');
            addConsoleMessage('üéØ Ready to build your empire in Empire City!', 'magenta');
            
            showNotification('üÜï New game started! Good luck building your empire!', 'success');
        }

        // Test save/load cycle to debug data persistence
        async function testSaveLoad() {
            console.log('üß™ TESTING SAVE/LOAD CYCLE');
            console.log('=================================');
            
            // Capture current state
            const beforeSave = {
                cash: gameState.player.cash,
                hoes: gameState.resources.hoes,
                thugs: gameState.resources.thugs,
                crack: gameState.resources.crack,
                weed: gameState.resources.weed,
                weapons: { ...gameState.resources.weapons },
                beer: gameState.resources.beer,
                condoms: gameState.resources.condoms,
                medicine: gameState.resources.medicine,
                turns: gameState.player.turnsWhenLastChecked
            };
            
            console.log('üìä BEFORE SAVE:', beforeSave);
            addConsoleMessage('üß™ Testing save/load - see console for details', 'cyan');
            
            // Modify some values to test
            gameState.player.cash += 1000;
            gameState.resources.crack += 50;
            gameState.resources.weed += 5;
            
            const afterModify = {
                cash: gameState.player.cash,
                crack: gameState.resources.crack,
                weed: gameState.resources.weed
            };
            
            console.log('‚úèÔ∏è AFTER MODIFY:', afterModify);
            
            // Save
            console.log('üíæ SAVING...');
            const saveResult = await saveGameState();
            console.log('üíæ Save result:', saveResult);
            
            // Wait a moment
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Reload from server
            console.log('üì• RELOADING...');
            await loadPlayerProfileFromAuth();
            
            const afterLoad = {
                cash: gameState.player.cash,
                hoes: gameState.resources.hoes,
                thugs: gameState.resources.thugs,
                crack: gameState.resources.crack,
                weed: gameState.resources.weed,
                weapons: { ...gameState.resources.weapons },
                beer: gameState.resources.beer,
                condoms: gameState.resources.condoms,
                medicine: gameState.resources.medicine,
                turns: gameState.player.turnsWhenLastChecked
            };
            
            console.log('üì• AFTER LOAD:', afterLoad);
            
            // Compare
            const comparison = {};
            Object.keys(beforeSave).forEach(key => {
                if (typeof beforeSave[key] === 'object') {
                    comparison[key] = {
                        before: beforeSave[key],
                        after: afterLoad[key],
                        match: JSON.stringify(beforeSave[key]) === JSON.stringify(afterLoad[key])
                    };
                } else {
                    comparison[key] = {
                        before: beforeSave[key],
                        after: afterLoad[key],
                        match: beforeSave[key] === afterLoad[key]
                    };
                }
            });
            
            console.log('üîç COMPARISON:', comparison);
            
            // Update UI
            updateUI();
            
            // Report results
            const failed = Object.entries(comparison).filter(([key, data]) => !data.match);
            if (failed.length === 0) {
                addConsoleMessage('‚úÖ Save/Load test PASSED - all data preserved!', 'green');
                showNotification('‚úÖ Save/Load working perfectly!', 'success');
            } else {
                addConsoleMessage(`‚ùå Save/Load test FAILED - ${failed.length} fields not preserved`, 'red');
                addConsoleMessage(`Failed fields: ${failed.map(([key]) => key).join(', ')}`, 'red');
                showNotification(`‚ùå Data loss in: ${failed.map(([key]) => key).join(', ')}`, 'error');
            }
        }

        // Fix corrupted database data by forcing a clean save
        async function fixCorruptedData() {
            if (!confirm('üîß Fix corrupted database data? This will overwrite any corrupted server data with your current game state.')) {
                return;
            }
            
            console.log('üîß Fixing corrupted database data...');
            addConsoleMessage('üîß Cleaning up corrupted data...', 'orange');
            
            // Ensure we have valid local data
            if (!gameState.resources || typeof gameState.resources !== 'object') {
                gameState.resources = {
                    hoes: 10,
                    hoeDetails: { streetWorkers: 7, sugarBabies: 2, highEndEscorts: 1, onlyTrampsModels: 0 },
                    thugs: 5,
                    crack: 0,
                    weed: 0,
                    weapons: { pistols: 5, shotguns: 0, tek9s: 0, ak47s: 0 },
                                                vehicles: { bicycle: 0, motorcycle: 0, kia: 0, lowrider: 0, escalade: 0, limo: 0, bentley: 0, armoredBeast: 0 },
                    condoms: 500,
                    beer: 200,
                    medicine: 10
                };
            }
            
            if (!gameState.supplies || typeof gameState.supplies !== 'object') {
                gameState.supplies = {
                    lastConsumedAt: Date.now(),
                    hoeHappiness: 70,
                    thugHappiness: 70
                };
            }
            
            if (!gameState.crew || typeof gameState.crew !== 'object') {
                gameState.crew = {
                    name: null,
                    tag: null,
                    description: null,
                    members: [],
                    treasury: 0,
                    level: 1,
                    territory: null,
                    thugs: [],
                    lastPayrollTime: Date.now(),
                    nextPayrollDue: Date.now() + (7 * 24 * 60 * 60 * 1000)
                };
            }
            
            // Force create crew thugs if missing
            if (gameState.resources.thugs > 0 && (!gameState.crew.thugs || gameState.crew.thugs.length === 0)) {
                gameState.crew.thugs = [];
                for (let i = 0; i < gameState.resources.thugs; i++) {
                    gameState.crew.thugs.push(createThug());
                }
            }
            
            console.log('üîß Cleaned data:', {
                resources: Object.keys(gameState.resources),
                supplies: Object.keys(gameState.supplies),
                crew: Object.keys(gameState.crew),
                thugsCount: gameState.crew.thugs?.length
            });
            
            // Force save the clean data
            console.log('üíæ Force saving clean data...');
            const saveResult = await saveGameState();
            
            if (saveResult) {
                addConsoleMessage('‚úÖ Database corruption fixed!', 'green');
                showNotification('‚úÖ Database fixed! All data should now save properly.', 'success');
                
                // Test the fix
                console.log('üß™ Testing the fix...');
                setTimeout(() => {
                    testSaveLoad();
                }, 1000);
            } else {
                addConsoleMessage('‚ùå Failed to fix database', 'red');
                showNotification('‚ùå Fix failed - check console for details', 'error');
            }
        }

        // Reset all thugs back to rookie rank
        function resetThugRanks() {
            if (!confirm('üë• Reset all thugs back to rookie rank? This will lower their salaries but they can earn promotions through experience.')) {
                return;
            }
            
            console.log('üë• Resetting all thugs to rookie rank...');
            
            if (!Array.isArray(gameState.crew.thugs)) {
                gameState.crew.thugs = [];
            }
            
            let resetCount = 0;
            gameState.crew.thugs.forEach(thug => {
                if (thug.rank !== 'rookie') {
                    console.log(`üë• Resetting ${thug.name} from ${thug.rank} to rookie`);
                    thug.rank = 'rookie';
                    thug.experience = 0;
                    thug.name = generateThugName('rookie'); // Give them a rookie name
                    resetCount++;
                }
            });
            
            addConsoleMessage(`üë• Reset ${resetCount} thugs back to rookie rank`, 'cyan');
            addConsoleMessage('üí° Thugs will earn promotions through combat and work experience', 'blue');
            showNotification(`üë• ${resetCount} thugs reset to rookie rank ($250/week each)`, 'success');
            
            updateUI();
            saveGameState();
        }

        // Update the Crack & Drugs modal without closing it
        function updateCrackAndDrugsModal() {
            // Only update if the modal is currently open
            const modal = document.getElementById('modalContainer');
            if (!modal || !modal.innerHTML.includes('CRACK & DRUG OPERATIONS')) {
                return; // Modal not open, nothing to update
            }
            
            // Refresh the modal with updated values
            showCrackAndDrugs();
        }

        // Dismiss tutorial banner
        function dismissTutorial() {
            const tutorialBanner = document.getElementById('tutorialBanner');
            if (tutorialBanner) {
                tutorialBanner.style.display = 'none';
                
                // Save the dismissal preference
                localStorage.setItem('tutorialDismissed', 'true');
                gameState.player.tutorialDismissed = true;
                
                addConsoleMessage('üìö Tutorial dismissed - you can re-enable it in settings', 'cyan');
                showNotification('üìö Tutorial dismissed', 'success');
                
                saveGameState();
            }
        }

        // Show tutorial missions (placeholder)
        function showTutorial() {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold gold-text">üéì TUTORIAL MISSIONS</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="p-4 border border-green-500/50 bg-green-900/20 rounded">
                                <h4 class="font-bold text-green-400 mb-2">‚úÖ Day 1: Empire Basics</h4>
                                <ul class="text-sm text-gray-300 space-y-1">
                                    <li>‚Ä¢ Scout for 30 turns in any district</li>
                                    <li>‚Ä¢ Produce crack with your thugs</li>
                                    <li>‚Ä¢ Buy supplies from Corner Store</li>
                                    <li>‚Ä¢ Attack a Hood Pimp</li>
                                </ul>
                                <p class="text-xs text-green-400 mt-2">Reward: +$5,000, +10 respect</p>
                            </div>
                            
                            <div class="p-4 border border-yellow-500/50 bg-yellow-900/20 rounded">
                                <h4 class="font-bold text-yellow-400 mb-2">üîÑ Day 2: Advanced Operations</h4>
                                <ul class="text-sm text-gray-300 space-y-1">
                                    <li>‚Ä¢ Choose your district specialization</li>
                                    <li>‚Ä¢ Manage thug happiness with beer & weed</li>
                                    <li>‚Ä¢ Sell drugs for profit</li>
                                    <li>‚Ä¢ Dominate a Hood Pimp completely</li>
                                </ul>
                                <p class="text-xs text-yellow-400 mt-2">Reward: +$10,000, +weapon upgrade</p>
                            </div>
                            
                            <div class="p-4 border border-purple-500/50 bg-purple-900/20 rounded">
                                <h4 class="font-bold text-purple-400 mb-2">üëë Day 3: Empire Building</h4>
                                <ul class="text-sm text-gray-300 space-y-1">
                                    <li>‚Ä¢ Optimize payout percentage strategy</li>
                                    <li>‚Ä¢ Build a vehicle fleet</li>
                                    <li>‚Ä¢ Join or create a crew</li>
                                    <li>‚Ä¢ Reach 100+ respect</li>
                                </ul>
                                <p class="text-xs text-purple-400 mt-2">Reward: +$25,000, crew invitation</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 text-center">
                            <button onclick="dismissTutorial(); closeModal();" class="px-4 py-2 bg-red-600 rounded text-sm hover:bg-red-500">
                                Skip Tutorial
                            </button>
                            <p class="text-xs text-gray-400 mt-2">You can always re-enable tutorials in settings</p>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold mt-4">
                            Continue Playing
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // Apply NFT effects to the game state
        function applyNFTEffects(nft) {
            switch(nft.type) {
                case 'hoe':
                    // Special hoes are added to their own category and tracked
                    if (!gameState.resources.specialHoes) gameState.resources.specialHoes = [];
                    gameState.resources.specialHoes.push(nft);
                    addConsoleMessage(`üåü ${nft.name} added to your special hoes (${nft.multiplier}x income)`, 'purple');
                    break;
                    
                case 'thug':
                    // Create special thug with higher rank
                    const specialThug = createThug(nft.name, nft.startRank);
                    specialThug.isNFT = true;
                    specialThug.nftBonus = nft.description;
                    gameState.crew.thugs.push(specialThug);
                    syncThugCount();
                    addConsoleMessage(`üåü ${nft.name} joined your crew as ${THUG_RANKS[nft.startRank].name}`, 'purple');
                    break;
                    
                case 'weapon':
                    // Special weapons are tracked separately
                    if (!gameState.resources.specialWeapons) gameState.resources.specialWeapons = [];
                    gameState.resources.specialWeapons.push(nft);
                    addConsoleMessage(`üåü ${nft.name} added to your arsenal (${nft.power}x power)`, 'purple');
                    break;
                    
                case 'vehicle':
                    // Special vehicles with bonuses
                    if (!gameState.resources.specialVehicles) gameState.resources.specialVehicles = [];
                    gameState.resources.specialVehicles.push(nft);
                    addConsoleMessage(`üåü ${nft.name} added to your garage (${nft.bonus})`, 'purple');
                    break;
                    
                case 'territory':
                    // Special territories provide ongoing bonuses
                    if (!gameState.player.specialTerritories) gameState.player.specialTerritories = [];
                    gameState.player.specialTerritories.push(nft);
                    addConsoleMessage(`üåü ${nft.name} acquired (${nft.bonus})`, 'purple');
                    break;
            }
        }

        // Turn tracking system to monitor where turns are being lost
        let turnHistory = [];
        
        function trackTurns() {
            console.log('üìä TURN TRACKING ANALYSIS:');
            console.log('=========================');
            
            const currentTurns = calculateCurrentTurns();
            const now = Date.now();
            
            console.log('Current State:', {
                displayedTurns: document.getElementById('currentTurns')?.textContent,
                calculatedTurns: currentTurns,
                storedTurns: gameState.player.turnsWhenLastChecked,
                lastActionTime: new Date(gameState.player.lastActionTime).toLocaleString(),
                regenRate: gameState.player.regenRate,
                maxTurns: gameState.player.maxTurns
            });
            
            console.log('Recent Turn History:');
            turnHistory.slice(-10).forEach((entry, index) => {
                console.log(`${index + 1}. ${entry.action}: ${entry.change} turns (${new Date(entry.time).toLocaleTimeString()})`);
            });
            
            // Add current state to history
            turnHistory.push({
                action: 'Track Check',
                change: 0,
                turns: currentTurns,
                stored: gameState.player.turnsWhenLastChecked,
                time: now
            });
            
            // Keep only last 20 entries
            if (turnHistory.length > 20) {
                turnHistory = turnHistory.slice(-20);
            }
            
            addConsoleMessage('üìä Turn tracking data logged to console', 'cyan');
            
            // Check for suspicious patterns
            const recentLosses = turnHistory.slice(-5).filter(entry => entry.change < -10);
            if (recentLosses.length > 0) {
                addConsoleMessage('‚ö†Ô∏è Detected recent large turn losses - investigating', 'yellow');
                console.log('üö® Suspicious turn losses:', recentLosses);
            }
        }

        // Enhanced turn usage tracking
        function logTurnUsage(action, amount, success) {
            const entry = {
                action,
                change: success ? -amount : 0,
                turns: calculateCurrentTurns(),
                stored: gameState.player.turnsWhenLastChecked,
                time: Date.now(),
                success
            };
            
            turnHistory.push(entry);
            console.log('üìä Turn usage logged:', entry);
        }

        // Emergency data integrity check
        function emergencyDataCheck() {
            console.log('üö® EMERGENCY DATA LOSS INVESTIGATION:');
            console.log('==========================================');
            
            // Check current game state
            console.log('Current Game State:', {
                cash: gameState.player.cash,
                hoes: gameState.resources.hoes,
                thugs: gameState.resources.thugs,
                crack: gameState.resources.crack,
                weapons: gameState.resources.weapons,
                weaponsTotal: Object.values(gameState.resources.weapons || {}).reduce((a, b) => a + b, 0),
                vehicles: gameState.resources.vehicles,
                netWorth: gameState.player.cash + (gameState.resources.hoes * 2000) + (gameState.resources.thugs * 750)
            });
            
            // Check localStorage backup
            const localBackup = localStorage.getItem('pimpFunGameState');
            if (localBackup) {
                try {
                    const backupData = JSON.parse(localBackup);
                    console.log('LocalStorage Backup Data:', {
                        cash: backupData.player?.cash,
                        hoes: backupData.resources?.hoes,
                        thugs: backupData.resources?.thugs,
                        weapons: backupData.resources?.weapons,
                        timestamp: backupData.player?.lastActionTime ? new Date(backupData.player.lastActionTime).toLocaleString() : 'unknown'
                    });
                    
                    // Calculate backup net worth
                    const backupNetWorth = (backupData.player?.cash || 0) + 
                                          ((backupData.resources?.hoes || 0) * 2000) + 
                                          ((backupData.resources?.thugs || 0) * 750);
                    console.log('Backup Net Worth:', backupNetWorth);
                    
                } catch (error) {
                    console.error('‚ùå Error reading localStorage backup:', error);
                }
            } else {
                console.log('‚ùå No localStorage backup found');
            }
            
            // Check for recent save/load operations
            if (window.SupabaseAPI && currentUser) {
                console.log('üåê Checking server data...');
                loadPlayerProfileFromAuth().then(() => {
                    console.log('üì• Server data reloaded - check if data was recovered');
                    updateUI();
                });
            }
            
            // Check for suspicious patterns
            addConsoleMessage('üö® Emergency data check - see console for details', 'red');
            addConsoleMessage('üîç Investigating massive data loss...', 'yellow');
            
            // Look for corruption patterns
            const corruptionIssues = [];
            
            if (typeof gameState.resources.hoes !== 'number') corruptionIssues.push('hoes not a number');
            if (typeof gameState.resources.thugs !== 'number') corruptionIssues.push('thugs not a number');
            if (typeof gameState.player.cash !== 'number') corruptionIssues.push('cash not a number');
            if (!gameState.resources.weapons || typeof gameState.resources.weapons !== 'object') corruptionIssues.push('weapons corrupted');
            
            if (corruptionIssues.length > 0) {
                console.log('üö® CORRUPTION DETECTED:', corruptionIssues);
                addConsoleMessage(`üö® Data corruption detected: ${corruptionIssues.join(', ')}`, 'red');
            }
            
            // Check for negative values (impossible in normal gameplay)
            if (gameState.resources.hoes < 0) {
                console.log('üö® IMPOSSIBLE: Negative hoes detected');
                addConsoleMessage('üö® Impossible negative hoes - data corruption!', 'red');
            }
            
            if (gameState.resources.thugs < 0) {
                console.log('üö® IMPOSSIBLE: Negative thugs detected');
                addConsoleMessage('üö® Impossible negative thugs - data corruption!', 'red');
            }
        }

        // EMERGENCY GAME FIX - Reset everything to working state
        function emergencyGameFix() {
            if (!confirm('üîß EMERGENCY FIX: Reset game to stable working state? This will fix all broken mechanics but may reset some progress.')) {
                return;
            }
            
            console.log('üö® APPLYING EMERGENCY FIXES...');
            addConsoleMessage('üö® EMERGENCY FIX: Resetting broken systems...', 'red');
            
            // 1. FIX TURN SYSTEM
            const now = Date.now();
            gameState.player.turnsWhenLastChecked = 150; // Reset to safe value
            gameState.player.lastActionTime = now;
            gameState.player.regenRate = 0.2; // Standard rate
            gameState.player.maxTurns = 200;
            
            // 2. FIX RESOURCES IF CORRUPTED
            if (!gameState.resources || typeof gameState.resources !== 'object') {
                gameState.resources = {};
            }
            
                                // Ensure minimum viable resources (ONLY INCREASE, NEVER DECREASE)
            if (typeof gameState.resources.hoes !== 'number' || gameState.resources.hoes < 5) {
                const oldHoes = gameState.resources.hoes || 0;
                gameState.resources.hoes = Math.max(oldHoes, 9); // Only increase to new starting value, never decrease
                if (oldHoes !== gameState.resources.hoes) {
                    logResourceChange('hoes', null, oldHoes, gameState.resources.hoes, 'corruption_fix_increase_only');
                }
            }
            if (typeof gameState.resources.thugs !== 'number' || gameState.resources.thugs < 3) {
                const oldThugs = gameState.resources.thugs || 0;
                gameState.resources.thugs = Math.max(oldThugs, 6); // Only increase to new starting value, never decrease
                if (oldThugs !== gameState.resources.thugs) {
                    logResourceChange('thugs', null, oldThugs, gameState.resources.thugs, 'corruption_fix_increase_only');
                }
            }
            if (typeof gameState.player.cash !== 'number' || gameState.player.cash < 1000) {
                const oldCash = gameState.player.cash || 0;
                gameState.player.cash = Math.max(oldCash, 9360); // Only increase to new starting value, never decrease
                if (oldCash !== gameState.player.cash) {
                    logResourceChange('cash', null, oldCash, gameState.player.cash, 'corruption_fix_increase_only');
                }
            }
            
            // 3. FIX WEAPONS
            if (!gameState.resources.weapons || typeof gameState.resources.weapons !== 'object') {
                gameState.resources.weapons = {
                    pistols: 5,
                    shotguns: 0,
                    tek9s: 0,
                    ak47s: 0
                };
            } else {
                // Clean any corrupted weapon values
                Object.keys(gameState.resources.weapons).forEach(weapon => {
                    if (typeof gameState.resources.weapons[weapon] !== 'number' || isNaN(gameState.resources.weapons[weapon])) {
                        gameState.resources.weapons[weapon] = 0;
                    }
                });
                
                // Ensure at least some weapons
                if (Object.values(gameState.resources.weapons).reduce((a, b) => a + b, 0) === 0) {
                    gameState.resources.weapons.pistols = 5;
                }
            }
            
            // 4. FIX VEHICLES
            if (!gameState.resources.vehicles || typeof gameState.resources.vehicles !== 'object') {
                gameState.resources.vehicles = {
                    bicycle: 0, motorcycle: 0, kia: 0, lowrider: 0, escalade: 0, limo: 0, bentley: 0, armoredBeast: 0
                };
            }
            
            // 5. FIX SUPPLIES
            if (!gameState.resources.beer || gameState.resources.beer < 50) gameState.resources.beer = 200;
            if (!gameState.resources.condoms || gameState.resources.condoms < 100) gameState.resources.condoms = 500;
            if (!gameState.resources.medicine || gameState.resources.medicine < 5) gameState.resources.medicine = 10;
            if (typeof gameState.resources.weed !== 'number') gameState.resources.weed = 0;
            if (typeof gameState.resources.crack !== 'number') gameState.resources.crack = 0;
            
            // 6. FIX CREW SYSTEM
            if (!gameState.crew || typeof gameState.crew !== 'object') {
                gameState.crew = {
                    thugs: [],
                    lastPayrollTime: now,
                    nextPayrollDue: now + (7 * 24 * 60 * 60 * 1000)
                };
            }
            
            // Ensure crew thugs match resource count
            if (!Array.isArray(gameState.crew.thugs)) {
                gameState.crew.thugs = [];
            }
            
            // Create missing crew members
            while (gameState.crew.thugs.length < gameState.resources.thugs) {
                gameState.crew.thugs.push(createThug());
            }
            
            // Remove excess crew members
            if (gameState.crew.thugs.length > gameState.resources.thugs) {
                gameState.crew.thugs = gameState.crew.thugs.slice(0, gameState.resources.thugs);
            }
            
            // 7. FIX HOE DETAILS
            if (!gameState.resources.hoeDetails) {
                gameState.resources.hoeDetails = {
                    streetWorkers: Math.floor(gameState.resources.hoes * 0.7),
                    sugarBabies: Math.floor(gameState.resources.hoes * 0.2),
                    highEndEscorts: Math.floor(gameState.resources.hoes * 0.1),
                    onlyTrampsModels: 0
                };
            }
            
            console.log('‚úÖ Emergency fixes applied:', {
                turns: gameState.player.turnsWhenLastChecked,
                cash: gameState.player.cash,
                hoes: gameState.resources.hoes,
                thugs: gameState.resources.thugs,
                weapons: Object.values(gameState.resources.weapons).reduce((a, b) => a + b, 0),
                crewSize: gameState.crew.thugs.length
            });
            
            // 8. FORCE SAVE AND UPDATE
            updateUI();
            updateTurnDisplay();
            updateSupplyStatus();
            saveGameState();
            
            addConsoleMessage('‚úÖ Emergency fixes completed!', 'green');
            addConsoleMessage(`üí∞ Cash: $${gameState.player.cash.toLocaleString()}`, 'gold');
            addConsoleMessage(`üë• Crew: ${gameState.resources.hoes} hoes, ${gameState.resources.thugs} thugs`, 'cyan');
            addConsoleMessage(`‚ö° Turns: ${gameState.player.turnsWhenLastChecked}/200`, 'blue');
            showNotification('üîß Game systems restored to working state!', 'success');
        }

        // Simple scout function that just works
        function simpleScout() {
            console.log('üîç Simple scout starting...');
            
            // Simple turn check
            const currentTurns = Math.max(0, gameState.player.turnsWhenLastChecked || 150);
            console.log('Current turns:', currentTurns);
            
            if (currentTurns < 30) {
                alert('Need 30 turns! You have ' + currentTurns);
                return;
            }
            
            // Use turns
            gameState.player.turnsWhenLastChecked = Math.max(0, currentTurns - 30);
            gameState.player.lastActionTime = Date.now();
            
            // Simple results
            const hoesFound = 3 + Math.floor(Math.random() * 5); // 3-7 hoes
            const thugsFound = 1 + Math.floor(Math.random() * 3); // 1-3 thugs  
            const moneyEarned = 500 + Math.floor(Math.random() * 500); // $500-1000
            
            gameState.resources.hoes += hoesFound;
            gameState.resources.thugs += thugsFound;
            gameState.player.cash += moneyEarned;
            
            // Create crew members for new thugs
            for (let i = 0; i < thugsFound; i++) {
                if (!gameState.crew.thugs) gameState.crew.thugs = [];
                gameState.crew.thugs.push(createThug());
            }
            
            console.log('Scout results:', { hoesFound, thugsFound, moneyEarned });
            
            // Force show results modal
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" style="display: flex !important;">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-xl font-bold cyan-glow mb-4">üîç SCOUT RESULTS</h3>
                        
                        <div class="mb-4 p-4 bg-green-900/30 rounded border border-green-500/50">
                            <h4 class="font-bold text-green-400 mb-3">‚úÖ Action Complete!</h4>
                            <p class="text-sm text-gray-300 mb-3">‚ö° Turns Used: <span class="text-yellow-400">30</span></p>
                            
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-pink-400">üë• Hoes Found:</span>
                                    <span class="text-white font-bold">+${hoesFound}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-blue-400">üí™ Thugs Found:</span>
                                    <span class="text-white font-bold">+${thugsFound}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-yellow-400">üí∞ Money Earned:</span>
                                    <span class="gold-text font-bold">+$${moneyEarned.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold">
                            Continue Playing
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
            
            // Also show notification
            showNotification(`üîç Scout: +${hoesFound} hoes, +${thugsFound} thugs, +$${moneyEarned}!`, 'success');
            addConsoleMessage(`Simple scout: +${hoesFound} hoes, +${thugsFound} thugs, +$${moneyEarned}`, 'green');
            
            updateUI();
            saveGameState();
        }

        // Test NFT system to verify it's working
        function testNFTSystem() {
            console.log('üíé TESTING NFT SYSTEM:');
            console.log('=====================');
            
            // Test the calculation for different turn amounts
            const testTurns = [10, 20, 30, 40, 50, 100];
            
            testTurns.forEach(turns => {
                const chance = calculateNFTChance(turns, 'scout');
                console.log(`${turns} turns: ${(chance * 100).toFixed(2)}% NFT chance`);
            });
            
            // Test NFT generation
            console.log('\nTesting NFT generation...');
            for (let i = 0; i < 5; i++) {
                const testNFT = generateNFTDrop('Test District');
                console.log(`Test NFT ${i + 1}:`, testNFT);
            }
            
            // Check if hoe names are loaded
            console.log('\nHoe names status:', {
                loaded: !!hoeNamesData,
                categories: hoeNamesData ? Object.keys(hoeNamesData) : 'none',
                totalNames: hoeNamesData ? Object.values(hoeNamesData).reduce((total, arr) => total + arr.length, 0) : 0
            });
            
            // Force trigger an NFT for testing
            console.log('\nForcing NFT drop for test...');
            const forcedNFT = generateNFTDrop('Test Location');
            
            if (forcedNFT) {
                // Show the NFT in a modal
                const modal = `
                    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" style="display: flex !important;">
                        <div class="game-panel rounded-lg p-6 max-w-md w-full">
                            <h3 class="text-xl font-bold cyan-glow mb-4">üíé NFT SYSTEM TEST</h3>
                            
                            <div class="mb-4 p-4 bg-gradient-to-r from-purple-900/70 to-pink-900/70 rounded border-2 border-purple-400 animate-pulse">
                                <h4 class="font-bold text-purple-300 mb-2 text-center">üéä TEST NFT GENERATED! üéä</h4>
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-3xl">üíé</span>
                                    <div class="flex-1">
                                        <p class="font-bold text-white text-lg">${forcedNFT.name}</p>
                                        <p class="text-sm text-purple-300 capitalize">${forcedNFT.rarity} ${forcedNFT.type} NFT</p>
                                        <p class="text-xs text-gray-300 mt-1">${forcedNFT.description}</p>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-purple-200 bg-purple-800/50 px-3 py-1 rounded-full inline-block">
                                        üß™ This is a test NFT
                                    </p>
                                </div>
                            </div>
                            
                            <div class="text-xs text-gray-400 mb-4 text-center">
                                NFT system is working! Check console for detailed test results.
                            </div>
                            
                            <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold">
                                Close Test
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modal;
                
                addConsoleMessage('üíé NFT system test completed - check console', 'purple');
                showNotification('üíé NFT system is working! Check console for details.', 'success');
            } else {
                addConsoleMessage('‚ùå NFT generation failed in test', 'red');
                alert('NFT system test failed - check console for details');
            }
        }

        // Force spawn Hood Pimps for debugging
        function forceSpawnPimps() {
            console.log('üö® FORCE SPAWNING HOOD PIMPS...');
            
            // Clear existing pimps
            ACTIVE_HOOD_PIMPS.clear();
            
            // Check if templates exist
            if (!HOOD_PIMP_TEMPLATES || !HOOD_PIMP_TEMPLATES.streetPimps) {
                console.error('‚ùå HOOD_PIMP_TEMPLATES not found!');
                addConsoleMessage('‚ùå Hood Pimp templates missing!', 'red');
                return;
            }
            
            console.log('‚úÖ Found Hood Pimp templates:', Object.keys(HOOD_PIMP_TEMPLATES));
            
            // Manually create 3 street pimps
            const streetPimps = HOOD_PIMP_TEMPLATES.streetPimps;
            for (let i = 0; i < Math.min(3, streetPimps.length); i++) {
                const template = streetPimps[i];
                const pimp = {
                    ...template,
                    id: 'force_' + i,
                    defeated: false,
                    respawnAt: null,
                    spawnedAt: Date.now()
                };
                
                ACTIVE_HOOD_PIMPS.set(pimp.id, pimp);
                console.log(`‚úÖ Force spawned: ${pimp.name}`);
            }
            
            console.log(`üö® Force spawned ${ACTIVE_HOOD_PIMPS.size} Hood Pimps`);
            
            // Update display
            updateHoodPimpDisplay();
            
                         addConsoleMessage(`üö® Force spawned ${ACTIVE_HOOD_PIMPS.size} Hood Pimps!`, 'red');
             showNotification(`üö® Spawned ${ACTIVE_HOOD_PIMPS.size} Hood Pimps!`, 'success');
         }

         // Show detailed weapon breakdown
         function showWeaponDetails() {
             const weapons = gameState.resources.weapons || {};
             const weaponNames = {
                 pistols: 'Pistols',
                 shotguns: 'Shotguns', 
                 tek9s: 'Tek-9s',
                 ak47s: 'AK-47s'
             };
             
             let weaponList = '';
             let totalValue = 0;
             
             Object.entries(weapons).forEach(([type, count]) => {
                 if (count > 0) {
                     const name = weaponNames[type] || type;
                     const value = count * (type === 'pistols' ? 250 : type === 'shotguns' ? 1250 : type === 'tek9s' ? 2500 : 5500);
                     totalValue += value;
                     weaponList += `
                         <div class="flex justify-between items-center py-2 border-b border-gray-700">
                             <div>
                                 <span class="font-bold text-white">${name}</span>
                                 <div class="text-xs text-gray-400">Combat Power: +${type === 'pistols' ? count : type === 'shotguns' ? count*2 : type === 'tek9s' ? count*9 : count*30}</div>
                             </div>
                             <div class="text-right">
                                 <div class="text-white">${count}</div>
                                 <div class="text-xs text-gold">$${value.toLocaleString()}</div>
                             </div>
                         </div>
                     `;
                 }
             });
             
             if (!weaponList) {
                 weaponList = '<div class="text-center text-gray-400 py-4">No weapons owned</div>';
             }
             
             const modal = `
                 <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                     <div class="game-panel rounded-lg p-6 max-w-md w-full">
                         <div class="flex items-center justify-between mb-4">
                             <h3 class="text-xl font-bold cyan-glow">üî´ WEAPON ARSENAL</h3>
                             <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                         </div>
                         
                         <div class="mb-4 p-3 bg-gray-800/50 rounded">
                             <div class="flex justify-between">
                                 <span class="text-gray-400">Total Weapons:</span>
                                 <span class="text-white">${Object.values(weapons).reduce((a, b) => a + b, 0)}</span>
                             </div>
                             <div class="flex justify-between">
                                 <span class="text-gray-400">Arsenal Value:</span>
                                 <span class="gold-text">$${totalValue.toLocaleString()}</span>
                             </div>
                         </div>
                         
                         <div class="max-h-64 overflow-y-auto">
                             ${weaponList}
                         </div>
                         
                         <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold mt-4">
                             Close Arsenal
                         </button>
                     </div>
                 </div>
             `;
             
             document.getElementById('modalContainer').innerHTML = modal;
                 }

        // Show detailed vehicle breakdown
        function showVehicleDetails() {
            const vehicles = gameState.resources.vehicles || {};
            const vehicleNames = {
                bicycle: 'Bicycles',
                motorcycle: 'Motorcycles',
                kia: 'Kia Cars', 
                lowrider: 'Lowriders',
                escalade: 'Escalades',
                limo: 'Limousines',
                bentley: 'Bentleys',
                armoredBeast: 'Armored Beasts'
            };
            
            let vehicleList = '';
            let totalValue = 0;
            
            Object.entries(vehicles).forEach(([type, count]) => {
                if (count > 0) {
                    const name = vehicleNames[type] || type;
                    const value = count * (type === 'bicycle' ? 1000 : type === 'motorcycle' ? 3500 : type === 'kia' ? 8000 : 
                                         type === 'lowrider' ? 15000 : type === 'escalade' ? 35000 : type === 'limo' ? 80000 : 
                                         type === 'bentley' ? 150000 : 250000);
                    totalValue += value;
                    vehicleList += `
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <div>
                                <span class="font-bold text-white">${name}</span>
                                <div class="text-xs text-gray-400">Protection & Status</div>
                            </div>
                            <div class="text-right">
                                <div class="text-white">${count}</div>
                                <div class="text-xs text-blue-400">$${value.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }
            });
            
            if (!vehicleList) {
                vehicleList = '<div class="text-center text-gray-400 py-4">No vehicles owned</div>';
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">üöó VEHICLE FLEET</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        
                        <div class="mb-4 p-3 bg-gray-800/50 rounded">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Total Vehicles:</span>
                                <span class="text-white">${Object.values(vehicles).reduce((a, b) => a + b, 0)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Fleet Value:</span>
                                <span class="gold-text">$${totalValue.toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="max-h-64 overflow-y-auto">
                            ${vehicleList}
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold mt-4">
                            Close Garage
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // Show detailed thug crew breakdown
        function showThugDetails() {
             const thugs = gameState.crew.thugs || [];
             const totalPayroll = thugs.reduce((total, thug) => {
                 const rank = THUG_RANKS[thug.rank] || THUG_RANKS.rookie;
                 return total + rank.salary;
             }, 0);
             
             let thugList = '';
             
             if (thugs.length > 0) {
                 thugs.forEach((thug, index) => {
                     const rank = THUG_RANKS[thug.rank] || THUG_RANKS.rookie;
                     const loyaltyColor = thug.loyalty >= 80 ? 'text-green-400' : 
                                        thug.loyalty >= 50 ? 'text-yellow-400' : 'text-red-400';
                     
                     thugList += `
                         <div class="p-3 border border-gray-700 rounded mb-2">
                             <div class="flex justify-between items-center mb-2">
                                 <div>
                                     <span class="font-bold text-white">${thug.name || 'Unknown Thug'}</span>
                                     <div class="text-xs text-gray-400">${rank.description}</div>
                                 </div>
                                 <div class="text-right">
                                     <div class="text-blue-400 font-bold">${rank.name}</div>
                                     <div class="text-xs gold-text">$${rank.salary}/week</div>
                                 </div>
                             </div>
                             <div class="flex justify-between text-xs">
                                 <span class="text-gray-400">Loyalty: <span class="${loyaltyColor}">${thug.loyalty || 70}%</span></span>
                                 <span class="text-gray-400">XP: ${thug.experience || 0}/${rank.promotionXP || 'MAX'}</span>
                             </div>
                         </div>
                     `;
                 });
             } else {
                 thugList = '<div class="text-center text-gray-400 py-4">No thugs in your crew</div>';
             }
             
             const modal = `
                 <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                     <div class="game-panel rounded-lg p-6 max-w-lg w-full max-h-[85vh] overflow-y-auto">
                         <div class="flex items-center justify-between mb-4">
                             <h3 class="text-xl font-bold cyan-glow">üë• THUG CREW</h3>
                             <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                         </div>
                         
                         <div class="mb-4 p-3 bg-gray-800/50 rounded">
                             <div class="flex justify-between">
                                 <span class="text-gray-400">Total Crew:</span>
                                 <span class="text-white">${thugs.length} thugs</span>
                             </div>
                             <div class="flex justify-between">
                                 <span class="text-gray-400">Weekly Payroll:</span>
                                 <span class="gold-text">$${totalPayroll.toLocaleString()}</span>
                             </div>
                             <div class="flex justify-between">
                                 <span class="text-gray-400">Next Payment:</span>
                                 <span class="text-cyan-400">${Math.ceil((gameState.crew.nextPayrollDue - Date.now()) / (1000 * 60 * 60 * 24))} days</span>
                             </div>
                         </div>
                         
                         <div class="space-y-2">
                             ${thugList}
                         </div>
                         
                         <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold mt-4">
                             Close Crew
                         </button>
                     </div>
                 </div>
             `;
             
             document.getElementById('modalContainer').innerHTML = modal;
         }

         // Show detailed hoe breakdown  
         function showHoeDetails() {
             const hoeDetails = gameState.resources.hoeDetails || {};
             const hoeCount = gameState.resources.hoes || 0;
             
             // Sync hoe details if missing
             if (!hoeDetails.streetWorkers && !hoeDetails.sugarBabies && !hoeDetails.highEndEscorts && hoeCount > 0) {
                 // Convert existing count to mostly street workers
                 gameState.resources.hoeDetails = {
                     streetWorkers: Math.floor(hoeCount * 0.7),
                     sugarBabies: Math.floor(hoeCount * 0.2),
                     highEndEscorts: Math.floor(hoeCount * 0.1),
                     onlyTrampsModels: 0
                 };
                 addConsoleMessage('üëØ Converted hoes to detailed categories', 'pink');
             }
             
             // Calculate income based on proper rates and your cut
             const payoutMultiplier = (100 - gameState.player.payoutPercentage) / 100;
             
             const hoeTypes = [
                 { 
                     name: 'Street Workers', 
                     count: hoeDetails.streetWorkers || 0, 
                     tricksPerDay: 4, // avg 3-5 tricks
                     daysPerWeek: 6,
                     pricePerTrick: 150,
                     weeklyIncome: 4 * 6 * 150, // $3,600/week
                     description: 'Backstreets recruits - high volume workers',
                     district: 'Backstreets'
                 },
                 { 
                     name: 'Sugar Babies', 
                     count: hoeDetails.sugarBabies || 0, 
                     tricksPerDay: 3,
                     daysPerWeek: 5, 
                     pricePerTrick: 250,
                     weeklyIncome: 3 * 5 * 250, // $3,750/week
                     description: 'Midtown talent - consistent earners',
                     district: 'Midtown'
                 },
                 { 
                     name: 'High-End Escorts', 
                     count: hoeDetails.highEndEscorts || 0, 
                     tricksPerDay: 2,
                     daysPerWeek: 5,
                     pricePerTrick: 420,
                     weeklyIncome: 2 * 5 * 420, // $4,200/week
                     description: 'Uptown elite - premium exclusive clients',
                     district: 'Uptown'
                 },
                 { 
                     name: 'OnlyTramps Models', 
                     count: hoeDetails.onlyTrampsModels || 0, 
                     tricksPerDay: 0, // Fixed daily rate
                     daysPerWeek: 7,
                     pricePerTrick: 0,
                     weeklyIncome: 7 * 1260, // $8,820/week ($1,260/day √ó 7 days)
                     description: 'üåü ULTRA RARE - Digital empire queens ($1,260/day)',
                     district: 'Global'
                 }
             ];
             
             const totalWeeklyIncome = hoeTypes.reduce((total, type) => {
                 const weeklyGross = type.count * type.weeklyIncome;
                 const weeklyNet = weeklyGross * payoutMultiplier; // Your cut after payout
                 return total + weeklyNet;
             }, 0);
             const dailyIncome = totalWeeklyIncome / 7;
             
             let hoeList = '';
             hoeTypes.forEach(type => {
                 if (type.count > 0) {
                     const weeklyGrossPerHoe = type.weeklyIncome;
                     const weeklyNetPerHoe = weeklyGrossPerHoe * payoutMultiplier;
                     const dailyNetPerHoe = weeklyNetPerHoe / 7;
                     const totalWeeklyFromType = type.count * weeklyNetPerHoe;
                     const rarityClass = type.name === 'OnlyTramps Models' ? 'border-purple-500 bg-purple-900/20' : 'border-gray-700';
                     
                     hoeList += `
                         <div class="p-3 border ${rarityClass} rounded mb-2">
                             <div class="flex justify-between items-center mb-2">
                                 <div>
                                     <span class="font-bold text-pink-400">${type.name}</span>
                                     ${type.name === 'OnlyTramps Models' ? '<span class="text-purple-400 text-xs ml-2">‚ú® ULTRA RARE</span>' : ''}
                                     <div class="text-xs text-gray-400">${type.description}</div>
                                     <div class="text-xs text-cyan-400">üìç ${type.district}</div>
                                 </div>
                                 <div class="text-right">
                                     <div class="text-white font-bold">${type.count}</div>
                                     <div class="text-xs gold-text">$${dailyNetPerHoe.toFixed(0)}/day each</div>
                                     <div class="text-xs text-green-400">$${(totalWeeklyFromType/7).toFixed(0)}/day total</div>
                                     ${type.name !== 'OnlyTramps Models' ? `
                                         <div class="text-xs text-gray-400">${type.tricksPerDay} tricks √ó ${type.daysPerWeek} days</div>
                                     ` : ''}
                                 </div>
                             </div>
                         </div>
                     `;
                 }
             });
             
             const modal = `
                 <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                     <div class="game-panel rounded-lg p-6 max-w-md w-full">
                         <div class="flex items-center justify-between mb-4">
                             <h3 class="text-xl font-bold cyan-glow">üëØ HOE ROSTER</h3>
                             <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                         </div>
                         
                         <div class="mb-4 p-3 bg-gray-800/50 rounded">
                             <div class="flex justify-between">
                                 <span class="text-gray-400">Total Hoes:</span>
                                 <span class="text-pink-400">${hoeCount}</span>
                             </div>
                             <div class="flex justify-between">
                                 <span class="text-gray-400">Your Cut:</span>
                                 <span class="gold-text">${100 - gameState.player.payoutPercentage}%</span>
                             </div>
                             <div class="flex justify-between">
                                 <span class="text-gray-400">Daily Income:</span>
                                 <span class="gold-text">$${dailyIncome.toFixed(0)}</span>
                             </div>
                             <div class="flex justify-between">
                                 <span class="text-gray-400">Weekly Income:</span>
                                 <span class="gold-text font-bold">$${totalWeeklyIncome.toFixed(0)}</span>
                             </div>
                         </div>
                         
                         <div class="space-y-2">
                             ${hoeList}
                         </div>
                         
                         <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold mt-4">
                             Close Roster
                         </button>
                     </div>
                 </div>
             `;
             
                           document.getElementById('modalContainer').innerHTML = modal;
          }

          // Individual store functions (no apostrophe issues)
          function visitReggiesPlug() {
              openReggiesPlug();
          }

          function visitPewPewJimmys() {
              openGunStore();
          }

          function visitTonysChopShop() {
              openTonysChopShop();
          }

          function visitCornerStore() {
              openCornerStore();
          }

          // Combined crack production and drug selling
          function showCrackAndDrugs() {
              const currentTurns = calculateCurrentTurns();
              const crackCount = gameState.resources.crack || 0;
              const maxSliderValue = Math.min(crackCount, 50000); // Set reasonable max for slider
              
              const modal = `
                  <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                      <div class="game-panel rounded-lg p-6 max-w-2xl w-full my-8 max-h-[90vh] overflow-y-auto">
                          <div class="flex items-center justify-between mb-4">
                              <h3 class="text-xl font-bold cyan-glow">üíé CRACK & DRUG OPERATIONS</h3>
                              <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                          </div>
                          
                          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                              <!-- Production Side -->
                              <div class="border border-gray-600 rounded p-4">
                                  <h4 class="font-bold text-purple-400 mb-3">üè≠ PRODUCE CRACK</h4>
                                  
                                  <div class="mb-3 p-2 bg-gray-800/50 rounded text-sm">
                                      <div>Available Turns: <span class="gold-text">${currentTurns}</span></div>
                                      <div>Thugs Working: <span class="text-blue-400">${gameState.resources.thugs}</span></div>
                                  </div>
                                  
                                  <div class="space-y-2">
                                      <button onclick="produceCrack(10)" class="w-full action-btn rounded py-2 text-sm">10 Turns</button>
                                      <button onclick="produceCrack(20)" class="w-full action-btn rounded py-2 text-sm">20 Turns</button>
                                      <button onclick="produceCrack(30)" class="w-full action-btn rounded py-2 text-sm">30 Turns</button>
                                  </div>
                              </div>
                              
                              <!-- Enhanced Selling Side -->
                              <div class="border border-gray-600 rounded p-4">
                                  <h4 class="font-bold text-green-400 mb-3">üí∞ SELL CRACK</h4>
                                  
                                  <div class="mb-3 p-2 bg-gray-800/50 rounded text-sm">
                                      <div>Crack Available: <span class="text-purple-400">${crackCount.toLocaleString()}</span></div>
                                      <div>Current Heat: <span class="text-orange-400">${gameState.player.heat}%</span></div>
                                  </div>
                                  
                                  <!-- Custom Amount Input with Slider -->
                                  <div class="mb-4">
                                      <div class="flex items-center gap-2 mb-2">
                                          <button onclick="setSellAmount(Math.max(1, parseInt(document.getElementById('crackSellAmount').value) - CRACK_INCREMENT))" 
                                                  class="w-8 h-8 bg-red-600 rounded text-white hover:bg-red-500 text-sm">-</button>
                                          <input type="number" id="crackSellAmount" value="100" min="1" max="${crackCount}" 
                                                 class="flex-1 text-center bg-gray-800 border border-gray-600 rounded text-white py-1"
                                                 oninput="updateSellEstimate()" placeholder="Amount">
                                          <button onclick="setSellAmount(Math.min(${crackCount}, parseInt(document.getElementById('crackSellAmount').value) + CRACK_INCREMENT))" 
                                                  class="w-8 h-8 bg-green-600 rounded text-white hover:bg-green-500 text-sm">+</button>
                                      </div>
                                      
                                      <!-- Slider -->
                                      <input type="range" id="crackSellSlider" min="1" max="${maxSliderValue}" value="100" 
                                             class="w-full accent-green-500" 
                                             oninput="document.getElementById('crackSellAmount').value = this.value; updateSellEstimate()">
                                      
                                      <!-- Quick Action Buttons -->
                                      <div class="grid grid-cols-3 gap-1 mt-2 text-xs">
                                          <button onclick="setSellAmount(100)" class="py-1 bg-gray-700 rounded hover:bg-gray-600">100</button>
                                          <button onclick="setSellAmount(1000)" class="py-1 bg-gray-700 rounded hover:bg-gray-600">1K</button>
                                          <button onclick="setSellAmount(5000)" class="py-1 bg-gray-700 rounded hover:bg-gray-600">5K</button>
                                      </div>
                                      <div class="grid grid-cols-2 gap-1 mt-1 text-xs">
                                          <button onclick="setSellAmount(10000)" class="py-1 bg-gray-700 rounded hover:bg-gray-600">10K</button>
                                          <button onclick="setSellAmount('max')" class="py-1 bg-blue-600 rounded hover:bg-blue-500">Max</button>
                                      </div>
                                  </div>
                                  
                                  <!-- Real-time Estimate Display -->
                                  <div class="mb-4 p-3 bg-gray-900/50 rounded text-sm">
                                      <div class="flex justify-between">
                                          <span>Price:</span>
                                          <span id="crackPriceDisplay" class="text-gray-300">$8/rock</span>
                                      </div>
                                      <div class="flex justify-between">
                                          <span>Total:</span>
                                          <span id="crackTotalDisplay" class="text-green-400 font-bold">$800</span>
                                      </div>
                                      <div class="flex justify-between">
                                          <span>Heat:</span>
                                          <span id="crackHeatDisplay" class="text-orange-400">+6%</span>
                                      </div>
                                  </div>
                                  
                                  <!-- Sell Button -->
                                  <button onclick="sellCrackCustom()" ${crackCount < 1 ? 'disabled' : ''} 
                                          class="w-full py-2 action-btn rounded font-bold ${crackCount < 1 ? 'opacity-50' : ''}">
                                      üí∞ SELL CRACK
                                  </button>
                              </div>
                          </div>
                          
                          <!-- Bulk Pricing Info -->
                          <div class="mb-4 p-3 bg-blue-900/30 rounded text-sm">
                              <h5 class="font-bold text-blue-400 mb-2">üìä Authentic 1991 NYC Crack Prices</h5>
                              <div class="grid grid-cols-2 gap-2 text-xs">
                                  <div><span class="text-gray-400">1-9:</span> <span class="text-red-400">$18/rock</span> <span class="text-red-300">(Street)</span></div>
                                  <div><span class="text-gray-400">10-99:</span> <span class="text-orange-400">$15/rock</span> <span class="text-orange-300">(Small)</span></div>
                                  <div><span class="text-gray-400">100-999:</span> <span class="text-yellow-400">$12/rock</span> <span class="text-yellow-300">(Bulk)</span></div>
                                  <div><span class="text-gray-400">1K-4,999:</span> <span class="text-blue-400">$9/rock</span> <span class="text-blue-300">(Dealer)</span></div>
                                  <div><span class="text-gray-400">5K-9,999:</span> <span class="text-green-400">$7/rock</span> <span class="text-green-300">(Wholesale)</span></div>
                                      <div class="text-gray-400 col-span-2">10K+:</div>
                                      <div class="text-purple-400 col-span-2">$6/rock</div>
                                      <div class="text-green-400 col-span-2">üî• DEEP WHOLESALE</div>
                              </div>
                              <p class="text-cyan-400 text-xs mt-2">üí° Bulk discounts = authentic drug economics ‚Ä¢ Heat scales with ‚àöquantity</p>
                          </div>
                          
                          <button onclick="closeModal()" class="w-full py-3 bg-gray-700 rounded font-bold">
                              Close Operations
                          </button>
                      </div>
                  </div>
              `;
              
              document.getElementById('modalContainer').innerHTML = modal;
              
              // Initialize estimates after modal is rendered
              setTimeout(() => {
                  updateSellEstimate();
              }, 100);
          }

          // Quick crack production (called from combined modal)
          function produceCrack(turns) {
              if (!useTurns(turns)) {
                  showNotification(`‚ùå Not enough turns! Need ${turns} turns`, 'error');
                  return;
              }
              
              const crackPerThugPerTurn = 0.8;
              const crackProduced = gameState.resources.thugs > 0 ? 
                  Math.floor(gameState.resources.thugs * turns * crackPerThugPerTurn) + Math.floor(Math.random() * turns) : 
                  Math.floor(turns * 0.1);
                  
              const moneyPerHoePerTurn = 8;
              const moneyEarned = gameState.resources.hoes > 0 ? 
                  gameState.resources.hoes * turns * moneyPerHoePerTurn + Math.floor(Math.random() * turns * 5) :
                  turns * 3;
              
              gameState.resources.crack += crackProduced;
              gameState.player.cash += moneyEarned;
              
              // Give thugs experience
              gameState.crew.thugs.forEach(thug => {
                  thug.experience += turns * 2;
              });
              checkThugPromotions();
              
              showActionResults({
                  action: 'Crack Production',
                  turnsUsed: turns,
                  results: {
                      crack: crackProduced,
                      money: moneyEarned
                  },
                  nftChance: false
              });
              
              addConsoleMessage(`üíé Produced ${crackProduced} crack rocks (+$${moneyEarned}) using ${turns} turns`, 'purple');
              updateUI();
              saveGameState();
          }
 
          // Test purchase function
        function testPurchase() {
            console.log('üß™ Testing direct weed purchase...');
            console.log('üß™ Before purchase:', {
                cash: gameState.player.cash,
                weed: gameState.resources.weed,
                weedElement: document.getElementById('weedCount')?.textContent
            });
            
            const cost = 15;
            const amount = 0.125;
            
            if (gameState.player.cash >= cost) {
                gameState.player.cash -= cost;
                gameState.resources.weed = (gameState.resources.weed || 0) + amount;
                
                console.log('üß™ After purchase:', {
                    newCash: gameState.player.cash,
                    newWeed: gameState.resources.weed,
                    gameStateResources: gameState.resources
                });
                
                // Force update UI components
                updateUI();
                updateSupplyStatus();
                calculateHappiness();
                
                console.log('üß™ After UI update:', {
                    weedElement: document.getElementById('weedCount')?.textContent,
                    thugHappiness: gameState.supplies.thugHappiness
                });
                
                saveGameState();
                
                showNotification(`üß™ Test: Bought ${amount}oz weed for $${cost}!`, 'success');
                addConsoleMessage(`üß™ Test purchase: ${amount}oz weed for $${cost} - Total: ${gameState.resources.weed.toFixed(3)}oz`, 'purple');
            } else {
                console.log('‚ùå Not enough cash for test purchase');
                showNotification('‚ùå Not enough cash for test!', 'error');
            }
        }

        // DAILY 4:20PM PAYOUT SYSTEM - Re-implemented
        function processDailyPayout() {
            const now = new Date();
            const today = now.toDateString();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTime = currentHour * 60 + currentMinute; // Minutes since midnight
            const payoutTime = 16 * 60 + 20; // 4:20 PM in minutes
            
            // Check if we've already done today's payout
            const lastPayoutDate = gameState.player.lastDailyPayoutDate || '';
            
            if (lastPayoutDate === today) {
                console.log('üí∞ Daily payout already completed for today');
                return; // Already paid today
            }
            
            // Check if it's past 4:20 PM
            if (currentTime >= payoutTime) {
                console.log('üí∞ PROCESSING DAILY 4:20PM PAYOUT...');
                
                // Calculate full daily earnings
                const payoutMultiplier = (100 - gameState.player.payoutPercentage) / 100;
                let totalDailyEarnings = 0;
                let payoutDetails = [];
                
                // Calculate by hoe tier
                const hoeDetails = gameState.resources.hoeDetails || {};
                
                // Street Workers - $180 base per day
                if (hoeDetails.streetWorkers > 0) {
                    const baseEarnings = hoeDetails.streetWorkers * 180;
                    const pimpEarnings = Math.floor(baseEarnings * payoutMultiplier);
                    totalDailyEarnings += pimpEarnings;
                    payoutDetails.push(`${hoeDetails.streetWorkers} Street Workers: $${pimpEarnings}`);
                }
                
                // Sugar Babies - $240 base per day
                if (hoeDetails.sugarBabies > 0) {
                    const baseEarnings = hoeDetails.sugarBabies * 240;
                    const pimpEarnings = Math.floor(baseEarnings * payoutMultiplier);
                    totalDailyEarnings += pimpEarnings;
                    payoutDetails.push(`${hoeDetails.sugarBabies} Sugar Babies: $${pimpEarnings}`);
                }
                
                // High-End Escorts - $350 base per day
                if (hoeDetails.highEndEscorts > 0) {
                    const baseEarnings = hoeDetails.highEndEscorts * 350;
                    const pimpEarnings = Math.floor(baseEarnings * payoutMultiplier);
                    totalDailyEarnings += pimpEarnings;
                    payoutDetails.push(`${hoeDetails.highEndEscorts} High-End Escorts: $${pimpEarnings}`);
                }
                
                // OnlyTramps Models - $1260 base per day
                if (hoeDetails.onlyTrampsModels > 0) {
                    const baseEarnings = hoeDetails.onlyTrampsModels * 1260;
                    const pimpEarnings = Math.floor(baseEarnings * payoutMultiplier);
                    totalDailyEarnings += pimpEarnings;
                    payoutDetails.push(`${hoeDetails.onlyTrampsModels} OnlyTramps Models: $${pimpEarnings}`);
                }
                
                // Apply happiness and heat modifiers
                const happinessBonus = gameState.supplies.hoeHappiness > 80 ? 1.1 : 
                                     gameState.supplies.hoeHappiness > 60 ? 1.0 : 0.9;
                const heatPenalty = gameState.player.heat > 75 ? 0.7 : 
                                  gameState.player.heat > 50 ? 0.85 : 1.0;
                
                totalDailyEarnings = Math.floor(totalDailyEarnings * happinessBonus * heatPenalty);
                
                if (totalDailyEarnings > 0) {
                    logResourceChange('cash', null, gameState.player.cash, gameState.player.cash + totalDailyEarnings, 'daily_420_payout');
                    gameState.player.cash += totalDailyEarnings;
                    
                    // Show payout modal
                    showDailyPayoutModal(totalDailyEarnings, payoutDetails, happinessBonus, heatPenalty);
                }
                
                // Mark today as paid
                gameState.player.lastDailyPayoutDate = today;
                saveGameState();
            }
        }
        
        function showDailyPayoutModal(totalEarnings, details, happinessBonus, heatPenalty) {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-xl font-bold gold-text mb-4">üí∞ DAILY 4:20PM PAYOUT</h3>
                        
                        <div class="mb-4 p-4 bg-green-900/30 rounded border border-green-500/50">
                            <h4 class="font-bold text-green-400 mb-3">üéâ Daily Earnings Collected!</h4>
                            <div class="text-center mb-3">
                                <div class="text-3xl font-bold gold-text">+$${totalEarnings.toLocaleString()}</div>
                                <div class="text-sm text-gray-400">Your cut from today's work</div>
                            </div>
                        </div>
                        
                        <div class="mb-4 p-3 bg-gray-800/50 rounded">
                            <h5 class="font-bold text-white mb-2">üìä Breakdown:</h5>
                            <div class="text-xs space-y-1">
                                ${details.map(detail => `<div class="text-gray-300">‚Ä¢ ${detail}</div>`).join('')}
                            </div>
                        </div>
                        
                        <div class="mb-4 p-3 bg-blue-900/30 rounded">
                            <h5 class="font-bold text-blue-400 mb-2">üîç Modifiers:</h5>
                            <div class="text-xs space-y-1">
                                <div class="text-gray-300">‚Ä¢ Happiness Bonus: ${((happinessBonus - 1) * 100).toFixed(0)}%</div>
                                <div class="text-gray-300">‚Ä¢ Heat Penalty: ${((1 - heatPenalty) * 100).toFixed(0)}%</div>
                                <div class="text-gray-300">‚Ä¢ Your Payout Rate: ${100 - gameState.player.payoutPercentage}%</div>
                            </div>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold">
                            Continue Playing
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
            addConsoleMessage(`üí∞ DAILY PAYOUT: $${totalEarnings.toLocaleString()} collected!`, 'gold');
            showNotification(`üí∞ Daily 4:20PM payout: $${totalEarnings.toLocaleString()}!`, 'success');
        }
        
        function getTimeUntilNextPayout() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 16, 20, 0); // Today at 4:20 PM
            
            if (now > today) {
                // If past 4:20 PM today, next payout is tomorrow at 4:20 PM
                today.setDate(today.getDate() + 1);
            }
            
            const timeUntil = today - now;
            const hours = Math.floor(timeUntil / (1000 * 60 * 60));
            const minutes = Math.floor((timeUntil % (1000 * 60 * 60)) / (1000 * 60));
            
            return `${hours}h ${minutes}m`;
        }

        // Generate income from working hoes
        function generateHoeIncome() {
            if (gameState.resources.hoes <= 0) return;
            
            const now = Date.now();
            const timeSinceLastIncome = now - (gameState.player.lastIncomeTime || now);
            const minutesPassed = timeSinceLastIncome / (1000 * 60);
            
            // Generate income every 30 minutes (reduced frequency to prevent exploits)
            if (minutesPassed >= 30) {
                const incomeIntervals = Math.min(48, Math.floor(minutesPassed / 30)); // Cap at 48 intervals (24 hours max)
                
                // FIXED: Much more conservative income generation
                const maxIncomePerInterval = 500; // Cap income per interval
                const maxDeedsPerInterval = Math.min(10, Math.floor(gameState.resources.hoes * 0.05)); // Max 5% of hoes work per interval
                
                let totalEarned = 0;
                let totalDeeds = 0;
                
                for (let i = 0; i < incomeIntervals; i++) {
                    // Random number of hoes work (0 to maxDeedsPerInterval)
                    const workingHoes = Math.floor(Math.random() * (maxDeedsPerInterval + 1));
                    
                    for (let j = 0; j < workingHoes; j++) {
                        // Each deed earns $50-100, hoe keeps based on payout %
                        const deedEarnings = 50 + Math.floor(Math.random() * 50); // $50-100 per deed
                        const hoeKeeps = Math.floor(deedEarnings * (gameState.player.payoutPercentage / 100));
                        const pimpEarns = deedEarnings - hoeKeeps;
                        
                        totalEarned += pimpEarns;
                        totalDeeds++;
                    }
                }
                
                // Apply hard cap to prevent exploits
                totalEarned = Math.min(totalEarned, maxIncomePerInterval * incomeIntervals);
                
                if (totalEarned > 0) {
                    // Log the change with our new tracking system
                    logResourceChange('cash', null, gameState.player.cash, gameState.player.cash + totalEarned, 'hoe_income_generation');
                    
                    gameState.player.cash += totalEarned;
                    addConsoleMessage(`üí∞ ${totalDeeds} deeds completed: +$${totalEarned} (${gameState.player.payoutPercentage}% payout)`, 'green');
                }
                
                gameState.player.lastIncomeTime = now;
                updateUI();
                saveLocalGameState();
            }
        }

        // Thug rank system and payroll
        const THUG_RANKS = {
            'rookie': { name: 'Rookie', salary: 250, promotionXP: 100, description: 'Street corner muscle' },
            'soldier': { name: 'Soldier', salary: 400, promotionXP: 300, description: 'Proven enforcer' },
            'lieutenant': { name: 'Lieutenant', salary: 650, promotionXP: 600, description: 'Crew leader' },
            'captain': { name: 'Captain', salary: 1000, promotionXP: 1200, description: 'District boss' },
            'enforcer': { name: 'Enforcer', salary: 1500, promotionXP: null, description: 'Elite muscle' }
        };

        // Initialize thugs with ranks when scouting
        function createThug(name = null, rank = 'rookie') {
            const thug = {
                id: Date.now() + Math.random(),
                name: name || generateThugName(rank),
                rank: rank,
                experience: 0,
                hiredDate: Date.now(),
                loyalty: 70
            };
            
            console.log('üë• Created new thug:', thug);
            return thug;
        }

        // Thug names organized by rank/promotion level
        const THUG_NAMES_BY_RANK = {
            rookie: [
                'Phoenix', 'Ice', 'Diesel', 'Tank', 'Blade', 'Bones', 'Crow', 'Fish', 'Brick', 'Stone',
                'Tiny', 'Patches', 'Smoke', 'Wire', 'Cash', 'Dice', 'Rook', 'Ace', 'Spade', 'Club',
                'Rookie', 'Fresh', 'Kid', 'Mouse', 'Pebble', 'Chip', 'Spark', 'Dash', 'Quick', 'Flash'
            ],
            soldier: [
                'Razor', 'Viper', 'Skull', 'Grim', 'Steel', 'Iron', 'Hammer', 'Spike', 'Torch', 'Frost',
                'Storm', 'Thunder', 'Lightning', 'Blaze', 'Fury', 'Rage', 'Shadow', 'Ghost', 'Phantom', 'Shade',
                'Wolf', 'Bear', 'Tiger', 'Hawk', 'Eagle', 'Falcon', 'Cobra', 'Shark', 'Bull', 'Rhino'
            ],
            enforcer: [
                'Big Mike', 'Heavy', 'Crusher', 'Breaker', 'Smasher', 'Wrecker', 'Destroyer', 'Bruiser', 'Killer', 'Slayer',
                'Terminator', 'Executioner', 'Reaper', 'Judge', 'Jury', 'Punisher', 'Enforcer', 'Guardian', 'Defender', 'Protector',
                'Titan', 'Giant', 'Goliath', 'Hercules', 'Atlas', 'Zeus', 'Thor', 'Odin', 'Ares', 'Mars'
            ],
            lieutenant: [
                'Commander', 'Captain', 'Major', 'Colonel', 'General', 'Admiral', 'Marshal', 'Chief', 'Boss', 'Leader',
                'King', 'Prince', 'Duke', 'Earl', 'Baron', 'Lord', 'Master', 'Overlord', 'Supreme', 'Prime',
                'Alpha', 'Omega', 'Delta', 'Sigma', 'Gamma', 'Beta', 'Epsilon', 'Lambda', 'Theta', 'Phi'
            ],
            underboss: [
                'Don', 'Godfather', 'Capo', 'Consigliere', 'Underboss', 'Right Hand', 'Left Hand', 'Iron Fist', 'Cold Blood', 'Dead Eye',
                'The Blade', 'The Hammer', 'The Anvil', 'The Forge', 'The Fire', 'The Ice', 'The Storm', 'The Calm', 'The Beast', 'The King',
                'Scarface', 'Blackjack', 'Diamond', 'Platinum', 'Gold', 'Silver', 'Bronze', 'Steel', 'Iron', 'Titanium'
            ]
        };

        function generateThugName(rank = 'rookie') {
            const namePool = THUG_NAMES_BY_RANK[rank] || THUG_NAMES_BY_RANK.rookie;
            return namePool[Math.floor(Math.random() * namePool.length)];
        }

        // Enhanced Heat Management System - Based on heat.JSON and HEAT.MD
        let heatSystemData = null;
        
        // Load heat system data (inline to avoid CORS issues)
        async function loadHeatSystem() {
            console.log('üöî Loading heat system (inline)...');
            // Use inline data to avoid CORS issues when opening HTML directly
            heatSystemData = {
                    heat: {
                        bribes: [
                            { id: "bribe_light", label: "Light Bribe", costPctNW: 0.02, heatDropPct: 0.15, corruption: 1, stingChance: 0.00 },
                            { id: "bribe_medium", label: "Medium Bribe", costPctNW: 0.05, heatDropPct: 0.30, corruption: 2, stingChance: 0.10 },
                            { id: "bribe_heavy", label: "Heavy Bribe", costPctNW: 0.10, heatDropPct: 0.50, corruption: 3, stingChance: 0.15 },
                            { id: "bribe_over", label: "Overbribe", costPctNW: 0.15, heatDropPct: 0.60, corruption: 5, stingChance: 0.15 }
                        ],
                        charityTiers: [
                            {
                                id: "minor", turns: 10, costPctNW: 0.005, heatDropRange: [8, 12], backfireChance: 0.05,
                                events: [
                                    { id: "thug_hug_therapy", title: "Thug Hug Therapy", flavor: "One hug at a time, the block gets softer." },
                                    { id: "street_cleanup_hoedown", title: "Street Clean-Up Hoe-Down", flavor: "Mopping corners, then twerking on 'em." },
                                    { id: "pimps_for_potholes", title: "Pimps for Potholes", flavor: "Filling cracks in the road, not just pipes." }
                                ]
                            },
                            {
                                id: "mid", turns: 20, costPctNW: 0.015, heatDropRange: [15, 20], backfireChance: 0.10,
                                events: [
                                    { id: "lap_dances_literacy", title: "Lap Dances for Literacy", flavor: "Shakin' it so kids can read good." },
                                    { id: "pimps_soup_kitchen", title: "Pimp's Soup Kitchen", flavor: "Serving broth, blunts, and bread rolls." }
                                ]
                            },
                            {
                                id: "major", turns: 35, costPctNW: 0.03, costPctNWMax: 0.05, heatDropRange: [25, 35], backfireChance: 0.15,
                                nftDrop: { chance: 0.02, pool: ["bronze_key","silver_key","gold_key","diamond_key"] },
                                events: [
                                    { id: "handjobs_homeless", title: "Handjobs for the Homeless", flavor: "Relief work at its finest." }
                                ]
                            }
                        ]
                    }
                };
            console.log('‚úÖ Heat system loaded (inline)');
        }
        
        // Heat system state
        const HEAT_STATE = {
            corruption: 0, // Corruption level from bribes
            lastBribeDate: 0,
            nftKeys: [], // NFT keys that reduce heat
            lastCharityDate: 0
        };

        // Enhanced Heat Management Services - Based on heat.JSON
        function showHeatReductionServices() {
            if (!heatSystemData) {
                showNotification('‚ùå Heat system loading...', 'error');
                return;
            }
            
            const heat = gameState.player.heat || 0;
            const netWorth = calculateNetWorth();
            const corruption = HEAT_STATE.corruption || 0;
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full my-8 max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">üöî HEAT MANAGEMENT</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        
                        <!-- Current Heat Status -->
                        <div class="mb-4 p-3 bg-red-900/30 rounded border border-red-500/50">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-red-400 font-bold">Current Heat:</span>
                                <span class="text-white font-bold text-2xl">${heat}%</span>
                            </div>
                            <div class="w-full h-3 bg-gray-800 rounded-full mb-2">
                                <div class="h-full rounded-full ${getHeatBarColor(heat)}" style="width: ${heat}%"></div>
                            </div>
                            <div class="text-xs text-gray-400">
                                Net Worth: $${netWorth.toLocaleString()} ‚Ä¢ Corruption: ${corruption}
                            </div>
                        </div>
                        
                        <!-- Police Bribes (Enhanced) -->
                        <div class="mb-4 border border-yellow-600 rounded p-3">
                            <h4 class="font-bold text-yellow-400 mb-3">üí∞ Police Bribes</h4>
                            <p class="text-xs text-gray-400 mb-3">Cost based on Net Worth ‚Ä¢ Builds corruption over time</p>
                            <div class="space-y-2">
                                ${heatSystemData.heat.bribes.map(bribe => {
                                    const cost = Math.floor(netWorth * bribe.costPctNW * (1 + corruption * 0.2));
                                    const heatDrop = Math.floor(heat * bribe.heatDropPct);
                                    const canAfford = gameState.player.cash >= cost;
                                    
                                    return `
                                        <button onclick="payEnhancedBribe('${bribe.id}')" 
                                                ${!canAfford ? 'disabled' : ''} 
                                                class="w-full action-btn rounded py-2 text-sm ${!canAfford ? 'opacity-50' : ''}">
                                            <div class="flex justify-between items-center">
                                                <span>${bribe.label}</span>
                                                <span>-${heatDrop}% heat ($${cost.toLocaleString()})</span>
                                            </div>
                                            ${bribe.stingChance > 0 ? `<div class="text-xs text-red-400">‚ö†Ô∏è ${(bribe.stingChance * 100)}% sting risk</div>` : ''}
                                    </button>
                                    `;
                                }).join('')}
                                </div>
                            </div>
                            
                        <!-- Charity Events (New!) -->
                        <div class="mb-4 border border-green-600 rounded p-3">
                            <h4 class="font-bold text-green-400 mb-3">üé≠ Charity Events</h4>
                            <p class="text-xs text-gray-400 mb-3">Funny community service ‚Ä¢ Cheaper but riskier</p>
                            <div class="space-y-2">
                                ${heatSystemData.heat.charityTiers.map(tier => {
                                    const cost = Math.floor(netWorth * tier.costPctNW);
                                    const minDrop = tier.heatDropRange[0];
                                    const maxDrop = tier.heatDropRange[1];
                                    const canAfford = gameState.player.cash >= cost && calculateCurrentTurns() >= tier.turns;
                                    
                                    return `
                                        <button onclick="doCharityEvent('${tier.id}')" 
                                                ${!canAfford ? 'disabled' : ''} 
                                                class="w-full action-btn rounded py-2 text-sm ${!canAfford ? 'opacity-50' : ''}">
                                            <div class="flex justify-between items-center">
                                                <span>${tier.id.charAt(0).toUpperCase() + tier.id.slice(1)} Charity</span>
                                                <span>-${minDrop}-${maxDrop}% heat (${tier.turns} turns, $${cost.toLocaleString()})</span>
                                            </div>
                                            <div class="text-xs text-yellow-400">${(tier.backfireChance * 100)}% backfire risk ${tier.nftDrop ? '‚Ä¢ 2% NFT Key chance!' : ''}</div>
                                    </button>
                                    `;
                                }).join('')}
                                </div>
                            </div>
                            
                        <!-- NFT Keys Display -->
                        ${HEAT_STATE.nftKeys.length > 0 ? `
                            <div class="mb-4 p-3 bg-purple-900/30 rounded border border-purple-500/50">
                                <h4 class="font-bold text-purple-400 mb-2">üóùÔ∏è NFT Keys to the City</h4>
                                <div class="text-xs space-y-1">
                                    ${HEAT_STATE.nftKeys.map(key => `
                                        <div class="flex justify-between">
                                            <span class="text-purple-300">${key.name}</span>
                                            <span class="text-green-400">-${key.heatReduction}% heat gain</span>
                                    </div>
                                    `).join('')}
                                </div>
                        </div>
                        ` : ''}
                        
                        <div class="text-xs text-gray-400 text-center">
                            ${getEnhancedHeatAdvice(heat)}
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-3 bg-gray-700 rounded font-bold mt-4">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // Enhanced heat management functions
        function payEnhancedBribe(brideId) {
            const bribe = heatSystemData.heat.bribes.find(b => b.id === brideId);
            if (!bribe) return;
            
            const netWorth = calculateNetWorth();
            const corruption = HEAT_STATE.corruption || 0;
            const cost = Math.floor(netWorth * bribe.costPctNW * (1 + corruption * 0.2));
            const heatDrop = Math.floor(gameState.player.heat * bribe.heatDropPct);
            
            if (gameState.player.cash < cost) {
                showNotification(`üí∏ Need $${cost.toLocaleString()} for ${bribe.label}`, 'error');
                return;
            }
            
            // Check for sting operation
            const stingRisk = bribe.stingChance + (corruption * 0.05); // +5% per corruption level
            if (Math.random() < stingRisk) {
                // STING OPERATION!
                gameState.player.cash -= cost;
                gameState.player.heat = Math.min(100, gameState.player.heat + 20);
                const fine = Math.floor(netWorth * 0.01);
                gameState.player.cash = Math.max(0, gameState.player.cash - fine);
                
                addConsoleMessage(`üö® STING OPERATION! Bribe backfired: +20% heat, $${fine.toLocaleString()} fine!`, 'red');
                showNotification(`üö® Sting operation! Lost $${(cost + fine).toLocaleString()} and gained heat!`, 'error');
            } else {
                // Successful bribe
                gameState.player.cash -= cost;
                gameState.player.heat = Math.max(0, gameState.player.heat - heatDrop);
                HEAT_STATE.corruption += bribe.corruption;
                HEAT_STATE.lastBribeDate = Date.now();
                
                addConsoleMessage(`üí∞ ${bribe.label}: -${heatDrop}% heat for $${cost.toLocaleString()}`, 'yellow');
                showNotification(`üí∞ ${bribe.label}: -${heatDrop}% heat`, 'success');
            }
            
            updateUI();
            saveGameState();
            showHeatReductionServices(); // Refresh modal
        }
        
        function doCharityEvent(tierId) {
            const tier = heatSystemData.heat.charityTiers.find(t => t.id === tierId);
            if (!tier) return;
            
            const netWorth = calculateNetWorth();
            const cost = Math.floor(netWorth * tier.costPctNW);
            
            if (!useTurns(tier.turns)) {
                showNotification(`‚ùå Need ${tier.turns} turns for charity event`, 'error');
                return;
            }
            
            if (gameState.player.cash < cost) {
                showNotification(`üí∏ Need $${cost.toLocaleString()} for charity event`, 'error');
                return;
            }
            
            // Random event from tier
            const randomEvent = tier.events[Math.floor(Math.random() * tier.events.length)];
            
            // Check for backfire
            if (Math.random() < tier.backfireChance) {
                // BACKFIRE!
                gameState.player.cash -= cost;
                const backfireHeat = Math.floor(Math.random() * 10) + 5; // +5-15% heat
                gameState.player.heat = Math.min(100, gameState.player.heat + backfireHeat);
                
                showCharityResultModal(randomEvent, tier, true, backfireHeat, cost);
                addConsoleMessage(`üö® CHARITY BACKFIRED: ${randomEvent.title} went wrong! +${backfireHeat}% heat`, 'red');
            } else {
                // Success!
                gameState.player.cash -= cost;
                const heatDrop = tier.heatDropRange[0] + Math.floor(Math.random() * (tier.heatDropRange[1] - tier.heatDropRange[0] + 1));
                gameState.player.heat = Math.max(0, gameState.player.heat - heatDrop);
                
                // Check for NFT Key drop (major events only)
                let nftKey = null;
                if (tier.nftDrop && Math.random() < tier.nftDrop.chance) {
                    const keyType = tier.nftDrop.pool[Math.floor(Math.random() * tier.nftDrop.pool.length)];
                    nftKey = createNFTKey(keyType);
                    HEAT_STATE.nftKeys.push(nftKey);
                    addConsoleMessage(`üóùÔ∏è NFT KEY DISCOVERED: ${nftKey.name}!`, 'purple');
                }
                
                showCharityResultModal(randomEvent, tier, false, heatDrop, cost, nftKey);
                addConsoleMessage(`üé≠ ${randomEvent.title}: -${heatDrop}% heat for $${cost.toLocaleString()}`, 'green');
            }
            
            HEAT_STATE.lastCharityDate = Date.now();
            updateUI();
            saveGameState();
        }
        
        function createNFTKey(keyType) {
            const keyData = {
                bronze_key: { name: "Bronze Key to the City", heatReduction: 5, rarity: "uncommon" },
                silver_key: { name: "Silver Key to the City", heatReduction: 10, rarity: "rare" },
                gold_key: { name: "Gold Key to the City", heatReduction: 15, rarity: "epic" },
                diamond_key: { name: "Diamond Key to the City", heatReduction: 20, rarity: "legendary" }
            };
            
            return {
                id: Date.now() + '_' + keyType,
                type: keyType,
                ...keyData[keyType],
                foundAt: Date.now(),
                foundLocation: "Charity Event"
            };
        }
        
        function showCharityResultModal(event, tier, backfired, heatChange, cost, nftKey = null) {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-xl font-bold cyan-glow mb-4">üé≠ CHARITY EVENT RESULT</h3>
                        
                        <div class="mb-4 p-4 ${backfired ? 'bg-red-900/30 border border-red-500/50' : 'bg-green-900/30 border border-green-500/50'} rounded">
                            <h4 class="font-bold ${backfired ? 'text-red-400' : 'text-green-400'} mb-2">${event.title}</h4>
                            <p class="text-sm text-gray-300 italic mb-3">"${event.flavor}"</p>
                            
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span>Cost:</span>
                                    <span class="text-red-400">-$${cost.toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Turns Used:</span>
                                    <span class="text-yellow-400">${tier.turns}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Heat Change:</span>
                                    <span class="${backfired ? 'text-red-400' : 'text-green-400'}">${backfired ? '+' : '-'}${heatChange}%</span>
                                </div>
                            </div>
                        </div>
                        
                        ${nftKey ? `
                            <div class="mb-4 p-4 bg-gradient-to-r from-purple-900/70 to-pink-900/70 rounded border-2 border-purple-400 animate-pulse">
                                <h4 class="font-bold text-purple-300 mb-2 text-center">üóùÔ∏è NFT KEY DISCOVERED!</h4>
                                <div class="text-center">
                                    <p class="font-bold text-white text-lg">${nftKey.name}</p>
                                    <p class="text-sm text-purple-300">Permanent -${nftKey.heatReduction}% heat gain reduction</p>
                                    <p class="text-xs text-gray-300 mt-1">This key is bound to your account forever!</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold">
                            ${backfired ? 'Learn from Mistakes' : 'Continue Good Work'}
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
        }
        
        function calculateNetWorth() {
            return gameState.player.cash + 
                   (gameState.resources.hoes * 2000) +
                   (gameState.resources.thugs * 750) +
                   (gameState.resources.crack * 3) +
                   Object.values(gameState.resources.weapons || {}).reduce((total, count) => {
                       return total + (count * 250); // Average weapon value
                   }, 0) +
                   Object.values(gameState.resources.vehicles || {}).reduce((total, count) => {
                       return total + (count * 10000); // Average vehicle value
                   }, 0);
        }
        
        function getEnhancedHeatAdvice(heat) {
            if (heat >= 85) return 'üö® CATASTROPHIC: Rico case incoming - use NFT keys or emergency options!';
            if (heat >= 69) return '‚ö†Ô∏è SERIOUS DANGER: SWAT raids likely - reduce heat immediately';
            if (heat >= 60) return 'üî• HIGH RISK: Major raids possible - consider charity events';
            if (heat >= 40) return '‚ö° WARM: Minor busts possible - manage heat levels';
            return '‚úÖ SAFE: Low police attention - normal operations';
        }

        // Legacy heat functions (simplified)
        function payBribe(heatReduction) {
            // Redirect to enhanced system
            payEnhancedBribe('bribe_light');
            
            if (gameState.player.cash < cost) {
                showNotification(`üí∏ Need $${cost.toLocaleString()} for bribe`, 'error');
                return;
            }
            
            const oldCash = gameState.player.cash;
            const oldHeat = gameState.player.heat;
            
            logResourceChange('cash', null, oldCash, oldCash - cost, 'police_bribe');
            logResourceChange('heat', null, oldHeat, Math.max(0, oldHeat - heatReduction), 'police_bribe');
            
            gameState.player.cash -= cost;
            gameState.player.heat = Math.max(0, gameState.player.heat - heatReduction);
            
            addConsoleMessage(`üí∞ Paid $${cost.toLocaleString()} bribe: -${heatReduction}% heat`, 'yellow');
            showNotification(`üí∞ Bribe paid: -${heatReduction}% heat`, 'success');
            
            updateUI();
            saveGameState();
            showHeatReductionServices(); // Refresh modal
        }

        function doCommunityService(turns) {
            if (!useTurns(turns)) {
                showNotification(`‚ùå Need ${turns} turns for community service`, 'error');
                return;
            }
            
            const oldHeat = gameState.player.heat;
            const heatReduction = turns === 20 ? 5 : 15;
            const newHeat = Math.max(0, oldHeat - heatReduction);
            
            logResourceChange('heat', null, oldHeat, newHeat, 'community_service');
            gameState.player.heat = newHeat;
            
            addConsoleMessage(`ü§ù Community service: ${turns} turns for -${heatReduction}% heat`, 'green');
            showNotification(`ü§ù Good deed done: -${heatReduction}% heat`, 'success');
            
            updateUI();
            saveGameState();
            closeModal();
        }

        function skipTown() {
            if (!confirm('üèÉ Skip town? You\'ll lose your territory bonuses but heat drops to 25%')) {
                return;
            }
            
            const oldHeat = gameState.player.heat;
            logResourceChange('heat', null, oldHeat, 25, 'skip_town');
            
            gameState.player.heat = 25;
            gameState.player.district = null; // Lose territory
            
            addConsoleMessage('üèÉ Skipped town: Heat reduced to 25%, lost territory', 'orange');
            showNotification('üèÉ New city, new start', 'warning');
            
            updateUI();
            saveGameState();
            closeModal();
        }

        function goUnderground() {
            if (!confirm('üï≥Ô∏è Go underground for 7 days? No income but heat drops to 0%')) {
                return;
            }
            
            const oldHeat = gameState.player.heat;
            logResourceChange('heat', null, oldHeat, 0, 'go_underground');
            
            gameState.player.heat = 0;
            gameState.player.underground = true;
            gameState.player.undergroundUntil = Date.now() + 7 * 24 * 60 * 60 * 1000;
            
            addConsoleMessage('üï≥Ô∏è Gone underground: 7 days, no income, heat cleared', 'purple');
            showNotification('üï≥Ô∏è Underground hideout activated', 'warning');
            
            updateUI();
            saveGameState();
            closeModal();
        }

        // Helper functions
        function getHeatBarColor(heat) {
            if (heat >= 100) return 'bg-red-600';
            if (heat >= 76) return 'bg-red-500';
            if (heat >= 51) return 'bg-orange-500';
            if (heat >= 26) return 'bg-yellow-500';
            return 'bg-green-500';
        }

        function getHeatAdvice(heat) {
            if (heat >= 100) return 'üö® EMERGENCY: Use emergency options or major bribes immediately!';
            if (heat >= 76) return '‚ö†Ô∏è EXTREME DANGER: Police operations likely - reduce heat ASAP';
            if (heat >= 51) return 'üî• HIGH RISK: Avoid drug sales, pay protection money';
            if (heat >= 26) return '‚ö° WARM: Police watching - be careful with operations';
            return '‚úÖ SAFE: Normal operations, low police attention';
        }

        // Process weekly payroll
        function processPayroll() {
            const now = Date.now();
            
            // Check if payroll is due (every 7 days)
            if (now >= gameState.crew.nextPayrollDue) {
                let totalPayroll = 0;
                let paidThugs = 0;
                
                gameState.crew.thugs.forEach(thug => {
                    const rank = THUG_RANKS[thug.rank];
                    totalPayroll += rank.salary;
                    paidThugs++;
                });
                
                if (totalPayroll > 0) {
                    if (gameState.player.cash >= totalPayroll) {
                        gameState.player.cash -= totalPayroll;
                        addConsoleMessage(`üí∏ Weekly payroll: $${totalPayroll} paid to ${paidThugs} thugs`, 'yellow');
                        
                        // Increase loyalty for paid thugs
                        gameState.crew.thugs.forEach(thug => {
                            thug.loyalty = Math.min(100, thug.loyalty + 5);
                        });
                    } else {
                        // Can't afford payroll - thugs get unhappy but DON'T LEAVE in single-player
                        addConsoleMessage(`üö® Can't afford payroll! Need $${totalPayroll}, have $${gameState.player.cash}`, 'red');
                        addConsoleMessage(`üí° SINGLE-PLAYER: Thugs are unhappy but won't leave (no asset losses)`, 'yellow');
                        
                        // Lower loyalty but no quitting in single-player
                        gameState.crew.thugs.forEach(thug => {
                            thug.loyalty = Math.max(10, thug.loyalty - 20); // Never below 10%
                        });
                        
                        // In future multiplayer: unhappy thugs might switch to other players
                        addConsoleMessage(`üîÆ Future multiplayer: Unhappy thugs might join other players!`, 'purple');
                    }
                }
                
                // Set next payroll date
                gameState.crew.nextPayrollDue = now + (7 * 24 * 60 * 60 * 1000);
                gameState.crew.lastPayrollTime = now;
                
                updateUI();
                saveLocalGameState();
            }
        }

        // Promote thugs based on experience
        function checkThugPromotions() {
            gameState.crew.thugs.forEach(thug => {
                const currentRank = THUG_RANKS[thug.rank];
                if (currentRank.promotionXP && thug.experience >= currentRank.promotionXP) {
                    const rankKeys = Object.keys(THUG_RANKS);
                    const currentIndex = rankKeys.indexOf(thug.rank);
                    if (currentIndex < rankKeys.length - 1) {
                        const oldName = thug.name || 'Unknown Thug';
                        const newRank = rankKeys[currentIndex + 1];
                        thug.rank = newRank;
                        thug.experience = 0; // Reset XP for next promotion
                        
                        // Give them a new name befitting their rank
                        const newName = generateThugName(newRank);
                        thug.name = newName;
                        
                        addConsoleMessage(`üéñÔ∏è ${oldName} promoted to ${THUG_RANKS[newRank].name} and now goes by "${newName}"!`, 'gold');
                        showNotification(`üéñÔ∏è ${oldName} ‚Üí ${newName} (${THUG_RANKS[newRank].name})`, 'success');
                    }
                }
            });
        }

        // Simple thug count sync - no loss detection
        function syncThugCount(reason = 'sync_operation') {
            if (!Array.isArray(gameState.crew.thugs)) {
                gameState.crew.thugs = [];
                for (let i = 0; i < gameState.resources.thugs; i++) {
                    gameState.crew.thugs.push(createThug());
                }
            }
            
            // Always use the higher count (never lose assets)
            const resourceCount = gameState.resources.thugs || 0;
            const crewCount = gameState.crew.thugs.length || 0;
            const finalCount = Math.max(resourceCount, crewCount);
            
            gameState.resources.thugs = finalCount;
            while (gameState.crew.thugs.length < finalCount) {
                gameState.crew.thugs.push(createThug());
            }
        }

        // Notification system for visual feedback
        function showNotification(message, type = 'success') {
            // Remove any existing notifications
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Show with animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Detailed action results with NFT potential
        function showActionResults(actionData) {
            console.log('üéä showActionResults called:', actionData);
            const { action, district, turnsUsed, results, nftChance, nftDrop } = actionData;
            
            // Add NFT to inventory if found
            if (nftDrop) {
                if (!gameState.nfts) gameState.nfts = [];
                gameState.nfts.push(nftDrop);
                
                // Apply NFT effects immediately
                applyNFTEffects(nftDrop);
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-xl font-bold cyan-glow mb-4">${action.toUpperCase()} RESULTS</h3>
                        
                        <div class="mb-4 p-4 bg-green-900/30 rounded border border-green-500/50">
                            <h4 class="font-bold text-green-400 mb-3">‚úÖ Action Complete!</h4>
                            
                            ${district ? `<p class="text-sm text-gray-300 mb-2">üìç Location: ${district}</p>` : ''}
                            <p class="text-sm text-gray-300 mb-3">‚ö° Turns Used: <span class="text-yellow-400">${turnsUsed}</span></p>
                            
                            <div class="space-y-2">
                                ${results.hoes ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-pink-400">üë• Hoes Found:</span>
                                        <span class="text-white font-bold">+${results.hoes}</span>
                                    </div>
                                ` : ''}
                                ${results.thugs ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-blue-400">üí™ Thugs Found:</span>
                                        <span class="text-white font-bold">+${results.thugs}</span>
                                    </div>
                                ` : ''}
                                ${results.crack ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-purple-400">üíé Crack Produced:</span>
                                        <span class="text-white font-bold">+${results.crack}</span>
                                    </div>
                                ` : ''}
                                ${results.money ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-yellow-400">üí∞ Money Earned:</span>
                                        <span class="gold-text font-bold">+$${results.money.toLocaleString()}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${nftDrop ? `
                            <div class="mb-4 p-4 bg-gradient-to-r from-purple-900/70 to-pink-900/70 rounded border-2 border-purple-400 animate-pulse">
                                <h4 class="font-bold text-purple-300 mb-2 text-center">üéä NFT DISCOVERED! üéä</h4>
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-3xl">üíé</span>
                                    <div class="flex-1">
                                        <p class="font-bold text-white text-lg">${nftDrop.name}</p>
                                        <p class="text-sm text-purple-300 capitalize">${nftDrop.rarity} ${nftDrop.type} NFT</p>
                                        <p class="text-xs text-gray-300 mt-1">${nftDrop.description}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-purple-400">Found in:</div>
                                        <div class="text-xs text-cyan-400">${district || 'Unknown'}</div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-purple-200 bg-purple-800/50 px-3 py-1 rounded-full inline-block">
                                        üîÆ Collectible #${(gameState.nfts?.length || 0)} in your vault
                                    </p>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="text-xs text-gray-400 mb-4 text-center">
                            ${nftChance ? 'üíé NFT drops possible with 10+ turns!' : 'Increase turns for better yields!'}
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold">
                            Continue Playing
                        </button>
                    </div>
                </div>
            `;
            
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.innerHTML = modal;
                console.log('‚úÖ Action results modal displayed');
                console.log('‚úÖ Modal HTML length:', modal.length);
                console.log('‚úÖ NFT Drop in modal:', !!nftDrop);
                
                // Force the modal to show by ensuring it's visible
                setTimeout(() => {
                    const modalElement = document.querySelector('.fixed.inset-0');
                    if (modalElement) {
                        console.log('‚úÖ Modal element found in DOM');
                        modalElement.style.display = 'flex';
                        modalElement.style.zIndex = '9999';
                    } else {
                        console.error('‚ùå Modal element not found in DOM after creation!');
                        // Emergency fallback - show notification
                        const summary = `${action}: +${results.hoes || 0} hoes, +${results.thugs || 0} thugs, +$${results.money || 0}${nftDrop ? ' + ' + nftDrop.name + '!' : ''}`;
                        showNotification(summary, 'success');
                    }
                }, 100);
            } else {
                console.error('‚ùå modalContainer not found!');
                // Fallback to notification if modal fails
                const summary = `${action}: +${results.hoes || 0} hoes, +${results.thugs || 0} thugs, +$${results.money || 0}${nftDrop ? ' + ' + nftDrop.name + '!' : ''}`;
                showNotification(summary, 'success');
            }
        }

        // Update UI
        function updateUI() {
            // FORCE FIX WEAPONS CORRUPTION FIRST
            if (!gameState.resources.weapons || typeof gameState.resources.weapons !== 'object') {
                console.log('üîß EMERGENCY: Fixing corrupted weapons object in updateUI');
                gameState.resources.weapons = {
                    pistols: 5,
                    shotguns: 0,
                    tek9s: 0,
                    ak47s: 0
                };
            }
            
            // Clean any non-numeric values
            let weaponsCorrupted = false;
            Object.keys(gameState.resources.weapons).forEach(weapon => {
                const value = gameState.resources.weapons[weapon];
                if (typeof value !== 'number' || isNaN(value) || value === null || value === undefined) {
                    console.log(`üîß EMERGENCY: Fixing weapon ${weapon}:`, value);
                    gameState.resources.weapons[weapon] = 0;
                    weaponsCorrupted = true;
                }
            });
            
            if (weaponsCorrupted) {
                console.log('üîß Weapons object after emergency fix:', gameState.resources.weapons);
                // Force save to prevent this from happening again
                saveGameState();
            }
            
            // Calculate happiness first
            calculateHappiness();
            
            console.log('üñ•Ô∏è Updating UI with gameState:', {
                cash: gameState.player.cash,
                hoes: gameState.resources.hoes,
                thugs: gameState.resources.thugs,
                crack: gameState.resources.crack,
                weed: gameState.resources.weed,
                weapons: gameState.resources.weapons
            });
            
            // Update supply status to refresh weed display
            updateSupplyStatus();
            
            // Safe element updates (check if exists first)
            const elements = {
                username: gameState.player.username,
                level: gameState.player.level,
                money: '$' + gameState.player.cash.toLocaleString(),
                hoes: gameState.resources.hoes,
                thugs: gameState.resources.thugs,
                crack: gameState.resources.crack,
                respect: gameState.player.respect,
                payout: gameState.player.payoutPercentage + '%',
                rank: gameState.player.localRank ? `#${gameState.player.localRank} Local (#${gameState.player.nationalRank} National)` : gameState.player.rank
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn(`‚ö†Ô∏è Element not found: ${id}`);
                }
            });
            
            // Heat display with color coding and warnings
            const heatEl = document.getElementById('heat');
            if (heatEl) {
                const heat = gameState.player.heat;
                heatEl.textContent = heat + '%';
                
                // Color code based on heat level
                if (heat >= 100) {
                    heatEl.className = 'text-red-600 font-bold animate-pulse';
                } else if (heat >= 76) {
                    heatEl.className = 'text-red-500 font-bold';
                } else if (heat >= 51) {
                    heatEl.className = 'text-orange-500';
                } else if (heat >= 26) {
                    heatEl.className = 'text-yellow-500';
                } else {
                    heatEl.className = 'text-green-400';
                }
            }
            
            // Happiness display with color coding (safe updates)
            const hoeColor = gameState.supplies.hoeHappiness >= 70 ? 'text-green-400' : 
                           gameState.supplies.hoeHappiness >= 40 ? 'text-yellow-400' : 'text-red-400';
            const thugColor = gameState.supplies.thugHappiness >= 70 ? 'text-green-400' : 
                            gameState.supplies.thugHappiness >= 40 ? 'text-yellow-400' : 'text-red-400';
            
            const hoeHappinessEl = document.getElementById('hoeHappiness');
            const thugHappinessEl = document.getElementById('thugHappiness');
            
            if (hoeHappinessEl) {
                hoeHappinessEl.textContent = gameState.supplies.hoeHappiness + '%';
                hoeHappinessEl.className = hoeColor;
            }
            
            if (thugHappinessEl) {
                thugHappinessEl.textContent = gameState.supplies.thugHappiness + '%';
                thugHappinessEl.className = thugColor;
            }
            
            // Weapons validation and calculation
            console.log('üî´ Weapons object:', gameState.resources.weapons);
            
            // Fix corrupted weapons object
            if (typeof gameState.resources.weapons !== 'object' || gameState.resources.weapons === null) {
                console.log('üîß Fixing corrupted weapons object');
                gameState.resources.weapons = {
                    pistols: 5,
                    shotguns: 0,
                    tek9s: 0,
                    ak47s: 0
                };
            }
            
            // Ensure all weapon counts are numbers and clean up any corruption
            let weaponsFixed = false;
            Object.keys(gameState.resources.weapons).forEach(weapon => {
                const currentValue = gameState.resources.weapons[weapon];
                if (typeof currentValue !== 'number' || isNaN(currentValue)) {
                    console.log(`üîß Fixing corrupted weapon: ${weapon}`, currentValue);
                    gameState.resources.weapons[weapon] = 0;
                    weaponsFixed = true;
                }
            });
            
            if (weaponsFixed) {
                console.log('üîß Weapons object after cleaning:', gameState.resources.weapons);
            }
            
            // Calculate total weapons safely
            let totalWeapons = 0;
            Object.entries(gameState.resources.weapons).forEach(([weapon, count]) => {
                if (typeof count === 'number' && !isNaN(count)) {
                    totalWeapons += count;
                }
            });
            
            console.log('üî´ Total weapons calculated:', totalWeapons);
            
            const totalWeaponsEl = document.getElementById('totalWeapons');
            if (totalWeaponsEl) {
                totalWeaponsEl.textContent = totalWeapons;
                console.log('üî´ Updated weapons display:', totalWeapons);
            }
            
            // Original net worth calculation
            const netWorth = gameState.player.cash + 
                            (gameState.resources.hoes * 2000) +     // Original: $2,000 each
                            (gameState.resources.thugs * 750) +     // Original: $750 each  
                            (gameState.resources.crack * 3) +       // Original: $3 each
                            (gameState.resources.condoms * 0.10) +  // Original: $0.10 each
                            (gameState.resources.medicine * 5) +    // Original: $5 each
                            (gameState.resources.beer * 0.75);      // Approx beer value
            
            const netWorthEl = document.getElementById('netWorth');
            if (netWorthEl) {
                netWorthEl.textContent = '$' + netWorth.toLocaleString();
            }
            
            // Turn display
            const regenRateEl = document.getElementById('regenRate');
            const weekNumberEl = document.getElementById('weekNumber');
            
            if (regenRateEl) {
                const turnsPerTenMinutes = (gameState.player.regenRate * 10);
                regenRateEl.textContent = turnsPerTenMinutes === 2 ? '2' : turnsPerTenMinutes.toFixed(1); // Show as turns per 10 min
            }
            
            if (weekNumberEl) {
                weekNumberEl.textContent = gameState.player.weekNumber;
            }
            
            // Update district display
            const districtEl = document.getElementById('district');
            if (districtEl) {
                if (gameState.player.district && window.GameConstants && window.GameConstants.DISTRICTS_AND_TERRITORIES[gameState.player.district]) {
                    let displayText = gameState.player.district;
                    if (gameState.player.territory) {
                        displayText += ` - ${gameState.player.territory}`;
                    }
                    districtEl.textContent = displayText;
                    districtEl.className = 'cyan-glow cursor-pointer';
                } else {
                    districtEl.textContent = 'Choose District';
                    districtEl.className = 'cyan-glow cursor-pointer';
                }
            }
            
            // Update payout button text
            const payoutButton = document.querySelector('button[onclick="adjustPayout()"]');
            if (payoutButton) {
                payoutButton.innerHTML = `üíÉ ADJUST HO $ PAYOUT (${gameState.player.payoutPercentage}%)`;
            }
            
            // Update admin panel visibility
            updateAdminPanelVisibility();
        }

        // Hood Pimp respawn and refresh
        function updateHoodPimpRespawns() {
            let needsUpdate = false;
            
            // Check for respawns and remove old defeated pimps
            for (const [id, pimp] of ACTIVE_HOOD_PIMPS.entries()) {
                if (pimp.defeated && Date.now() >= pimp.respawnAt) {
                    ACTIVE_HOOD_PIMPS.delete(id);
                    needsUpdate = true;
                }
            }
            
            // Spawn new pimps if needed
            if (ACTIVE_HOOD_PIMPS.size < MAX_ACTIVE_PIMPS) {
                spawnHoodPimps();
                needsUpdate = true;
            }
            
            if (needsUpdate) {
                updateHoodPimpDisplay();
            }
        }

        // Simple game loop - run much less frequently
        function gameLoop() {
            // Only update turn display every 10 seconds
            if (Math.random() < 0.1) { // ~once per 10 seconds
            updateTurnDisplay();
            }
            
            // Only run other systems every 60 seconds to prevent spam
            if (Math.random() < 0.016) { // ~once per 60 seconds
            updateHoodPimpRespawns();
                generateHoeIncome();
                processPayroll();
                processDailyPayout();
            }
        }
        
        // Comprehensive data integrity validation
        function validateAllDataIntegrity() {
            const issues = [];
            let fixed = false;
            
            console.log('üîç COMPREHENSIVE DATA VALIDATION...');
            
            // Validate player data
            if (typeof gameState.player.cash !== 'number' || isNaN(gameState.player.cash) || gameState.player.cash < 0) {
                issues.push('cash corrupted');
                gameState.player.cash = Math.max(0, gameState.player.cash || 0);
                fixed = true;
            }
            
            if (typeof gameState.player.level !== 'number' || gameState.player.level < 1) {
                issues.push('level corrupted');
                gameState.player.level = Math.max(1, gameState.player.level || 1);
                fixed = true;
            }
            
            // Validate resources
            const resourceDefaults = {
                hoes: 9, thugs: 6, crack: 0, weed: 0, beer: 200, condoms: 500, medicine: 10
            };
            
            Object.entries(resourceDefaults).forEach(([resource, defaultValue]) => {
                const currentValue = gameState.resources[resource];
                if (typeof currentValue !== 'number' || isNaN(currentValue) || currentValue < 0) {
                    issues.push(`${resource} corrupted`);
                    const oldValue = currentValue || 0;
                    // ONLY INCREASE - use the larger of current value or default
                    const newValue = Math.max(oldValue, defaultValue);
                    gameState.resources[resource] = newValue;
                    logResourceChange(resource, null, oldValue, newValue, 'corruption_fix_increase_only');
                    fixed = true;
                }
            });
            
            // Validate weapons object
            if (!gameState.resources.weapons || typeof gameState.resources.weapons !== 'object') {
                issues.push('weapons object missing');
                gameState.resources.weapons = { pistols: 5, shotguns: 0, tek9s: 0, ak47s: 0 };
                fixed = true;
            } else {
                // Check each weapon type
                const weaponDefaults = { pistols: 0, shotguns: 0, tek9s: 0, ak47s: 0 };
                Object.entries(weaponDefaults).forEach(([weapon, defaultValue]) => {
                    const currentValue = gameState.resources.weapons[weapon];
                    if (typeof currentValue !== 'number' || isNaN(currentValue) || currentValue < 0) {
                        issues.push(`${weapon} corrupted`);
                        const oldValue = currentValue;
                        gameState.resources.weapons[weapon] = Math.max(0, currentValue || defaultValue);
                        logResourceChange('weapons', weapon, oldValue, gameState.resources.weapons[weapon], 'corruption_fix');
                        fixed = true;
                    }
                });
            }
            
            // Validate vehicles object
            if (!gameState.resources.vehicles || typeof gameState.resources.vehicles !== 'object') {
                issues.push('vehicles object missing');
                gameState.resources.vehicles = {
                    bicycle: 0, motorcycle: 0, kia: 0, lowrider: 0, escalade: 0, limo: 0, bentley: 0, armoredBeast: 0
                };
                fixed = true;
            }
            
            // Validate crew structure
            if (!gameState.crew || typeof gameState.crew !== 'object') {
                issues.push('crew object missing');
                gameState.crew = {
                    thugs: [],
                    lastPayrollTime: Date.now(),
                    nextPayrollDue: Date.now() + (7 * 24 * 60 * 60 * 1000)
                };
                fixed = true;
            }
            
            if (!Array.isArray(gameState.crew.thugs)) {
                issues.push('crew thugs array corrupted');
                gameState.crew.thugs = [];
                // Recreate crew from resource count
                for (let i = 0; i < gameState.resources.thugs; i++) {
                    gameState.crew.thugs.push(createThug());
                }
                fixed = true;
            }
            
            // Check for crew/resource sync issues
            const crewCount = gameState.crew.thugs.length;
            const resourceCount = gameState.resources.thugs;
            if (Math.abs(crewCount - resourceCount) > 0) {
                issues.push('crew/resource desync');
                console.warn('üö® CREW/RESOURCE DESYNC:', { crewCount, resourceCount });
                // Use the larger of the two as the "correct" value
                const correctCount = Math.max(crewCount, resourceCount);
                gameState.resources.thugs = correctCount;
                
                // Adjust crew array to match
                while (gameState.crew.thugs.length < correctCount) {
                    gameState.crew.thugs.push(createThug());
                }
                while (gameState.crew.thugs.length > correctCount) {
                    gameState.crew.thugs.pop();
                }
                
                logResourceChange('thugs', null, resourceCount, correctCount, 'desync_fix');
                fixed = true;
            }
            
            // Report findings
            if (issues.length > 0) {
                console.warn('üö® DATA INTEGRITY ISSUES FOUND AND FIXED:', issues);
                addConsoleMessage(`üîß Fixed ${issues.length} data corruption issues`, 'yellow');
                
                if (fixed) {
                    saveGameState(); // Save the fixes immediately
                }
            } else {
                console.log('‚úÖ Data integrity check passed');
            }
            
            return issues.length === 0;
        }

        // Validate turn data integrity
        function validateTurnIntegrity() {
            const issues = [];
            
            // Check for corrupted turn data
            if (typeof gameState.player.turnsWhenLastChecked !== 'number' || isNaN(gameState.player.turnsWhenLastChecked)) {
                issues.push('turnsWhenLastChecked is not a number');
                gameState.player.turnsWhenLastChecked = TURN_MECHANICS.startingTurns;
            }
            
            if (gameState.player.turnsWhenLastChecked < -10) {
                issues.push('turns are extremely negative');
                gameState.player.turnsWhenLastChecked = TURN_MECHANICS.startingTurns;
            }
            
            if (typeof gameState.player.lastActionTime !== 'number' || isNaN(gameState.player.lastActionTime)) {
                issues.push('lastActionTime is not a number');
                gameState.player.lastActionTime = Date.now();
            }
            
            if (gameState.player.lastActionTime > Date.now() + 60000) { // More than 1 minute in future
                issues.push('lastActionTime is in the future');
                gameState.player.lastActionTime = Date.now();
            }
            
            if (typeof gameState.player.regenRate !== 'number' || gameState.player.regenRate <= 0) {
                issues.push('regenRate is invalid');
                gameState.player.regenRate = TURN_MECHANICS.regenRate;
            }
            
            if (issues.length > 0) {
                console.log('üîß Turn integrity issues found and fixed:', issues);
                addConsoleMessage(`üîß Fixed ${issues.length} turn system issues`, 'cyan');
                saveGameState(); // Save the fixes
                updateTurnDisplay();
            }
        }

        // Initialize game - SUPABASE-CONNECTED VERSION
        async function initGame() {
            console.log('üéÆ INITIALIZING SUPABASE-CONNECTED GAME...');
            addConsoleMessage('üéÆ Starting Empire City with shared database', 'cyan');
            
            // Load enhanced heat system
            await loadHeatSystem();
            
            // Check if required scripts are loaded
            if (!window.initSupabase) {
                console.error('‚ùå Supabase configuration not loaded');
                addConsoleMessage('‚ùå Database connection failed - missing configuration', 'red');
                return;
            }
            
            // Try to initialize Supabase connection
            let supabaseConnected = false;
            try {
                console.log('üîÑ Initializing Supabase connection...');
                supabaseConnected = await initSupabase();
                if (supabaseConnected && window.supabaseClient) {
                    addConsoleMessage('üåê Connected to shared database!', 'green');
                    console.log('‚úÖ Supabase client ready:', !!window.supabaseClient);
                } else {
                    console.error('‚ùå Supabase connection failed');
                    addConsoleMessage('‚ùå Database connection failed', 'red');
                    addConsoleMessage('üö® Authentication system unavailable - showing local demo', 'yellow');
                    // Don't return - continue to set up auth landing page
                }
            } catch (error) {
                console.error('‚ùå Supabase init error:', error);
                addConsoleMessage('‚ùå Database connection failed: ' + error.message, 'red');
                addConsoleMessage('üö® Authentication system unavailable - showing local demo', 'yellow');
                // Don't return - continue to set up auth landing page
            }
            
            // Check for existing auth session
            const authSuccess = await checkAuthSession();
            
            if (isLoggedIn && currentUser) {
                // User is logged in - load from server
                document.getElementById('authLanding').classList.add('hidden');
                document.getElementById('gameContent').classList.remove('hidden');
                
                addConsoleMessage('üåê MULTIPLAYER MODE: Connected to shared database', 'green');
                await loadPlayerProfileFromAuth();
                
                updateUI();
                updateTurnDisplay();
                updateSupplyStatus();
                
                addConsoleMessage('‚úÖ Multiplayer game initialized!', 'green');
                addConsoleMessage('üíæ Progress saved to shared database', 'cyan');
                addConsoleMessage('üöî Enhanced heat system with charity events loaded!', 'yellow');
                
            } else {
                // Show auth landing but ALSO initialize game systems for demo
                document.getElementById('authLanding').classList.remove('hidden');
                document.getElementById('gameContent').classList.add('hidden');
                
                addConsoleMessage('üö® AUTHENTICATION REQUIRED', 'yellow');
                addConsoleMessage('üåê Multiplayer game with shared database for 1000+ players', 'cyan');
                addConsoleMessage('üë• Create account to compete and save progress!', 'gold');
                addConsoleMessage('üèÜ Leaderboards, crews, and real competition await!', 'purple');
                
                // Initialize demo game systems for testing (Hood Pimps visible even without auth)
                addConsoleMessage('üéÆ Initializing demo mode...', 'cyan');
                document.getElementById('gameContent').classList.remove('hidden');
                
                // Initialize basic game state for demo mode
                if (!gameState.player.username || gameState.player.username === 'Anonymous Pimp') {
                    addConsoleMessage('üéÆ Setting up demo player...', 'cyan');
                    gameState.player.username = 'Demo Player';
                    gameState.player.weekNumber = 1; // Ensure week is set for NPC spawning
                    gameState.player.district = 'Midtown Market'; // Set a district for NPCs
                }
                
                // Initialize demo UI
                updateUI();
            }
            
            // Initialize game systems regardless of auth status (moved outside auth check)
            initializeHoodPimps();
            setTimeout(() => {
                if (ACTIVE_HOOD_PIMPS.size === 0) forceSpawnBasicPimps();
            }, 1000);
            
            updateHoodPimpDisplay();
            setInterval(gameLoop, 1000);
            
            // Ensure correct initial UI state (fallback)
            setTimeout(() => {
                if (!isLoggedIn) {
                    // In demo mode, keep both landing and game content visible
                    document.getElementById('authLanding').classList.remove('hidden');
                    // Keep game content visible for demo mode
                    console.log('üîß Applied fallback UI state: Demo mode with game content visible');
                }
            }, 1000);
        }

        // Load player profile from Supabase (auth-based) - SERVER ONLY
        async function loadPlayerProfileFromAuth() {
            if (!window.SupabaseAPI || !currentUser) return;
            
            try {
                addConsoleMessage('üì• Loading profile from server...', 'cyan');
                console.log('üåê Loading player data from Supabase for user:', currentUser.id);
                
                // Find player by auth user ID
                const { data: existingPlayers } = await window.supabaseClient
                    .from('players')
                    .select('*')
                    .eq('wallet_address', currentUser.id);
                
                let player = existingPlayers?.[0];
                
                if (player) {
                    console.log('‚úÖ Found existing player in database:', player.username);
                    console.log('üì• Raw player data from database:', {
                        cash: player.cash,
                        hoes: player.hoes,
                        thugs: player.thugs,
                        crack: player.crack,
                        weed: player.weed,
                        hasResources: !!player.resources,
                        hasSupplies: !!player.supplies,
                        hasCrewData: !!player.crew_data,
                        turnsWhenLastChecked: player.turns_when_last_checked
                    });
                    
                    // COMPLETELY RESET gameState from server data - no mixing with defaults
                    console.log('üîÑ Resetting gameState from server data...');
                    
                    // Player data
                    gameState.player = {
                        id: player.id,
                        username: player.username,
                        bio: player.bio || '',
                        level: player.level || 1,
                        exp: player.exp || 0,
                        expToNext: (player.level || 1) * 1000,
                        cash: player.cash || 10000,
                        lastActionTime: player.last_action_time ? new Date(player.last_action_time).getTime() : Date.now(),
                        lastIncomeTime: Date.now(),
                        turnsWhenLastChecked: Math.max(0, player.turns_when_last_checked || TURN_MECHANICS.startingTurns),
                        maxTurns: player.max_turns || 200,
                        regenRate: player.regen_rate || 0.2,
                        weekNumber: player.week_number || 1,
                        tutorialDay: player.tutorial_day || 1,
                        checkinsToday: 1,
                        heat: player.heat || 0,
                        respect: player.respect || 0,
                        payoutPercentage: player.payout_percentage || 30,
                        district: player.territory || null,
                        rank: 'Unranked',
                        localRank: null,
                        nationalRank: null,
                        crewId: player.crew_id || null,
                        crewRole: null,
                        joinedDate: null,
                        isOnline: false
                    };
                    
                    // Resources data - prioritize JSONB resources over individual columns
                    if (player.resources) {
                        console.log('üì¶ Loading resources from JSONB field');
                        try {
                            const parsedResources = typeof player.resources === 'string' ? 
                                JSON.parse(player.resources) : player.resources;
                            gameState.resources = parsedResources;
                            console.log('‚úÖ JSONB resources loaded:', {
                                hoes: parsedResources.hoes,
                                thugs: parsedResources.thugs,
                                crack: parsedResources.crack,
                                weed: parsedResources.weed,
                                weapons: parsedResources.weapons
                            });
                        } catch (error) {
                            console.error('‚ùå Error parsing JSONB resources:', error);
                            console.log('üì¶ Falling back to individual columns');
                            gameState.resources = {
                                hoes: player.hoes || 0,
                                hoeDetails: {
                                    streetWorkers: 0,
                                    sugarBabies: 0,
                                    highEndEscorts: 0,
                                    onlyTrampsModels: 0
                                },
                                thugs: player.thugs || 0,
                                crack: player.crack || 0,
                                weed: parseFloat(player.weed || 0),
                                weapons: {
                                    pistols: player.pistols || 0,
                                    shotguns: player.shotguns || 0,
                                    tek9s: player.tek9s || 0,
                                    ak47s: player.ak47s || 0
                                },
                                vehicles: {
                                    bike: 0,
                                    sedan: 0,
                                    suv: 0,
                                    sportscar: 0,
                                    limo: 0,
                                    armored: 0
                                },
                                condoms: player.condoms || 0,
                                beer: player.beer || 0,
                                medicine: player.medicine || 0
                            };
                        }
                    } else {
                        console.log('üì¶ Loading resources from individual columns');
                        gameState.resources = {
                            hoes: player.hoes || 0,
                            hoeDetails: {
                                streetWorkers: 0,
                                sugarBabies: 0,
                                highEndEscorts: 0,
                                onlyTrampsModels: 0
                            },
                            thugs: player.thugs || 0,
                            crack: player.crack || 0,
                            weed: parseFloat(player.weed || 0),
                            weapons: {
                                pistols: player.pistols || 0,
                                shotguns: player.shotguns || 0,
                                tek9s: player.tek9s || 0,
                                ak47s: player.ak47s || 0
                            },
                            vehicles: {
                                bike: 0,
                                sedan: 0,
                                suv: 0,
                                sportscar: 0,
                                limo: 0,
                                armored: 0
                            },
                            condoms: player.condoms || 0,
                            beer: player.beer || 0,
                            medicine: player.medicine || 0
                        };
                        console.log('‚úÖ Individual columns loaded:', {
                            hoes: gameState.resources.hoes,
                            thugs: gameState.resources.thugs,
                            crack: gameState.resources.crack,
                            weed: gameState.resources.weed,
                            weapons: gameState.resources.weapons
                        });
                    }
                    
                    // Supplies data
                    if (player.supplies) {
                        console.log('üç∫ Loading supplies from JSONB field');
                        try {
                            const parsedSupplies = typeof player.supplies === 'string' ? 
                                JSON.parse(player.supplies) : player.supplies;
                            gameState.supplies = parsedSupplies;
                            console.log('‚úÖ JSONB supplies loaded:', parsedSupplies);
                        } catch (error) {
                            console.error('‚ùå Error parsing JSONB supplies:', error);
                            gameState.supplies = {
                                lastConsumedAt: Date.now(),
                                hoeHappiness: 70,
                                thugHappiness: 70
                            };
                        }
                    } else {
                        gameState.supplies = {
                            lastConsumedAt: Date.now(),
                            hoeHappiness: 70,
                            thugHappiness: 70
                        };
                    }
                    
                    // Crew data
                    if (player.crew_data) {
                        console.log('üë• Loading crew from JSONB field');
                        try {
                            const parsedCrew = typeof player.crew_data === 'string' ? 
                                JSON.parse(player.crew_data) : player.crew_data;
                            gameState.crew = parsedCrew;
                            console.log('‚úÖ JSONB crew loaded:', {
                                thugsCount: parsedCrew.thugs?.length || 0,
                                lastPayrollTime: parsedCrew.lastPayrollTime
                            });
                        } catch (error) {
                            console.error('‚ùå Error parsing JSONB crew:', error);
                            gameState.crew = {
                                name: null,
                                tag: null,
                                description: null,
                                members: [],
                                treasury: 0,
                                level: 1,
                                territory: null,
                                thugs: [],
                                lastPayrollTime: Date.now(),
                                nextPayrollDue: Date.now() + (7 * 24 * 60 * 60 * 1000)
                            };
                        }
                    } else {
                        gameState.crew = {
                            name: null,
                            tag: null,
                            description: null,
                            members: [],
                            treasury: 0,
                            level: 1,
                            territory: null,
                            thugs: [],
                            lastPayrollTime: Date.now(),
                            nextPayrollDue: Date.now() + (7 * 24 * 60 * 60 * 1000)
                        };
                    }
                    
                    // Ensure crew.thugs array exists and is synced
                    if (!Array.isArray(gameState.crew.thugs)) {
                        gameState.crew.thugs = [];
                    }
                    
                    // Create individual thug objects if we have a simple count but no detailed crew
                    if (gameState.resources.thugs > 0 && gameState.crew.thugs.length === 0) {
                        console.log(`üîß Creating ${gameState.resources.thugs} crew members from count`);
                        for (let i = 0; i < gameState.resources.thugs; i++) {
                            gameState.crew.thugs.push(createThug());
                        }
                    }
                    
                    // Sync the counts
                    gameState.resources.thugs = gameState.crew.thugs.length;
                    
                    console.log('‚úÖ Complete server data loaded:', {
                        cash: gameState.player.cash,
                        hoes: gameState.resources.hoes,
                        thugs: gameState.resources.thugs,
                        weed: gameState.resources.weed,
                        turns: gameState.player.turnsWhenLastChecked,
                        lastActionTime: new Date(gameState.player.lastActionTime).toLocaleString()
                    });
                    
                    addConsoleMessage(`üíæ SERVER: $${gameState.player.cash}, ${gameState.resources.hoes} hoes, ${gameState.resources.thugs} thugs`, 'green');
                    addConsoleMessage(`üéØ TURNS: ${gameState.player.turnsWhenLastChecked}/${gameState.player.maxTurns}`, 'cyan');
                    addConsoleMessage(`üì• Profile loaded from database!`, 'green');
                    addConsoleMessage(`Welcome back, ${player.username}!`, 'gold');
                    
                    // Update current turns based on time passed
                    const currentCalculatedTurns = calculateCurrentTurns();
                    console.log('‚è∞ Current calculated turns:', currentCalculatedTurns);
                    
                } else {
                    console.log('‚ùå No player found - creating new player');
                    addConsoleMessage('‚ö†Ô∏è No player profile found - creating new player...', 'yellow');
                    
                    // Create new player with current gameState defaults
                    const newPlayer = await SupabaseAPI.createPlayer({
                        walletAddress: currentUser.id,
                        username: `Pimp_${currentUser.id.slice(-6)}`,
                        bio: '',
                        level: gameState.player.level,
                        cash: gameState.player.cash,
                        respect: gameState.player.respect,
                        heat: gameState.player.heat
                    });
                    
                    if (newPlayer) {
                        // Update gameState with new player ID but keep existing defaults
                        gameState.player.id = newPlayer.id;
                        gameState.player.username = newPlayer.username;
                        
                        console.log('üÜï New player created with defaults:', {
                            cash: gameState.player.cash,
                            turns: gameState.player.turnsWhenLastChecked,
                            hoes: gameState.resources.hoes,
                            thugs: gameState.resources.thugs
                        });
                        
                        // Save the initial state immediately
                        console.log('üíæ Saving initial player state...');
                        await saveGameState();
                        
                        addConsoleMessage('üÜï New player profile created and saved!', 'green');
                        addConsoleMessage(`üí° Starting with $${gameState.player.cash}, ${gameState.player.turnsWhenLastChecked} turns`, 'cyan');
                    } else {
                        console.error('‚ùå Failed to create new player');
                        addConsoleMessage('‚ùå Failed to create player profile', 'red');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error loading player profile:', error);
                addConsoleMessage('‚ö†Ô∏è Could not load profile from server: ' + error.message, 'red');
            }
        }

        // Check for existing auth session on startup
        async function checkAuthSession() {
            try {
                console.log('üîê Checking auth session...');
                if (!window.supabaseClient) {
                    console.log('‚ùå Supabase client not available');
                    return false;
                }
                const { data: { user } } = await window.supabaseClient.auth.getUser();
                if (user) {
                    console.log('‚úÖ Found existing user session:', user.email);
                    currentUser = user;
                    isLoggedIn = true;
                    
                    // Update UI
                    document.getElementById('authStatus').textContent = 
                        `üë§ ${user.email.split('@')[0]}`;
                    document.getElementById('authButton').classList.add('bg-green-600');
                    
                    addConsoleMessage(`üîÑ Auto-signed in as ${user.email}`, 'green');
                    
                    console.log('‚úÖ Auth session verified - ready for server data load');
                    return true;
                } else {
                    console.log('‚ùå No user session found');
                    currentUser = null;
                    isLoggedIn = false;
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Auth session check error:', error);
                currentUser = null;
                isLoggedIn = false;
                return false;
            }
        }

        // Profile Management
                function editProfile() {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <h3 class="text-xl font-bold cyan-glow mb-4">EDIT PROFILE</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-2 text-gray-300">Pimp Name</label>
                                <input type="text" id="editUsername" value="${gameState.player.username}" 
                                       class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white" 
                                       maxlength="20" placeholder="Enter your pimp name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold mb-2 text-gray-300">Bio</label>
                                <textarea id="editBio" class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white h-20" 
                                          maxlength="150" placeholder="Tell your pimp story...">${gameState.player.bio}</textarea>
                                <p class="text-xs text-gray-400 mt-1">150 characters max</p>
                            </div>
                            
                            ${!isLoggedIn ? `
                                <div class="bg-yellow-900/30 p-3 rounded border border-yellow-500/50">
                                    <h4 class="font-bold text-yellow-400 mb-2">üíæ Local Save Only</h4>
                                    <p class="text-xs text-gray-400 mb-2">Changes will be saved locally. Sign in to save permanently!</p>
                                    <button onclick="showEmailAuth()" class="text-xs px-3 py-1 bg-purple-600 rounded hover:bg-purple-500">
                                        Sign In
                                    </button>
                                </div>
                            ` : `
                                <div class="bg-green-900/30 p-3 rounded border border-green-500/50">
                                    <h4 class="font-bold text-green-400 mb-2">‚úÖ Signed In</h4>
                                    <p class="text-xs text-gray-400">Profile will be saved to database</p>
                                </div>
                            `}
                        </div>
                        
                        <div class="flex gap-2 mt-6">
                            <button onclick="saveProfile()" class="flex-1 py-2 action-btn rounded">Save Changes</button>
                            <button onclick="closeModal()" class="flex-1 py-2 bg-gray-700 rounded">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        async function saveProfile() {
            const newUsername = document.getElementById('editUsername').value.trim();
            const newBio = document.getElementById('editBio').value.trim();
            
            // Validate username
            if (!newUsername || newUsername.length < 3) {
                alert('Pimp name must be at least 3 characters!');
                return;
            }
            
            // Always save locally first
            gameState.player.username = newUsername;
            gameState.player.bio = newBio;
            
            // Save to localStorage for persistence
            localStorage.setItem('pimpFunGameState', JSON.stringify(gameState));
            
            // Show immediate feedback
            showNotification(`‚úÖ Profile updated! Welcome ${newUsername}`, 'success');
            
            // Save to Supabase if authenticated
            if (isLoggedIn && gameState.player.id && currentUser) {
                try {
                    addConsoleMessage('üíæ Saving to database...', 'cyan');
                    
                    // Check if username is taken by someone else
                    const { data: existingUsers } = await window.supabaseClient
                        .from('players')
                        .select('id, username')
                        .eq('username', newUsername)
                        .neq('id', gameState.player.id);
                    
                    if (existingUsers && existingUsers.length > 0) {
                        alert('That pimp name is already taken! Choose another.');
                        return;
                    }
                    
                    const updates = {
                        username: newUsername,
                        bio: newBio,
                        level: gameState.player.level,
                        cash: gameState.player.cash,
                        respect: gameState.player.respect,
                        heat: gameState.player.heat,
                        // Save all resources
                        hoes: gameState.resources.hoes,
                        thugs: gameState.resources.thugs,
                        crack: gameState.resources.crack,
                        weed: gameState.resources.weed,
                        beer: gameState.resources.beer,
                        condoms: gameState.resources.condoms,
                        medicine: gameState.resources.medicine,
                        pistols: gameState.resources.weapons.pistols,
                        shotguns: gameState.resources.weapons.shotguns,
                        tek9s: gameState.resources.weapons.tek9s,
                        ak47s: gameState.resources.weapons.ak47s
                    };
                    
                    const result = await SupabaseAPI.updatePlayer(gameState.player.id, updates);
                    if (result) {
                        addConsoleMessage('‚úÖ Profile saved to database!', 'green');
                    } else {
                        addConsoleMessage('‚ùå Failed to save to database', 'red');
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    addConsoleMessage('‚ùå Save error: ' + error.message, 'red');
                }
            } else {
                addConsoleMessage('‚úÖ Profile saved locally!', 'green');
            }
            
            updateUI();
            updatePlayerProfile();
            closeModal();
        }

        function updatePlayerProfile() {
            // Safely update username
            const usernameEl = document.getElementById('username');
            if (usernameEl) {
                usernameEl.textContent = gameState.player.username;
            }
            
            // Safely update bio (element might not exist on main game page)
            const bioElement = document.getElementById('playerBio');
            if (bioElement) {
                if (gameState.player.bio) {
                    bioElement.textContent = `"${gameState.player.bio}"`;
                    bioElement.classList.remove('italic');
                } else {
                    bioElement.textContent = '"Click to add your pimp story..."';
                    bioElement.classList.add('italic');
                }
            } else {
                console.log('‚ÑπÔ∏è playerBio element not found (OK if on main game page)');
            }
        }

        // Crew & Social Functions
        function showCrewMenu() {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full">
                        <h3 class="text-xl font-bold cyan-glow mb-4">CREW & CARTELS</h3>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <button onclick="showCrewBrowser()" class="action-btn rounded p-4">
                                <div class="text-lg font-bold">üîç Browse Crews</div>
                                <div class="text-xs text-gray-400">Find active crews</div>
                            </button>
                            <button onclick="createCrew()" class="action-btn rounded p-4">
                                <div class="text-lg font-bold">üëë Create Crew</div>
                                <div class="text-xs text-gray-400">Start your empire</div>
                            </button>
                            <button onclick="showCrewInvites()" class="action-btn rounded p-4">
                                <div class="text-lg font-bold">üì® Invites</div>
                                <div class="text-xs text-gray-400">Pending invitations</div>
                            </button>
                            <button onclick="showCrewRankings()" class="action-btn rounded p-4">
                                <div class="text-lg font-bold">üèÜ Rankings</div>
                                <div class="text-xs text-gray-400">Top crews</div>
                            </button>
                        </div>
                        
                        <div class="bg-yellow-900/30 p-3 rounded mb-4">
                            <h4 class="font-bold text-yellow-400 mb-2">üí° Crew Benefits</h4>
                            <ul class="text-xs text-gray-300 space-y-1">
                                <li>‚Ä¢ Shared protection and backup in fights</li>
                                <li>‚Ä¢ Access to crew territory and bonuses</li>
                                <li>‚Ä¢ Group raids on high-value targets</li>
                                <li>‚Ä¢ Crew treasury and resource sharing</li>
                                <li>‚Ä¢ Exclusive crew-only events and rewards</li>
                            </ul>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-2 bg-gray-700 rounded">Close</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        async function showCrewBrowser() {
            let crews = [];
            
            // Try to get real crew data from Supabase
            if (window.SupabaseAPI) {
                try {
                    crews = await SupabaseAPI.getCrews(20);
                    if (crews.length === 0) {
                        // If no crews exist, show sample data
                        crews = [
                            { name: "Diamond Cartel", tag: "[DMND]", member_count: 18, level: 5, territory: "Uptown", description: "Elite pimps only. High standards, high rewards." },
                            { name: "Street Kings", tag: "[KING]", member_count: 15, level: 3, territory: "Midtown", description: "We run these streets. Join the royalty." },
                            { name: "Midnight Riders", tag: "[RIDE]", member_count: 12, level: 4, territory: "Backstreets", description: "Night owls and hustlers. We move in shadows." },
                            { name: "Golden Empire", tag: "[GOLD]", member_count: 20, level: 6, territory: "Downtown", description: "Money talks, we listen. Serious players only." }
                        ];
                    }
                } catch (error) {
                    console.error('Error loading crews:', error);
                    // Fallback to mock data
                    crews = [
                        { name: "Diamond Cartel", tag: "[DMND]", member_count: 18, level: 5, territory: "Uptown", description: "Elite pimps only. High standards, high rewards." },
                        { name: "Street Kings", tag: "[KING]", member_count: 15, level: 3, territory: "Midtown", description: "We run these streets. Join the royalty." }
                    ];
                }
            } else {
                // Offline mode - use mock data
                crews = [
                    { name: "Diamond Cartel", tag: "[DMND]", member_count: 18, level: 5, territory: "Uptown", description: "Elite pimps only. High standards, high rewards." },
                    { name: "Street Kings", tag: "[KING]", member_count: 15, level: 3, territory: "Midtown", description: "We run these streets. Join the royalty." },
                    { name: "Midnight Riders", tag: "[RIDE]", member_count: 12, level: 4, territory: "Backstreets", description: "Night owls and hustlers. We move in shadows." },
                    { name: "Golden Empire", tag: "[GOLD]", member_count: 20, level: 6, territory: "Downtown", description: "Money talks, we listen. Serious players only." }
                ];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                        <h3 class="text-xl font-bold cyan-glow mb-4">ACTIVE CREWS</h3>
                        
                                                 <div class="space-y-3 mb-4">
                            ${crews.map(crew => `
                                <div class="bg-gray-800/50 p-4 rounded border border-gray-700">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <h4 class="font-bold text-white">${crew.name} ${crew.tag}</h4>
                                            <p class="text-sm text-gray-400">üìç ${crew.territory} ‚Ä¢ üë• ${crew.member_count || crew.members}/20 ‚Ä¢ ‚≠ê Level ${crew.level}</p>
                                        </div>
                                        <button onclick="requestJoinCrew('${crew.name}')" class="px-3 py-1 action-btn rounded text-sm">
                                            Request Join
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-300">"${crew.description}"</p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-2 bg-gray-700 rounded">Close</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        async function showPimpDirectory() {
            let players = [];
            
            // Try to get real player data from Supabase
            if (window.SupabaseAPI) {
                try {
                    players = await SupabaseAPI.searchPlayers('', 20);
                    // Map Supabase data to display format
                    players = players.map(p => ({
                        id: p.id,
                        name: p.username,
                        level: p.level,
                        respect: p.respect,
                        crew: p.crew ? `[${p.crew.tag}] ${p.crew.name}` : 'Solo',
                        territory: p.territory,
                        status: p.status || (new Date() - new Date(p.last_active) < 300000 ? 'online' : 'offline')
                    }));
                    
                    if (players.length === 0) {
                        // If no players exist, show sample data
                        players = [
                            { name: "Big Boss Tony", level: 25, respect: 450, crew: "[DMND] Diamond Cartel", territory: "Uptown", status: "online" },
                            { name: "Queen Bee", level: 22, respect: 380, crew: "[KING] Street Kings", territory: "Midtown", status: "online" },
                            { name: "Shadow Walker", level: 28, respect: 520, crew: "[RIDE] Midnight Riders", territory: "Backstreets", status: "offline" }
                        ];
                    }
                } catch (error) {
                    console.error('Error loading players:', error);
                    // Fallback to mock data
                    players = [
                        { name: "Big Boss Tony", level: 25, respect: 450, crew: "[DMND] Diamond Cartel", territory: "Uptown", status: "online" },
                        { name: "Queen Bee", level: 22, respect: 380, crew: "[KING] Street Kings", territory: "Midtown", status: "online" }
                    ];
                }
            } else {
                // Offline mode - use mock data
                players = [
                    { name: "Big Boss Tony", level: 25, respect: 450, crew: "[DMND] Diamond Cartel", territory: "Uptown", status: "online" },
                    { name: "Queen Bee", level: 22, respect: 380, crew: "[KING] Street Kings", territory: "Midtown", status: "online" },
                    { name: "Shadow Walker", level: 28, respect: 520, crew: "[RIDE] Midnight Riders", territory: "Backstreets", status: "offline" },
                    { name: "Golden Fingers", level: 30, respect: 600, crew: "[GOLD] Golden Empire", territory: "Downtown", status: "online" }
                ];
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                        <h3 class="text-xl font-bold cyan-glow mb-4">PIMP DIRECTORY</h3>
                        
                                                 <div class="space-y-2 mb-4">
                            ${players.map(pimp => `
                                <div class="bg-gray-800/50 p-3 rounded border border-gray-700 flex justify-between items-center">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold ${pimp.status === 'online' ? 'text-green-400' : 'text-gray-500'}">${pimp.name}</span>
                                            <span class="text-xs px-2 py-1 rounded bg-purple-900 text-purple-300">Lv.${pimp.level}</span>
                                            <span class="w-2 h-2 rounded-full ${pimp.status === 'online' ? 'bg-green-400' : 'bg-gray-500'}"></span>
                                        </div>
                                        <p class="text-xs text-gray-400">üèÜ ${pimp.respect} respect ‚Ä¢ ${pimp.crew} ‚Ä¢ üìç ${pimp.territory}</p>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="sendMessage('${pimp.name}')" class="px-2 py-1 action-btn rounded text-xs">üí¨</button>
                                        <button onclick="challengePimp('${pimp.name}')" class="px-2 py-1 action-btn rounded text-xs">‚öîÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-2 bg-gray-700 rounded">Close</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // Placeholder functions for crew/social features
        function createCrew() {
            alert('Create Crew feature coming soon! You\'ll be able to start your own empire with custom names, territories, and member roles.');
            closeModal();
        }

        function showCrewInvites() {
            alert('No pending crew invitations. Check back later or browse active crews to request membership!');
            closeModal();
        }

        function showCrewRankings() {
            alert('Crew Rankings feature coming soon! See which crews dominate Empire City.');
            closeModal();
        }

        function requestJoinCrew(crewName) {
            alert(`Join request sent to ${crewName}! Crew leaders will review your application. Check back for updates.`);
            closeModal();
        }

        function sendMessage(pimpName) {
            alert(`Message feature coming soon! You'll be able to send private messages to ${pimpName} and other players.`);
        }

        function challengePimp(pimpName) {
            alert(`PvP challenges coming soon! You'll be able to challenge ${pimpName} to battles for respect and territory.`);
        }

        function showMessages() {
            alert('Messaging system coming soon! Connect with other pimps, coordinate crew activities, and build your network.');
        }

                // Simple Auth Integration
        let currentUser = null;
        let isLoggedIn = false;

        function showAuthModal() {
            if (!walletManager) {
                walletManager = new SolanaWalletManager();
            }
            
            const availableWallets = walletManager.getAvailableWallets();
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">CONNECT WALLET</h3>
                            <button onclick="refreshWallets()" class="text-xs px-2 py-1 action-btn rounded">
                                üîÑ Refresh
                            </button>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">Choose your Solana wallet to save your pimp profile:</p>
                        
                        <div class="space-y-3">
                            ${availableWallets.map(wallet => `
                                <button onclick="${wallet.detected ? `connectWallet('${wallet.name}')` : `installWallet('${wallet.installUrl}')`}" 
                                        class="w-full p-4 rounded border ${wallet.detected ? 'border-green-500 bg-green-900/20 hover:bg-green-900/40' : 'border-gray-600 bg-gray-800/50 hover:bg-gray-700/50'} transition-all">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">${wallet.icon}</span>
                                            <div class="text-left">
                                                <div class="font-bold text-white">${wallet.name}</div>
                                                <div class="text-xs text-gray-400">
                                                    ${wallet.detected ? 'Ready to connect' : 'Not installed'}
                                                </div>
                                            </div>
                                        </div>
                                        <span class="text-sm ${wallet.detected ? 'text-green-400' : 'text-gray-500'}">
                                            ${wallet.detected ? 'Connect' : 'Install'}
                                        </span>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                        
                        <div class="mt-4 p-3 bg-blue-900/30 rounded">
                            <p class="text-xs text-blue-400">üí° Why connect a wallet?</p>
                            <ul class="text-xs text-gray-400 mt-1 space-y-1">
                                <li>‚Ä¢ Save your pimp profile permanently</li>
                                <li>‚Ä¢ Play across multiple devices</li>
                                <li>‚Ä¢ Join crews and message other players</li>
                                <li>‚Ä¢ Future $PIMP token integration</li>
                            </ul>
                        </div>
                        
                        <div class="mt-4 p-2 bg-gray-800 rounded text-xs">
                            <button onclick="debugWallets()" class="text-cyan-400 hover:text-cyan-300">
                                üîß Debug: Show wallet detection info
                            </button>
                        </div>
                        
                        <div class="mt-4 p-3 bg-purple-900/30 rounded">
                            <button onclick="directConnectPhantom()" class="w-full py-2 bg-purple-600 rounded text-sm hover:bg-purple-500">
                                üëª Connect Phantom Directly
                            </button>
                            <p class="text-xs text-gray-400 mt-1 text-center">Simple connection - works with any Phantom setup</p>
                        </div>
                        
                        <div class="flex gap-2 mt-4">
                            <button onclick="playOffline()" class="flex-1 py-2 bg-gray-700 rounded text-sm">
                                Play Offline (No Save)
                            </button>
                            <button onclick="closeModal()" class="flex-1 py-2 bg-gray-600 rounded text-sm">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // Email auth tab switching
        function showEmailSignIn() {
            document.getElementById('emailSignInTab').className = 'flex-1 py-2 px-4 rounded text-sm bg-purple-600 text-white';
            document.getElementById('emailSignUpTab').className = 'flex-1 py-2 px-4 rounded text-sm text-gray-400';
            document.getElementById('emailSignInForm').classList.remove('hidden');
            document.getElementById('emailSignUpForm').classList.add('hidden');
        }

        function showEmailSignUp() {
            document.getElementById('emailSignInTab').className = 'flex-1 py-2 px-4 rounded text-sm text-gray-400';
            document.getElementById('emailSignUpTab').className = 'flex-1 py-2 px-4 rounded text-sm bg-green-600 text-white';
            document.getElementById('emailSignInForm').classList.add('hidden');
            document.getElementById('emailSignUpForm').classList.remove('hidden');
        }

        // Email Sign In
        async function emailSignIn() {
            const email = document.getElementById('emailSignInEmail').value.trim();
            const password = document.getElementById('emailSignInPassword').value;
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            // Ensure Supabase is initialized
            if (!window.supabaseClient) {
                console.log('üîÑ Supabase not ready, attempting to initialize...');
                try {
                    if (window.initSupabase) {
                        const success = await window.initSupabase();
                        if (!success || !window.supabaseClient) {
                            alert('Authentication service is not available. Please refresh the page and try again.');
                            return;
                        }
                    } else {
                        alert('Authentication service failed to load. Please refresh the page.');
                        return;
                    }
                } catch (error) {
                    console.error('Failed to initialize Supabase:', error);
                    alert('Authentication service failed to initialize. Please refresh the page.');
                    return;
                }
            }
            
            try {
                console.log('üîê Attempting email sign in for:', email);
                const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                console.log('‚úÖ Sign in successful:', data.user?.email);
                await handleAuthSuccess(data.user, email);
                
            } catch (error) {
                console.error('Email sign in error:', error);
                alert('Sign in failed: ' + error.message);
            }
        }

        // Email Sign Up
        async function emailSignUp() {
            const email = document.getElementById('emailSignUpEmail').value.trim();
            const password = document.getElementById('emailSignUpPassword').value;
            const username = document.getElementById('emailSignUpUsername').value.trim();
            
            if (!email || !password || !username) {
                alert('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            // Ensure Supabase is initialized
            if (!window.supabaseClient) {
                console.log('üîÑ Supabase not ready, attempting to initialize...');
                try {
                    if (window.initSupabase) {
                        const success = await window.initSupabase();
                        if (!success || !window.supabaseClient) {
                            alert('Authentication service is not available. Please refresh the page and try again.');
                            return;
                        }
                    } else {
                        alert('Authentication service failed to load. Please refresh the page.');
                        return;
                    }
                } catch (error) {
                    console.error('Failed to initialize Supabase:', error);
                    alert('Authentication service failed to initialize. Please refresh the page.');
                    return;
                }
            }
            
            try {
                // Check if username is taken
                const { data: existingUsers } = await window.supabaseClient
                    .from('players')
                    .select('username')
                    .eq('username', username);
                
                if (existingUsers && existingUsers.length > 0) {
                    alert('That pimp name is already taken! Choose another.');
                    return;
                }
                
                const { data, error } = await window.supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                // Create player profile
                const player = await SupabaseAPI.createPlayer({
                    walletAddress: data.user.id,
                    username: username,
                    bio: '',
                    level: 1,
                    cash: 9360,
                    respect: 0,
                    heat: 0
                });
                
                if (player) {
                    gameState.player.id = player.id;
                    gameState.player.username = username;
                }
                
                await handleAuthSuccess(data.user, email);
                
            } catch (error) {
                console.error('Email sign up error:', error);
                alert('Sign up failed: ' + error.message);
            }
        }

        // Phone/OTP functions
        async function sendOTP() {
            const phone = document.getElementById('phoneNumber').value.trim();
            
            if (!phone) {
                alert('Please enter a phone number');
                return;
            }
            
            try {
                const { data, error } = await window.supabaseClient.auth.signInWithOtp({
                    phone: phone
                });
                
                if (error) throw error;
                
                document.getElementById('phoneAuthStep').classList.add('hidden');
                document.getElementById('otpVerifyStep').classList.remove('hidden');
                
                alert('Verification code sent to your phone!');
                
            } catch (error) {
                console.error('OTP send error:', error);
                alert('Failed to send code: ' + error.message);
            }
        }

        async function verifyOTP() {
            const phone = document.getElementById('phoneNumber').value.trim();
            const token = document.getElementById('otpCode').value.trim();
            const username = document.getElementById('otpUsername').value.trim();
            
            if (!token || !username) {
                alert('Please enter verification code and pimp name');
                return;
            }
            
            try {
                const { data, error } = await window.supabaseClient.auth.verifyOtp({
                    phone: phone,
                    token: token,
                    type: 'sms'
                });
                
                if (error) throw error;
                
                // Create player profile
                const player = await SupabaseAPI.createPlayer({
                    walletAddress: data.user.id,
                    username: username,
                    bio: '',
                    level: 1,
                    cash: 9360,
                    respect: 0,
                    heat: 0
                });
                
                if (player) {
                    gameState.player.id = player.id;
                    gameState.player.username = username;
                }
                
                await handleAuthSuccess(data.user, phone);
                
            } catch (error) {
                console.error('OTP verify error:', error);
                alert('Verification failed: ' + error.message);
            }
        }

        // Handle successful authentication
        async function handleAuthSuccess(user, identifier) {
            currentUser = user;
            isLoggedIn = true;
            
            // Update UI
            document.getElementById('authStatus').textContent = `üë§ ${identifier.split('@')[0]}`;
            document.getElementById('authButton').classList.add('bg-green-600');
            
            // Hide auth landing, show game
            document.getElementById('authLanding').classList.add('hidden');
            document.getElementById('gameContent').classList.remove('hidden');
            
            closeModal();
            
            addConsoleMessage(`‚úÖ Signed in as ${identifier}`, 'green');
            addConsoleMessage('üí° Click "Edit" next to your profile to change your pimp name!', 'cyan');
            
            // Load player profile
            await loadPlayerProfileFromAuth();
        }

        // Sign In
        async function signIn() {
            const email = document.getElementById('signInEmail').value.trim();
            const password = document.getElementById('signInPassword').value;
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            try {
                addConsoleMessage('üîë Signing in...', 'cyan');
                
                const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                isLoggedIn = true;
                
                // Update UI
                document.getElementById('authStatus').textContent = 
                    `üë§ ${email.split('@')[0]}`;
                document.getElementById('authButton').classList.add('bg-green-600');
                
                addConsoleMessage(`‚úÖ Signed in as ${email}`, 'green');
                closeModal();
                
                // Load player profile from database
                await loadPlayerProfileFromAuth();
                
            } catch (error) {
                console.error('Sign in error:', error);
                addConsoleMessage('‚ùå Sign in failed: ' + error.message, 'red');
                
                if (error.message.includes('Invalid login credentials')) {
                    alert('Invalid email or password. Please check your credentials.');
                } else {
                    alert('Sign in failed: ' + error.message);
                }
            }
        }

        // Sign Up
        async function signUp() {
            const email = document.getElementById('signUpEmail').value.trim();
            const password = document.getElementById('signUpPassword').value;
            const username = document.getElementById('signUpUsername').value.trim();
            
            if (!email || !password || !username) {
                alert('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            if (username.length < 3) {
                alert('Pimp name must be at least 3 characters');
                return;
            }
            
            try {
                addConsoleMessage('üÜï Creating account...', 'cyan');
                
                // Check if username is taken
                const { data: existingUsers } = await window.supabaseClient
                    .from('players')
                    .select('username')
                    .eq('username', username);
                
                if (existingUsers && existingUsers.length > 0) {
                    alert('That pimp name is already taken! Choose another.');
                    return;
                }
                
                // Create auth account
                const { data, error } = await window.supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                isLoggedIn = true;
                
                // Create player profile
                const player = await SupabaseAPI.createPlayer({
                    walletAddress: currentUser.id, // Use auth ID as unique identifier
                    username: username,
                    bio: '',
                    level: 1,
                    cash: 9360,
                    respect: 0,
                    heat: 0
                });
                
                if (player) {
                    gameState.player.id = player.id;
                    gameState.player.username = username;
                    
                    // Update UI
                    document.getElementById('authStatus').textContent = 
                        `üë§ ${email.split('@')[0]}`;
                    document.getElementById('authButton').classList.add('bg-green-600');
                    
                    addConsoleMessage(`‚úÖ Account created! Welcome ${username}`, 'green');
                    closeModal();
                    updateUI();
                } else {
                    throw new Error('Failed to create player profile');
                }
                
            } catch (error) {
                console.error('Sign up error:', error);
                addConsoleMessage('‚ùå Sign up failed: ' + error.message, 'red');
                alert('Sign up failed: ' + error.message);
            }
        }

        // Guest mode removed - Authentication required for multiplayer

        // Google Authentication
        async function signInWithGoogle() {
            try {
                addConsoleMessage('üîó Redirecting to Google...', 'cyan');
                
                const { data, error } = await window.supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + '/game/game-v3.html'
                    }
                });
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Google sign in error:', error);
                alert('Google sign in failed: ' + error.message);
            }
        }

        // Email Authentication Modal
        function showEmailAuth() {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <div class="text-center mb-4">
                            <img src="images/pimpfun_logo.png" alt="PIMP.FUN" class="h-12 mx-auto mb-2">
                            <h3 class="text-xl font-bold cyan-glow">Email Authentication</h3>
                        </div>
                        
                        <div id="emailAuthTabs" class="flex mb-4 bg-gray-800 rounded p-1">
                            <button onclick="showEmailSignIn()" id="emailSignInTab" class="flex-1 py-2 px-4 rounded text-sm bg-purple-600 text-white">
                                Sign In
                            </button>
                            <button onclick="showEmailSignUp()" id="emailSignUpTab" class="flex-1 py-2 px-4 rounded text-sm text-gray-400">
                                Sign Up
                            </button>
                        </div>
                        
                        <!-- Sign In Form -->
                        <div id="emailSignInForm" class="space-y-4">
                            <input type="email" id="emailSignInEmail" placeholder="Email address" 
                                   class="w-full p-3 bg-gray-800 border border-gray-600 rounded text-white">
                            <input type="password" id="emailSignInPassword" placeholder="Password" 
                                   class="w-full p-3 bg-gray-800 border border-gray-600 rounded text-white">
                            <button onclick="emailSignIn()" class="w-full py-3 bg-purple-600 rounded font-bold hover:bg-purple-500">
                                üîë Sign In
                            </button>
                        </div>
                        
                        <!-- Sign Up Form -->
                        <div id="emailSignUpForm" class="space-y-4 hidden">
                            <input type="email" id="emailSignUpEmail" placeholder="Email address" 
                                   class="w-full p-3 bg-gray-800 border border-gray-600 rounded text-white">
                            <input type="password" id="emailSignUpPassword" placeholder="Password (6+ characters)" 
                                   class="w-full p-3 bg-gray-800 border border-gray-600 rounded text-white">
                            <input type="text" id="emailSignUpUsername" placeholder="Your pimp name" 
                                   class="w-full p-3 bg-gray-800 border border-gray-600 rounded text-white" maxlength="20">
                            <button onclick="emailSignUp()" class="w-full py-3 bg-green-600 rounded font-bold hover:bg-green-500">
                                üÜï Create Account
                            </button>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-700 rounded">Back</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // Phone/OTP Authentication Modal
        function showPhoneAuth() {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full">
                        <div class="text-center mb-4">
                            <img src="images/pimpfun_logo.png" alt="PIMP.FUN" class="h-12 mx-auto mb-2">
                            <h3 class="text-xl font-bold cyan-glow">Phone Authentication</h3>
                        </div>
                        
                        <div id="phoneAuthStep" class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-2 text-gray-300">Phone Number</label>
                                <input type="tel" id="phoneNumber" placeholder="+1 (555) 123-4567" 
                                       class="w-full p-3 bg-gray-800 border border-gray-600 rounded text-white">
                            </div>
                            <button onclick="sendOTP()" class="w-full py-3 bg-cyan-600 rounded font-bold hover:bg-cyan-500">
                                üì± Send Code
                            </button>
                        </div>
                        
                        <div id="otpVerifyStep" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-bold mb-2 text-gray-300">Verification Code</label>
                                <input type="text" id="otpCode" placeholder="Enter 6-digit code" 
                                       class="w-full p-3 bg-gray-800 border border-gray-600 rounded text-white text-center text-2xl tracking-widest">
                            </div>
                            <input type="text" id="otpUsername" placeholder="Your pimp name" 
                                   class="w-full p-3 bg-gray-800 border border-gray-600 rounded text-white" maxlength="20">
                            <button onclick="verifyOTP()" class="w-full py-3 bg-green-600 rounded font-bold hover:bg-green-500">
                                ‚úÖ Verify & Enter
                            </button>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full mt-4 py-2 bg-gray-700 rounded">Back</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // District Selection
        // District Selection with Enhanced Mafia-Inspired Details
        function selectDistrict() {
            console.log('üèôÔ∏è District selection clicked');
            console.log('üèôÔ∏è GameConstants available:', typeof window.GameConstants !== 'undefined');
            
            if (typeof window.GameConstants === 'undefined') {
                console.error('‚ùå GameConstants not available');
                showNotification('‚ùå Game data not loaded properly. Please refresh the page.', 'error');
                return;
            }
            
            const districts = window.GameConstants.DISTRICTS_AND_TERRITORIES;
            console.log('üèôÔ∏è Using GameConstants districts:', Object.keys(districts));
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-5xl w-full my-8 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-2xl font-bold cyan-glow mb-4 text-center">üèôÔ∏è CHOOSE YOUR EMPIRE DISTRICT</h3>
                        <p class="text-sm text-gray-400 mb-6 text-center">Empire City's five districts each offer unique mafia-inspired advantages. Choose wisely - your empire depends on it.</p>
                        
                        <div class="space-y-6">
                            ${Object.entries(districts).map(([districtName, districtData]) => `
                                <div class="district-card border border-gray-600 rounded-lg p-5 bg-gradient-to-r from-gray-800/40 to-gray-700/40 hover:from-gray-700/50 hover:to-gray-600/50 transition-all">
                                    <!-- District Header -->
                                    <div class="district-header mb-4">
                                        <div class="flex justify-between items-start mb-3">
                                            <div class="flex-1">
                                                <h4 class="text-2xl font-bold cyan-glow mb-2">${districtName}</h4>
                                                <p class="text-sm text-amber-400 mb-1">üåç Based on ${districtData.realWorldName} ‚Ä¢ ${districtData.territoryCount} Territories</p>
                                                <p class="text-sm text-purple-400 font-semibold">üí™ ${districtData.districtBonus.name}</p>
                                            </div>
                                            <button onclick="toggleDistrictDetails('${districtName.replace(/\s+/g, '-')}')" 
                                                    class="px-3 py-1 bg-cyan-600 hover:bg-cyan-500 rounded text-sm font-bold transition-all">
                                                View Details
                                            </button>
                                        </div>
                                        
                                        <!-- Vibe Description -->
                                        <div class="mb-3 p-3 bg-gray-900/60 rounded border-l-4 border-cyan-500">
                                            <p class="text-sm text-gray-300 italic">${districtData.vibe}</p>
                                        </div>
                                        
                                        <!-- District Bonus -->
                                        <div class="mb-4 p-3 bg-purple-900/30 rounded border border-purple-600/30">
                                            <p class="text-sm text-purple-300">
                                                <span class="text-purple-400 font-bold">üéØ District Bonus:</span> 
                                                ${districtData.districtBonus.description}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Territory Details (Initially Hidden) -->
                                    <div id="details-${districtName.replace(/\s+/g, '-')}" class="territory-details hidden">
                                        <div class="mb-4 p-3 bg-yellow-900/20 rounded border border-yellow-600/30">
                                            <p class="text-sm text-yellow-300">
                                                <span class="text-yellow-400 font-bold">üèóÔ∏è Why ${districtData.realWorldName}?</span> 
                                                ${districtData.whyFits}
                                            </p>
                                        </div>
                                        
                                        <!-- Key Territories -->
                                        <div class="mb-4">
                                            <h5 class="text-lg font-bold text-cyan-400 mb-3">üè¥‚Äç‚ò†Ô∏è Key Territories</h5>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                ${districtData.territories.slice(0, 6).map(territory => `
                                                    <div class="territory-card p-3 bg-gray-800/50 rounded border border-gray-600/50 hover:border-cyan-500/50 transition-all cursor-pointer"
                                                         onclick="selectSpecificTerritory('${districtName}', '${territory.name}')">
                                                        <div class="flex justify-between items-start mb-2">
                                                            <h6 class="font-bold text-gold-text">${territory.name}</h6>
                                                            ${territory.trait ? `<span class="text-xs text-green-400">‚≠ê</span>` : ''}
                                                        </div>
                                                        <p class="text-xs text-gray-400 mb-2">${territory.description}</p>
                                                        ${territory.trait ? `
                                                            <div class="text-xs text-green-300 bg-green-900/30 rounded px-2 py-1">
                                                                <span class="text-green-400 font-bold">Special:</span> ${territory.trait}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                            
                                            ${districtData.territories.length > 6 ? `
                                                <div class="mt-3 text-center">
                                                    <button onclick="showAllTerritories('${districtName}')" 
                                                            class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm font-bold transition-all">
                                                        View All ${districtData.territoryCount} Territories
                                                    </button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    
                                    <!-- Choose District Button -->
                                    <div class="text-center mt-4">
                                        <button onclick="chooseNewDistrict('${districtName}')" 
                                                class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 rounded font-bold text-lg transition-all transform hover:scale-105">
                                            ‚ö° Claim ${districtName} ‚ö°
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${gameState.player.district ? `
                            <div class="text-center mt-6 p-4 bg-gray-800/50 rounded border border-cyan-500/30">
                                <p class="text-sm text-gray-400">Current District: <span class="cyan-glow font-bold">${gameState.player.district}</span></p>
                                ${gameState.player.territory ? `<p class="text-xs text-gray-500 mt-1">Territory: <span class="text-gold-text">${gameState.player.territory}</span></p>` : ''}
                            </div>
                        ` : ''}
                        
                        <button onclick="closeModal()" class="w-full mt-6 py-3 bg-gray-700 hover:bg-gray-600 rounded font-bold transition-all">Close</button>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // Toggle district details display
        function toggleDistrictDetails(safeDistrictId) {
            const detailsContainer = document.getElementById(`details-${safeDistrictId}`);
            const button = event.target;
            
            if (detailsContainer && detailsContainer.classList.contains('hidden')) {
                detailsContainer.classList.remove('hidden');
                button.textContent = 'Hide Details';
                button.classList.add('bg-red-600', 'hover:bg-red-500');
                button.classList.remove('bg-cyan-600', 'hover:bg-cyan-500');
            } else if (detailsContainer) {
                detailsContainer.classList.add('hidden');
                button.textContent = 'View Details';
                button.classList.remove('bg-red-600', 'hover:bg-red-500');
                button.classList.add('bg-cyan-600', 'hover:bg-cyan-500');
            }
        }

        // Show all territories for a district
        function showAllTerritories(districtName) {
            const districts = window.GameConstants.DISTRICTS_AND_TERRITORIES;
            const districtData = districts[districtName];
            
            if (!districtData) {
                console.error('District not found:', districtName);
                return;
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-4xl w-full my-8 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-2xl font-bold cyan-glow mb-4 text-center">üè¥‚Äç‚ò†Ô∏è ${districtName} - All Territories</h3>
                        <p class="text-sm text-gray-400 mb-6 text-center">${districtData.territoryCount} mafia-inspired territories await your command</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${districtData.territories.map(territory => `
                                <div class="territory-card p-4 bg-gray-800/50 rounded border border-gray-600/50 hover:border-cyan-500/50 transition-all cursor-pointer"
                                     onclick="selectSpecificTerritory('${districtName}', '${territory.name}')">
                                    <div class="flex justify-between items-start mb-2">
                                        <h6 class="font-bold text-gold-text">${territory.name}</h6>
                                        ${territory.trait ? `<span class="text-sm text-green-400">‚≠ê Special</span>` : ''}
                                    </div>
                                    <p class="text-sm text-gray-400 mb-3">${territory.description}</p>
                                    ${territory.trait ? `
                                        <div class="text-xs text-green-300 bg-green-900/30 rounded px-2 py-1">
                                            <span class="text-green-400 font-bold">Unique Trait:</span> ${territory.trait}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="chooseNewDistrict('${districtName}')" 
                                    class="flex-1 py-3 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 rounded font-bold transition-all">
                                ‚ö° Claim ${districtName} ‚ö°
                            </button>
                            <button onclick="selectDistrict()" 
                                    class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded font-bold transition-all">
                                ‚Üê Back to Districts
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // Toggle district territory display - Updated for GameConstants
        function toggleDistrictTerritories(districtName) {
            const safeDistrictId = districtName.replace(/\s+/g, '-');
            const territoriesContainer = document.getElementById(`territories-${safeDistrictId}`);
            const toggleIcon = document.getElementById(`toggle-${safeDistrictId}`);
            
            if (territoriesContainer && territoriesContainer.classList.contains('hidden')) {
                // Close all other districts first
                Object.keys(window.GameConstants.DISTRICTS_AND_TERRITORIES).forEach(name => {
                    const safeName = name.replace(/\s+/g, '-');
                    if (safeName !== safeDistrictId) {
                        const container = document.getElementById(`territories-${safeName}`);
                        const icon = document.getElementById(`toggle-${safeName}`);
                        if (container) container.classList.add('hidden');
                        if (icon) icon.textContent = '‚ñº';
                    }
                });
                
                territoriesContainer.classList.remove('hidden');
                if (toggleIcon) toggleIcon.textContent = '‚ñ≤';
            } else if (territoriesContainer) {
                territoriesContainer.classList.add('hidden');
                if (toggleIcon) toggleIcon.textContent = '‚ñº';
            }
        }

        // Select specific territory within district - Enhanced for Mafia Details
        function selectSpecificTerritory(districtName, territoryName) {
            const districts = window.GameConstants.DISTRICTS_AND_TERRITORIES;
            const districtData = districts[districtName];
            
            if (!districtData) {
                console.error('District not found:', districtName);
                return;
            }
            
            // Find the territory object
            const territory = districtData.territories.find(t => 
                (typeof t === 'string' ? t : t.name) === territoryName
            );
            
            if (!territory) {
                console.error('Territory not found in district:', territoryName, districtName);
                return;
            }
            
            // Extract territory data (handle both old string format and new object format)
            const territoryObj = typeof territory === 'string' ? 
                { name: territory, description: 'A strategic location in your empire.' } : territory;
            
            // Show enhanced territory details
            const detailModal = `
                <div class="fixed inset-0 bg-black/90 backdrop-blur-sm z-60 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full">
                        <h3 class="text-2xl font-bold cyan-glow mb-3">üè¥‚Äç‚ò†Ô∏è ${territoryObj.name}</h3>
                        <p class="text-sm text-amber-400 mb-4">${districtName} ‚Ä¢ ${districtData.realWorldName}</p>
                        
                        <div class="space-y-4">
                            <!-- Territory Description -->
                            <div class="p-4 bg-gray-800/50 rounded border-l-4 border-cyan-500">
                                <h4 class="font-bold text-cyan-400 mb-2">üèòÔ∏è Territory Overview</h4>
                                <p class="text-sm text-gray-300">${territoryObj.description}</p>
                            </div>
                            
                            <!-- District Bonus -->
                            <div class="p-3 bg-purple-900/30 rounded border border-purple-600/30">
                                <h4 class="font-bold text-purple-400 mb-2">üéØ District Bonus: ${districtData.districtBonus.name}</h4>
                                <p class="text-sm text-purple-300">${districtData.districtBonus.description}</p>
                            </div>
                            
                            ${territoryObj.trait ? `
                                <!-- Special Territory Trait -->
                                <div class="p-3 bg-green-900/30 rounded border border-green-600/30">
                                    <h4 class="font-bold text-green-400 mb-2">‚≠ê Unique Territory Trait</h4>
                                    <p class="text-sm text-green-300">${territoryObj.trait}</p>
                                </div>
                            ` : ''}
                            
                            <!-- Empire Benefits -->
                            <div class="p-3 bg-blue-900/30 rounded border border-blue-600/30">
                                <h4 class="font-bold text-blue-400 mb-2">üèõÔ∏è Empire Benefits</h4>
                                <p class="text-sm text-blue-300">Claiming ${territoryObj.name} will establish your operations in ${districtName}, giving you access to:</p>
                                <ul class="text-xs text-blue-200 mt-2 space-y-1">
                                    <li>‚Ä¢ District-wide ${districtData.districtBonus.name} bonus</li>
                                    <li>‚Ä¢ Strategic position in ${districtData.realWorldName}</li>
                                    <li>‚Ä¢ Territory-specific opportunities and resources</li>
                                    ${territoryObj.trait ? '<li>‚Ä¢ Unique territory trait advantages</li>' : ''}
                                </ul>
                            </div>
                            
                            <!-- Territory Stats -->
                            <div class="p-3 bg-yellow-900/30 rounded border border-yellow-600/30">
                                <h4 class="font-bold text-yellow-400 mb-2">üìä Territory Stats</h4>
                                <div class="grid grid-cols-2 gap-3 text-xs">
                                    <div>
                                        <span class="text-gray-400">District:</span>
                                        <span class="text-yellow-300 font-bold">${districtName}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Total Territories:</span>
                                        <span class="text-yellow-300 font-bold">${districtData.territoryCount}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Special Trait:</span>
                                        <span class="text-yellow-300 font-bold">${territoryObj.trait ? 'Yes ‚≠ê' : 'Standard'}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Based on:</span>
                                        <span class="text-yellow-300 font-bold">${districtData.realWorldName}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="confirmNewTerritorySelection('${districtName}', '${territoryObj.name}')" 
                                    class="flex-1 py-3 bg-gradient-to-r from-green-600 to-emerald-600 rounded font-bold hover:from-green-500 hover:to-emerald-500 transition-all transform hover:scale-105">
                                ‚ö° Claim ${territoryObj.name} ‚ö°
                            </button>
                            <button onclick="showAllTerritories('${districtName}')" 
                                    class="flex-1 py-3 bg-gray-700 rounded font-bold hover:bg-gray-600 transition-all">
                                ‚Üê Back to ${districtName}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = detailModal;
        }

        // Choose district without specific territory - Updated for GameConstants
        function chooseNewDistrict(districtName) {
            const districts = window.GameConstants.DISTRICTS_AND_TERRITORIES;
            const districtData = districts[districtName];
            
            if (!districtData) {
                console.error('District not found:', districtName);
                return;
            }
            
            const isFirstTime = !gameState.player.district;
            
            gameState.player.district = districtName;
            gameState.player.territory = null; // No specific territory chosen
            
            // Update UI
            document.getElementById('district').textContent = districtName;
            document.getElementById('district').className = 'cyan-glow cursor-pointer';
            
            if (isFirstTime) {
                // Starter kit for first-time district selection
                gameState.resources.thugs += 10;
                gameState.resources.weapons.pistols += 10;
                gameState.resources.condoms += 500;
                gameState.resources.beer += 200;
                gameState.player.cash += 5000;
                
                addConsoleMessage(`üèôÔ∏è Welcome to ${districtName}!`, 'cyan');
                addConsoleMessage('üéÅ Starter kit received: 10 thugs, 10 pistols, supplies, +$5,000', 'green');
                addConsoleMessage(`üóΩ Operating in ${districtData.realWorldName} with ${districtData.territoryCount} territories available`, 'blue');
                addConsoleMessage('üí° Tip: Click "Choose District" again to select a specific territory!', 'blue');
            } else {
                addConsoleMessage(`üöö Moved operations to ${districtName}`, 'cyan');
                addConsoleMessage('üí° Tip: Click "Choose District" again to select a specific territory!', 'blue');
            }
            
            updateUI();
            calculateRank();
            saveGameState();
            closeModal();
        }

        // Confirm specific territory selection - Updated for GameConstants  
        function confirmNewTerritorySelection(districtName, territoryName) {
            const districts = window.GameConstants.DISTRICTS_AND_TERRITORIES;
            const districtData = districts[districtName];
            const isFirstTime = !gameState.player.district;
            
            gameState.player.district = districtName;
            gameState.player.territory = territoryName;
            
            // Update UI
            document.getElementById('district').textContent = `${districtName} - ${territoryName}`;
            document.getElementById('district').className = 'cyan-glow cursor-pointer';
            
            if (isFirstTime) {
                // Starter kit for first-time district selection
                gameState.resources.thugs += 10;
                gameState.resources.weapons.pistols += 10;
                gameState.resources.condoms += 500;
                gameState.resources.beer += 200;
                gameState.player.cash += 5000;
                
                addConsoleMessage(`üèôÔ∏è Welcome to ${territoryName} in ${districtName}!`, 'cyan');
                addConsoleMessage('üéÅ Starter kit received: 10 thugs, 10 pistols, supplies, +$5,000', 'green');
                addConsoleMessage(`üóΩ Based in ${districtData.realWorldName} territory`, 'gold');
                addConsoleMessage(`üìç Territory ${territoryName} claimed successfully`, 'blue');
            } else {
                addConsoleMessage(`üöö Moved to ${territoryName} in ${districtName}`, 'cyan');
                addConsoleMessage(`üìç New territory claimed: ${territoryName}`, 'gold');
            }
            
            updateUI();
            calculateRank();
            saveGameState();
            closeModal();
        }

        // Payout adjustment (original PimpWar mechanic)
        function adjustPayout() {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full my-8 max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">HOE PAYOUT RATE</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">Set how much your hoes keep (affects happiness and your income):</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2 text-gray-300">Payout Percentage</label>
                            <input type="range" id="payoutSlider" min="1" max="99" value="${gameState.player.payoutPercentage}" 
                                   class="w-full" oninput="updatePayoutPreview()">
                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                <span>1% (More money for you)</span>
                                <span>99% (Defensive - hoes won't leave)</span>
                            </div>
                            <div class="text-center mt-2">
                                <span id="payoutValue" class="text-2xl font-bold gold-text">${gameState.player.payoutPercentage}%</span>
                            </div>
                        </div>
                        
                        <div class="mb-4 p-3 bg-gray-800/50 rounded">
                            <h4 class="font-bold text-white mb-2">üí° Original Strategy Tips:</h4>
                            <ul class="text-xs text-gray-400 space-y-1">
                                <li>‚Ä¢ <strong>Normal play:</strong> 20-40% keeps hoes happy</li>
                                <li>‚Ä¢ <strong>Defensive:</strong> 99% before logging out (hoes won't be stolen)</li>
                                <li>‚Ä¢ <strong>Aggressive:</strong> 8-15% for maximum income (risky)</li>
                            </ul>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="setPayout()" class="flex-1 py-2 action-btn rounded">Set Payout</button>
                            <button onclick="closeModal()" class="flex-1 py-2 bg-gray-700 rounded">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        function updatePayoutPreview() {
            const value = document.getElementById('payoutSlider').value;
            document.getElementById('payoutValue').textContent = value + '%';
        }

        function setPayout() {
            const newPayout = parseInt(document.getElementById('payoutSlider').value);
            gameState.player.payoutPercentage = newPayout;
            
            // Recalculate happiness immediately
            calculateHappiness();
            
            showNotification(`üí∞ Payout set to ${newPayout}%`, 'success');
            addConsoleMessage(`Payout set to ${newPayout}% - hoe happiness will adjust`, 'green');
            updateUI();
            saveLocalGameState();
            closeModal();
        }

        // Scout with turn selection
        function showScoutOptions() {
            const currentTurns = calculateCurrentTurns();
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full my-8 max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">üîç SCOUT DISTRICTS</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        
                        <div class="mb-4 p-3 bg-gray-800/50 rounded">
                            <p class="text-sm text-white">Available Turns: <span class="gold-text">${currentTurns}</span></p>
                        </div>
                        
                        <!-- District Selection - ALL 5 DISTRICTS -->
                        <div class="mb-6">
                            <label class="block text-sm font-bold mb-3 text-gray-300">Choose District:</label>
                            <div class="space-y-2">
                                <button onclick="selectScoutDistrict('uptown')" id="scoutUptown" class="district-btn w-full p-3 border-2 border-transparent rounded hover:border-gold">
                                    <div class="text-left">
                                        <div class="font-bold gold-text text-base">üèôÔ∏è Uptown Plaza</div>
                                        <div class="text-xs text-gray-400">Quality over quantity ‚Ä¢ Higher income per hoe</div>
                                        <div class="text-xs text-yellow-400">üìä Fewer recruits (-35%) but premium earners (+60%)</div>
                                    </div>
                                </button>
                                
                                <button onclick="selectScoutDistrict('midtown')" id="scoutMidtown" class="district-btn w-full p-3 border-2 border-transparent rounded hover:border-cyan-400">
                                    <div class="text-left">
                                        <div class="font-bold cyan-glow text-base">üåÉ Midtown Market</div>
                                        <div class="text-xs text-gray-400">Balanced recruiting ‚Ä¢ Steady income</div>
                                        <div class="text-xs text-cyan-400">üìä Baseline yields ‚Ä¢ Recommended for beginners</div>
                                    </div>
                                </button>
                                
                                <button onclick="selectScoutDistrict('crooklyn')" id="scoutCrooklyn" class="district-btn w-full p-3 border-2 border-transparent rounded hover:border-magenta">
                                    <div class="text-left">
                                        <div class="font-bold magenta-glow text-base">üèöÔ∏è Crooklyn Heights</div>
                                        <div class="text-xs text-gray-400">Brooklyn streets ‚Ä¢ Real recognize real</div>
                                        <div class="text-xs text-purple-400">üìä More recruits (+25%) but lower income (-30%)</div>
                                    </div>
                                </button>
                                
                                <button onclick="selectScoutDistrict('docks')" id="scoutDocks" class="district-btn w-full p-3 border-2 border-transparent rounded hover:border-blue-400">
                                    <div class="text-left">
                                        <div class="font-bold text-blue-400 text-base">üö¢ Harbor Docks</div>
                                        <div class="text-xs text-gray-400">Brooklyn Navy Yard ‚Ä¢ Import/export empire</div>
                                        <div class="text-xs text-blue-400">üìä Vehicle access (+25%) ‚Ä¢ Weapon imports (+30%)</div>
                                    </div>
                                </button>
                                
                                <button onclick="selectScoutDistrict('financial')" id="scoutFinancial" class="district-btn w-full p-3 border-2 border-transparent rounded hover:border-emerald-400">
                                    <div class="text-left">
                                        <div class="font-bold text-emerald-400 text-base">üè¢ Financial District</div>
                                        <div class="text-xs text-gray-400">Wall Street towers ‚Ä¢ Corporate fronts</div>
                                        <div class="text-xs text-emerald-400">üìä Money laundering (+50%) ‚Ä¢ Heat reduction (-25%)</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Turn Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2 text-gray-300">Select Turns:</label>
                            <div class="grid grid-cols-4 gap-2 mb-3">
                                <button onclick="setScoutTurns(5)" class="px-3 py-2 action-btn rounded text-sm">5</button>
                                <button onclick="setScoutTurns(10)" class="px-3 py-2 action-btn rounded text-sm">10</button>
                                <button onclick="setScoutTurns(15)" class="px-3 py-2 action-btn rounded text-sm">15</button>
                                <button onclick="setScoutTurns(20)" class="px-3 py-2 action-btn rounded text-sm">20</button>
                                <button onclick="setScoutTurns(25)" class="px-3 py-2 action-btn rounded text-sm">25</button>
                                <button onclick="setScoutTurns(30)" class="px-3 py-2 bg-green-600 rounded text-sm">30 ‚≠ê</button>
                                <button onclick="setScoutTurns(40)" class="px-3 py-2 action-btn rounded text-sm">40</button>
                                <button onclick="setScoutTurns(50)" class="px-3 py-2 action-btn rounded text-sm">50</button>
                            </div>
                            <input type="number" id="scoutTurnsInput" value="30" min="5" max="200" step="5"
                                   class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white text-center">
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="executeScoutWithTurns()" id="scoutExecuteBtn" disabled class="flex-1 py-3 bg-gray-600 disabled:cursor-not-allowed rounded font-bold">
                                üîç Scout Selected District
                            </button>
                            <button onclick="closeModal()" class="flex-1 py-2 bg-gray-700 rounded">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
            
            // Auto-select midtown as default after modal loads
            setTimeout(() => {
                selectScoutDistrict('midtown');
            }, 100);
        }

        function showCrackOptions() {
            const currentTurns = calculateCurrentTurns();
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                    <div class="game-panel rounded-lg p-6 max-w-md w-full my-8 max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold cyan-glow">PRODUCE CRACK</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        
                        <div class="mb-4 p-3 bg-gray-800/50 rounded">
                            <p class="text-sm text-white">Available Turns: <span class="gold-text">${currentTurns}</span></p>
                            <p class="text-sm text-white">Thugs: <span class="text-white">${gameState.resources.thugs}</span></p>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2 text-gray-300">Select Turns:</label>
                            <div class="grid grid-cols-4 gap-2 mb-3">
                                <button onclick="setCrackTurns(5)" class="px-3 py-2 action-btn rounded text-sm">5</button>
                                <button onclick="setCrackTurns(10)" class="px-3 py-2 action-btn rounded text-sm">10</button>
                                <button onclick="setCrackTurns(15)" class="px-3 py-2 bg-green-600 rounded text-sm">15 ‚≠ê</button>
                                <button onclick="setCrackTurns(20)" class="px-3 py-2 action-btn rounded text-sm">20</button>
                                <button onclick="setCrackTurns(25)" class="px-3 py-2 action-btn rounded text-sm">25</button>
                                <button onclick="setCrackTurns(30)" class="px-3 py-2 action-btn rounded text-sm">30</button>
                                <button onclick="setCrackTurns(40)" class="px-3 py-2 action-btn rounded text-sm">40</button>
                                <button onclick="setCrackTurns(50)" class="px-3 py-2 action-btn rounded text-sm">50</button>
                            </div>
                            <input type="number" id="crackTurnsInput" value="15" min="5" max="200" step="5"
                                   class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white text-center">
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="executeCrackWithTurns()" class="flex-1 py-3 action-btn rounded font-bold">
                                üíé Produce Now
                            </button>
                            <button onclick="closeModal()" class="flex-1 py-2 bg-gray-700 rounded">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // Scout district selection
        let selectedScoutDistrict = 'midtown'; // Default to balanced option

        function selectScoutDistrict(district) {
            console.log('üéØ Selecting scout district:', district);
            
            // Clear ALL previous selections with more specific class removal
            document.querySelectorAll('.district-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-900/30');
                btn.classList.remove('border-gold', 'border-cyan-500', 'border-magenta', 'border-blue-400', 'border-emerald-400');
                btn.classList.remove('bg-gold/20', 'bg-cyan-900/20', 'bg-magenta/20', 'bg-blue-900/20', 'bg-emerald-900/20');
                if (!btn.classList.contains('border-transparent')) {
                btn.classList.add('border-transparent');
                }
            });
            
            // Set the selected district
            selectedScoutDistrict = district;
            
            // Highlight ONLY the selected district
            const btn = document.getElementById(`scout${district.charAt(0).toUpperCase() + district.slice(1)}`);
            if (btn) {
                btn.classList.remove('border-transparent');
                btn.classList.add('border-purple-500', 'bg-purple-900/30');
                console.log('‚úÖ Highlighted ONLY button:', btn.id);
            }
            
            // Enable scout button
            const districtInfo = DISTRICTS[district];
            if (districtInfo) {
                const executeBtn = document.getElementById('scoutExecuteBtn');
                if (executeBtn) {
                    executeBtn.disabled = false;
                    executeBtn.classList.remove('bg-gray-600', 'disabled:cursor-not-allowed');
                    executeBtn.classList.add('bg-green-600', 'hover:bg-green-500');
                    executeBtn.textContent = `üîç Scout ${districtInfo.name}`;
                }
                addConsoleMessage(`üéØ Selected ${districtInfo.name} for scouting`, 'cyan');
            }
        }

        function setScoutTurns(turns) {
            document.getElementById('scoutTurnsInput').value = turns;
        }

        function setCrackTurns(turns) {
            document.getElementById('crackTurnsInput').value = turns;
        }

        function executeScoutWithTurns() {
            const turnsToUse = parseInt(document.getElementById('scoutTurnsInput').value) || 30;
            const district = selectedScoutDistrict || 'midtown';
            
            console.log('üéØ EXECUTING ENHANCED SCOUT:', { turnsToUse, district });
            
            // Close the scout options modal first
            closeModal();
            
            // Use the proper useTurns function with logging
            if (!useTurns(turnsToUse)) {
                showNotification(`‚ùå Not enough turns! Need ${turnsToUse} turns`, 'error');
                return;
            }
            
            // Get district info and bonuses
            const districtInfo = DISTRICTS[district];
            const districtName = districtInfo.name;
            
            // Enhanced district-specific scouting yields
            let hoesFound = 0;
            let thugsFound = 0;
            let hoeQuality = 1.0;
            
            // Base rates with better scaling
            let baseHoeChance = 0.20; // Increased base rate
            let baseThugsChance = 0.15; // Increased base rate
            
            // Apply district modifiers for all 5 districts
            if (district === 'uptown') {
                baseHoeChance *= 0.65; // -35% recruits but higher quality
                hoeQuality = 1.6; // +60% income
                baseThugsChance *= 0.8;
            } else if (district === 'crooklyn') {
                baseHoeChance *= 1.25; // +25% recruits (Brooklyn hustle)
                hoeQuality = 0.7; // -30% income (street rates)
                baseThugsChance *= 1.15; // +15% thugs (tough neighborhood)
            } else if (district === 'docks') {
                baseHoeChance *= 1.1; // +10% recruits (sailors/workers)
                hoeQuality = 1.15; // +15% income (import money)
                baseThugsChance *= 1.05; // +5% thugs (dock workers)
            } else if (district === 'financial') {
                baseHoeChance *= 0.8; // -20% recruits (exclusive Wall Street)
                hoeQuality = 1.5; // +50% income (corporate money laundering)
                baseThugsChance *= 0.9; // -10% thugs (white collar setting)
            }
            // Midtown uses baseline values (no modifiers)
            
            // Better yield calculation
            if (turnsToUse <= 15) {
                // Small scouts: probability per turn
                for (let i = 0; i < turnsToUse; i++) {
                    if (Math.random() < baseHoeChance) hoesFound++;
                    if (Math.random() < baseThugsChance) thugsFound++;
                }
            } else {
                // Large scouts: guaranteed base + bonus
                hoesFound = Math.floor(turnsToUse * baseHoeChance) + Math.floor(Math.random() * Math.ceil(turnsToUse * 0.12));
                thugsFound = Math.floor(turnsToUse * baseThugsChance) + Math.floor(Math.random() * Math.ceil(turnsToUse * 0.10));
            }
            
            // Guaranteed minimums for meaningful results
            const minHoes = Math.max(1, Math.floor(turnsToUse * 0.1));
            const minThugs = Math.max(1, Math.floor(turnsToUse * 0.08));
            
            if (hoesFound < minHoes) hoesFound = minHoes;
            if (thugsFound < minThugs) thugsFound = minThugs;
            
            // District-specific money earnings (balanced for all 5 districts)
            const baseMoneyPerTurn = 18;
            let districtBonus = 7; // Default midtown bonus
            
            if (district === 'uptown') {
                districtBonus = 12; // Higher earnings, premium Manhattan
            } else if (district === 'crooklyn') {
                districtBonus = 4; // Lower earnings, Brooklyn hustle
            } else if (district === 'docks') {
                districtBonus = 15; // High earnings, import/export
            } else if (district === 'financial') {
                districtBonus = 20; // Highest earnings, Wall Street money laundering
            }
            
            const moneyEarned = (baseMoneyPerTurn + districtBonus) * turnsToUse + Math.floor(Math.random() * turnsToUse * 6);
            
            // Calculate NFT chance
            const nftChance = calculateNFTChance(turnsToUse, 'scout');
            const nftFound = Math.random() < nftChance;
            
            let nftDrop = null;
            if (nftFound) {
                nftDrop = generateNFTDrop(districtName);
                if (!gameState.nfts) gameState.nfts = [];
                gameState.nfts.push(nftDrop);
                applyNFTEffects(nftDrop);
                console.log('üåü NFT Drop generated:', nftDrop);
            }
            
            // Apply changes with logging
            const oldCash = gameState.player.cash;
            const oldHoes = gameState.resources.hoes;
            const oldThugs = gameState.resources.thugs;
            
            logResourceChange('cash', null, oldCash, oldCash + moneyEarned, `scout_${district}`);
            logResourceChange('hoes', null, oldHoes, oldHoes + hoesFound, `scout_${district}`);
            logResourceChange('thugs', null, oldThugs, oldThugs + thugsFound, `scout_${district}`);
            
            gameState.player.cash += moneyEarned;
            
            // Add hoes to appropriate categories
            if (!gameState.resources.hoeDetails) {
                gameState.resources.hoeDetails = {
                    streetWorkers: 0, sugarBabies: 0, highEndEscorts: 0, onlyTrampsModels: 0
                };
            }
            
            // Assign hoes to appropriate categories based on all 5 districts
            if (district === 'uptown') {
                gameState.resources.hoeDetails.highEndEscorts += hoesFound;
            } else if (district === 'midtown') {
                gameState.resources.hoeDetails.sugarBabies += hoesFound;
            } else if (district === 'financial') {
                // Financial District gets mix of high-end and sugar babies (Wall Street clients)
                const highEnd = Math.ceil(hoesFound * 0.6);
                const sugar = hoesFound - highEnd;
                gameState.resources.hoeDetails.highEndEscorts += highEnd;
                gameState.resources.hoeDetails.sugarBabies += sugar;
            } else if (district === 'docks') {
                // Harbor Docks gets mix of street workers and sugar babies (sailors/dock workers)
                const street = Math.ceil(hoesFound * 0.7);
                const sugar = hoesFound - street;
                gameState.resources.hoeDetails.streetWorkers += street;
                gameState.resources.hoeDetails.sugarBabies += sugar;
            } else {
                // Crooklyn gets mostly street workers (Brooklyn hustle)
                gameState.resources.hoeDetails.streetWorkers += hoesFound;
            }
            
            // Update total hoe count
            gameState.resources.hoes = Object.values(gameState.resources.hoeDetails).reduce((a, b) => a + b, 0);
            
            // Create crew members for new thugs
            for (let i = 0; i < thugsFound; i++) {
                gameState.crew.thugs.push(createThug());
            }
            syncThugCount('scout_recruitment');
            
            // FORCE show the results modal after a brief delay
            setTimeout(() => {
                const modal = `
                    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" style="display: flex !important;">
                        <div class="game-panel rounded-lg p-6 max-w-md w-full">
                            <h3 class="text-xl font-bold cyan-glow mb-4">üîç SCOUT RESULTS</h3>
                            
                            <div class="mb-4 p-4 bg-green-900/30 rounded border border-green-500/50">
                                <h4 class="font-bold text-green-400 mb-3">‚úÖ Scout Complete!</h4>
                                <p class="text-sm text-gray-300 mb-2">üìç Location: <span class="cyan-glow">${districtName}</span></p>
                                <p class="text-sm text-gray-300 mb-3">‚ö° Turns Used: <span class="text-yellow-400 font-bold">${turnsToUse}</span></p>
                                
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-pink-400">üë• Hoes Found:</span>
                                        <span class="text-white font-bold text-lg">+${hoesFound}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-blue-400">üí™ Thugs Found:</span>
                                        <span class="text-white font-bold text-lg">+${thugsFound}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-yellow-400">üí∞ Money Earned:</span>
                                        <span class="gold-text font-bold text-lg">+$${moneyEarned.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                            
                            ${nftDrop ? `
                                <div class="mb-4 p-4 bg-gradient-to-r from-purple-900/70 to-pink-900/70 rounded border-2 border-purple-400 animate-pulse">
                                    <h4 class="font-bold text-purple-300 mb-2 text-center">üéä NFT DISCOVERED! üéä</h4>
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-3xl">üíé</span>
                                        <div class="flex-1">
                                            <p class="font-bold text-white text-lg">${nftDrop.name}</p>
                                            <p class="text-sm text-purple-300 capitalize">${nftDrop.rarity} ${nftDrop.type} NFT</p>
                                            <p class="text-xs text-gray-300 mt-1">${nftDrop.description}</p>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-xs text-purple-200 bg-purple-800/50 px-3 py-1 rounded-full inline-block">
                                            üîÆ Added to your NFT collection!
                                        </p>
                                    </div>
                                </div>
                            ` : `
                                <div class="mb-4 p-3 bg-gray-800/50 rounded border border-gray-600">
                                    <h4 class="font-bold text-gray-400 mb-2">üíé NFT Search Results</h4>
                                    <p class="text-sm text-gray-400 mb-1">NFT Chance: <span class="text-purple-400">${(nftChance * 100).toFixed(1)}%</span></p>
                                    <p class="text-xs text-gray-500">No NFT found this time - try more turns for better odds!</p>
                                </div>
                            `}
                            
                            <div class="text-xs text-gray-400 mb-4 text-center">
                                üí° ${district === 'uptown' ? 'Premium Manhattan quality hoes found!' : 
                                     district === 'crooklyn' ? 'Brooklyn hustle - high volume recruitment!' : 
                                     district === 'docks' ? 'Navy Yard connections made!' :
                                     district === 'financial' ? 'Wall Street corporate contacts established!' :
                                     'Balanced Midtown results!'}
                            </div>
                            
                            <button onclick="closeModal()" class="w-full py-3 action-btn rounded font-bold">
                                Continue Playing
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modal;
                console.log('‚úÖ Enhanced scout results modal displayed');
            }, 100);
            
            // Show notification and console messages
            const quickSummary = `üîç ${districtName}: +${hoesFound} hoes, +${thugsFound} thugs, +$${moneyEarned}${nftDrop ? ' + NFT!' : ''}`;
            showNotification(quickSummary, 'success');
            
            addConsoleMessage(`${districtName} scout (${turnsToUse} turns): +${hoesFound} hoes, +${thugsFound} thugs, +$${moneyEarned}`, 'green');
            addConsoleMessage(`üíé NFT chance: ${(nftChance * 100).toFixed(1)}% (${nftFound ? 'SUCCESS!' : 'no luck this time'})`, 'purple');
            
            if (nftDrop) {
                addConsoleMessage(`üåü NFT discovered: ${nftDrop.name} (${nftDrop.rarity} ${nftDrop.type})`, 'purple');
            }
            
            updateUI();
            updateTurnDisplay();
            saveGameState();
        }

        function executeCrackWithTurns() {
            const turnsToUse = parseInt(document.getElementById('crackTurnsInput').value) || 15;
            
            console.log('üíé Starting crack production with', turnsToUse, 'turns');
            
            if (!useTurns(turnsToUse)) {
                showNotification(`‚ùå Not enough turns! Need ${turnsToUse} turns`, 'error');
                return;
            }
            
            // Realistic crack production - thugs produce slowly
            const crackPerThugPerTurn = 0.8; // Each thug makes ~0.8 crack per turn
            const crackProduced = gameState.resources.thugs > 0 ? 
                Math.floor(gameState.resources.thugs * turnsToUse * crackPerThugPerTurn) + Math.floor(Math.random() * turnsToUse) : 
                Math.floor(turnsToUse * 0.1); // Minimal without thugs
                
            // Hoes earn money slowly but consistently  
            const moneyPerHoePerTurn = 8; // Each hoe earns ~$8 per turn
            const moneyEarned = gameState.resources.hoes > 0 ? 
                gameState.resources.hoes * turnsToUse * moneyPerHoePerTurn + Math.floor(Math.random() * turnsToUse * 5) :
                turnsToUse * 3; // Minimal base income
            
            console.log('üíé Crack results:', { thugs: gameState.resources.thugs, crackProduced, moneyEarned });
            
            // Update resources
            gameState.resources.crack += crackProduced;
            gameState.player.cash += moneyEarned;
            
            // Give thugs experience for working
            gameState.crew.thugs.forEach(thug => {
                thug.experience += turnsToUse * 2; // 2 XP per turn worked
            });
            
            // Check for promotions
            checkThugPromotions();
            
            // Calculate NFT chance for crack production (lower chance)
            const nftChance = calculateNFTChance(turnsToUse, 'crack');
            const nftFound = Math.random() < nftChance;
            
            let nftDrop = null;
            if (nftFound) {
                nftDrop = generateNFTDrop('Production Site');
                console.log('üåü Crack production NFT drop:', nftDrop);
            }
            
            // Show detailed results
            showActionResults({
                action: 'Crack Production',
                turnsUsed: turnsToUse,
                results: {
                    crack: crackProduced,
                    money: moneyEarned
                },
                nftChance: nftChance,
                nftDrop: nftDrop
            });
            
            addConsoleMessage(`Crack production (${turnsToUse} turns): +${crackProduced} rocks, +$${moneyEarned}`, 'green');
            
            updateUI();
            saveLocalGameState();
            closeModal();
        }

        // Ranking System
        // Load game state from localStorage
        function loadLocalGameState() {
            try {
                const saved = localStorage.getItem('pimpFunGameState');
                console.log('üì• LOAD DEBUG: localStorage data exists:', !!saved);
                
                if (saved) {
                    const savedState = JSON.parse(saved);
                    console.log('üì• LOAD DEBUG: Parsed saved state:', {
                        cash: savedState.player?.cash,
                        beer: savedState.resources?.beer,
                        condoms: savedState.resources?.condoms,
                        hoes: savedState.resources?.hoes,
                        thugs: savedState.resources?.thugs
                    });
                    
                    console.log('üì• Loading saved state:', {
                        cash: savedState.player?.cash,
                        hoes: savedState.resources?.hoes,
                        thugs: savedState.resources?.thugs,
                        weed: savedState.resources?.weed,
                        turnsWhenLastChecked: savedState.player?.turnsWhenLastChecked,
                        lastActionTime: savedState.player?.lastActionTime ? new Date(savedState.player.lastActionTime).toLocaleTimeString() : 'none'
                    });
                    
                    // Merge saved state with current state (preserve structure)
                    gameState.player = { ...gameState.player, ...savedState.player };
                    gameState.resources = { ...gameState.resources, ...savedState.resources };
                    gameState.supplies = { ...gameState.supplies, ...savedState.supplies };
                    gameState.crew = { ...gameState.crew, ...savedState.crew };
                    
                    // Ensure critical values have defaults
                    if (typeof gameState.player.turnsWhenLastChecked !== 'number') gameState.player.turnsWhenLastChecked = 150;
                    if (typeof gameState.player.lastActionTime !== 'number') gameState.player.lastActionTime = Date.now();
                    if (typeof gameState.player.regenRate !== 'number') gameState.player.regenRate = 0.2;
                    if (typeof gameState.resources.weed !== 'number') gameState.resources.weed = 0;
                    if (!Array.isArray(gameState.crew.thugs)) gameState.crew.thugs = [];
                    if (!gameState.player.district || (!DISTRICTS[gameState.player.district] && !DISTRICTS[getDistrictKey(gameState.player.district)])) {
                        gameState.player.district = null;
                    }
                    
                    // Sync thugs: If simple count exists but crew array is empty, create crew members
                    const simpleThugCount = gameState.resources.thugs || 0;
                    if (simpleThugCount > 0 && gameState.crew.thugs.length === 0) {
                        console.log(`üîß Creating ${simpleThugCount} crew members from simple thug count`);
                        for (let i = 0; i < simpleThugCount; i++) {
                            gameState.crew.thugs.push(createThug());
                        }
                        addConsoleMessage(`üë• Converted ${simpleThugCount} thugs to detailed crew members`, 'cyan');
                    }
                    
                                            // Fix existing thugs without proper structure
                        if (gameState.crew.thugs && Array.isArray(gameState.crew.thugs)) {
                            console.log('üîß Fixing existing thugs, count:', gameState.crew.thugs.length);
                            gameState.crew.thugs = gameState.crew.thugs.map((thug, index) => {
                                const originalRank = thug.rank;
                                if (!thug.name) thug.name = generateThugName('rookie');
                                if (!thug.rank || thug.rank === 'soldier') thug.rank = 'rookie'; // Force reset soldiers back to rookie
                                if (!thug.experience) thug.experience = 0;
                                if (!thug.loyalty) thug.loyalty = 70;
                                if (!thug.id) thug.id = Date.now() + Math.random() + index;
                                if (!thug.hiredDate) thug.hiredDate = Date.now();
                                
                                if (originalRank !== thug.rank) {
                                    console.log(`üîß Fixed thug ${index}: ${originalRank} ‚Üí ${thug.rank}`);
                                }
                                return thug;
                            });
                        
                        // Update simple count to match crew array
                        gameState.resources.thugs = gameState.crew.thugs.length;
                        console.log(`üîß Synced thug counts: simple=${gameState.resources.thugs}, crew=${gameState.crew.thugs.length}`);
                    }
                    
                    // Update turns based on time passed since last save
                    const now = Date.now();
                    const timeSinceLastAction = now - gameState.player.lastActionTime;
                    const minutesPassed = timeSinceLastAction / 60000;
                    
                    console.log(`‚è∞ Time calculation: ${minutesPassed.toFixed(1)} minutes since last action`);
                    console.log(`‚è∞ Saved turns: ${gameState.player.turnsWhenLastChecked}, Max: ${gameState.player.maxTurns}`);
                    
                    if (minutesPassed > 5) { // Only update if significant time passed
                        const turnsToAdd = minutesPassed * gameState.player.regenRate;
                        const newTurnCount = Math.min(gameState.player.turnsWhenLastChecked + turnsToAdd, gameState.player.maxTurns);
                        
                        console.log(`‚è∞ Adding ${turnsToAdd.toFixed(1)} turns, new total: ${newTurnCount.toFixed(0)}`);
                        
                        gameState.player.turnsWhenLastChecked = Math.floor(newTurnCount);
                        gameState.player.lastActionTime = now;
                        
                        addConsoleMessage(`‚è∞ ${minutesPassed.toFixed(0)} minutes offline - gained ${Math.floor(turnsToAdd)} turns!`, 'cyan');
                    } else {
                        console.log(`‚è∞ No turn update needed (only ${minutesPassed.toFixed(1)} minutes)`);
                    }
                    
                    addConsoleMessage('üì• Profile loaded from local storage!', 'green');
                    addConsoleMessage(`Welcome back, ${gameState.player.username}!`, 'gold');
                } else {
                    addConsoleMessage('üÜï New player - welcome to Empire City!', 'cyan');
                    
                    // Initialize fresh player with proper defaults
                    initializeFreshGameState();
                    addConsoleMessage(`üÜï Fresh game initialized with ${TURN_MECHANICS.startingTurns} turns`, 'green');
                }
            } catch (error) {
                console.error('Error loading saved state:', error);
                addConsoleMessage('‚ö†Ô∏è Could not load saved profile', 'yellow');
            }
        }

        // Save game state to localStorage
        // Supabase save system with localStorage fallback
        async function saveGameState() {
            const dataToSave = {
                player: gameState.player,
                resources: gameState.resources,
                supplies: gameState.supplies,
                crew: gameState.crew
            };
            
            // Deep validation to prevent [object Object] JSON errors
            function validateAndCleanObject(obj, path = '') {
                if (obj === null || obj === undefined) return obj;
                
                if (typeof obj === 'object' && !Array.isArray(obj)) {
                    const cleaned = {};
                    for (const [key, value] of Object.entries(obj)) {
                        const fullPath = path ? `${path}.${key}` : key;
                        
                        if (value === null || value === undefined) {
                            cleaned[key] = value;
                        } else if (typeof value === 'number') {
                            if (isNaN(value) || !isFinite(value)) {
                                console.warn(`üîß Fixing corrupted number at ${fullPath}:`, value);
                                cleaned[key] = 0;
                            } else {
                                cleaned[key] = value;
                            }
                        } else if (typeof value === 'string' || typeof value === 'boolean') {
                            cleaned[key] = value;
                        } else if (Array.isArray(value)) {
                            cleaned[key] = value.filter(item => item !== null && item !== undefined);
                        } else if (typeof value === 'object') {
                            cleaned[key] = validateAndCleanObject(value, fullPath);
                        } else {
                            console.warn(`üîß Removing invalid data type at ${fullPath}:`, typeof value, value);
                            cleaned[key] = null;
                        }
                    }
                    return cleaned;
                } else if (Array.isArray(obj)) {
                    return obj.filter(item => item !== null && item !== undefined);
                }
                
                return obj;
            }
            
            // Clean all data to prevent JSON corruption
            dataToSave.player = validateAndCleanObject(dataToSave.player, 'player');
            dataToSave.resources = validateAndCleanObject(dataToSave.resources, 'resources');
            dataToSave.supplies = validateAndCleanObject(dataToSave.supplies, 'supplies');
            dataToSave.crew = validateAndCleanObject(dataToSave.crew, 'crew');
            
            // Validate critical data types AND economic sanity
            if (typeof dataToSave.player.cash !== 'number' || isNaN(dataToSave.player.cash)) {
                console.error('üö® SAVE ABORTED: Corrupted cash value', dataToSave.player.cash);
                addConsoleMessage('üö® Save aborted - corrupted cash value', 'red');
                return false;
            }
            
            // ECONOMIC SANITY CHECKS
            if (dataToSave.player.cash > 100000000) { // $100M cap for beta
                console.error('üö® ECONOMIC EXPLOIT DETECTED: Cash over $100M', dataToSave.player.cash);
                addConsoleMessage(`üö® EXPLOIT DETECTED: Cash capped at $100M (was $${dataToSave.player.cash.toLocaleString()})`, 'red');
                dataToSave.player.cash = 100000000; // Cap at $100M
                gameState.player.cash = 100000000;
                
                // Log this as a major event
                logResourceChange('cash', null, dataToSave.player.cash, 100000000, 'exploit_prevention_cap');
            }
            
            if (dataToSave.resources.hoes > 1000) { // 1000 hoe cap for beta
                console.error('üö® EXPLOIT DETECTED: Hoes over 1000', dataToSave.resources.hoes);
                addConsoleMessage(`üö® EXPLOIT DETECTED: Hoes capped at 1000 (was ${dataToSave.resources.hoes})`, 'red');
                dataToSave.resources.hoes = 1000;
                gameState.resources.hoes = 1000;
            }
            
            if (dataToSave.resources.thugs > 500) { // 500 thug cap for beta
                console.error('üö® EXPLOIT DETECTED: Thugs over 500', dataToSave.resources.thugs);
                addConsoleMessage(`üö® EXPLOIT DETECTED: Thugs capped at 500 (was ${dataToSave.resources.thugs})`, 'red');
                dataToSave.resources.thugs = 500;
                gameState.resources.thugs = 500;
            }
            
            if (typeof dataToSave.resources.thugs !== 'number' || isNaN(dataToSave.resources.thugs)) {
                console.error('üö® SAVE ABORTED: Corrupted thugs value', dataToSave.resources.thugs);
                addConsoleMessage('üö® Save aborted - corrupted thugs value', 'red');
                return false;
            }
            
            // Validate weapons object
            if (!dataToSave.resources.weapons || typeof dataToSave.resources.weapons !== 'object') {
                console.error('üö® SAVE ABORTED: Corrupted weapons object', dataToSave.resources.weapons);
                addConsoleMessage('üö® Save aborted - corrupted weapons object', 'red');
                return false;
            }
            
            console.log('üíæ Saving validated game state:', {
                cash: dataToSave.player.cash,
                hoes: dataToSave.resources.hoes,
                thugs: dataToSave.resources.thugs,
                crewCount: dataToSave.crew.thugs?.length || 0,
                weapons: Object.values(dataToSave.resources.weapons).reduce((a, b) => a + b, 0),
                turnsWhenLastChecked: dataToSave.player.turnsWhenLastChecked
            });
            
            // Supabase-first approach with localStorage fallback
            if (window.SupabaseAPI && currentUser && isLoggedIn) {
                // Save to Supabase (shared database)
                try {
                    console.log('üåê Saving to shared database...');
                    
                    const playerData = {
                        username: gameState.player.username,
                        level: gameState.player.level,
                        cash: gameState.player.cash,
                        respect: gameState.player.respect,
                        heat: gameState.player.heat,
                        hoes: gameState.resources.hoes || 0,
                        thugs: gameState.resources.thugs || 0,
                        crack: gameState.resources.crack || 0,
                        weed: gameState.resources.weed || 0,
                        resources: JSON.stringify(gameState.resources),
                        supplies: JSON.stringify(gameState.supplies),
                        crew_data: JSON.stringify(gameState.crew),
                        turns_when_last_checked: gameState.player.turnsWhenLastChecked,
                        last_action_time: new Date(gameState.player.lastActionTime).toISOString()
                    };
                    
                    const result = await SupabaseAPI.updatePlayer(currentUser.id, playerData);
                    if (result && result.success) {
                        console.log('‚úÖ Saved to shared database!');
                        return true;
                    } else {
                        console.error('‚ùå Database save failed, using localStorage');
                localStorage.setItem('pimpFunGameState', JSON.stringify(dataToSave));
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå Database error, using localStorage:', error);
                    localStorage.setItem('pimpFunGameState', JSON.stringify(dataToSave));
                    return false;
                }
            } else {
                // Guest mode - localStorage only
                try {
                    localStorage.setItem('pimpFunGameState', JSON.stringify(dataToSave));
                    console.log('üíæ Guest mode: saved to browser storage');
                return true;
            } catch (error) {
                console.error('‚ùå Save failed:', error);
                return false;
                }
            }
            
            return true;
        }
        
        // Backwards compatibility - redirects to server save when authenticated
        function saveLocalGameState() {
            if (isLoggedIn && currentUser) {
                console.log('üåê Redirecting local save to server save');
                return saveGameState(); // Server save when authenticated
            } else {
                console.log('üö® Not authenticated - no save capability');
                addConsoleMessage('üö® Sign in to save progress!', 'red');
                return false;
            }
        }

        function calculateRank() {
            // Calculate net worth for ranking
            const netWorth = gameState.player.cash + 
                            (gameState.resources.hoes * 2000) +
                            (gameState.resources.thugs * 750) +
                            (gameState.resources.crack * 3) +
                            (gameState.resources.condoms * 0.10) +
                            (gameState.resources.medicine * 5) +
                            (gameState.resources.beer * 0.75);
            
            // Simple ranking based on net worth (will be real when multiplayer)
            let rank = 'Unranked';
            if (netWorth >= 1000000) rank = 'Kingpin';
            else if (netWorth >= 500000) rank = 'Boss';
            else if (netWorth >= 100000) rank = 'Lieutenant'; 
            else if (netWorth >= 50000) rank = 'Soldier';
            else if (netWorth >= 25000) rank = 'Hustler';
            else if (netWorth >= 15000) rank = 'Runner';
            
            gameState.player.rank = rank;
            
            // Mock local/national ranks (will be real when multiplayer)
            gameState.player.localRank = Math.floor(Math.random() * 50) + 1;
            gameState.player.nationalRank = Math.floor(Math.random() * 500) + 1;
        }

        async function connectWallet(walletName) {
            try {
                if (!walletManager) {
                    walletManager = new SolanaWalletManager();
                }
                
                addConsoleMessage(`üîó Connecting to ${walletName}...`, 'cyan');
                
                // Use the wallet manager to connect
                let result;
                if (walletName === 'Phantom') {
                    result = await walletManager.connectPhantom();
                } else if (walletName === 'Solflare') {
                    result = await walletManager.connectSolflare();
                } else if (walletName === 'Backpack') {
                    result = await walletManager.connectBackpack();
                } else {
                    throw new Error(`${walletName} not supported yet`);
                }
                
                if (result.success) {
                    walletAddress = result.walletAddress;
                    
                    // Update UI
                    const walletIcon = walletName === 'Phantom' ? 'üëª' : 
                                     walletName === 'Solflare' ? 'üî•' : 'üéí';
                    document.getElementById('walletStatus').textContent = 
                        `${walletIcon} ${walletAddress.slice(0, 4)}...${walletAddress.slice(-4)}`;
                    document.getElementById('connectWallet').classList.add('bg-green-600');
                    
                    addConsoleMessage(`‚úÖ ${walletName} connected: ${walletAddress.slice(0, 8)}...`, 'green');
                    
                    // Save wallet type for auto-reconnect
                    localStorage.setItem('connectedWalletType', walletName);
                    
                    closeModal();
                    
                    // Load or create player profile with wallet address
                    await loadPlayerProfileWithWallet(walletAddress);
                    
                    return walletAddress;
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Wallet connection error:', error);
                addConsoleMessage(`‚ùå Failed to connect ${walletName}`, 'red');
                
                if (error.message.includes('rejected') || error.message.includes('User rejected')) {
                    addConsoleMessage('User rejected wallet connection', 'yellow');
                } else if (error.message.includes('not found')) {
                    addConsoleMessage(`${walletName} extension not found - please install it first`, 'yellow');
                } else {
                    addConsoleMessage('Connection error: ' + error.message, 'red');
                }
            }
        }

        function installWallet(installUrl) {
            window.open(installUrl, '_blank');
            closeModal();
        }

        function playOffline() {
            addConsoleMessage('üì± Playing in offline mode - progress will not be saved', 'yellow');
            closeModal();
        }

        // Direct Phantom connection (simple and reliable)
        async function directConnectPhantom() {
            try {
                addConsoleMessage('üëª Connecting directly to Phantom...', 'cyan');
                
                // Direct connection - no complex detection
                if (!window.solana) {
                    alert('Phantom wallet not found!\n\nPlease:\n1. Install Phantom from phantom.app\n2. Refresh this page\n3. Make sure Phantom is unlocked');
                    window.open('https://phantom.app/', '_blank');
                    return;
                }
                
                console.log('Found window.solana:', window.solana);
                
                // Simple connect
                const response = await window.solana.connect();
                walletAddress = response.publicKey.toString();
                
                // Update UI
                document.getElementById('walletStatus').textContent = 
                    `üëª ${walletAddress.slice(0, 4)}...${walletAddress.slice(-4)}`;
                document.getElementById('connectWallet').classList.add('bg-green-600');
                
                addConsoleMessage(`‚úÖ Phantom connected: ${walletAddress.slice(0, 8)}...`, 'green');
                
                // Save wallet type
                localStorage.setItem('connectedWalletType', 'Phantom');
                
                closeModal();
                
                // Load player profile
                await loadPlayerProfileWithWallet(walletAddress);
                
                return walletAddress;
            } catch (error) {
                console.error('Direct connect error:', error);
                addConsoleMessage('‚ùå Connection failed: ' + error.message, 'red');
                
                if (error.code === 4001) {
                    addConsoleMessage('User rejected connection', 'yellow');
                } else {
                    alert(`Connection failed: ${error.message}\n\nTroubleshooting:\n1. Make sure Phantom is installed and unlocked\n2. Refresh the page\n3. Try again`);
                }
            }
        }

        function debugWallets() {
            const debug = {
                'window.solana': !!window.solana,
                'window.solana.isPhantom': window.solana?.isPhantom,
                'window.phantom': !!window.phantom,
                'window.phantom.solana': !!window.phantom?.solana,
                'window.solflare': !!window.solflare,
                'window.backpack': !!window.backpack,
                'userAgent': navigator.userAgent,
                'availableWallets': availableWallets.length
            };
            
            console.log('üîß Wallet Debug Info:', debug);
            
            alert(`Wallet Debug Info:
            
üîç Detection Results:
‚Ä¢ window.solana: ${debug['window.solana'] ? '‚úÖ' : '‚ùå'}
‚Ä¢ window.solana.isPhantom: ${debug['window.solana.isPhantom'] ? '‚úÖ' : '‚ùå'}
‚Ä¢ window.phantom: ${debug['window.phantom'] ? '‚úÖ' : '‚ùå'}
‚Ä¢ Available wallets: ${debug.availableWallets}

üí° If Phantom shows as not detected but you have it installed:
1. Refresh the page
2. Make sure Phantom is unlocked
3. Try clicking "Phantom" anyway - sometimes it works despite detection issues`);
        }

        // Try to auto-connect wallet if user was previously connected
        async function tryAutoConnectWallet() {
            const savedWalletType = localStorage.getItem('connectedWalletType');
            if (!savedWalletType) {
                addConsoleMessage('üí° Connect a wallet to save your progress permanently', 'cyan');
                return;
            }
            
            try {
                if (!walletManager) {
                    walletManager = new SolanaWalletManager();
                }
                
                addConsoleMessage(`üîÑ Checking for ${savedWalletType} connection...`, 'cyan');
                
                const autoConnectResult = await walletManager.autoConnect();
                
                if (autoConnectResult.success) {
                    walletAddress = autoConnectResult.walletAddress;
                    
                    // Update UI
                    const walletIcon = savedWalletType === 'Phantom' ? 'üëª' : 
                                     savedWalletType === 'Solflare' ? 'üî•' : 'üéí';
                    document.getElementById('walletStatus').textContent = 
                        `${walletIcon} ${walletAddress.slice(0, 4)}...${walletAddress.slice(-4)}`;
                    document.getElementById('connectWallet').classList.add('bg-green-600');
                    
                    addConsoleMessage(`üîÑ Auto-connected to ${savedWalletType}`, 'green');
                    
                    // Load player profile
                    await loadPlayerProfileWithWallet(walletAddress);
                } else {
                    addConsoleMessage(`üí° ${savedWalletType} available - click to reconnect`, 'cyan');
                }
            } catch (error) {
                console.error('Auto-connect error:', error);
                localStorage.removeItem('connectedWalletType');
                addConsoleMessage('Auto-connect failed - please reconnect manually', 'yellow');
            }
        }

        // Load player profile with wallet authentication
        async function loadPlayerProfileWithWallet(walletAddr) {
            if (!window.SupabaseAPI) {
                addConsoleMessage('Database not connected - using demo mode', 'yellow');
                return;
            }
            
            try {
                // Search for existing player by wallet address
                const { data: existingPlayers } = await window.supabaseClient
                    .from('players')
                    .select('*')
                    .eq('wallet_address', walletAddr);
                
                let player = existingPlayers?.[0];
                
                if (!player) {
                    // Create new player with wallet address
                    player = await SupabaseAPI.createPlayer({
                        walletAddress: walletAddr,
                        username: `Pimp_${walletAddr.slice(-6)}`, // Default name
                        bio: '',
                        level: gameState.player.level,
                        cash: gameState.player.cash,
                        respect: gameState.player.respect,
                        heat: gameState.player.heat
                    });
                    
                    if (player) {
                        addConsoleMessage('üÜï New player profile created with wallet!', 'green');
                        addConsoleMessage('Click your name to customize your pimp profile', 'cyan');
                    }
                } else {
                    // Load existing player data
                    gameState.player.id = player.id;
                    gameState.player.username = player.username;
                    gameState.player.bio = player.bio || '';
                    gameState.player.level = player.level;
                    gameState.player.cash = player.cash;
                    gameState.player.respect = player.respect;
                    gameState.player.heat = player.heat;
                    gameState.player.crewId = player.crew_id;
                    
                    // Load resources
                    gameState.resources.hoes = player.hoes;
                    gameState.resources.thugs = player.thugs;
                    gameState.resources.crack = player.crack;
                    gameState.resources.weed = parseFloat(player.weed || 0);
                    gameState.resources.beer = player.beer;
                    gameState.resources.condoms = player.condoms;
                    gameState.resources.medicine = player.medicine;
                    
                    // Load weapons
                    gameState.resources.weapons.pistols = player.pistols;
                    gameState.resources.weapons.shotguns = player.shotguns;
                    gameState.resources.weapons.tek9s = player.tek9s;
                    gameState.resources.weapons.ak47s = player.ak47s;
                    
                    addConsoleMessage('üì• Player profile loaded from blockchain!', 'green');
                    addConsoleMessage(`Welcome back, ${player.username}!`, 'gold');
                }
                
                if (player) {
                    gameState.player.id = player.id;
                    gameState.player.isOnline = true;
                    
                    // Update UI with loaded data
                    updateUI();
                    updatePlayerProfile();
                }
                
            } catch (error) {
                console.error('Error loading wallet player profile:', error);
                addConsoleMessage('‚ö†Ô∏è Could not load profile from server', 'yellow');
            }
        }

        // Update save profile to include wallet address
        async function saveProfileWithWallet() {
            if (!walletAddress || !gameState.player.id) {
                addConsoleMessage('Please connect your Phantom wallet first', 'red');
                return false;
            }

            const newUsername = document.getElementById('editUsername').value.trim();
            const newBio = document.getElementById('editBio').value.trim();
            
            // Validate username
            if (!newUsername || newUsername.length < 3) {
                alert('Pimp name must be at least 3 characters!');
                return false;
            }
            
            try {
                // Check if username is already taken (by someone else)
                const { data: existingUsers } = await window.supabaseClient
                    .from('players')
                    .select('id, username')
                    .eq('username', newUsername)
                    .neq('id', gameState.player.id);
                
                if (existingUsers && existingUsers.length > 0) {
                    alert('That pimp name is already taken! Choose another.');
                    return false;
                }
                
                // Check if name change costs money (not first time from default)
                const isDefaultName = gameState.player.username.startsWith('Pimp_');
                if (!isDefaultName && newUsername !== gameState.player.username) {
                    if (gameState.player.cash < 5000) {
                        alert('Need $5,000 to change your name!');
                        return false;
                    }
                    gameState.player.cash -= 5000;
                    addConsoleMessage('Paid $5,000 for name change', 'gold');
                }
                
                // Save to Supabase
                const updates = {
                    username: newUsername,
                    bio: newBio,
                    cash: gameState.player.cash,
                    // Save all current game state
                    level: gameState.player.level,
                    exp: gameState.player.exp,
                    respect: gameState.player.respect,
                    heat: gameState.player.heat,
                    hoes: gameState.resources.hoes,
                    thugs: gameState.resources.thugs,
                    crack: gameState.resources.crack,
                    weed: gameState.resources.weed,
                    beer: gameState.resources.beer,
                    condoms: gameState.resources.condoms,
                    medicine: gameState.resources.medicine,
                    pistols: gameState.resources.weapons.pistols,
                    shotguns: gameState.resources.weapons.shotguns,
                    tek9s: gameState.resources.weapons.tek9s,
                    ak47s: gameState.resources.weapons.ak47s
                };
                
                const result = await SupabaseAPI.updatePlayer(gameState.player.id, updates);
                if (result) {
                    gameState.player.username = newUsername;
                    gameState.player.bio = newBio;
                    
                    addConsoleMessage('‚úÖ Profile synced to blockchain!', 'green');
                    return true;
                } else {
                    addConsoleMessage('‚ùå Failed to sync profile', 'red');
                    return false;
                }
                
            } catch (error) {
                console.error('Profile save error:', error);
                addConsoleMessage('‚ùå Profile sync failed: ' + error.message, 'red');
                return false;
            }
        }

        // Auth button event
        document.getElementById('authButton').addEventListener('click', () => {
            if (isLoggedIn) {
                // Show logout option
                if (confirm('Sign out of your account?')) {
                    signOut();
                }
            } else {
                showEmailAuth();
            }
        });

        // Sign out function
        async function signOut() {
            try {
                const { error } = await window.supabaseClient.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                isLoggedIn = false;
                
                // Reset UI
                document.getElementById('authStatus').textContent = 'Sign In';
                document.getElementById('authButton').classList.remove('bg-green-600');
                
                // Show auth landing
                document.getElementById('authLanding').classList.remove('hidden');
                document.getElementById('gameContent').classList.add('hidden');
                
                addConsoleMessage('üëã Signed out successfully', 'cyan');
                
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Sign out failed: ' + error.message);
            }
                 }
        
        // ECONOMIC DASHBOARD - Enhanced with mobile optimization and error handling
        function showEconomicDashboard() {
            console.log('üìä Opening Economic Dashboard...');
            
            try {
                // Defensive programming - ensure all required data exists
                if (!gameState || !gameState.resources || !gameState.player) {
                    console.error('‚ùå Invalid gameState for Economic Dashboard');
                    showNotification('‚ùå Cannot load Economic Dashboard - game data missing', 'error');
                    return;
                }
                
                // Calculate income sources with safe defaults
                const hoeDetails = gameState.resources.hoeDetails || {};
                const payoutPercentage = gameState.player.payoutPercentage || 30;
                const payoutMultiplier = (100 - payoutPercentage) / 100;
                
                const dailyIncomeBreakdown = [
                    {
                        type: 'Street Workers',
                        count: hoeDetails.streetWorkers || 0,
                        baseDaily: 180,
                        pimpDaily: Math.floor(180 * payoutMultiplier),
                        total: (hoeDetails.streetWorkers || 0) * Math.floor(180 * payoutMultiplier)
                    },
                    {
                        type: 'Sugar Babies', 
                        count: hoeDetails.sugarBabies || 0,
                        baseDaily: 240,
                        pimpDaily: Math.floor(240 * payoutMultiplier),
                        total: (hoeDetails.sugarBabies || 0) * Math.floor(240 * payoutMultiplier)
                    },
                    {
                        type: 'High-End Escorts',
                        count: hoeDetails.highEndEscorts || 0,
                        baseDaily: 350,
                        pimpDaily: Math.floor(350 * payoutMultiplier),
                        total: (hoeDetails.highEndEscorts || 0) * Math.floor(350 * payoutMultiplier)
                    },
                    {
                        type: 'OnlyTramps Models',
                        count: hoeDetails.onlyTrampsModels || 0,
                        baseDaily: 1260,
                        pimpDaily: Math.floor(1260 * payoutMultiplier),
                        total: (hoeDetails.onlyTrampsModels || 0) * Math.floor(1260 * payoutMultiplier)
                    }
                ];
                
                const totalDailyIncome = dailyIncomeBreakdown.reduce((sum, source) => sum + source.total, 0);
                
                // Calculate expenses with safe defaults
                const thugs = (gameState.crew && gameState.crew.thugs) ? gameState.crew.thugs : [];
                const defaultRookieSalary = 250; // Fallback if THUG_RANKS is unavailable
                const weeklyPayroll = thugs.reduce((total, thug) => {
                    let rank = null;
                    if (THUG_RANKS && THUG_RANKS[thug.rank]) {
                        rank = THUG_RANKS[thug.rank];
                    } else if (THUG_RANKS && THUG_RANKS.rookie) {
                        rank = THUG_RANKS.rookie;
                    } else {
                        // Ultimate fallback if THUG_RANKS is completely unavailable
                        rank = { salary: defaultRookieSalary };
                    }
                    return total + (rank.salary || defaultRookieSalary);
                }, 0);
                const dailyPayroll = weeklyPayroll / 7;
                
                // Safe access to supplies data
                const supplies = gameState.supplies || {};
                const hoeHappiness = supplies.hoeHappiness || 70;
                const playerHeat = gameState.player.heat || 0;
                
                const modal = `
                    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                        <div class="game-panel rounded-lg p-4 sm:p-6 max-w-lg w-full my-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg sm:text-xl font-bold cyan-glow">üìä ECONOMIC DASHBOARD</h3>
                                <button type="button" onclick="closeModal()" 
                                        class="text-red-400 hover:text-red-300 text-2xl font-bold min-w-[44px] min-h-[44px] flex items-center justify-center"
                                        aria-label="Close Economic Dashboard">&times;</button>
                            </div>
                            
                            <!-- Daily Income Summary -->
                            <div class="mb-4 p-3 sm:p-4 bg-green-900/30 rounded border border-green-500/50">
                                <h4 class="font-bold text-green-400 mb-2 text-sm sm:text-base">üí∞ Daily Income</h4>
                                <div class="text-center mb-3">
                                    <div class="text-xl sm:text-2xl font-bold gold-text">$${totalDailyIncome.toLocaleString()}</div>
                                    <div class="text-xs sm:text-sm text-gray-400">Per day from all sources</div>
                                </div>
                            </div>
                            
                            <!-- Income Breakdown -->
                            <div class="mb-4 p-3 bg-gray-800/50 rounded">
                                <h5 class="font-bold text-white mb-2 text-sm">üìã Income Sources:</h5>
                                <div class="space-y-1 text-xs">
                                    ${dailyIncomeBreakdown.filter(source => source.count > 0).map(source => `
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-300">${source.count} ${source.type}</span>
                                            <span class="text-green-400">$${source.total.toLocaleString()}/day</span>
                                        </div>
                                    `).join('')}
                                    ${dailyIncomeBreakdown.filter(source => source.count > 0).length === 0 ? 
                                        '<div class="text-gray-400">No income sources - scout for hoes!</div>' : ''}
                                </div>
                            </div>
                            
                            <!-- Expenses -->
                            <div class="mb-4 p-3 bg-red-900/30 rounded border border-red-500/50">
                                <h5 class="font-bold text-red-400 mb-2 text-sm">üí∏ Daily Expenses:</h5>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-300">Thug Payroll (${thugs.length} thugs)</span>
                                        <span class="text-red-400">$${dailyPayroll.toFixed(0)}/day</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-300">Supply Costs (beer, condoms)</span>
                                        <span class="text-red-400">~$50/day</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Net Profit -->
                            <div class="mb-4 p-3 bg-blue-900/30 rounded">
                                <h5 class="font-bold text-blue-400 mb-2 text-sm">üìà Net Daily Profit:</h5>
                                <div class="text-center">
                                    <div class="text-lg sm:text-xl font-bold ${totalDailyIncome - dailyPayroll > 0 ? 'text-green-400' : 'text-red-400'}">
                                        $${(totalDailyIncome - dailyPayroll - 50).toFixed(0)}
                                    </div>
                                    <div class="text-xs text-gray-400">After payroll and supplies</div>
                                </div>
                            </div>
                            
                            <!-- Economic Advice -->
                            <div class="p-3 bg-yellow-900/30 rounded mb-4">
                                <h5 class="font-bold text-yellow-400 mb-2 text-sm">üí° Economic Advice:</h5>
                                <div class="text-xs text-gray-300 space-y-1">
                                    ${totalDailyIncome === 0 ? '<div>üîç Scout for hoes to start earning daily income!</div>' : ''}
                                    ${totalDailyIncome > 0 && totalDailyIncome < dailyPayroll ? '<div>‚ö†Ô∏è Income lower than payroll - recruit more hoes or reduce crew!</div>' : ''}
                                    ${payoutPercentage > 40 ? '<div>üí° Consider lowering payout % for more income</div>' : ''}
                                    ${hoeHappiness < 70 ? '<div>üòû Improve hoe happiness for better earnings</div>' : ''}
                                    ${playerHeat > 50 ? '<div>üöî High heat reduces earnings - manage heat levels</div>' : ''}
                                    ${totalDailyIncome > 1000 ? '<div>üí∞ Great income! Consider expanding to new districts</div>' : ''}
                                </div>
                            </div>
                            
                            <button type="button" onclick="closeModal()" 
                                    class="w-full py-3 bg-gray-700 hover:bg-gray-600 rounded font-bold transition-colors min-h-[44px]"
                                    aria-label="Close Economic Dashboard">
                                Close Dashboard
                            </button>
                        </div>
                    </div>
                `;
                
                const modalContainer = document.getElementById('modalContainer');
                if (!modalContainer) {
                    console.error('‚ùå Modal container not found');
                    showNotification('‚ùå Cannot display Economic Dashboard - modal container missing', 'error');
                    return;
                }
                
                modalContainer.innerHTML = modal;
                console.log('‚úÖ Economic Dashboard opened successfully');
                
                // Add keyboard accessibility
                setTimeout(() => {
                    const closeButton = modalContainer.querySelector('button[onclick="closeModal()"]');
                    if (closeButton) {
                        closeButton.focus();
                    }
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Error opening Economic Dashboard:', error);
                showNotification('‚ùå Failed to load Economic Dashboard', 'error');
            }
        }
        
        // Test daily payout function
        function testDailyPayout() {
            console.log('üß™ TESTING DAILY PAYOUT SYSTEM...');
            
            // Force set last payout to yesterday to trigger payout
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            gameState.player.lastDailyPayoutDate = yesterday.toDateString();
            
            addConsoleMessage('üß™ Set last payout to yesterday - triggering payout...', 'cyan');
            
            // Force process the payout
            processDailyPayout();
            
            updateUI();
        }
        
        // COMPREHENSIVE DATA LOSS INVESTIGATION (Blockchain-Aware)
        function investigateDataLoss() {
            console.log('üîç INVESTIGATING DATA LOSS...');
            console.log('================================');
            console.log('üìã NOTE: This tracking system prepares for Solana blockchain migration');
            console.log('üîÆ FUTURE: All changes will be immutable blockchain transactions');
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold red-glow">üîç DATA LOSS INVESTIGATION</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Current State -->
                            <div class="p-4 bg-gray-800/50 rounded">
                                <h4 class="font-bold text-white mb-2">üìä Current State</h4>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div>Cash: <span class="gold-text">$${gameState.player.cash.toLocaleString()}</span></div>
                                    <div>Level: <span class="text-white">${gameState.player.level}</span></div>
                                    <div>Hoes: <span class="text-pink-400">${gameState.resources.hoes}</span></div>
                                    <div>Thugs: <span class="text-blue-400">${gameState.resources.thugs}</span></div>
                                    <div>Crew Array: <span class="text-blue-400">${gameState.crew?.thugs?.length || 0}</span></div>
                                    <div>Crack: <span class="text-purple-400">${gameState.resources.crack}</span></div>
                                    <div>Weapons: <span class="text-red-400">${Object.values(gameState.resources.weapons || {}).reduce((a, b) => a + b, 0)}</span></div>
                                    <div>Vehicles: <span class="text-cyan-400">${Object.values(gameState.resources.vehicles || {}).reduce((a, b) => a + b, 0)}</span></div>
                                </div>
                            </div>
                            
                            <!-- Recent Changes -->
                            <div class="p-4 bg-red-900/30 rounded border border-red-500/50">
                                <h4 class="font-bold text-red-400 mb-2">üìâ Recent Resource Changes</h4>
                                <div class="text-xs space-y-1 max-h-40 overflow-y-auto" id="recentChanges">
                                    ${dataChangeLog.slice(-15).reverse().map(change => `
                                        <div class="flex justify-between items-center ${change.difference < 0 ? 'text-red-400' : 'text-green-400'}">
                                            <span>${change.time}</span>
                                            <span>${change.type}${change.item ? '.' + change.item : ''}</span>
                                            <span>${change.oldValue} ‚Üí ${change.newValue}</span>
                                            <span class="text-gray-400">${change.reason}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${dataChangeLog.length === 0 ? '<p class="text-gray-400 text-sm">No resource changes logged yet</p>' : ''}
                            </div>
                            
                            <!-- Potential Issues -->
                            <div class="p-4 bg-yellow-900/30 rounded border border-yellow-500/50">
                                <h4 class="font-bold text-yellow-400 mb-2">‚ö†Ô∏è Current Beta Data Loss Sources</h4>
                                <div class="text-xs text-gray-300 space-y-1">
                                    <div>‚Ä¢ Combat defeats (max 3% loss per fight)</div>
                                    <div>‚Ä¢ Crew/resource desynchronization</div>
                                    <div>‚Ä¢ Save/load corruption during page refresh</div>
                                    <div>‚Ä¢ Emergency fix functions overwriting data</div>
                                    <div>‚Ä¢ syncThugCount() function discrepancies</div>
                                    <div>‚Ä¢ JSON parsing errors in Supabase data</div>
                                </div>
                            </div>
                            
                            <!-- Blockchain Future -->
                            <div class="p-4 bg-purple-900/30 rounded border border-purple-500/50">
                                <h4 class="font-bold text-purple-400 mb-2">‚õìÔ∏è Blockchain Future (Solana)</h4>
                                <div class="text-xs text-gray-300 space-y-1">
                                    <div>‚úÖ Immutable transaction history on-chain</div>
                                    <div>‚úÖ Cryptographic proof of all asset changes</div>
                                    <div>‚úÖ No data loss - assets exist on blockchain</div>
                                    <div>‚úÖ Transparent audit trail for all players</div>
                                    <div>‚úÖ Community verification of game mechanics</div>
                                    <div class="text-purple-400 mt-2">üîÆ Current tracking prepares for blockchain migration</div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="runFullDataAudit()" class="action-btn rounded py-2 text-sm">
                                    üîç Full Data Audit
                                </button>
                                <button onclick="exportDataChangeLog()" class="action-btn rounded py-2 text-sm">
                                    üìÑ Export Change Log
                                </button>
                                <button onclick="validateAllDataIntegrity()" class="action-btn rounded py-2 text-sm">
                                    üîß Fix Corruption
                                </button>
                                <button onclick="restoreFromBackup()" class="action-btn rounded py-2 text-sm" ${!lastKnownGoodState ? 'disabled' : ''}>
                                    üîÑ Restore Backup
                                </button>
                            </div>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-3 bg-gray-700 rounded font-bold mt-4">
                            Close Investigation
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
        }
        
        // Full data audit function
        function runFullDataAudit() {
            console.log('üîç RUNNING FULL DATA AUDIT...');
            console.log('===============================');
            
            // Check for suspicious patterns in the change log
            const significantLosses = dataChangeLog.filter(change => 
                change.difference < -10 && ['thugs', 'weapons', 'hoes'].includes(change.type)
            );
            
            if (significantLosses.length > 0) {
                console.log('üö® SIGNIFICANT LOSSES FOUND:', significantLosses);
                addConsoleMessage(`üö® Found ${significantLosses.length} significant losses in history`, 'red');
                
                significantLosses.forEach((loss, index) => {
                    console.log(`${index + 1}. ${loss.time}: Lost ${Math.abs(loss.difference)} ${loss.type} (${loss.reason})`);
                    addConsoleMessage(`üìâ ${loss.time}: Lost ${Math.abs(loss.difference)} ${loss.type} (${loss.reason})`, 'red');
                });
            } else {
                addConsoleMessage('‚úÖ No significant losses found in recent history', 'green');
            }
            
            // Check current data integrity
            const integrityPassed = validateAllDataIntegrity();
            if (integrityPassed) {
                addConsoleMessage('‚úÖ Current data integrity check passed', 'green');
            }
            
            // Show recommendations
            addConsoleMessage('üí° Audit complete - check console for detailed findings', 'cyan');
        }
        
        // Export change log for analysis
        function exportDataChangeLog() {
            const logData = {
                exportTime: new Date().toISOString(),
                gameState: {
                    cash: gameState.player.cash,
                    level: gameState.player.level,
                    hoes: gameState.resources.hoes,
                    thugs: gameState.resources.thugs,
                    weapons: gameState.resources.weapons,
                    vehicles: gameState.resources.vehicles
                },
                changeLog: dataChangeLog,
                lastBackup: lastKnownGoodState
            };
            
            // Convert to JSON and download
            const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pimp_fun_data_log_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addConsoleMessage('üìÑ Data change log exported to download', 'cyan');
        }
        
        // EMERGENCY ASSET RECOVERY SYSTEM
        function emergencyAssetRecovery() {
            console.log('üö® EMERGENCY ASSET RECOVERY INVESTIGATION...');
            console.log('===============================================');
            
            // Analyze recent significant losses
            const significantLosses = dataChangeLog.filter(change => 
                change.difference < -10 && ['thugs', 'weapons', 'hoes'].includes(change.type)
            );
            
            console.log('üö® SIGNIFICANT LOSSES FOUND:', significantLosses);
            
            // Calculate total losses by type
            const totalLosses = {
                thugs: 0,
                weapons: 0,
                hoes: 0,
                cash: 0
            };
            
            significantLosses.forEach(loss => {
                if (totalLosses[loss.type] !== undefined) {
                    totalLosses[loss.type] += Math.abs(loss.difference);
                }
            });
            
            console.log('üìä TOTAL LOSSES BY TYPE:', totalLosses);
            
            // Check for suspicious patterns
            const suspiciousPatterns = [];
            
            // Pattern 1: Mass losses from unknown sources
            const unknownLosses = significantLosses.filter(loss => 
                !loss.reason || loss.reason.includes('unknown') || loss.reason.includes('corruption')
            );
            if (unknownLosses.length > 0) {
                suspiciousPatterns.push(`${unknownLosses.length} unknown/corruption losses`);
            }
            
            // Pattern 2: Emergency fix overwrites
            const emergencyLosses = significantLosses.filter(loss => 
                loss.reason && loss.reason.includes('emergency')
            );
            if (emergencyLosses.length > 0) {
                suspiciousPatterns.push(`${emergencyLosses.length} emergency function losses`);
            }
            
            // Pattern 3: Combat losses (shouldn't be this high)
            const combatLosses = significantLosses.filter(loss => 
                loss.reason && loss.reason.includes('combat')
            );
            if (combatLosses.length > 5) {
                suspiciousPatterns.push(`${combatLosses.length} combat losses (too many)`);
            }
            
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold red-glow">üö® EMERGENCY ASSET RECOVERY</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        
                        <!-- Loss Summary -->
                        <div class="mb-4 p-4 bg-red-900/30 rounded border border-red-500/50">
                            <h4 class="font-bold text-red-400 mb-2">üìâ DETECTED LOSSES</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>Thugs Lost: <span class="text-red-400 font-bold">${totalLosses.thugs}</span></div>
                                <div>Weapons Lost: <span class="text-red-400 font-bold">${totalLosses.weapons}</span></div>
                                <div>Hoes Lost: <span class="text-red-400 font-bold">${totalLosses.hoes}</span></div>
                                <div>Cash Lost: <span class="text-red-400 font-bold">$${totalLosses.cash.toLocaleString()}</span></div>
                            </div>
                        </div>
                        
                        <!-- Suspicious Patterns -->
                        ${suspiciousPatterns.length > 0 ? `
                            <div class="mb-4 p-4 bg-yellow-900/30 rounded border border-yellow-500/50">
                                <h4 class="font-bold text-yellow-400 mb-2">‚ö†Ô∏è SUSPICIOUS PATTERNS</h4>
                                <div class="space-y-1 text-sm text-gray-300">
                                    ${suspiciousPatterns.map(pattern => `<div>‚Ä¢ ${pattern}</div>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Recent Loss Events -->
                        <div class="mb-4 p-4 bg-gray-800/50 rounded">
                            <h4 class="font-bold text-white mb-2">üìã Recent Loss Events</h4>
                            <div class="text-xs space-y-1 max-h-40 overflow-y-auto">
                                ${significantLosses.slice(-10).reverse().map(loss => `
                                    <div class="flex justify-between items-center text-red-400">
                                        <span>${loss.time}</span>
                                        <span>-${Math.abs(loss.difference)} ${loss.type}</span>
                                        <span class="text-gray-400">${loss.reason}</span>
                                    </div>
                                `).join('')}
                            </div>
                            ${significantLosses.length === 0 ? '<p class="text-gray-400 text-sm">No significant losses in recent history</p>' : ''}
                        </div>
                        
                        <!-- Recovery Options -->
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <button onclick="recoverLostAssets()" class="action-btn rounded py-2 text-sm">
                                üîÑ Recover Assets
                            </button>
                            <button onclick="preventFutureLosses()" class="action-btn rounded py-2 text-sm">
                                üõ°Ô∏è Lock Assets
                            </button>
                            <button onclick="exportLossReport()" class="action-btn rounded py-2 text-sm">
                                üìÑ Export Report
                            </button>
                            <button onclick="restoreFromBackup()" class="action-btn rounded py-2 text-sm" ${!lastKnownGoodState ? 'disabled' : ''}>
                                ‚è™ Restore Backup
                            </button>
                        </div>
                        
                        <div class="text-xs text-gray-400 text-center mb-4">
                            üîÆ Blockchain Future: On Solana, assets can't be lost - they exist permanently on-chain!
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-3 bg-gray-700 rounded font-bold">
                            Close Recovery
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
            
            // Also log to console for detailed analysis
            console.log('üìä LOSS ANALYSIS COMPLETE:');
            console.log('- Total significant loss events:', significantLosses.length);
            console.log('- Thugs lost:', totalLosses.thugs);
            console.log('- Weapons lost:', totalLosses.weapons);
            console.log('- Suspicious patterns:', suspiciousPatterns);
            
            addConsoleMessage(`üö® ASSET LOSS INVESTIGATION: ${totalLosses.thugs} thugs, ${totalLosses.weapons} weapons lost`, 'red');
            
            // IMMEDIATE INVESTIGATION FOR USER'S SPECIFIC LOSS
            console.log('üîç SEARCHING FOR 190 WEAPON LOSS AND 150 THUG LOSS...');
            
            // Look for large losses that match the user's report
            const largeThuggLosses = dataChangeLog.filter(c => c.type === 'thugs' && c.difference < -50);
            const largeWeaponLosses = dataChangeLog.filter(c => c.type === 'weapons' && c.difference < -50);
            
            if (largeThuggLosses.length > 0) {
                console.error('üö® LARGE THUG LOSSES FOUND:', largeThuggLosses);
                largeThuggLosses.forEach(loss => {
                    addConsoleMessage(`üìâ MAJOR THUG LOSS: ${Math.abs(loss.difference)} thugs lost at ${loss.time} (${loss.reason})`, 'red');
                });
            }
            
            if (largeWeaponLosses.length > 0) {
                console.error('üö® LARGE WEAPON LOSSES FOUND:', largeWeaponLosses);
                largeWeaponLosses.forEach(loss => {
                    addConsoleMessage(`üìâ MAJOR WEAPON LOSS: ${Math.abs(loss.difference)} weapons lost at ${loss.time} (${loss.reason})`, 'red');
                });
            }
            
            if (largeThuggLosses.length === 0 && largeWeaponLosses.length === 0) {
                addConsoleMessage('‚ö†Ô∏è No large losses found in tracking log - loss may have occurred before tracking was implemented', 'yellow');
                addConsoleMessage('üí° All future changes will be tracked - this won\'t happen again', 'cyan');
            }
        }
        
        // Recover lost assets based on backup data
        function recoverLostAssets() {
            if (!lastKnownGoodState) {
                showNotification('‚ùå No backup available for recovery', 'error');
                return;
            }
            
            const current = {
                thugs: gameState.resources.thugs,
                weapons: Object.values(gameState.resources.weapons || {}).reduce((a, b) => a + b, 0),
                hoes: gameState.resources.hoes
            };
            
            const backup = {
                thugs: lastKnownGoodState.resources.thugs,
                weapons: Object.values(lastKnownGoodState.resources.weapons || {}).reduce((a, b) => a + b, 0),
                hoes: lastKnownGoodState.resources.hoes
            };
            
            // Calculate what should be recovered
            const recovery = {
                thugs: Math.max(0, backup.thugs - current.thugs),
                weapons: Math.max(0, backup.weapons - current.weapons),
                hoes: Math.max(0, backup.hoes - current.hoes)
            };
            
            if (recovery.thugs > 0 || recovery.weapons > 0 || recovery.hoes > 0) {
                // Apply recovery
                if (recovery.thugs > 0) {
                    logResourceChange('thugs', null, current.thugs, current.thugs + recovery.thugs, 'asset_recovery');
                    gameState.resources.thugs += recovery.thugs;
                    
                    // Create crew members for recovered thugs
                    for (let i = 0; i < recovery.thugs; i++) {
                        gameState.crew.thugs.push(createThug());
                    }
                    syncThugCount('asset_recovery');
                }
                
                if (recovery.weapons > 0) {
                    logResourceChange('weapons', 'pistols', gameState.resources.weapons.pistols, gameState.resources.weapons.pistols + recovery.weapons, 'asset_recovery');
                    gameState.resources.weapons.pistols += recovery.weapons;
                }
                
                if (recovery.hoes > 0) {
                    logResourceChange('hoes', null, current.hoes, current.hoes + recovery.hoes, 'asset_recovery');
                    gameState.resources.hoes += recovery.hoes;
                    gameState.resources.hoeDetails.streetWorkers += recovery.hoes;
                }
                
                addConsoleMessage(`üîÑ RECOVERED: ${recovery.thugs} thugs, ${recovery.weapons} weapons, ${recovery.hoes} hoes`, 'green');
                showNotification(`üîÑ Assets recovered from backup!`, 'success');
                
                updateUI();
                saveGameState();
                closeModal();
            } else {
                showNotification('‚úÖ No assets need recovery', 'success');
            }
        }
        
        // Lock assets to prevent future losses
        function preventFutureLosses() {
            // Add asset protection flags
            gameState.assetProtection = {
                enabled: true,
                maxCombatLoss: 1, // Max 1 thug loss per combat defeat
                maxLossPerDay: 10, // Max 10 total asset losses per day
                lossesToday: 0,
                lastLossReset: Date.now()
            };
            
            addConsoleMessage('üõ°Ô∏è Asset protection enabled - maximum losses limited', 'green');
            showNotification('üõ°Ô∏è Asset protection activated!', 'success');
            saveGameState();
            closeModal();
        }
        
        // Export detailed loss report
        function exportLossReport() {
            const report = {
                timestamp: new Date().toISOString(),
                investigation: {
                    totalLosses: dataChangeLog.filter(c => c.difference < 0).length,
                    significantLosses: dataChangeLog.filter(c => c.difference < -10).length,
                    thugsLost: dataChangeLog.filter(c => c.type === 'thugs' && c.difference < 0).reduce((sum, c) => sum + Math.abs(c.difference), 0),
                    weaponsLost: dataChangeLog.filter(c => c.type === 'weapons' && c.difference < 0).reduce((sum, c) => sum + Math.abs(c.difference), 0)
                },
                currentState: {
                    thugs: gameState.resources.thugs,
                    weapons: gameState.resources.weapons,
                    hoes: gameState.resources.hoes,
                    cash: gameState.player.cash
                },
                fullChangeLog: dataChangeLog,
                suspiciousEvents: dataChangeLog.filter(c => 
                    c.difference < -50 || 
                    c.reason.includes('emergency') || 
                    c.reason.includes('corruption')
                )
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `asset_loss_report_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addConsoleMessage('üìÑ Asset loss report exported for analysis', 'cyan');
        }
        
        // GUARANTEE ASSET SAFETY (Single-Player Protection)
        function guaranteeAssetSafety() {
            console.log('üõ°Ô∏è ACTIVATING ASSET SAFETY GUARANTEE...');
            
            // Enable comprehensive asset protection
            gameState.assetProtection = {
                enabled: true,
                singlePlayerMode: true,
                allowLosses: false, // NO LOSSES ALLOWED
                guaranteedMinimums: {
                    thugs: Math.max(5, gameState.resources.thugs), // Never go below current
                    hoes: Math.max(10, gameState.resources.hoes),
                    cash: Math.max(1000, gameState.player.cash),
                    weapons: Object.values(gameState.resources.weapons || {}).reduce((a, b) => a + b, 0)
                },
                lastProtectionCheck: Date.now()
            };
            
            addConsoleMessage('üõ°Ô∏è ASSET SAFETY GUARANTEED: Assets can only increase, never decrease!', 'green');
            addConsoleMessage('üí° This is single-player mode - no PvP asset losses', 'cyan');
            addConsoleMessage('üîÆ Future multiplayer will have strategic asset losses vs other players', 'purple');
            
            showNotification('üõ°Ô∏è Assets permanently protected!', 'success');
            
            // Add protection notice to console
            const protectionNotice = `
üõ°Ô∏è ASSET PROTECTION ACTIVE:
‚Ä¢ Thugs: Protected (min ${gameState.assetProtection.guaranteedMinimums.thugs})
‚Ä¢ Hoes: Protected (min ${gameState.assetProtection.guaranteedMinimums.hoes})  
‚Ä¢ Weapons: Protected (min ${gameState.assetProtection.guaranteedMinimums.weapons})
‚Ä¢ Cash: Protected (min $${gameState.assetProtection.guaranteedMinimums.cash.toLocaleString()})
            `;
            
            console.log(protectionNotice);
                         addConsoleMessage('üõ°Ô∏è Full asset protection details logged to console', 'green');
             
             saveGameState();
         }
         
         // COMPLETE GAME RESET - Start completely fresh for testing
         function completeGameReset() {
             const modal = `
                 <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                     <div class="game-panel rounded-lg p-6 max-w-md w-full">
                         <div class="flex items-center justify-between mb-4">
                             <h3 class="text-xl font-bold orange-glow">üîÑ COMPLETE GAME RESET</h3>
                             <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                         </div>
                         
                         <div class="mb-4 p-4 bg-orange-900/30 rounded border border-orange-500/50">
                             <h4 class="font-bold text-orange-400 mb-2">‚ö†Ô∏è WARNING</h4>
                             <p class="text-sm text-gray-300 mb-2">This will completely reset your entire game to starting values:</p>
                             <ul class="text-xs text-gray-400 space-y-1">
                                 <li>‚Ä¢ Cash: Reset to $10,000</li>
                                 <li>‚Ä¢ Level: Reset to 1</li>
                                 <li>‚Ä¢ Hoes: Reset to 10</li>
                                 <li>‚Ä¢ Thugs: Reset to 5</li>
                                 <li>‚Ä¢ Weapons: Reset to 5 pistols</li>
                                 <li>‚Ä¢ Vehicles: Reset to 0</li>
                                 <li>‚Ä¢ Supplies: Reset to starting amounts</li>
                                 <li>‚Ä¢ Heat: Reset to 0%</li>
                                 <li>‚Ä¢ Respect: Reset to 0</li>
                                 <li>‚Ä¢ District: Unselected</li>
                                 <li>‚Ä¢ NFTs: Cleared</li>
                                 <li>‚Ä¢ Data logs: Cleared</li>
                             </ul>
                         </div>
                         
                         <div class="mb-4 p-3 bg-blue-900/30 rounded">
                             <h4 class="text-blue-400 font-bold mb-2">üí° Perfect for Testing</h4>
                             <div class="text-xs text-gray-300 space-y-1">
                                 <div>‚úÖ Fresh start with proper asset protection</div>
                                 <div>‚úÖ All systems reset to default values</div>
                                 <div>‚úÖ Change tracking starts clean</div>
                                 <div>‚úÖ All 5 NYC districts available</div>
                                 <div>‚úÖ 168 NPCs ready to spawn</div>
                             </div>
                         </div>
                         
                         <div class="flex gap-2">
                             <button onclick="executeCompleteReset()" class="flex-1 py-3 bg-orange-600 rounded font-bold hover:bg-orange-500">
                                 üîÑ YES, RESET EVERYTHING
                             </button>
                             <button onclick="closeModal()" class="flex-1 py-3 bg-gray-700 rounded font-bold">
                                 Cancel
                             </button>
                         </div>
                     </div>
                 </div>
             `;
             
             document.getElementById('modalContainer').innerHTML = modal;
         }
         
         // Execute the complete reset
         function executeCompleteReset() {
             console.log('üîÑ EXECUTING COMPLETE GAME RESET...');
             addConsoleMessage('üîÑ COMPLETE RESET: Starting fresh game...', 'orange');
             
             const now = Date.now();
             
             // Reset gameState to pristine defaults
             gameState = {
                 player: {
                     id: gameState.player.id, // Keep ID for database continuity
                     username: gameState.player.username, // Keep username
                     bio: '',
                     level: 1,
                     exp: 0,
                     expToNext: 1000,
                     cash: 9360,
                     lastActionTime: now,
                     lastIncomeTime: now,
                     turnsWhenLastChecked: 150, // Fresh 150 turns
                     maxTurns: 200,
                     regenRate: 0.2,
                     weekNumber: 1,
                     tutorialDay: 1,
                     checkinsToday: 1,
                     heat: 0,
                     respect: 0,
                     payoutPercentage: 30,
                     district: null,
                     rank: 'Unranked',
                     localRank: null,
                     nationalRank: null,
                     crewId: null,
                     crewRole: null,
                     joinedDate: null,
                     isOnline: false
                 },
                 crew: {
                     name: null,
                     tag: null,
                     description: null,
                     members: [],
                     treasury: 0,
                     level: 1,
                     territory: null,
                     thugs: [], // Will be populated below
                     lastPayrollTime: now,
                     nextPayrollDue: now + (7 * 24 * 60 * 60 * 1000)
                 },
                 resources: {
                     hoes: 9,
                     hoeDetails: {
                         streetWorkers: 6,
                         sugarBabies: 2,
                         highEndEscorts: 1,
                         onlyTrampsModels: 0
                     },
                     thugs: 6,
                     crack: 0,
                     weed: 0,
                     weapons: {
                         pistols: 5,
                         shotguns: 0,
                         tek9s: 0,
                         ak47s: 0
                     },
                     vehicles: {
                         bicycle: 0,
                         motorcycle: 0,
                         kia: 0,
                         lowrider: 0,
                         escalade: 0,
                         limo: 0,
                         bentley: 0,
                         armoredBeast: 0
                     },
                     condoms: 500,
                     beer: 200,
                     medicine: 10
                 },
                 supplies: {
                     lastConsumedAt: now,
                     hoeHappiness: 70,
                     thugHappiness: 70
                 },
                 npcs: {},
                 combatHistory: [],
                 nfts: [] // Clear NFT collection
             };
             
                         // Create starting crew thugs
            gameState.crew.thugs = [];
            for (let i = 0; i < 6; i++) {
                gameState.crew.thugs.push(createThug());
            }
             
             // Clear tracking systems
             dataChangeLog = [];
             lastKnownGoodState = null;
             
             // Clear Hood Pimps
             ACTIVE_HOOD_PIMPS.clear();
             
             // Enable asset protection by default
             gameState.assetProtection = {
                 enabled: true,
                 singlePlayerMode: true,
                 allowLosses: false,
                 guaranteedMinimums: {
                     thugs: 5,
                     hoes: 10,
                     cash: 1000,
                     weapons: 5
                 },
                 lastProtectionCheck: now
             };
             
             console.log('‚úÖ GAME RESET COMPLETE:', {
                 cash: gameState.player.cash,
                 turns: gameState.player.turnsWhenLastChecked,
                 hoes: gameState.resources.hoes,
                 thugs: gameState.resources.thugs,
                 weapons: Object.values(gameState.resources.weapons).reduce((a, b) => a + b, 0),
                 crewSize: gameState.crew.thugs.length
             });
             
             // Initialize fresh systems
             spawnHoodPimps();
             updateUI();
             updateTurnDisplay();
             updateSupplyStatus();
             updateHoodPimpDisplay();
             
             // Save the fresh state
             saveGameState();
             
             // Success messages
             addConsoleMessage('‚úÖ FRESH START: New game initialized!', 'green');
             addConsoleMessage(`üí∞ Starting cash: $${gameState.player.cash.toLocaleString()}`, 'gold');
             addConsoleMessage(`‚ö° Starting turns: ${gameState.player.turnsWhenLastChecked}/200 (2 per 10 min)`, 'cyan');
             addConsoleMessage(`üë• Starting crew: ${gameState.resources.hoes} hoes, ${gameState.resources.thugs} thugs`, 'pink');
             addConsoleMessage(`üî´ Starting weapons: ${Object.values(gameState.resources.weapons).reduce((a, b) => a + b, 0)} pistols`, 'blue');
             addConsoleMessage(`üõ°Ô∏è Asset protection: ENABLED (assets can only increase)`, 'green');
             addConsoleMessage(`üóΩ Ready to build your empire in Empire City's 5 districts!`, 'magenta');
             
             showNotification('üîÑ Fresh game started! Ready for testing!', 'success');
             closeModal();
         }
        
        // Fix economic exploits (billion dollar bug)
        function fixEconomicExploit() {
            if (!confirm('üö® Fix the billion dollar exploit? This will cap your cash at $10M and reset to reasonable levels.')) {
                return;
            }
            
            console.log('üö® FIXING ECONOMIC EXPLOIT...');
            addConsoleMessage('üö® Applying economic balance fixes...', 'red');
            
            const oldCash = gameState.player.cash;
            const oldHoes = gameState.resources.hoes;
            const oldThugs = gameState.resources.thugs;
            
            // Reset to reasonable maximum values for beta
            const maxCash = 10000000; // $10M cap
            const maxHoes = 500; // 500 hoe cap
            const maxThugs = 250; // 250 thug cap
            
            let fixed = false;
            
            if (gameState.player.cash > maxCash) {
                logResourceChange('cash', null, oldCash, maxCash, 'economic_exploit_fix');
                gameState.player.cash = maxCash;
                addConsoleMessage(`üí∞ Cash reduced from $${oldCash.toLocaleString()} to $${maxCash.toLocaleString()}`, 'yellow');
                fixed = true;
            }
            
            if (gameState.resources.hoes > maxHoes) {
                logResourceChange('hoes', null, oldHoes, maxHoes, 'economic_exploit_fix');
                gameState.resources.hoes = maxHoes;
                addConsoleMessage(`üëØ Hoes reduced from ${oldHoes} to ${maxHoes}`, 'yellow');
                fixed = true;
            }
            
            if (gameState.resources.thugs > maxThugs) {
                logResourceChange('thugs', null, oldThugs, maxThugs, 'economic_exploit_fix');
                gameState.resources.thugs = maxThugs;
                
                // Adjust crew array to match
                if (gameState.crew.thugs.length > maxThugs) {
                    gameState.crew.thugs = gameState.crew.thugs.slice(0, maxThugs);
                }
                
                syncThugCount('economic_exploit_fix');
                addConsoleMessage(`üë• Thugs reduced from ${oldThugs} to ${maxThugs}`, 'yellow');
                fixed = true;
            }
            
            if (fixed) {
                addConsoleMessage('‚úÖ Economic exploit fixed - balanced for fair gameplay', 'green');
                showNotification('üö® Economy rebalanced for fair play', 'success');
                updateUI();
                saveGameState();
            } else {
                addConsoleMessage('‚úÖ No economic exploits detected', 'green');
            }
        }

        // Check if user is admin (add your admin check logic here)
        function isAdminUser() {
            // For now, check if username contains "admin" or specific admin emails
            const adminUsers = ['admin', 'pimp_admin', 'dev', 'test_admin'];
            const currentUser = gameState?.player?.username?.toLowerCase() || '';
            return adminUsers.some(admin => currentUser.includes(admin)) || 
                   currentUser.includes('@pimp.fun');
        }

        // Show/hide admin panel based on user permissions
        function updateAdminPanelVisibility() {
            const adminPanel = document.getElementById('adminPanel');
            if (adminPanel) {
                adminPanel.style.display = isAdminUser() ? 'block' : 'none';
            }
        }

        // Season reset information modal
        function showSeasonResetInfo() {
            const modal = `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="game-panel rounded-lg p-6 max-w-lg w-full max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold purple-glow">üèÜ SEASON RESET SYSTEM</h3>
                            <button onclick="closeModal()" class="text-red-400 hover:text-red-300 text-2xl font-bold">&times;</button>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Season Reset Explanation -->
                            <div class="p-4 bg-purple-900/30 rounded border border-purple-500/50">
                                <h4 class="font-bold text-purple-400 mb-2">üéØ What is a Season Reset?</h4>
                                <div class="text-sm text-gray-300 space-y-1">
                                    <div>‚Ä¢ Competitive seasons (like Clash Royale, Fortnite)</div>
                                    <div>‚Ä¢ Everyone starts fresh with same resources</div>
                                    <div>‚Ä¢ Race to build the biggest empire</div>
                                    <div>‚Ä¢ Season winners get special rewards/NFTs</div>
                                </div>
                            </div>
                            
                            <!-- What Gets KEPT -->
                            <div class="p-4 bg-green-900/30 rounded border border-green-500/50">
                                <h4 class="font-bold text-green-400 mb-2">‚úÖ PRESERVED (Your Identity)</h4>
                                <div class="text-sm text-gray-300 space-y-1">
                                    <div>‚Ä¢ Your username and bio</div>
                                    <div>‚Ä¢ Your email/wallet address</div>
                                    <div>‚Ä¢ NFT collection (if any)</div>
                                    <div>‚Ä¢ Achievement badges (if any)</div>
                                    <div>‚Ä¢ Account creation date</div>
                                    <div>‚Ä¢ Previous season rankings</div>
                                </div>
                            </div>
                            
                            <!-- What Gets RESET -->
                            <div class="p-4 bg-orange-900/30 rounded border border-orange-500/50">
                                <h4 class="font-bold text-orange-400 mb-2">üîÑ RESET (Fresh Start)</h4>
                                <div class="text-sm text-gray-300 space-y-1">
                                    <div>‚Ä¢ Cash ‚Üí $9,360</div>
                                    <div>‚Ä¢ Level ‚Üí 1</div>
                                    <div>‚Ä¢ Hoes ‚Üí 9 (6 street, 2 sugar, 1 high-end)</div>
                                    <div>‚Ä¢ Thugs ‚Üí 6</div>
                                    <div>‚Ä¢ Weapons ‚Üí 5 pistols</div>
                                    <div>‚Ä¢ Vehicles ‚Üí 0</div>
                                    <div>‚Ä¢ Territory ‚Üí None</div>
                                    <div>‚Ä¢ Crew membership ‚Üí None</div>
                                    <div>‚Ä¢ Heat ‚Üí 0%</div>
                                    <div>‚Ä¢ Respect ‚Üí 0</div>
                                </div>
                            </div>
                            
                            <!-- How to Execute -->
                            <div class="p-4 bg-blue-900/30 rounded border border-blue-500/50">
                                <h4 class="font-bold text-blue-400 mb-2">üõ†Ô∏è How to Execute Season Reset</h4>
                                <div class="text-sm text-gray-300 space-y-2">
                                    <div><strong>1.</strong> Go to Supabase Dashboard ‚Üí SQL Editor</div>
                                    <div><strong>2.</strong> Copy contents of <code>SEASON_RESET.sql</code></div>
                                    <div><strong>3.</strong> Paste and click "Run"</div>
                                    <div><strong>4.</strong> All players reset to starting values</div>
                                    <div><strong>5.</strong> Announce new season to players</div>
                                </div>
                            </div>
                            
                            <!-- Timeline Example -->
                            <div class="p-4 bg-gray-800/50 rounded">
                                <h4 class="font-bold text-gray-300 mb-2">üìÖ Example Season Timeline</h4>
                                <div class="text-xs text-gray-400 space-y-1">
                                    <div><strong>Week 12:</strong> Announce "Season 1 ending in 1 week"</div>
                                    <div><strong>Week 13:</strong> Take final leaderboard snapshot</div>
                                    <div><strong>Week 13:</strong> Award season champion NFTs</div>
                                    <div><strong>Week 13:</strong> Run SEASON_RESET.sql</div>
                                    <div><strong>Week 13:</strong> Announce "Season 2 begins!"</div>
                                    <div><strong>Ongoing:</strong> Players compete for Season 2 crown</div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full py-3 bg-gray-700 rounded font-bold mt-4">
                            Close Info
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modal;
        }

        // Start game (simplified)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéÆ DOM loaded, waiting for scripts...');
            
            // Add robust event listener for district selection as fallback
            setTimeout(() => {
                const districtElement = document.getElementById('district');
                if (districtElement) {
                    // Add click event listener as backup to onclick attribute
                    districtElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üèôÔ∏è District clicked via event listener');
                        if (typeof selectDistrict === 'function') {
                            selectDistrict();
                        } else {
                            console.error('‚ùå selectDistrict function not available');
                        }
                    });
                    console.log('‚úÖ District click listener added as fallback');
                }
            }, 100);
            
            // Give more time for external scripts to load
            setTimeout(async () => {
                console.log('üîÑ Starting game initialization...');
                try {
                    await initGame();
                } catch (error) {
                    console.error('‚ùå Game initialization failed:', error);
                    addConsoleMessage('‚ùå Game failed to start. Please refresh the page.', 'red');
                }
            }, 500); // Increased timeout to ensure scripts load
        });
    </script>
</body>
</html> 